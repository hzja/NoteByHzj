Linux ssh
<a name="dVK8g"></a>
## SSH基本用法
参数：

- `-p`：指定端口号。
- user：登录的用户名。
- host：登录的主机。
```bash
ssh -p 22 user@host
```
参数：`-p`：指定端口号。user：登录的用户名。host：登录的主机。默认的端口号为22，当端口号为22的时候，可以省略，直接使用如下方式：
```bash
ssh user@host
```
如果本地正在使用的用户名与远程登录的用户名一致，登录用户名也是可以省略的，即如下：
```bash
ssh host
```
<a name="wsyLT"></a>
## SSH端口转发
SSH 不仅仅能够自动加密和解密 SSH 客户端与服务端之间的网络数据，同时，SSH 还能够提供了一个非常有用的功能，那就是端口转发，即将TCP 端口的网络数据，转发到指定的主机某个端口上，在转发的同时会对数据进行相应的加密及解密。如果工作环境中的防火墙限制了一些网络端口的使用，但是允许 SSH 的连接，那么也是能够通过使用SSH转发后的端口进行通信。转发，主要分为本地转发与远程转发两种类型。
<a name="86972334"></a>
### 1、参数
```
-C：压缩数据
-f ：后台认证用户/密码，通常和-N连用，不用登录到远程主机。
-N ：不执行脚本或命令，通常与-f连用。
-g ：在-L/-R/-D参数中，允许远程主机连接到建立的转发的端口，如果不加这个参数，只允许本地主机建立连接。
-L : 本地端口:目标IP:目标端口
-D : 动态端口转发
-R : 远程端口转发
-T ：不分配 TTY 只做代理用
-q ：安静模式，不输出 错误/警告 信息
```
<a name="WjU6X"></a>
### 2、本地转发
由本地网络服务器的某个端口，转发到远程服务器某个端口。将发送到本地端口的请求，转发到目标端口。格式如下：
```bash
ssh -L [本地地址:]本地端口:远程地址:远程端口 远程用户@远程地址
```
将本地的MySQL的3306端口转发至服务器的3306端口进行访问
```bash
ssh -L 127.0.0.1:3306:127.0.0.1:3306 root@192.168.13.142
```
如果IP为127.0.0.1则可以省略成如下格式
```bash
ssh -L 3306:127.0.0.1:3306 root@192.168.13.142
```
ssh连接的时候，若两台机器的用户名相同，也是可以省略的
```bash
ssh -L 3306:127.0.0.1:3306 192.168.13.14
```
<a name="3p7Mb"></a>
### 3、远程转发
远程转发，即把发给远程机器的某个端口请求，转发到本地的机器上面。由远程服务器的某个端口，转发到本地网络的服务器某个端口。就是将发送到远程端口的请求，转发到目标端口。格式如下：
```bash
ssh -R [远程地址:]远程端口:本地地址:本地端口 远程用户@远程地址
```
```bash
ssh -R 10.18.78.135:80:127.0.0.1:80 root@192.168.13.142
```
<a name="Nj3D6"></a>
#### 利用远程转发，实现代理功能
目前B机器，只能在自己127.0.0.1的80端口监听并转发，如何让B机器作为代理，转发其他机器的请求到A机器上面呢？比如，现在有一台机器C（192.168.13.143），C不能访问A，但是能够访问B。如何让C利用B来访问A呢？此时，需要将B的监听，由127.0.0.1:8081，改为0:0.0.0:8081，修改sshd的配置/etc/ssh/sshd_config。
```bash
vim /etc/ssh/sshd_config
```
如果有`GatewayPorts no`改为`GatewayPorts yes`<br />如果没有，添加即可，如果使用SSH作为中间代理层还需要转发一层，则需要开启`AllowAgentForwarding yes`<br />和`AllowTcpForwarding yes`<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1661925276024-bdf233c6-27ff-4ed5-a143-97e26d9a4dca.png#averageHue=%23272821&clientId=u3a12281f-921e-4&from=paste&height=94&id=u9c1ce91c&originHeight=236&originWidth=957&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18199&status=done&style=none&taskId=u499a4bb8-c09c-4740-9e58-6b364576d4d&title=&width=382.8)<br />然后重启sshd
```bash
sudo service sshd restart

# 或

systemctl restart sshd
```
设置动态转发，如下：
```bash
ssh -f -g -N -R 8081:127.0.0.1:80 root@192.168.13.149
```
<a name="mui2N"></a>
## ssh的远程操作
ssh远程操作，主要用于在远程的机器上面执行某个操作，格式如下
```bash
ssh user@host 'command'
```
在机器A（192.168.13.148）中查看机器B（192.168.13.149）的操作系统类型。
```bash
ssh  dequan@192.168.13.149  'uname -a'
```
将机器A（192.168.13.148）中test文件夹复制到B机器（192.168.13.149）。
```bash
tar -cz test | ssh root@192.168.13.149 'tar -xz'
```
<a name="rY22L"></a>
## ssh的动态转发
对于SSH的本地转发和远程转发，都需要将本地端口和远程端口一一绑定，格式如下：
```bash
ssh -D [本地地址:]本地端口号 远程用户@远程地址
```
<a name="5IYwN"></a>
## ssh–安全连接客户端
ssh命令全称是“Secure Shell”是openssh套件中的客户端连接工具，可以给予ssh加密协议实现安全的远程登录服务器，实现对服务器的远程管理。<br />语法格式: ssh [参数] [远程主机]<br />常用参数：

| -1 | 强制使用ssh协议版本1 |
| --- | --- |
| -2 | 强制使用ssh协议版本2 |
| -4 | 强制使用IPv4地址 |
| -6 | 强制使用IPv6地址 |

<a name="zYB6W"></a>
## SSH有密登录和免密登录

- **SSH实现免密登录步骤**
```bash
# 在本地生成一对公钥和私钥
$ ssh-keygen
# 将公钥发送给远程服务器,必须给出远程服务器的密码本地才接收公钥
$ ssh-copy-id address
# 查看公钥
$ cat authorized_keys
# 发送登录请求，实现免密登录
$ ssh address
```
