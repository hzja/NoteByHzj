Linux<br />Linux 存储系统 I/O 栈由文件系统层（file system layer）、通用块层（ general block layer）和设备层（device layer）构成。<br />其中，**通用块层**是 Linux 磁盘 I/O 的核心。向上，它为访问文件系统和应用程序的块设备提供了标准接口；向下，它将各种异构磁盘设备抽象为一个统一的块设备，并响应文件系统和应用程序发送的 I/O。<br />来看看磁盘的性能指标以及如何查看这些指标。
<a name="mXBXU"></a>
## Linux 磁盘性能指标
在衡量磁盘性能时，经常提到五个常见指标：利用率、饱和度、IOPS、吞吐量和响应时间。这五个指标是衡量磁盘性能的基本指标。

1. **利用率（Utilization）**：磁盘处理 I/O 的时间百分比。过度使用（如超过 80%）通常意味着磁盘 I/O 存在性能瓶颈。
2. **饱和度（Saturation）**：指磁盘处理 I/O 的繁忙程度。过度饱和意味着磁盘存在严重的性能瓶颈。当饱和度为 100% 时，磁盘无法接受新的 I/O 请求。
3. **IOPS（Input/Output Per Second）**：指每秒 I/O 请求的数量。
4. **吞吐量（Throughput）**：每秒 I/O 请求的大小。
5. **响应时间（Response time）**：指发送 I/O 请求和接收响应之间的间隔时间。

_这里需要注意的是，关于利用率，只考虑有无 I/O，而不考虑 I/O 的大小。也就是说，当利用率为 100% 时，磁盘仍有可能接受新的 I/O 请求。_<br />一般来说，在为应用选择服务器时，首先要对磁盘的 I/O 性能进行基准测试，这样才能准确评估磁盘性能，以判断是否能够满足应用的需求。<br />当然，这需要在**随机读**、**顺序读**、**随机写**、**顺序写**等各种应用场景下测试不同 I/O 大小（通常是 512B ~ 1MB 之间）的性能。
<a name="bpl0z"></a>
## 磁盘 I/O 观察
首先要观察的是每个磁盘的使用情况。iostat 是最常用的磁盘 I/O 性能观察工具。它提供了各种常用性能指标，例如每个磁盘的**利用率**、**IOPS** 和**吞吐量**。当然，这些指标实际上来自 /proc/diskstats。<br />以下是 iostat 的输出示例：
```bash
# -d -x means display all disk I/O performance
$ iostat -d -x 1 
Device            r/s     w/s     rkB/s     wkB/s   rrqm/s   wrqm/s  %rrqm  %wrqm r_await w_await aqu-sz rareq-sz wareq-sz  svctm  %util 
loop0            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 
loop1            0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 
sda              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00 
sdb              0.00    0.00      0.00      0.00     0.00     0.00   0.00   0.00    0.00    0.00   0.00     0.00     0.00   0.00   0.00
```
在上述指标中，需要注意的是：

- %util 是前面提到的磁盘 I/O 使用情况
- r/s 和 w/s 是 IOPS
- rkB/s 和 wkB/s 是吞吐量
- r_await 和 w_await 是响应时间

iostat 不能直接获取磁盘的饱和度。事实上，通常没有什么简单的方法可以测量饱和度。但是，可以将观察到的**平均请求队列长度**或**完成读写请求的等待时间**与**基准测试**（例如通过 fio）的结果进行比较，以综合评估磁盘饱和度。
<a name="e8AmF"></a>
## 进程 I/O 观察
除了每个磁盘的 I/O 情况，每个进程的 I/O 情况也是大家关注的重点。<br />上面提到的 iostat 只提供了观察磁盘的整体 I/O 性能数据。缺点是无法知道哪些进程正在读写磁盘。要观察进程的 I/O，还可以使用 pidstat 和 iotop 工具。<br />例如，要使用 pidstat
```bash
$ pidstat -d 1 
13:39:51      UID       PID   kB_rd/s   kB_wr/s kB_ccwr/s iodelay  Command 
13:39:52      102       916      0.00      4.00      0.00       0  rsyslogd
```
从 pidstat 的输出可以看出，它可以实时查看每个进程的 I/O 情况，这包括以下内容：

- 用户 ID (UID) 和进程 ID (PID)。
- 每秒读取的数据大小 (kB_rd/s)，以 KB 为单位。
- 每秒发出的写请求数据的大小（kB_wr/s），单位为KB。
- 每秒取消写入请求的数据大小 (kB_ccwr/s)，以 KB 为单位。
- 块 I/O 延迟 (iodelay)，包括等待同步块（synchronized block）I/O 和换入块（swap-in block）I/O 完成的时间，以**时钟周期**为单位。

除了使用 pidstat 实时查看进程磁盘 I/O 外，还有一个磁盘性能分析的常用方法是根据 I/O 大小对进程进行排序。为此，推荐 iotop 工具。它是一个类似于 top 的工具，可以按 I/O 大小对进程进行排序，并找到具有更大 I/O 的进程。
```bash
$ iotop
Total DISK READ :       0.00 B/s | Total DISK WRITE :       7.85 K/s 
Actual DISK READ:       0.00 B/s | Actual DISK WRITE:       0.00 B/s 
  TID  PRIO  USER     DISK READ  DISK WRITE  SWAPIN     IO>    COMMAND 
15055 be/3 root        0.00 B/s    7.85 K/s  0.00 %  0.00 % systemd-journald
```
从该输出可以看到，前两行分别代表**进程的磁盘读写总大小**和**磁盘的实际读写总大小**。由于**缓存**、**缓冲区**、**I/O 合并**等因素，它们可能不相等。<br />剩下的部分从各个角度代表了进程的 I/O 情况，包括 **线程 ID**、**I/O 优先级**、**每秒磁盘读取大小**、**每秒磁盘写入大小**、**换入百分比**和**等待 I/O 时钟百分比**。
<a name="sYxpg"></a>
## 结论
介绍了 Linux 磁盘 I/O 的性能指标和查看性能工具。通常使用 **IOPS**、**吞吐量**、**利用率**、**饱和度**和**响应时间**等几个指标来评估磁盘的 I/O 性能。<br />可以使用 iostat 获取磁盘的 I/O 情况，也可以使用 pidstat、iotop 等观察进程的 I/O 情况。但在分析这些性能指标时，要注意结合**读写比率**、**I/O 类型**、**I/O 大小**等综合分析。
