网络NAT<br />为了更好的利用这有限的IP数量，网络分为**局域网和广域网**，将IP分为了**私有IP和公网IP**，一个局域网里的N多台机器都可以**共用一个公网IP**，从而大大增加了"可用IP数量"。<br />![收发数据就像收发快递](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841139-6ae5ec88-53dd-49c4-a67b-a8360dd30d26.png#averageHue=%23eaedf0&clientId=u2e4c34bc-20b4-4&from=paste&id=ub83208be&originHeight=486&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u112be5e0-cd22-45d4-a9d7-a5e992d7509&title=%E6%94%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E5%B0%B1%E5%83%8F%E6%94%B6%E5%8F%91%E5%BF%AB%E9%80%92 "收发数据就像收发快递")<br />当需要发送网络包的时候，在IP层，需要填入源IP地址，和目的IP地址，也就是对应快递的发货地址和收货地址。<br />![IP报头里含有发送和接收IP地址](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841107-67b403d3-5a6e-48f4-a2af-3f7abcbf3198.png#averageHue=%23b0d59d&clientId=u2e4c34bc-20b4-4&from=paste&id=u96fc9128&originHeight=450&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u0bf5447a-81e3-4eba-bc96-e6a63dce8a1&title=IP%E6%8A%A5%E5%A4%B4%E9%87%8C%E5%90%AB%E6%9C%89%E5%8F%91%E9%80%81%E5%92%8C%E6%8E%A5%E6%94%B6IP%E5%9C%B0%E5%9D%80 "IP报头里含有发送和接收IP地址")<br />但是家里的局域网内，基本上都用192.168.xx.xx这样的**私有IP**。<br />如果在发送网络包的时候，这么填。对方在回数据包的时候该怎么回？毕竟千家万户人用的都是192.168.0.1，网络怎么知道该发给谁？<br />所以肯定需要将这个192.168.xx**私有IP转换成公有IP**。<br />局域网内用的是私有IP，公网用的都是公有IP。一个局域网里的私有IP想访问局域网外的公有IP，必然要做个IP转换，这是在哪里做的转换呢？<br />![私有IP和公有IP在哪进行转换](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841104-b7dcfd4d-8fd2-43c9-a721-1427d37d6b28.png#averageHue=%23e9edef&clientId=u2e4c34bc-20b4-4&from=paste&id=uf2d6ada0&originHeight=360&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=uaf481b3d-35d1-410e-9ed6-bbc68e30fb9&title=%E7%A7%81%E6%9C%89IP%E5%92%8C%E5%85%AC%E6%9C%89IP%E5%9C%A8%E5%93%AA%E8%BF%9B%E8%A1%8C%E8%BD%AC%E6%8D%A2 "私有IP和公有IP在哪进行转换")<br />答案是**NAT设备**，全称**N**etwork **A**ddress **T**ranslation，网络地址转换。基本上家用路由器都支持这功能。<br />来聊下它是怎么工作的。
<a name="fASzL"></a>
## NAT的工作原理
为了简单，假设你很富，你家里分到了一个公网IP地址 20.20.20.20，对应配到了你家自带NAT功能的**家用路由器上**，你家里需要上网的设备有很多，比如你的手机，电脑都需要上网，他们构成了一个**局域网**，用的都是**私有IP**，比如192.168.xx。其中你在电脑上执行ifconfig命令，发现家里的电脑IP是192.168.30.5。要访问的公网IP地址是30.30.30.30。<br />于是就有下面这样一张图<br />![内网IP访问公网IP](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841117-fa2a974b-ccf5-4ea7-bd9f-4b7b7c673b5b.png#averageHue=%23e5ebed&clientId=u2e4c34bc-20b4-4&from=paste&id=u4fc80735&originHeight=270&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u840141f5-8a62-42bd-9fb6-8feac251d49&title=%E5%86%85%E7%BD%91IP%E8%AE%BF%E9%97%AE%E5%85%AC%E7%BD%91IP "内网IP访问公网IP")<br />当准备发送数据包的时候，电脑内核协议栈就会构造一个IP数据包。这个IP数据包报头里的**发送端**IP地址填的就是192.168.30.5，**接收端**IP地址就是30.30.30.30。将数据包发到NAT路由器中。<br />此时NAT路由器会将IP数据包里的**源IP地址**修改一下，私有IP地址192.168.30.5改写为公网IP地址20.20.20.20，这叫**SNAT**（**S**ource **N**etwork **A**ddress **T**ranslation，源地址转换）。并且还会在NAT路由器内部留下一条 192.168.30.5 -> 20.20.20.20的映射记录，这个信息会在后面用到。之后IP数据包经过公网里各个路由器的转发，发到了接收端30.30.30.30，到这里**发送流程**结束。<br />![SNAT](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841112-e8892b77-1611-462b-a1a4-75ed510f0999.png#averageHue=%23e0e9ea&clientId=u2e4c34bc-20b4-4&from=paste&id=u3ff7f344&originHeight=585&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u869497e5-5d5a-45c4-bbd7-8fb62aff0da&title=SNAT "SNAT")<br />如果接收端处理完数据了，需要发一个响应给你的电脑，那就需要将**发送端**IP地址填上自己的30.30.30.30，将**接收端**地址填为公网IP地址20.20.20.20，发往NAT路由器。NAT路由器收到公网来的消息之后，会检查下自己之前留下的映射信息，发现之前留下了这么一条 192.168.30.5 -> 20.20.20.20记录，就会将这个数据包的**目的IP地址**修改一下，变成内网IP地址192.168.30.5, 这也叫DNAT（**D**estination **N**etwork **A**ddress **T**ranslation，目的地址转换）。之后将其转发到电脑上。<br />![DNAT](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841580-6720f057-d7a6-4315-ba56-4f9905ffe9a3.png#averageHue=%23e0e9ea&clientId=u2e4c34bc-20b4-4&from=paste&id=ue21f677f&originHeight=585&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u9b39e590-18ed-490a-b7ec-27870a27827&title=DNAT "DNAT")<br />整个过程下来，NAT悄悄的改了IP数据包的发送和接收端IP地址，但对真正的发送方和接收方来说，他们却**对这件事情，一无所知**。<br />这就是NAT的工作原理。
<a name="gJw9p"></a>
## NAPT的原理
到这里，相信大家都有一个很大的疑问。<br />局域网里并不只有一台机器，局域网内 每台机器都在NAT下留下的映射信息都会是 192.168.xx.xx -> 20.20.20.20，发送消息是没啥事，但**接收**消息的时候就不知道该回给谁了。<br />![NAT的问题](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841764-99c6db54-0dea-480d-bfc9-67f5ff705c49.png#averageHue=%23e0e8ea&clientId=u2e4c34bc-20b4-4&from=paste&id=u6bff7027&originHeight=585&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=ufe601a1d-e2d4-4bb6-9aa5-e66a6ba9690&title=NAT%E7%9A%84%E9%97%AE%E9%A2%98 "NAT的问题")<br />这问题相当致命，因此**实际上大部分时候不会使用普通的NAT**。<br />那怎么办呢？<br />问题出在没办法区分内网里的多个网络连接。<br />于是乎。<br />可以**加入其他信息去区分内网里的各个网络连接，很自然就能想到端口。**<br />但IP数据包（**网络层**）本身是没有端口信息的。常见的**传输层**协议TCP和UDP数据报文里才有**端口**的信息。<br />![TCP报头有端口号](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841595-957fb117-36ce-47b0-9882-db3c6c93ccce.png#averageHue=%238ec4a1&clientId=u2e4c34bc-20b4-4&from=paste&id=u34f020fc&originHeight=450&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u5adab710-335e-4142-82a6-2a0d84fcdfc&title=TCP%E6%8A%A5%E5%A4%B4%E6%9C%89%E7%AB%AF%E5%8F%A3%E5%8F%B7 "TCP报头有端口号")<br />![UDP报头也有端口号](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841612-8cc0bf61-a683-493e-9f01-da61ba83d14b.png#averageHue=%238dc3a1&clientId=u2e4c34bc-20b4-4&from=paste&id=uc25b6f80&originHeight=225&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u5cce9bc0-f61d-4010-a86e-2c013c75d34&title=UDP%E6%8A%A5%E5%A4%B4%E4%B9%9F%E6%9C%89%E7%AB%AF%E5%8F%A3%E5%8F%B7 "UDP报头也有端口号")<br />于是流程就变成了下面这样子。<br />当准备发送数据包的时候，电脑内核协议栈就会先构造一个TCP或者UDP数据报头，里面写入端口号，比如发送端口是5000，接收端口是3000，然后在这个基础上，加入IP数据报头，填入发送端和接收端的IP地址。<br />那数据包长这样。<br />![数据包的构成](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841746-75132835-3048-4dd5-a930-50b8af46d2c5.png#averageHue=%23d9e6e6&clientId=u2e4c34bc-20b4-4&from=paste&id=u3df4c384&originHeight=473&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u9af4f58e-3269-4603-8f20-1b33956ebd0&title=%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E6%9E%84%E6%88%90 "数据包的构成")<br />假设，**发送端**IP地址填的就是192.168.30.5，**接收端**IP地址就是30.30.30.30。<br />将数据包发到NAT路由器中。<br />此时NAT路由器会将IP数据包里的**源IP地址和端口号**修改一下，从192.168.30.5:5000改写成20.20.20.20:6000。并且还会在NAT路由器内部留下一条 192.168.30.5:5000 -> 20.20.20.20:6000的映射记录。之后数据包经过公网里各个路由器的转发，发到了接收端30.30.30.30:3000，到这里**发送流程**结束。<br />![NAPT发送数据](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842356-9d10629d-6c27-47a4-9135-cd5a3d2e105e.png#averageHue=%23dfe8e9&clientId=u2e4c34bc-20b4-4&from=paste&id=uddefd9dd&originHeight=585&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u0b839329-e0e5-471c-a3c2-94ffa0e71af&title=NAPT%E5%8F%91%E9%80%81%E6%95%B0%E6%8D%AE "NAPT发送数据")<br />接收端响应时，就会在数据包里填入**发送端**地址是30.30.30.30:3000，将**接收端**是20.20.20.20:6000，发往NAT路由器。NAT路由器发现下自己之前留下过这么一条 192.168.30.5:5000 -> 20.20.20.20:6000的记录，就会将这个数据包的**目的IP地址和端口**修改一下，变回原来的192.168.30.5:5000。之后将其转发到电脑上。<br />![NAPT接收数据](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808841990-18b64307-af08-405c-adb6-fdd0431a6aa4.png#averageHue=%23dfe8e9&clientId=u2e4c34bc-20b4-4&from=paste&id=u11e17a99&originHeight=585&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u33266826-8539-4d51-970d-e440bbb7f10&title=NAPT%E6%8E%A5%E6%94%B6%E6%95%B0%E6%8D%AE "NAPT接收数据")<br />如果局域网内有多个设备，他们就会映射到不同的公网端口上，毕竟端口最大可达65535，完全够用。这样大家都可以相安无事。<br />像这种同时转换**IP和端口**的技术，就是**NAPT**（Network Address Port Transfer , **网络地址端口转换** ）。<br />看到这里，问题就来了。<br />那这么说**只有用到端口的网络协议才能被NAT识别出来并转发？**<br />但这怎么解释ping命令？ping基于ICMP协议，而ICMP协议报文里并不带端口信息。依然可以正常的ping通公网机器并收到回包。<br />![ping报头](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842151-7a3c7432-762f-4c8c-9bb6-a1da6ee33e3b.png#averageHue=%2369aea1&clientId=u2e4c34bc-20b4-4&from=paste&id=u998b4776&originHeight=225&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u02f15670-9f68-48a5-b813-7754ade389a&title=ping%E6%8A%A5%E5%A4%B4 "ping报头")<br />事实上针对ICMP协议，NAT路由器做了特殊处理。ping报文头里有个Identifier的信息，它其实指的是放出ping命令的**进程id**。<br />对NAT路由器来说，这个Identifier的作用就跟端口一样。<br />另外，当去抓包的时候，就会发现有两个Identifier，一个后面带个BE（Big Endian），另一个带个LE（Little Endian）。<br />其实他们都是**同一个数值**，只不过**大小端不同**，读出来的值不一样。就好像同样的数字345，反着读就成了543。这是为了兼容不同操作系统（比如linux和Windows）下大小端不同的情况。<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842075-5ac6614b-0ce4-43af-816a-ba2631f73bc9.png#averageHue=%23adf9ad&clientId=u2e4c34bc-20b4-4&from=paste&id=u36319595&originHeight=466&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=false&status=done&style=none&taskId=u7f493002-51df-4daf-a542-5e6be539533&title=)
<a name="BGHXl"></a>
## 内网穿透是什么
看到这里，大概也发现了。使用了NAT上网的话，前提得**内网机器主动请求公网IP**，这样NAT才能将内网的**IP端口**转成外网**IP端口**。<br />反过来公网的机器想主动请求内网机器，就会被拦在NAT路由器上，此时由于NAT路由器并没有任何相关的IP端口的**映射记录**，因此也就不会转发数据给内网里的任何一台机器。<br />举个现实中的场景就是，在家里的电脑上启动了一个HTTP服务，地址是192.168.30.5:5000，此时在公司办公室里想通过手机去访问一下，却发现访问不了。<br />那问题就来了，有没有办法让外网机器访问到内网的服务？<br />有。<br />大家应该听过一句话叫，"**没有什么是加中间层不能解决的，如果有，那就再加一层**"。<br />放在这里，依然适用。<br />说到底，因为NAT的存在，只能从内网主动发起连接，否则NAT设备不会记录相应的映射关系，没有映射关系也就不能转发数据。<br />所以就在**公网上**加一台服务器x，并暴露一个访问域名，再让内网的服务**主动**连接服务器x，这样NAT路由器上就有对应的**映射关系**。接着，所有人都去访问服务器x，服务器x将数据转发给内网机器，再原路返回响应，这样数据就都通了。这就是所谓的**内网穿透**。<br />像上面提到的服务器x，也不需要自己去搭，已经有很多现成的方案，花钱就完事了，比如花某壳。<br />![内网穿透](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842194-8c7be01a-f191-4dbd-a12a-2bbf43cd5ad4.png#averageHue=%23dbe6e7&clientId=u2e4c34bc-20b4-4&from=paste&id=u659f7814&originHeight=637&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u88e6c840-d49a-4a52-b010-495e492f0b4&title=%E5%86%85%E7%BD%91%E7%A9%BF%E9%80%8F "内网穿透")<br />到这里，就可以回答文章标题的问题。<br />**为什么在公司里访问不了家里的电脑？**<br />那是因为家里的电脑在局域网内，局域网和广域网之间有个NAT路由器。由于NAT路由器的存在，外网服务无法主动连通局域网内的电脑。
<a name="nQKSi"></a>
### 两个内网的聊天软件如何建立通讯
好了，问题就叒来了。<br />我家机子是在小区的局域网里，班花家的机子也是在她们小区的局域网里。都在局域网里，且NAT只能从内网连到外网，那电脑上登录的QQ是怎么和班花电脑里的QQ连上的呢？<br />![两个局域网内的服务无法直接连通](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842408-71875e9b-8e85-447a-89f8-399b2ec66e08.png#averageHue=%23e7ecee&clientId=u2e4c34bc-20b4-4&from=paste&id=u319dc401&originHeight=386&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u3dfa1e5a-8509-4924-8f62-f70c5ee6d46&title=%E4%B8%A4%E4%B8%AA%E5%B1%80%E5%9F%9F%E7%BD%91%E5%86%85%E7%9A%84%E6%9C%8D%E5%8A%A1%E6%97%A0%E6%B3%95%E7%9B%B4%E6%8E%A5%E8%BF%9E%E9%80%9A "两个局域网内的服务无法直接连通")<br />上面这个问法其实是存在个误解，误以为两个qq客户端应用是直接建立连接的。<br />然而实际上并不是，两个qq客户端之间还隔了一个服务器。<br />![聊天软件会主动与公网服务器建立连接](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842628-b0204248-568f-49f6-8f63-2944d4e5d876.png#averageHue=%23dee7e9&clientId=u2e4c34bc-20b4-4&from=paste&id=u314986a5&originHeight=540&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=udec28a4d-21b4-49c1-b920-ff581a70223&title=%E8%81%8A%E5%A4%A9%E8%BD%AF%E4%BB%B6%E4%BC%9A%E4%B8%BB%E5%8A%A8%E4%B8%8E%E5%85%AC%E7%BD%91%E6%9C%8D%E5%8A%A1%E5%99%A8%E5%BB%BA%E7%AB%8B%E8%BF%9E%E6%8E%A5 "聊天软件会主动与公网服务器建立连接")<br />也就是说，两个在内网的客户端登录qq时都会**主动**向公网的聊天服务器建立连接，这时两方的NAT路由器中都会记录有相应的映射关系。当在其中一个qq上发送消息时，数据会先到服务器，再通过服务器转发到另外一个客户端上。反过来也一样，通过这个方式让两台内网的机子进行数据传输。
<a name="pcAXT"></a>
### 两个内网的应用如何直接建立连接
上面的情况，是两个客户端通过**第三方服务器**进行通讯，但有些场景就是要**抛开第三端**，直接进行两端通信，比如P2P下载，这种该怎么办呢？<br />这种情况下，其实也还是离不开第三方服务器的帮助。<br />假设还是A和B两个**局域网内**的机子，A内网对应的NAT设备叫NAT_A，B内网里的NAT设备叫NAT_B，和一个第三方服务器server。<br />流程如下。<br />**step1和2**：A主动去连server，此时A对应的NAT_A就会留下A的内网地址和外网地址的**映射关系**，server也拿到了A对应的外网IP地址和端口。<br />**step3和4**：B的操作和A一样，主动连第三方server，NAT_B内留下B的内网地址和外网地址的**映射关系**，然后server也拿到了B对应的外网IP地址和端口。<br />**step5和step6以及step7**：重点来了。此时server发消息给A，让A主动发UDP消息到B的外网IP地址和端口。此时NAT_B收到这个A的UDP数据包时，这时候**根据NAT_B的设置不同**，导致这时候**有可能**NAT_B能直接转发数据到B，那此时A和B就通了。但也**有可能不通**，直接丢包，不过丢包没关系，这个操作的**目的是**给NAT_A上留下**有关B的映射关系**。<br />**step8和step9以及step10**：跟step5一样熟悉的配方，此时server再发消息给B，让B主动发UDP消息到A的外网IP地址和端口。NAT_B上也留下了关于A到映射关系，这时候由于之前NAT_A上有过关于B的映射关系，此时NAT_A就能正常接受B的数据包，并将其转发给A。到这里A和B就能正常进行数据通信了。这就是所谓的**NAT打洞**。<br />**step11**：注意，之前都是用的**UDP数据包**，目的只是为了在两个局域网的NAT上**打个洞**出来，实际上大部分应用用的都是TCP连接，所以，这时候还需要在A主动向B发起TCP连接。到此，就完成了两端之间的通信。<br />![NAT打洞](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842598-0c4df016-ffa0-4b12-a77a-a0688a37dd7a.png#averageHue=%23dde7e8&clientId=u2e4c34bc-20b4-4&from=paste&id=ued2779f7&originHeight=540&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=u3b50dc4c-c869-41e6-b0f0-e1103c5afcf&title=NAT%E6%89%93%E6%B4%9E "NAT打洞")<br />这里估计大家会有疑惑。
<a name="YXCyI"></a>
#### 端口已经被udp用过了，TCP再用，那岂不是端口重复占用（address already in use）？
其实并不会，端口重复占用的报错**常见于**两个TCP连接在不使用SO_REUSEADDR的情况下，重复使用了某个IP端口。而UDP和TCP之间却不会报这个错。之所以会有这个错，主要是因为在一个linux内核中，内核收到网络数据时，会通过五元组（传输协议，源IP，目的IP，源端口，目的端口）去唯一确定数据接受者。当五元组都一模一样的时候，内核就不知道该把数据发给谁。而UDP和TCP之间"传输协议"不同，因此五元组也不同，所以也就不会有上面的问题。<br />![五元组](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842636-9c40e2c2-47f8-4294-9a61-749e64e0829b.png#averageHue=%23a7c1ce&clientId=u2e4c34bc-20b4-4&from=paste&id=u6417d70e&originHeight=450&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=true&status=done&style=none&taskId=udaabb1f0-e8c4-4344-9407-99bedf96bae&title=%E4%BA%94%E5%85%83%E7%BB%84 "五元组")
<a name="FoMuv"></a>
#### NAPT还分为好多种类型，上面的nat打洞方案，都能成功吗？
关于NAPT，确实还细分为好几种类型，比如完全锥形NAT和限制型NAT啥的，但这并不是本文的重点。所以就略过了。现在常见的都是锥形NAT。上面的打洞方案适用于大部分场景，这其中包括限制最多的**端口受限锥形NAT**。<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1676808842859-c3ad97a4-144f-41e2-8337-099f76be4eb0.png#averageHue=%23d5e2e5&clientId=u2e4c34bc-20b4-4&from=paste&id=u5878248e&originHeight=600&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=false&status=done&style=none&taskId=u894dbc01-debe-4953-bbe4-f278873b9a6&title=)
<a name="QbZw4"></a>
## 总结

- IPV4地址有限，但通过NAT路由器，可以使得整个内网N多台机器，对外只使用一个公网IP，大大节省了IP资源。
- 内网机子**主动**连接公网IP，中间的NAT会将内网机子的内网IP转换为公网IP，从而实现内网和外网的数据交互。
- 普通的NAT技术，只会修改网络包中的发送端和接收端IP地址，当内网设备较多时，将有可能导致冲突。因此一般都会使用NAPT技术，同时修改发送端和接收端的**IP地址和端口**。
- 由于NAT的存在，公网IP是无法访问内网服务的，但通过内网穿透技术，就可以让公网IP访问内网服务。一波操作下来，就可以在公司的网络里访问家里的电脑。

最后留个问题，有了NAT之后，原本并不富裕的IPv4地址突然就变得非常够用了。<br />那为什么还需要IPv6？<br />另外IPv6号称地址多到每粒沙子都能拥有自己的IP地址，那还需要NAT吗？
