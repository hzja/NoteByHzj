刚入门学习java审计，注定要走很多弯路，但希望能坚持下来<br /> <br />这篇文章是基于[panda](https://xz.aliyun.com/u/18248) 师傅的文章来学习的，<br />[https://xz.aliyun.com/t/6872?accounttraceid=80830b9ba7504847b13dec404f34658aspsf](https://xz.aliyun.com/t/6872?accounttraceid=80830b9ba7504847b13dec404f34658aspsf)<br /> <br />首先要把servlet的sql注入项目导入idea，sql 测试源码：<br /> [https://github.com/cn-panda/JavaCodeAudit](https://github.com/cn-panda/JavaCodeAudit)<br /> <br />启动mysql添加数据库和对应的数据，直接把数据库语句复制到sql编译器执行就能完成添加。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602349764-1c08525c-f9e3-45a0-b806-db9ae242cec4.png#align=left&display=inline&height=394&originHeight=788&originWidth=964&status=done&style=none&width=482)<br />然后在Userinfodaoimpl文件中修改本地数据库的账号连接密码。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602350034-63c82c04-9ec0-4dbb-8e20-3e11103132fe.png#align=left&display=inline&height=211&originHeight=414&originWidth=1464&status=done&style=none&width=746)<br />然后根据servlet的javaweb搭建思路导入sql注入测试的源码即可。<br />数据库文件和servlet项目导入配置好后，就可以来进行的简单java审计的学习了。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602350332-aabaa1e9-ccdc-4f75-aaeb-bafcb57c0f6e.png#align=left&display=inline&height=221&originHeight=321&originWidth=1086&status=done&style=none&width=746)

<a name="kaQ0f"></a>
## 敏感函数追踪+工具配合 
 <br />1.利用fortify工具对sql注入测试源码进行扫描，发现提示Userinfodaoimpl代码中的24行有注入。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602350566-6fe5deac-a786-43a9-b50b-9cb6b64b6318.png#align=left&display=inline&height=511&originHeight=974&originWidth=1422&status=done&style=none&width=746)<br />2.我可以看到24行代码中的sql是一条数据库查询语句，如果id没有进行过滤，那么就可能存在注入，<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602350846-5efabd4b-f1e3-469a-ab25-ab342090ae5c.png#align=left&display=inline&height=400&originHeight=599&originWidth=1062&status=done&style=none&width=709)<br />String sql = **"select **_*_** from userinfo where id = " **+ id;这条语句中的id主要是是Userinfofounddao()方法中的参数，这个方法是在userInfoDaoImpl这个类里边，所以我要去查这个userInfoDaoImpl类在哪被用过，idea功能里边，ctrl+b就能查询类被谁使用过。可以看到，这个类在userinfoserviceimpl中的15行被new过，继续往下跟踪。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602351097-a6f2686b-f8df-4c1d-be03-acbde59d82dc.png#align=left&display=inline&height=110&originHeight=154&originWidth=1045&status=done&style=none&width=746)<br />跳到userinfoserviceimpl.java这个文件后 可以看到UserInfoDao  ui = new UserInfoDaoImpl(); 这是一个多态语句，Userinfodaoimpl()在这里被使用了，并且这里定义了userinfofoundservice方法用来返回参数，所以我要继续看Userinfoserviceimpl在哪被引用了<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602351372-2c506dc8-8e4e-4465-b00f-b42bbfb576e8.png#align=left&display=inline&height=405&originHeight=540&originWidth=709&status=done&style=none&width=532)<br />对该类进行跟踪，发现在infoServlet.java<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602351628-1de9a361-69c4-4752-9d19-1f169851c599.png#align=left&display=inline&height=113&originHeight=155&originWidth=1020&status=done&style=none&width=746)<br />跳转到infoservlet.java文件后发现这是个servlet定义get和post方法的文件<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602351886-39f8a4e9-dc12-4cf9-b8b8-aef4b5200170.png#align=left&display=inline&height=440&originHeight=839&originWidth=1423&status=done&style=none&width=746)<br />然后根据servlet输入流的过程，进行payload的构造，看看这个InfoServlet.java文件在web.xml中的目录映射关系，对位到/info目录，漏洞是因为id参数get请求拼接到数据库语句中，payload 127.0.0.1/tomcat中javaweb映射的地址/info?id=1 and 1=2 union select 1,2,3,4,database()<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602352132-21da084e-21ca-4dfc-b7d7-68c20a1d4205.png#align=left&display=inline&height=329&originHeight=518&originWidth=1173&status=done&style=none&width=746)![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602352455-8836cd90-d066-48fe-97d0-ab2adbe46034.png#align=left&display=inline&height=365&originHeight=487&originWidth=783&status=done&style=none&width=587)![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612602352654-63cdc3ec-3c57-46f2-8688-7216e4c2c0ff.png#align=left&display=inline&height=207&originHeight=276&originWidth=942&status=done&style=none&width=707)
<a name="yDrQ4"></a>
## Debug调试审计
idea的调试技巧
> F7是会进入当前方法体进行调试
> F8是进入下一步，不会进入方法
> F9跳入下一个断点调试。
> alt+Shift+F7 ， 进入下一步，如果当前断点是一个方法，方法还有方法则循环进入
> 当你f7跟进函数，发现它不是你要找的，你可以用shift+f8跳出这个方法回到上一层继续找
> 2.如果想恢复Ctrl+z 掉的内容，快捷键为：Ctrl + Shift + Z


在传参id处打下断点，并以debug的形式运行tomcat<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612760744454-14656558-a2e1-4e0a-a3a7-497d4a22fe40.png#align=left&display=inline&height=287&originHeight=573&originWidth=1204&size=43959&status=done&style=none&width=602)<br />传入参数，并在idea中进行调试<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612760946626-009e9643-cbc4-4f87-a4cd-db7a5fa687b3.png#align=left&display=inline&height=189&originHeight=252&originWidth=843&size=12114&status=done&style=none&width=632)<br />调试可以发现，id在前端接收参数后会传入uif中的UserInfoFoundService方法<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612761239134-3394bea3-390b-456e-bb9e-50c7a3776d50.png#align=left&display=inline&height=282&originHeight=376&originWidth=1170&size=34507&status=done&style=none&width=878)<br />使用F7进入方法体，会来到UserInfoServiceImpl类中实现UserinfoService接口的方法，这个方法中接收前端id的值然后返回给UserInfoDaoImpl

![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612761690458-fe06ed70-8fa8-4f9e-bead-c70171a5af50.png#align=left&display=inline&height=210&originHeight=420&originWidth=957&size=22487&status=done&style=none&width=478.5)<br />继续跟进方法体，跳入了UserinfoDaoImpl，这里就可以看到SQL的接入语句了，是完全没有过滤就接入数据库的。至此，审计结束。<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1612763069673-eb5b68ee-ac59-48ef-8686-b04fa056bfeb.png#align=left&display=inline&height=235&originHeight=469&originWidth=1016&size=32421&status=done&style=none&width=508)

