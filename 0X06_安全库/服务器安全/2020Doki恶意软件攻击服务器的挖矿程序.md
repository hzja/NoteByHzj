[网络安全研究员发现的记录](https://thehackernews.com/2020/07/docker-linux-malware.html)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596725011511-c5abb847-de51-40d7-9311-16486f82224c.png#align=left&display=inline&height=481&originHeight=1444&originWidth=2760&size=1718866&status=done&style=shadow&width=920)<br />本人遭受攻击的就是阿里云服务器，部署的Docker后遭受攻击
<a name="K9KWj"></a>
# 1、检测CPU的使用情况
<a name="7ZAB4"></a>
## A.使用TOP命令未检测出
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596725145853-f23bb599-befe-48d1-9e79-5aaaf9c8c612.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2104606&status=done&style=none&width=1107.6666666666667)
<a name="Iix2V"></a>
## B.使用htop命令检测
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596725188272-8d34a090-7dbb-41de-bce6-a35d9f0e9aec.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2184903&status=done&style=none&width=1107.6666666666667)<br />可以看到CPU已经百分之百
<a name="19XNo"></a>
## C.使用busybox检测
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596725323683-122e9645-db7d-47e7-b9bd-504d325807c8.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2282061&status=done&style=none&width=1107.6666666666667)
<a name="CAPL7"></a>
# 2、Docker镜像查看
<a name="uPs6n"></a>
## A.使用lazydocker查看镜像和容器
发现多了三个容器和镜像，这三个镜像以及容器非个人下载<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596763141251-ab6a230d-3be2-4ef2-b21a-edc36be572e5.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2140393&status=done&style=none&width=1107.6666666666667)
<a name="gENHr"></a>
## B.使用ctop查看到占CPU高的异常容器
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596763268407-ba801035-6283-4c0d-ba87-983ad8af7bd7.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=1868079&status=done&style=none&width=1107.6666666666667)
<a name="BQ5hB"></a>
# 3、kill掉占CPU高的进程，删除异常镜像，关闭Docker的客户端访问
<a name="hw0N9"></a>
## A.kill掉占CPU高的进程
```bash
Mem: 1749136K used, 134588K free, 45284K shrd, 12408K buff, 263384K cached
CPU:  65% usr   0% sys  33% nic   0% idle   0% io   0% irq   0% sirq
Load average: 2.50 2.86 2.89 7/4464399 25946
  PID  PPID USER     STAT   VSZ %VSZ CPU %CPU COMMAND
 8718  8673 root     S     707m  38%   0  65% /xmrig -c /config.json
 8541     1 root     SN    734m  40%   0  33% /usr/sbin/cpumon -c /usr/cpu -t 1
17312     1 root     S<    121m   7%   0   0% /usr/local/aegis/aegis_client/aegis_10_83/AliYunDun
17274     1 root     S<   32720   2%   0   0% /usr/local/aegis/aegis_update/AliYunDunUpdate
30355 30338 admin    S    2968m 161%   0   0% /usr/local/openjdk-11/bin/java -Dzookeeper.log.dir=/logs -Dzookeeper.log.f
31137 31100 admin    S    2460m 133%   0   0% java -jar /usr/share/jenkins/jenkins.war
25073 24905 mysql    S    1340m  73%   0   0% /local/mysql/mysql8.0/mysql-8.0.11-linux-glibc2.12-x86_64/bin/mysqld --bas
28737     1 root     S     732m  40%   0   0% /usr/bin/dockerd-current -H tcp://0.0.0.0:2375 -H unix://var/run/docker.so
  743     1 root     S     540m  29%   0   0% {tuned} /usr/bin/python -Es /usr/sbin/tuned -l -P
  444     1 polkitd  S     515m  28%   0   0% /usr/lib/polkit-1/polkitd --no-debug
10814     1 root     S<    426m  23%   0   0% /usr/local/aegis/AliSecGuard/AliSecGuard
28742 28737 root     S     329m  18%   0   0% /usr/bin/docker-containerd-current -l unix:///var/run/docker/libcontainerd
 8618 28742 root     S     266m  14%   0   0% /usr/bin/docker-containerd-shim-current e0233104442d1508f9c000a7d5dab75fca
31045 28742 root     S     266m  14%   0   0% /usr/bin/docker-containerd-shim-current ad0ed7c845f7e82f731bb21c46bfe33112
30338 28742 root     S     266m  14%   0   0% /usr/bin/docker-containerd-shim-current 6c06b127e03a0b14d6ef374570169d3ded
15329 28742 root     S     258m  14%   0   0% /usr/bin/docker-containerd-shim-current ca73cd30f8af1b5cfa0ecf78648f8766ce
  738     1 root     S     254m  14%   0   0% /usr/sbin/rsyslogd -n
    1     0 root     SN    186m  10%   0   0% /usr/lib/systemd/systemd --system --deserialize 20
12453  9878 root     S     174m   9%   0   0% {crond} /usr/sbin/CROND -n
20800  2171 root     S     145m   8%   0   0% sshd: root@pts/1
 9878     1 root     S     123m   7%   0   0% /usr/sbin/crond -n
24691     1 root     S     119m   6%   0   0% /usr/sbin/lvmetad -f
20802 20800 root     S     112m   6%   0   0% -bash
24905     1 root     S     112m   6%   0   0% {mysqld_safe} /bin/sh /local/mysql/mysql8.0/mysql-8.0.11-linux-glibc2.12-x
15486     1 root     S     110m   6%   0   0% /sbin/dhclient -H iZuligp6e1dyzfZ -1 -q -lf /var/lib/dhclient/dhclient--et
  485     1 root     S     107m   6%   0   0% /sbin/agetty --noclear tty1 linux
[root@iZuligp6e1dyzfZ tools-software]# kill -9 8718
[root@iZuligp6e1dyzfZ tools-software]# kill -9 8541
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596763436622-12b45e6c-a9fe-4c82-9763-e0e639d27146.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2270733&status=done&style=none&width=1107.6666666666667)
<a name="UTVWW"></a>
## B.删除异常镜像
```bash
[root@iZuligp6e1dyzfZ tools-software]# docker ps -a
CONTAINER ID        IMAGE                  COMMAND                  CREATED             STATUS                    PORTS                                                            NAMES
ca73cd30f8af        ubuntu:18.04           "/bin/bash"              12 hours ago        Up 12 hours
                                                           zealous_agelast
2729cd78b2a6        widoc26117/cpuinfo:1   "/start.sh"              23 hours ago        Exited (0) 23 hours ago
                                                           cpuinfo
e0233104442d        widoc26117/xmr:pro06   "/bin/sh -c /docke..."   23 hours ago        Up 2 minutes
                                                           xmr
ad0ed7c845f7        cd14cecfdb3a           "/bin/tini -- /usr..."   2 days ago          Up 2 days                 8080/tcp, 50000/tcp, 0.0.0.0:8081->8081/tcp                      jenkins01
6c06b127e03a        7341c5373a13           "/docker-entrypoin..."   2 days ago          Up 2 days                 2181/tcp, 2888/tcp, 3888/tcp, 0.0.0.0:2180->2180/tcp, 8080/tcp   zk01
[root@iZuligp6e1dyzfZ tools-software]# docker stop ca73cd30f8af
ca73cd30f8af
[root@iZuligp6e1dyzfZ tools-software]# docker rm ca73cd30f8af
ca73cd30f8af
[root@iZuligp6e1dyzfZ tools-software]# docker stop xmr
xmr
[root@iZuligp6e1dyzfZ tools-software]# docker rm xmr
xmr
[root@iZuligp6e1dyzfZ tools-software]# docker rm cpuinfo
cpuinfo
[root@iZuligp6e1dyzfZ tools-software]# docker images
REPOSITORY                     TAG                 IMAGE ID            CREATED             SIZE
docker.io/zookeeper            latest              7341c5373a13        8 days ago          252 MB
docker.io/ubuntu               18.04               2eb2d388e1a2        13 days ago         64.2 MB
docker.io/mysql                latest              e3fcc9e1cc04        2 weeks ago         544 MB
docker.io/widoc26117/xmr       pro06               fd1815ba61bf        3 weeks ago         13.4 MB
docker.io/widoc26117/cpuinfo   1                   1fbcc6b19220        2 months ago        5.61 MB
docker.io/jenkins              latest              cd14cecfdb3a        2 years ago         696 MB
[root@iZuligp6e1dyzfZ tools-software]# docker rmi 2eb2d388e1a2
Untagged: docker.io/ubuntu:18.04
Untagged: docker.io/ubuntu@sha256:a61728f6128fb4a7a20efaa7597607ed6e69973ee9b9123e3b4fd28b7bba100b
Deleted: sha256:2eb2d388e1a255c98029f40d6d7f8029fb13f1030abc8f11ccacbca686a8dc12
Deleted: sha256:48ba0c6fdf4b069aad7a1eb6299dee017ef75b929a87ed63bc9226dee2cd50e8
Deleted: sha256:4d5330c8d5056fdfb6f2e32b225452de71517794a80e3ef998440e184d2e80cb
Deleted: sha256:3a9fa6b9e7ae21b704ed61109b612970f2b21449cd53e3154ed8800e2aefee0d
Deleted: sha256:7ef3687765828a9cb2645925f27febbac21a5adece69e8437c26184a897b6ec7
[root@iZuligp6e1dyzfZ tools-software]# docker rmi fd1815ba61bf
Untagged: docker.io/widoc26117/xmr:pro06
Untagged: docker.io/widoc26117/xmr@sha256:cda35615c1b38afd687e3a2794d27a1dd03d917dee6e7a8defe30be9c12fb21f
Deleted: sha256:fd1815ba61bfb6572b2233a206d6863583ff6437e5bc618f6a2bc9e910285be7
Deleted: sha256:8bc999d654c01f07f99a13505ae6e4b356cdbf97455a4898f3d58aa5848b2d25
Deleted: sha256:602f21850132ef25789f9680f34a411d49c6cd359b6d311e781123f6de7d8e93
Deleted: sha256:269333f4cef02c051c8cf0a8716acd1df391d14a09bb5d34b88b5bf638977529
[root@iZuligp6e1dyzfZ tools-software]# docker rmi 1fbcc6b19220
Untagged: docker.io/widoc26117/cpuinfo:1
Untagged: docker.io/widoc26117/cpuinfo@sha256:2ee433a91fead6baecc67cbf0956e827eedbc0b225baceb046a41ddee0531cbb
Deleted: sha256:1fbcc6b1922031b1dae71badda9936e3bf0cdcf5686703fe9a6521c5129f4abc
Deleted: sha256:a9307a6c81a72b6cf39d360a6cfcf482a47ffd3c6f714cfe65a3a15075682841
Deleted: sha256:3e207b409db364b595ba862cdc12be96dcdad8e36c59a03b7b3b61c946a5741a
[root@iZuligp6e1dyzfZ tools-software]# docker images
REPOSITORY            TAG                 IMAGE ID            CREATED             SIZE
docker.io/zookeeper   latest              7341c5373a13        8 days ago          252 MB
docker.io/mysql       latest              e3fcc9e1cc04        2 weeks ago         544 MB
docker.io/jenkins     latest              cd14cecfdb3a        2 years ago         696 MB
[root@iZuligp6e1dyzfZ tools-software]#
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596763722748-7c1431b3-4910-4971-b129-344a45f48b53.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2191396&status=done&style=none&width=1107.6666666666667)
<a name="gKloU"></a>
## C.关闭Docker的客户端访问
参考客户端开放访问的配置<br />[语雀内容](https://www.yuque.com/fcant/operation/zek7g8?view=doc_embed)
<a name="s123T"></a>
### ①编辑配置文件
```bash
[root@iZuligp6e1dyzfZ /]# vim /usr/lib/systemd/system/docker.service
```
<a name="hb5SM"></a>
### ②删除客户端访问配置
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1596763929899-a03e5e39-dc0f-4740-9b51-c70f8ec18065.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2121331&status=done&style=none&width=1107.6666666666667)
<a name="Dnx2d"></a>
### ③保存后退出
<a name="Hl9mV"></a>
## D.重新加载配置、重启Docker服务
```bash
[root@iZuligp6e1dyzfZ /]# systemctl daemon-reload
[root@iZuligp6e1dyzfZ /]# systemctl restart docker
```

