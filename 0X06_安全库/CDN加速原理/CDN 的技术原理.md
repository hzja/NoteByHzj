CDN
<a name="Xujn0"></a>
## 浏览器的网络请求
要理解 CDN 这件事情，就得先理解浏览器发出一个请求的过程是怎样的，其整体过程如下图所示。<br />![](https://cdn.nlark.com/yuque/0/2022/jpeg/396745/1659507685425-a1ceb2e2-4fb9-4c02-a8b0-caf647f0aaf0.jpeg)<br />浏览器网络请求过程

1. **用户在浏览器中输入要访问的网址域名。**
2. **浏览器向本地 DNS 服务器请求对域名的解析。**
3. **如果本地 DNS 服务器有域名的解析结果，那么直接响应用户请求，返回该域名对应的 IP 地址。**
4. **如果本地 DNS 服务器没有域名的解析结果，那么则会递归地向 DNS 系统请求解析，随后将该结果返回给用户。**
5. **浏览器得到域名解析结果后，其实也就是域名对应的 IP 地址。**
6. **随后浏览器向服务器请求内容。**
7. **服务器将用户请求内容返回给浏览器。**

通过这么复杂的步骤，用户就可以看到页面内容了。但实际上，在第 6、7 这两步的时候，其中间也经过了非常复杂的过程。为了更清晰地表述，可以将这个过程分为 3 个主要节点，如下图所示。<br />![](https://cdn.nlark.com/yuque/0/2022/jpeg/396745/1659507850739-dafe9d07-424b-42f3-b46f-2baf7a06d298.jpeg)<br />服务器数据传输过程<br />网站服务器通过公网出口，再通过长途骨干网，最后通过用户的宽带广猫到达用户所在的局域网，最终才到达用户电脑的浏览器。<br />**其中长途骨干网的传输是最为耗时的，它需要经过网站服务器所在的机房、骨干网、用户所在城域网、用户所在接入网等，其物理传输距离非常遥远。** <br />在这种情况下，如果传输的数据非常多，访问的用户特别大，那么就会出现很长的延时，影响用户体验。同时，每请求一次数据都需要经过漫长的数据传输，对于长途骨干网来说，都是一次负担。<br />刚刚说的这个场景，很形象的一个例子是春节抢票的场景。当春节抢票时，都会登陆 12306 网站，网站上肯定有不少图片资源。这时候可能同时会有 1 个亿的人，同时去请求一张一模一样的图片。<br />这时候如果都按照上面的过程去请求一次图片数据，那么将会产生 1 亿次的网络数据传输，这对于整个国家的互联网基础设施是个灾难啊！<br />但事实情况是：12306 貌似也没有挂掉呀！<br />那么他们是如何解决这个问题呢？**答案就是：CDN！**
<a name="DFfZx"></a>
## 什么是 CDN ？
其实 CDN 就是内容分发网络的意思，其英文全称为 Content Delivery Network。**简单地说，CDN 可以提前把数据存在离用户最近的数据节点，从而避免长途跋涉经过长途骨干网，最终达到减少骨干网负担、提高访问速度的目的。** <br />按照上面的场景，如果没有 CDN 的话，每次请求都需要从网站服务器经过公网出口、长途骨干网、用户接入局域网，最终到达浏览器。但是当有了 CDN 之后，可能就变成了下面这样：<br />![](https://cdn.nlark.com/yuque/0/2022/jpeg/396745/1659507943122-bbaabd6d-ebbd-4af6-a930-1d72b7a276ac.jpeg)<br />CDN 缓存服务器<br />浏览器请求图片数据时，会先去 CDN 缓存服务器获取。如果获取到数据，那么就直接返回。否则才会经过长途骨干网，最终到达网站服务器获取图片数据。那么只要提前在 CDN 缓存服务器上传图片，那么就可以极大地减少网络流量，同时减少网络延迟。<br />从上图可能会觉得：这不就是在长途骨干网和用户局域网中间，加了一个服务器嘛。但事实上可并不是这样，CDN 其实还缩短了请求数据的距离。<br />知道用户所处的位置可能是全国各地，为了尽可能地减少网络传输的延时，一般都会在离用户较近的地方设置 CDN 缓存服务器，例如：在华南、华北、华东、西南设置一个主 CDN 服务器，这样各个地区的用户就可以直接请求对应的 CDN 服务器，而不需要来回跑大半个中国，极大地提高了效率！<br />**因此，当说内容分发网络的时候，脑海里应该有如下这样一张图片：遍布全国各地的 CDN 缓存服务器，组成了内容分发网络。每次用户请求都会到离他最近的 CDN 服务器请求数据，从而极大地提高访问速度。**
<a name="FFHVA"></a>
## CDN 工作原理
到了这里，相信大家都知道 CDN 是什么了。但实际上 CDN 是如何与 DNS 结合起来的，这里面还是有点复杂的。加入了 CDN 之后，浏览器的网络请求就变成如下图所示的情况。<br />![](https://cdn.nlark.com/yuque/0/2022/jpeg/396745/1659509449864-b7de5f10-bfb7-4389-86bf-8fd69350077c.jpeg)<br />CDN 基本工作过程

1. **浏览器发起图片 URL 请求，经过本地 DNS 解析，会将域名解析权交给域名 CNAME 指向的 CDN 专用 DNS 服务器。**
2. **CDN 的 DNS 服务器将 CDN 的全局负载均衡设备 IP 地址返回给浏览器。**
3. **浏览器向 CDN 全局负载均衡设备发起 URL 请求。**
4. **CDN 全局负载均衡设备根据用户 IP 地址，以及用户请求的 URL，选择一台用户所属区域的区域负载均衡设备，向其发起请求。**
5. **区域负载均衡设备会为用户选择最合适的 CDN 缓存服务器（考虑的依据包括：服务器负载情况，距离用户的距离等），并返回给全局负载均衡设备。**
6. **全局负载均衡设备将选中的 CDN 缓存服务器 IP 地址返回给用户。**
7. **用户向 CDN 缓存服务器发起请求，缓存服务器响应用户请求，最终将用户所需要偶的内容返回给浏览器。**

使用 CDN 服务的网站，只需要将域名解析权交给 CDN 服务商，接着将需要分发的内容上传到 CDN，就可以实现内容加速了！
<a name="Ok1C8"></a>
## 总结
这么看下来，其实 CDN 内容分发网络，本质上就是一大堆遍布在全球各个角落的缓存服务器。通过与 DNS 的配合，找到最靠近用户的一台 CDN 缓存服务器，然后把数据快速地分发给用户。<br />通过 CDN 技术，不仅减少了对于整体骨干网的流量负担，还提高了用户的体验，真是一举两得啊！
