<a name="skZn0"></a>
## ![文件上传漏洞绕过.png](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588429291534-2b2951a5-e7d0-4f98-9bf3-f2caf1115449.png#align=left&display=inline&height=377&originHeight=1815&originWidth=3591&size=528189&status=done&style=none&width=746)
<a name="H8Vl6"></a>
## 语言可解析的后缀
（前提：在Apache httpd.conf 配置文件中有特殊语言的配置<br />AddHandler application/x-httpd-php .php<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428128397-f7b937c2-a135-41e6-ac51-93aebf3fd17b.png#align=left&display=inline&height=156&originHeight=179&originWidth=855&status=done&style=none&width=746)<br />搭配大小写、双重、空格来进行<br />其中：<br />phtml、pht、php3、php4和php5都是Apache和php认可的php程序的文件后缀<br /> 
<a name="2EiIC"></a>
## 常见的MIME类型
** **<br />　　**超文本标记语言文本 .html,.html text/html**<br />**　　普通文本 .txt text/plain**<br />**　　RTF文本 .rtf application/rtf**<br />**　　GIF图形 .gif image/gif**<br />**　　JPEG图形 .jpeg,.jpg image/jpeg**<br />**　　au声音文件 .au audio/basic**<br />**　　MIDI音乐文件 mid,.midi audio/midi,audio/x-midi**<br />**　　RealAudio音乐文件 .ra, .ram audio/x-pn-realaudio**<br />**　　MPEG文件 .mpg,.mpeg video/mpeg**<br />**　　AVI文件 .avi video/x-msvideo**<br />**　　GZIP文件 .gz application/x-gzip**<br />**TAR文件 .tar application/x-tar**<br /> 
<a name="lntoK"></a>
## windows特性
Windows下文件名不区分大小写，Linux下文件名区分大写欧西；<br />Windows下ADS流特性，导致上传文件xxx.php::$DATA = xxx.php；<br />Windows下文件名结尾加入.,空格,<,·>,>>>,0x81-0xff等字符，最终生成的文件均被windows忽略。<br /> 
<a name="x2DQb"></a>
## 00截断
0x00截断是将上传文件名或路径名中使用ascll码值为0的字符（也就是null）来进行截断，%00一般用在URL中用于截断url来进行文件包含，两者原理都一样，都是ascll为0的字符，只是形式不同<br />** **<br />使用%00截断，需要两个条件<br />（1）php版本小于5.3.4（2）php的magic_quotes_gpc为OFF状态<br />例如：1.asp%00.jpg<br /> <br /> <br /> <br />post型：post不会像get对%00进行自动解码，所以先添加一个+号，<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428128509-290929c7-fec3-4b06-a6a9-47b323819010.png#align=left&display=inline&height=140&originHeight=140&originWidth=557&status=done&style=none&width=557)<br />然后找到2b<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428128644-abdc4e75-1069-4d57-b89b-ae8cee11eed7.png#align=left&display=inline&height=122&originHeight=122&originWidth=580&status=done&style=none&width=580)<br /> <br /> <br /> <br />使用0x00截断<br />先在文件尾添加一个空格，点开hex，将其对应的20改成00即可，就可以绕过后缀名的过滤<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428128948-c2d91ad8-3746-414c-9b3f-99bdf2aac519.png#align=left&display=inline&height=299&originHeight=299&originWidth=471&status=done&style=none&width=471)<br />** **
<a name="gChZo"></a>
## 文件头检查
改后缀为php上传，还是失败<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129071-0b666b22-f94a-4f75-82af-f6dd6bacf884.png#align=left&display=inline&height=351&originHeight=351&originWidth=508&status=done&style=none&width=508)<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129183-4a35ddc0-60eb-4386-804c-6cd325df7b61.png#align=left&display=inline&height=168&originHeight=168&originWidth=284&status=done&style=none&width=284)<br />合成图片马，再修改后缀php再上传<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129307-61a1e847-6b12-4e07-aeed-4e886c9add96.png#align=left&display=inline&height=349&originHeight=465&originWidth=994&status=done&style=none&width=746)<br />** **<br />如果是检测gif的话，可以在内容前添加GIF89a，例如<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129457-902c91c8-6151-4567-8c98-b6d66ff2ec27.png#align=left&display=inline&height=223&originHeight=316&originWidth=1057&status=done&style=none&width=746)<br /> 
<a name="RxpM5"></a>
## 二次渲染
上传的图片会被修改部分内容，此时要对比未上传和已上传的图片对比出没有被修改的部分，在未修改的部分插入一句马子<br /> <br />例如上传前，把马子插入gif图片的底部<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129592-d782d8b7-1b0c-4f90-9b1b-da55d6be96eb.png#align=left&display=inline&height=211&originHeight=211&originWidth=696&status=done&style=none&width=696)<br />上传后，发现马子不见了<br />需要找到渲染前后没有变化的位置,然后将php代码写进去 例如：<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129727-74038467-b3cd-44b8-bccd-2a556b09cb20.png#align=left&display=inline&height=238&originHeight=238&originWidth=678&status=done&style=none&width=678)
<a name="zwLmz"></a>
## .htaccess绕过
.htaccess(apache的配置文件，可以帮我们实现：网页301重定向、自定义404错误页面、改变文件扩展名、允许/阻止特定的用户或者目录的访问、禁止目录列表、配置默认文档等功能。)<br /> <br />前提是：httpd.conf，启用AllowOverride（将该值改为all）<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129860-266fbe55-dcfc-465c-9e4c-46b520dc9b90.png#align=left&display=inline&height=184&originHeight=184&originWidth=472&status=done&style=none&width=472)
```
<Directory />
    Options FollowSymLinks
    AllowOverride All
    AddType application/x-httpd-php .jpg	#将.jpg后缀的文件作为PHP文件解析
</Directory>
```
上传一个.htaccess内容如下的文件<br /><FilesMatch "2.jpg"><br />SetHandler application/x-httpd-php<br /></FilesMatch><br />.htaccess文件的内容的意思是 对2.jpg使用php重新解析<br /> <br />如果只是单纯如下语句，它会把所有上传文件当成php来解析<br />SetHandler application/x-httpd-php
```
<Directory />
    Options FollowSymLinks
    AllowOverride All
    AddType application/x-httpd-php 	#将.jpg后缀的文件作为PHP文件解析
</Directory>
```

<a name="GXg65"></a>
## Apache解析漏洞
**一：**<br />其2.4.0~2.4.29版本中存在一个解析漏洞，在解析PHP时，1.php\x0A将被按照PHP后缀进行解析，导致绕过<br />例如：<br />正常上传.php文件上传不成功，burp抓包后发送到Repeater然后hex在置右键-Insert byte，在0d、0a前加一个0a，然后send，即可绕过上传<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428129982-24190162-decf-47fd-b879-2c82141c8087.png#align=left&display=inline&height=89&originHeight=89&originWidth=501&status=done&style=none&width=501)<br />在页面访问[http://192.168.0.99:8080/feng.php%0a](http://192.168.0.99:8080/feng.php%0a)<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428130103-be1c0f8c-c7b6-449d-b061-a1f639bf1ec0.png#align=left&display=inline&height=228&originHeight=228&originWidth=529&status=done&style=none&width=529)<br /> <br />**二：**<br />Apache多后缀解析<br />**如果运维人员给.php后缀增加了处理器：**<br />AddHandler application/x-httpd-php .php<br />那么，在有多个后缀的情况下，只要一个文件含有.php后缀的文件即将被识别成PHP文件，没必要是最后一个后缀。利用这个特性，将会造成一个可以绕过上传白名单的解析漏洞。<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588428130272-ae782453-ce30-4bc7-aad0-564111d75844.png#align=left&display=inline&height=268&originHeight=268&originWidth=529&status=done&style=none&width=529)<br />**三**<br />**影响版本Apache 1.x和Apache 2.x**<br />Apache在解析文件时有一个原则：当碰到不认识的扩展名时，将会从后面向前解析，直到碰到认识的扩展名为止。<br />例如feng.php.QWE.ABC<br />Apache在处理时，先读取最后一个后缀，为ABC不认识，继续往左读取QWE不认识，读到php能识别这个后缀，于是就把feng.php.QWE.ABC当成是feng.php文件来解析，若是所有后缀都看完了没有一个认识怎么办？此时就会把该文件当做默认类型进行处理了，一般来说，默认类型是text/plain。<br />** **<br />phtml、pht、php3、php4和php5都是Apache和php认可的php程序的文件后缀<br />** **
<a name="CEcBM"></a>
## IIS 解析漏洞
**    目录解析**<br />/xx.asp/xx.jpg<br />若文件夹的名字后缀为 .asp、.asa，其目录内的任何扩展名的文件都被IIS当作asp文件来解析并执行。<br />例如创建目录 abc.asp，那么<br />/abc.asp/1.jpg<br />1.jpg将被当作1.asp文件来执行。不管你上传后你的图片改不改名都能拿shell了。<br /> <br />**    文件解析**<br />在IIS6.0下，分号后面的不被解析，例如<br />abc.asp;.jpg<br />会被服务器看成是abc.asp<br />原理大抵是IIS 5.x/6.0在从文件路径中读取文件后缀时，遇到一个“.”后，便进入了一种截断状态，在该状态下遇到特殊符号 “/”和“;”，都会进行截断，只保留特殊符号前的部分，即“.asp”，从而认为文件后缀为“.asp”。<br /> <br />**    默认解析**<br />IIS6.0 默认的可执行文件除了asp还包含这三种默认解析：/xx.asa /xx.cer /xx.cdx<br />原因：由于在 IIS 默认配置中，这几个后缀默认由 asp.dll 来解析，所以执行权限和 .asp 一摸一样，你可在配置中自行删除该后缀，以防止安全隐患<br />此处可联系利用目录解析漏洞 /xx.asa/xx.jpg 或 /xx.cer/xx.jpg 或 xx.asa;.jpg<br /> <br />    **IIS 7.0/IIS 7.5/ Nginx <8.03****畸形解析漏洞**<br />前提：默认Fast-CGI开启状况下，在一个文件路径(/xx.jpg)后面加上/xx.php会将<br />/xx.jpg/xx.php 解析为 php 文件。<br />在某些使用有漏洞的网站中，访问[http://xxx.xxx.xxx/1.jpg/1.php](http://xxx.xxx.xxx/1.jpg/1.php)，此时的1.jpg会被当作PHP脚本来解析,但是1.php是不存在的。<br /> <br />这就意味着攻击者可以上传合法的“图片”（图片木马）然后在URL后面加上“/1.php”，就可以获得网站的WebShell，菜刀连接：[http://xxx.xxx.xxx/1.jpg/1.php](http://xxx.xxx.xxx/1.jpg/1.php)<br />** **
<a name="ySlqg"></a>
##  java的空字节截断

\u0000.jpg
