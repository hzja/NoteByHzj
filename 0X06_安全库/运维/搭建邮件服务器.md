实验环境centos7.8 ip地址10.4.7.11 邮件服务器的域名域名是mail.linuxprobe.com
<a name="hNEUc"></a>
# 一、dns域名配置部分
<a name="857121d2"></a>
## 1、安装软件
```c
[root@postfix ~]# yum install -y bind
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.aliyun.com
 * centos-gluster7: mirrors.aliyun.com
 * extras: mirrors.aliyun.com
 * updates: mirrors.aliyun.com
Package 32:bind-9.11.4-16.P2.el7_8.6.x86_64 already installed and latest version
Nothing to do
[root@postfix ~]#
```
<a name="GE6zt"></a>
## 2、修改配置文件
```c
[root@postfix ~]# grep -A 12 "options" /etc/named.conf
options {
        listen-on port 53 { any; };			#修改为any
        listen-on-v6 port 53 { ::1; };
        directory       "/var/named";
        dump-file       "/var/named/data/cache_dump.db";
        statistics-file "/var/named/data/named_stats.txt";
        memstatistics-file "/var/named/data/named_mem_stats.txt";
        recursing-file  "/var/named/data/named.recursing";
        secroots-file   "/var/named/data/named.secroots";
        allow-query     { any; };			#修改为any
		forwarders      { 10.4.7.254; };
        /*
         - If you are building an AUTHORITATIVE DNS server, do NOT enable recursion.
[root@postfix ~]#
```

<a name="6Y96O"></a>
## 3、创建区域解析文件
```c
[root@postfix ~]# tail -8 /etc/named.rfc1912.zones
zone "linuxprobe.com" IN {
        type master;
        file "linuxprobe.com.zone";
        allow-update { none; };
};
[root@postfix ~]# cat /var/named/linuxprobe.com.zone
$TTL 1D
@       IN SOA  linuxprobe.com. root.linuxprobe.com. (
                                0       ; serial
                                1D      ; refresh
                                1H      ; retry
                                1W      ; expire
                                3H )    ; minimum
        NS      ns.linuxprobe.com.
ns      IN A            10.4.7.11
@       IN MX 10        mail.linuxprobe.com.
mail    IN A            10.4.7.11
[root@postfix ~]# systemctl restart named
[root@postfix ~]# systemctl restart named
[root@postfix ~]# systemctl stop firewall.service
Failed to stop firewall.service: Unit firewall.service not loaded.
[root@postfix ~]# setenforce 0
[root@postfix ~]# systemctl restart named
```
```bash
[root@centos ~]# tail -6  /etc/named.rfc1912.zones
zone "1.1.10.in-addr.arpa" IN {
        type master;
        file "oldjiang.loopback";
        allow-update { none; };
};
[root@centos ~]# cat /var/named/oldjiang.loopback
$TTL 1D
@       IN SOA  oldjiang.com.  admin.oldjiang.com. (
                                        20216301      ; serial
                                        1D            ; refresh
                                        1H            ; retry
                                        1W            ; expire
                                       3H )          ; minimum
        NS      oldjiang.com.
ns       A       10.1.1.6
4       IN  PTR     www.oldjiang.com.
6       IN  PTR     dns.oldjiang.com.

```
<a name="CHlpr"></a>
## 4、编辑网络设置
```c
[root@postfix ~]# nmcli device show eno16777984
GENERAL.DEVICE:                         eno16777984
GENERAL.TYPE:                           ethernet
    GENERAL.HWADDR:                         00:0C:29:47:E2:A6
GENERAL.MTU:                            1500
GENERAL.STATE:                          100 (connected)
GENERAL.CONNECTION:                     eno16777984
GENERAL.CON-PATH:                       /org/freedesktop/NetworkManager/ActiveConnection/8
WIRED-PROPERTIES.CARRIER:               on
IP4.ADDRESS[1]:                         10.4.7.11/24
IP4.GATEWAY:                            10.4.7.254
IP4.ROUTE[1]:                           dst = 10.4.7.0/24, nh = 0.0.0.0, mt = 100
IP4.ROUTE[2]:                           dst = 0.0.0.0/0, nh = 10.4.7.254, mt = 100
IP4.DNS[1]:                             10.4.7.11
IP6.ADDRESS[1]:                         fe80::20c:29ff:fe47:e2a6/64
IP6.GATEWAY:                            --
IP6.ROUTE[1]:                           dst = fe80::/64, nh = ::, mt = 100
IP6.ROUTE[2]:                           dst = ff00::/8, nh = ::, mt = 256, table=255
[root@postfix ~]#
```
<a name="hMUYB"></a>
## 5、解析测试解析测试
a、Linux机器测试
```c
[root@postfix ~]# nslookup mail.linuxprobe.com
Server:         10.4.7.11
Address:        10.4.7.11#53

Name:   mail.linuxprobe.com
Address: 10.4.7.11

[root@postfix ~]#
```
b、Windows机器测试（使用VMware的哪一张网卡就将dns地址改为10.4.7.11）<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604835527686-630b144e-6603-4d54-9879-dc8d9e459275.png#height=341&id=dbFXw&originHeight=681&originWidth=543&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41621&status=done&style=none&title=&width=271.5)![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604835571960-24a066ad-0a1c-4080-98f8-57e4d9f2ad4c.png#height=337&id=a737c&originHeight=634&originWidth=628&originalType=binary&ratio=1&rotation=0&showTitle=false&size=54244&status=done&style=none&title=&width=334)
<a name="tglqe"></a>
# 二、postfix部分
<a name="7CZH6"></a>
## 1、安装postfix
```c
[root@postfix ~]#  yum install postfix
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.cqu.edu.cn
 * centos-gluster7: mirrors.cqu.edu.cn
 * extras: mirrors.aliyun.com
 * updates: mirrors.cqu.edu.cn
Package 2:postfix-2.10.1-9.el7.x86_64 already installed and latest version
Nothing to do
```
<a name="PlQRb"></a>
## 2、修改配置文件
```c
[root@postfix ~]#  vim /etc/postfix/main.cf
76 myhostname = mail.linuxprobe.com
83 mydomain = linuxprobe.com
99 myorigin = $mydomain
116 inet_interfaces = all
164 mydestination = $myhostname , $mydomain 
[root@postfix ~]#  useradd boss
[root@postfix ~]# passwd boss
Changing password for user boss.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.
[root@postfix ~]# systemctl restart postfix
```
<a name="HFuSr"></a>
## 3、安装dovecot
```c
[root@postfix ~]#  yum install dovecot
Loaded plugins: fastestmirror, langpacks
Loading mirror speeds from cached hostfile
 * base: mirrors.cqu.edu.cn
 * centos-gluster7: mirrors.cqu.edu.cn
 * extras: mirrors.aliyun.com
 * updates: mirrors.cqu.edu.cn
Package 1:dovecot-2.2.36-6.el7_8.1.x86_64 already installed and latest version
Nothing to do
[root@postfix ~]#
```
<a name="zGuoq"></a>
## 4、修改配置文件
```c
[root@postfix ~]#  vim /etc/dovecot/dovecot.conf
24 protocols = imap pop3 lmtp 
25 disable_plaintext_auth = no
48 login_trusted_networks = 192.168.10.0/24			#0.0.0.0/24
[root@postfix ~]#  vim /etc/dovecot/conf.d/10-mail.con
24   mail_location = mbox:~/mail:INBOX=/var/mail/%u
[root@postfix ~]#  su - boss
Last login: Sun Nov  8 06:57:48 EST 2020 on pts/0
[boss@postfix ~]$  mkdir -p mail/.imap/INBOX
[boss@postfix ~]$ su - root
[root@postfix ~]# systemctl restart dovecot ;systemctl enable dovecot
```
<a name="tjmOE"></a>
## 5、发送邮件测试
在创建Outlook的时候可能会失败一次在尝试下就好了要是新的<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604842015300-7a5ee0a2-92ab-4c34-a33f-db245311dfa1.png#height=330&id=N11mV&originHeight=660&originWidth=1313&originalType=binary&ratio=1&rotation=0&showTitle=false&size=41125&status=done&style=none&title=&width=656.5)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604842044573-4846029b-870f-4ec0-b40f-c16e640128b2.png#height=331&id=n5ujB&originHeight=661&originWidth=1311&originalType=binary&ratio=1&rotation=0&showTitle=false&size=33950&status=done&style=none&title=&width=655.5)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604842171727-74037aed-eba6-4fae-b894-48071d7def1d.png#height=330&id=F6LqH&originHeight=660&originWidth=1316&originalType=binary&ratio=1&rotation=0&showTitle=false&size=136471&status=done&style=none&title=&width=658)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604842345233-0a27f918-46f7-4f6b-8d5d-d7e7e29924fd.png#height=377&id=q3Uig&originHeight=754&originWidth=1415&originalType=binary&ratio=1&rotation=0&showTitle=false&size=99376&status=done&style=none&title=&width=707.5)<br />![image.png](https://cdn.nlark.com/yuque/0/2020/png/2476579/1604842365917-8c23b217-f2ea-4f37-ba6e-131cca4af74a.png#height=304&id=jL8Bk&originHeight=607&originWidth=1634&originalType=binary&ratio=1&rotation=0&showTitle=false&size=95733&status=done&style=none&title=&width=817)
<a name="hdo8y"></a>
# 三、Debian搭建邮件服务器
<a name="YtSAA"></a>
## 1、前言：bind9
先做好dns解析步骤如下所示
<a name="yOqIk"></a>
### 1、安装bind9
```bash
root@StorgeSrv:/etc/bind# apt install -y bind9
Reading package lists... Done
Building dependency tree
Reading state information... Done
bind9 is already the newest version (1:9.11.5.P4+dfsg-5.1+deb10u2).
0 upgraded, 0 newly installed, 0 to remove and 0 not upgraded.
root@StorgeSrv:/etc/bind#

```
<a name="SwGvQ"></a>
### 2、主配置文件
```bash
root@StorgeSrv:/etc/bind# cat named.conf.default-zones |tail -11
zone "oldjiang.net" {
        type master;
        file "/etc/bind/zzz.zone";
        allow-update { none; };
};

zone "100.16.172.in-addr.arpa" {
        type master;
        file "/etc/bind/fff.zone";
        allow-update { none; };
};

```
<a name="B3itl"></a>
### 3、区域文件
```c
root@StorgeSrv:/etc/bind# cat zzz.zone fff.zone
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA     oldjiang.net. mail.oldjiang.net. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
        NS      www.oldjiang.net.
www     IN A    172.16.100.101
@       MX 10   mail.oldjiang.net.
mail    IN A    172.16.100.101
download        IN A    172.16.100.101
;
; BIND data file for local loopback interface
;
$TTL    604800
@       IN      SOA    oldjiang.net. mail.oldjiang.net. (
                              2         ; Serial
                         604800         ; Refresh
                          86400         ; Retry
                        2419200         ; Expire
                         604800 )       ; Negative Cache TTL
;
        NS      www.oldjiang.net.
101     IN PTR  www.oldjiang.net.
@       MX 10   mail.oldjiang.net.
101     IN PTR  mail.oldjiang.net.
101     IN PTR  download.oldjiang.net.

```
<a name="SGJkz"></a>
### 4、修改dns地址指向自己
```bash
root@StorgeSrv:~# ip a|grep "172"
    inet 172.16.100.101/24 brd 172.16.100.255 scope global noprefixroute ens192
root@StorgeSrv:~# nmcli connection show ens192 |grep DNS
IP4.DNS[1]:                             172.16.100.101	#将dns地址设置为自己
root@StorgeSrv:~#

```
<a name="eKz5g"></a>
### 5、解析验证
```bash
root@StorgeSrv:~# nslookup mail.oldjiang.net
Server:         172.16.100.101
Address:        172.16.100.101#53

Name:   mail.oldjiang.net
Address: 172.16.100.101

root@StorgeSrv:~# nslookup 172.16.100.101
101.100.16.172.in-addr.arpa     name = www.oldjiang.net.
101.100.16.172.in-addr.arpa     name = mail.oldjiang.net.
101.100.16.172.in-addr.arpa     name = download.oldjiang.net.

root@StorgeSrv:~#

```
<a name="FZCIc"></a>
## 2、邮件服务器
<a name="bNS74"></a>
### a、安装软件
```bash
root@StorgeSrv:~# apt-get install postfix libsasl2-2 sasl2-bin libsasl2-modules dovecot-imapd dovecot-pop3d dovecot-common
```
<a name="vyzsC"></a>
### b、关闭服务
```bash
root@StorgeSrv:~# postfix stop
postfix/postfix-script: stopping the Postfix mail system
root@StorgeSrv:~# systemctl stop dovecot.service
root@StorgeSrv:~#
```
<a name="cA0r1"></a>
### c、修改配置文件
先把证书文件给注释掉<br />修改第一个配置文件 vim /etc/postfix/main.cf<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1618973552037-61130de3-8394-41c5-9310-dc819e43e05f.png#clientId=uf8afacc3-ca84-4&from=paste&height=66&id=u3f929ba1&originHeight=131&originWidth=903&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17777&status=done&style=none&taskId=u61b5d189-8f10-4122-9fc4-a1393d86d93&title=&width=451.5)<br />第二步 修改主机名和邮件服务器的域名<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1618977310352-46331a31-7cc0-4ef0-88db-312ae167c7d9.png#clientId=uf8afacc3-ca84-4&from=paste&height=44&id=ua518dba9&originHeight=87&originWidth=831&originalType=binary&ratio=1&rotation=0&showTitle=false&size=11879&status=done&style=none&taskId=u1be59db5-fd65-4d3a-a1c5-20638de968d&title=&width=415.5)
```bash
myhostname = StorgeSrv
mydestination = oldjiang.net, localhost.localdomain, localhost
```
注意注意注意：重要的事情说三遍<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1618977466090-04fa9a46-eae6-43d9-8154-fa6d8180b491.png#clientId=uf8afacc3-ca84-4&from=paste&height=52&id=u9fa32307&originHeight=104&originWidth=998&originalType=binary&ratio=1&rotation=0&showTitle=false&size=12233&status=done&style=none&taskId=ubcc68411-5bfd-45e5-bdd7-37481be60e8&title=&width=499)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/2476579/1618977493168-6f5d1b62-2c4d-48c3-aaa4-828d86a512d1.png#clientId=uf8afacc3-ca84-4&from=paste&height=144&id=u945aeb51&originHeight=287&originWidth=1501&originalType=binary&ratio=1&rotation=0&showTitle=false&size=84367&status=done&style=none&taskId=u30e33720-1a31-4c32-8f20-cf342c209a0&title=&width=750.5)<br />不然有可能会报这样的错误

保存退出


修改第二个配置文件<br />vim /etc/dovecot/dovecot.conf中添加以下四行
```bash
root@StorgeSrv:~# grep -Ev "#|^$" /etc/dovecot/dovecot.conf|head -2
protocols = pop3 imap
mail_location = mbox:~/mail:INBOX=/var/mail/%u
disable_plaintext_auth=no
login_trusted_networks =0.0.0.0/24
```
第三启动服务
```bash
root@StorgeSrv:~# systemctl restart postfix.service
root@StorgeSrv:~# systemctl restart dovecot.service
```
第四创建用户和密码发送邮件
<a name="zGxxl"></a>
### d、发送邮件测试
```bash
root@StorgeSrv:~# su - mailuser1
mailuser1@StorgeSrv:~$ echo "测试邮件" | mail -s "测试" mailuser2@oldjiang.net
```
查看是否收到邮件
```bash
mailuser2@StorgeSrv:~$ cat /var/spool/mail/mailuser2
From mailuser1@StorgeSrv  Wed Apr 21 00:04:36 2021
Return-Path: <mailuser1@StorgeSrv>
X-Original-To: mailuser2@oldjiang.net
Delivered-To: mailuser2@oldjiang.net
Received: by StorgeSrv (Postfix, from userid 2004)
        id 4DE7281F34; Wed, 21 Apr 2021 00:04:36 -0400 (EDT)
Subject: 测试
To: <mailuser2@oldjiang.net>
X-Mailer: mail (GNU Mailutils 3.5)
Message-Id: <20210421040436.4DE7281F34@StorgeSrv>
Date: Wed, 21 Apr 2021 00:04:36 -0400 (EDT)
From: mailuser1@StorgeSrv

测试邮件

```













