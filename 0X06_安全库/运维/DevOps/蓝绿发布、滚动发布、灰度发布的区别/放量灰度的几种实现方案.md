<a name="mdQJi"></a>
## 网关统一灰度
网关默认是路由的/v1/order/detail接口，现在新加了/v2/order/detail接口，如果全部切过去，万一有问题，所有用户都会受到影响，所以需要灰度放量来将风险降到最低。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638148883848-e1cd262d-9427-4956-9f75-4a181ea55369.webp#clientId=ufd2c6302-c858-4&from=paste&id=u65875927&originHeight=860&originWidth=1038&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=uf8b77084-914c-4159-a466-4997720dc7e&title=)<br />网关内部可以对指定的用户路由到v2版本的接口，也可以根据地区路由，方式有很多种，常用的路由方式有哪些会在下面进行讲解。
<a name="ddSIV"></a>
## 应用内部自己灰度
除了在网关进行灰度，另一种方案就是应用内部自己灰度。也就是说APP请求到网关，网关到具体的服务，这个服务此时还是之前的老服务，需要在这个老服务调用新服务的接口，然后返回，这就是应用内部自己灰度的方式。<br />一旦灰度完成，老服务内部的代码就可以删除，当请求过来的时候只需要路由到请服务即可。然后可以将网关路由的地址直接改成新服务的地址，此时老服务内的接口可以直接删除，完成迁移动作。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638148883831-dad1b667-38f7-4e32-a7ea-94d1c4ef9e1d.webp#clientId=ufd2c6302-c858-4&from=paste&id=u7abeac2b&originHeight=860&originWidth=1038&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u68ab4f5c-188e-4188-9c5a-67d875028e5&title=)
<a name="Dkeds"></a>
## 灰度方式介绍
<a name="PvPca"></a>
### 用户白名单灰度
此方式较为简单，就是构建一个用户的白名单，可以用手机号或者用户ID，白名单可以放在数据表里面，也可以放在配置中心。从性能角度考虑放配置中心更合适，更新后也能实时生效。<br />也就是当前请求的用户在配置的白名单里面，就让他访问新版本的接口，不在就默认还是旧接口。通过这种方式观察一段时间，如果没有问题，就可以加大灰度人数或者全量放开。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638148883870-50eb0537-4b00-4062-8259-c2bade911d35.webp#clientId=ufd2c6302-c858-4&from=paste&id=u87ac66e9&originHeight=1009&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u9b860294-fd67-4d02-8709-771a2760c26&title=)
<a name="TpL20"></a>
### 用户百分比灰度
提取用户ID的后两位，然后产生一个随机数，如果匹配上了，这个用户就灰度中了。
<a name="UuH5e"></a>
### 百分比灰度
百分比灰度也是一种常用的灰度方式，此方式不会固定用户，而是采用随机的方式进行。如果设置了10%的灰度比例，也就是100次请求中有10次请求会被灰度中，会访问新的接口。<br />当然为了影响降到最低，也可以实现千分比，万分比，慢慢调高比例，一点点往上灰度，这种方式非常稳妥。<br />伪代码如下：
```java
public static void main(String[] args) {
    // 灰度比例，配在配置中心
    int grayScale = 10;
    int probability = new Random().nextInt(100);
    if (probability < grayScale) {
        // 调用 /v2/order/detail
    } else {
        // 走本地老逻辑
    }
}
```
