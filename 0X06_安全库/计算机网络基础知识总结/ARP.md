网络 ARP<br />![2021-05-01-17-17-34-138902.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861045650-c25a08e0-2c09-4b2a-8dea-51034d26728a.png#clientId=ufc962763-2a81-4&from=ui&id=ue27bdc04&originHeight=306&originWidth=1080&originalType=binary&size=68407&status=done&style=shadow&taskId=u6e8b5693-a592-40dc-94d4-ed9862271e1)<br />只要确定了 IP 地址后，就能够向这个 IP 地址所在的主机发送数据报。但是再往深了想，IP 地址只是标识网络层的地址，那么在网络层下方数据链路层是不是也有一个地址能够告诉对方主机自己的地址呢？是的，这个地址就是MAC 地址。
<a name="OHuLX"></a>
## 认识 MAC 地址
MAC 地址的全称是 Media Access Control Address，译为媒体访问控制地址，它是网络上以太网或网络适配器的唯一标识符。MAC 地址能够区分不同的网络接口，并用于多种网络技术，尤其是大多数 IEEE 802 网络。<br />MAC 地址也称为物理地址，硬件地址和老化地址。<br />MAC 地址主要用于识别数据链路中互联的节点，如下图所示<br />![2021-05-01-17-17-34-443858.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861296428-609027a9-db18-40db-a66c-d95425c9cd46.png#clientId=ufc962763-2a81-4&from=ui&id=u8d1dd090&originHeight=499&originWidth=1080&originalType=binary&size=133140&status=done&style=shadow&taskId=u8a37066d-b1a7-4d5f-8819-5db58de44ca)<br />MAC 地址长 48 bit，在使用网卡(NIC) 的情况下，MAC 地址一般都会烧入 ROM 中。因此，任何一个网卡的 MAC 地址都是唯一的。MAC 地址的结构如下<br />![2021-05-01-17-17-34-720121.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861311900-f06c5d0a-6138-427f-a723-9d04adcfb194.png#clientId=ufc962763-2a81-4&from=ui&id=u252fa364&originHeight=490&originWidth=1080&originalType=binary&size=111094&status=done&style=shadow&taskId=ue7929605-b6d3-4a06-9279-e31367e35b8)<br />MAC 地址中的 3 - 24 位表示厂商识别码，每个 NIC 厂商都有特定唯一的识别数字。25 - 48 位是厂商内部为识别每个网卡而用。因此，可以保证全世界不会有相同 MAC 地址的网卡。<br />MAC 地址也有例外情况，即 MAC 地址也会有重复的时候，但是问题不大，只要两个 MAC 地址是属于不同的数据链路层就不会出现问题。
<a name="LTwSM"></a>
## ARP 是什么
ARP 协议的全称是 Address Resolution Protocol(地址解析协议)，它是一个通过用于实现从 IP 地址到 MAC 地址的映射，即询问目标 IP 对应的 MAC 地址 的一种协议。ARP 协议在 IPv4 中极其重要。<br />注意：ARP 只用于 IPv4 协议中，IPv6 协议使用的是 Neighbor Discovery Protocol，译为邻居发现协议，它被纳入 ICMPv6 中。<br />简而言之，ARP 就是一种解决地址问题的协议，它以 IP 地址为线索，定位下一个应该接收数据分包的主机 MAC 地址。如果目标主机不在同一个链路上，那么会查找下一跳路由器的 MAC 地址。
<a name="P8Vju"></a>
### ARP 的工作机制
下面探讨一下 ARP 的工作机制是怎样的。假设 A 和 B 位于同一链路，不需要经过路由器的转换，主机 A 向主机 B 发送一个 IP 分组，主机 A 的地址是 192.168.1.2 ，主机 B 的地址是 192.168.1.3，它们都不知道对方的 MAC 地址是啥，主机 C 和 主机 D 是同一链路的其他主机。<br />![2021-05-01-17-17-34-926573.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861327971-59e3c407-0760-4cf6-9c98-c17f6cb2cb12.png#clientId=ufc962763-2a81-4&from=ui&id=ua53291e5&originHeight=458&originWidth=1080&originalType=binary&size=71145&status=done&style=shadow&taskId=uee5cac21-6062-47af-8fd1-9e0d75ea923)<br />主机 A 想要获取主机 B 的 MAC 地址，通过主机 A 会通过广播 的方式向以太网上的所有主机发送一个 ARP 请求包，这个 ARP 请求包中包含了主机 A 想要知道的主机 B 的 IP 地址的 MAC 地址。<br />![2021-05-01-17-17-35-150181.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861339960-de89c3f2-4740-46f1-b8ae-1e512099f50f.png#clientId=ufc962763-2a81-4&from=ui&id=uc067421a&originHeight=447&originWidth=1080&originalType=binary&size=125590&status=done&style=shadow&taskId=u9407e89a-b94c-4d06-9a37-d576a57d0df)<br />主机 A 发送的 ARP 请求包会被同一链路上的所有主机/路由器接收并进行解析。每个主机/路由器都会检查 ARP 请求包中的信息，如果 ARP 请求包中的目标 IP 地址 和自己的相同，就会将自己主机的 MAC 地址写入响应包返回主机 A<br />![2021-05-01-17-17-35-369506.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861351445-0e3f6f7c-5baa-494b-a410-9467763e8b8f.png#clientId=ufc962763-2a81-4&from=ui&id=u8bba41ff&originHeight=452&originWidth=1080&originalType=binary&size=92194&status=done&style=shadow&taskId=ub7186a67-ff86-46cf-b6ef-55ea11c394c)<br />由此，可以通过 ARP 从 IP 地址获取 MAC 地址，实现同一链路内的通信。<br />如果是不同链路怎么办呢？<br />这就要使用到 代理 ARP 了，通常 ARP 会被路由器隔离，但是采用代理 ARP (ARP Proxy) 的路由器可以将 ARP 请求转发给临近的网段。使多个网段中的节点像是在同一网段内通信。
<a name="ddddE"></a>
### ARP 缓存
现在知道了发送一次 IP 分组前通过发送一次 ARP 请求就能够确定 MAC 地址。那么是不是每发送一次都得经过广播 -> 封装 ARP 响应 -> 返回给主机这一系列流程呢？<br />想想看，浏览器是如何做的呢？浏览器内置了缓存能够缓存最近经常使用的地址，那么 ARP 也是一样的。ARP 高效运行的关键就是维护每个主机和路由器上的 ARP 缓存(或表)。这个缓存维护着每个 IP 到 MAC 地址的映射关系。通过把第一次 ARP 获取到的 MAC 地址作为 IP 对 MAC 的映射关系到一个 ARP 缓存表中，下一次再向这个地址发送数据报时就不再需要重新发送 ARP 请求了，而是直接使用这个缓存表中的 MAC 地址进行数据报的发送。每发送一次 ARP 请求，缓存表中对应的映射关系都会被清除。<br />通过 ARP 缓存，降低了网络流量的使用，在一定程度上防止了 ARP 的大量广播。<br />![2021-05-01-17-17-35-560532.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861364548-5c5923d9-2a45-4c6d-a9df-eb90010fcc76.png#clientId=ufc962763-2a81-4&from=ui&id=u9899d729&originHeight=463&originWidth=1080&originalType=binary&size=110603&status=done&style=shadow&taskId=u05edec63-8192-48b4-aac1-a3f2da81f0f)<br />一般来说，发送过一次 ARP 请求后，再次发送相同请求的几率比较大，因此使用 ARP 缓存能够减少 ARP 包的发送，除此之外，不仅仅 ARP 请求的发送方能够缓存 ARP 接收方的 MAC 地址，接收方也能够缓存 ARP 请求方的 IP 和 MAC 地址，如下所示<br />![2021-05-01-17-17-35-763331.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861379079-45417a11-cec2-4bf2-8c18-ce8a0e08f5ca.png#clientId=ufc962763-2a81-4&from=ui&id=u920aa3c6&originHeight=496&originWidth=1080&originalType=binary&size=106185&status=done&style=none&taskId=u4e48eeba-7683-4ea5-8dc6-ef15a95d391)<br />不过，MAC 地址的缓存有一定期限，超过这个期限后，缓存的内容会被清除。<br />可以在 Linux 或者 Windows 中使用 arp 命令查看 ARP 缓存。选项 -a 用于显示两个系统缓存中所有的缓存项。<br />在 Linux 中使用 arp 查询缓存<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861474201-1288460f-61a3-43cb-8870-4e8f74afb42d.png#clientId=ufc962763-2a81-4&from=paste&height=254&id=u3739b3bd&originHeight=761&originWidth=3323&originalType=binary&size=892736&status=done&style=none&taskId=u660b6168-a1da-4049-adf7-bde035370bc&width=1107.6666666666667)<br />主要包含五项

- 主机名 --- 对应一个 IP 地址
- 硬件地址类型
- 硬件地址
- 标志
- 本地网络接口

标志主要分为三类: C 、M 或 P，C 表示的是由 ARP 协议动态学习。M 类可以通过 arp -s 增加一条。P 类表示的是 发布，对于任何 P 类项目，主机对输入的 ARP 请求都返回一个 ARP 响应。这个选项用于配置代理 ARP。<br />比如在 Windows 中进行 ARP 缓存查询<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861539634-f7777993-6239-49a4-a100-0e518b40523d.png#clientId=ufc962763-2a81-4&from=paste&height=432&id=uf07c1070&originHeight=1296&originWidth=3323&originalType=binary&size=1535311&status=done&style=none&taskId=u07e48866-343d-419f-a4a7-5d235c0511c&width=1107.6666666666667)<br />Windows 中的 ARP 程序显示了 IPv4 的地址，它的接口是十六进制数，Windows 版本还指出地址是手动输入还是 ARP 动态学习的。在上面的例子中，既有静态的也有动态的。48 位的 MAC 地址被显示为 6 个十六进制数，在 Linux 中使用 : 号，在 Windows 中使用 - 进行分隔。
<a name="Gdy62"></a>
## ARP 结构
上面说到，ARP 对想要知道 MAC 地址的目标主机会首先发送 ARP 请求，那么这个请求中都携带哪些信息呢？下面是在以太网中转换一个 IPv4 的地址常用的 ARP 请求或响应的报文格式。<br />![2021-05-01-17-17-36-277487.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861557765-089e493a-e5af-4317-a44e-75621afad97b.png#clientId=ufc962763-2a81-4&from=ui&id=ua905dc07&originHeight=392&originWidth=1080&originalType=binary&size=112301&status=done&style=shadow&taskId=u73a9b31b-dc09-45a7-9abe-40b961e8d36)<br />前面 14 个字节构成标准以太网的首部，前两个字段 DST 和 SRC 分别表示 以太网的目的地址 和 以太网的源地址，以太网的目的地址如果是 ff:ff:ff:ff:ff:ff 全部为 1 表示广播地址，在同一广播域中的所有以太网接口可以接收这些帧。后面紧跟着的是 ARP 请求的长度/类型，ARP 请求 和 ARP 应答这个值为 0x0806。

- 硬件类型表示硬件地址的类型，硬件地址常见的有 MAC 物理或者以太网地址，对于以太网来说，此值为 1。
- 协议类型 指出映射的协议地址类型，对于 IPv4 地址，这个值是 0x0800。
- 硬件大小和 协议大小 分别指出硬件地址和协议地址的字节数。对于以太网中使用 IPv4 的 ARP 请求或应答，它们的值分别是 6 和 4。
- Op 字段指出如果是 ARP 请求，Op = 1，ARP 应答 ，Op = 2，RARP 请求 Op = 3，RARP 应答，Op = 4。
- 紧跟在 Op 之后的是 发送方硬件地址(MAC 地址)，发送方的协议地址(IPv4 地址)，目的硬件地址 和 目的协议地址。
<a name="tr16f"></a>
## ARP 抓包实战
分别演示在 Mac 和 Linux 下的 ARP 报文的截获<br />在 Mac 环境下，这边使用的是 WireShark 进行抓包，可以从官网下载，地址如下<br />[https://www.wireshark.org/download.html](https://www.wireshark.org/download.html)<br />![2021-05-01-17-17-36-691201.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861589935-50ac0bf6-4210-4a5c-b268-7d165c080c86.png#clientId=ufc962763-2a81-4&from=ui&id=u458f82ce&originHeight=431&originWidth=1080&originalType=binary&size=60738&status=done&style=shadow&taskId=uaa5e7956-26e6-49ee-ae27-3cf7b0af991)<br />下载完成后阅读安装说明的手册，阅读后会发现需要安装两个插件，根据提示安装即可，然后打开 WireShark ，开始报文拦截，下面是截获的 ARP 数据包<br />![2021-05-01-17-17-37-207387.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861611013-3af46a2e-063d-4511-b5af-7acc5c76fb3d.png#clientId=ufc962763-2a81-4&from=ui&id=u1ff6910d&originHeight=158&originWidth=1080&originalType=binary&size=142372&status=done&style=none&taskId=u614b5ad9-e6b5-4af7-b123-be3f760a4dd)<br />这款软件很好的一个地方是对不同的数据包会有不同的颜色标识，这点非常好。<br />然后查看 ARP 请求<br />![2021-05-01-17-17-37-837406.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861631532-36ad0163-e7e8-4080-8479-e6d1bc95f76b.png#clientId=ufc962763-2a81-4&from=ui&id=u82360e91&originHeight=502&originWidth=1080&originalType=binary&size=315866&status=done&style=stroke&taskId=u7885c0af-38fe-4ff0-8e99-c9801f27b8b)<br />可以看到，这就是一个完整的 ARP 请求包，使用的硬件类型是以太网，协议类型是 IPv4 ，默认值是 0x0800，然后硬件大小是 6 个字节，协议大小占用 2 个字节，Op 的全称是 Opcode ，Op = 1 表示这是一个 ARP 请求，然后是发送方的硬件地址和协议地址，接收方的硬件地址和协议地址。<br />ARP 响应如下<br />![2021-05-01-17-17-38-525523.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861643308-0a961038-888f-4b64-91eb-6c61b78e67d9.png#clientId=ufc962763-2a81-4&from=ui&id=u0dc83ca5&originHeight=457&originWidth=1080&originalType=binary&size=283623&status=done&style=shadow&taskId=u576ccb07-13d2-450f-ac3e-5e13032e48f)<br />可以看到 Op = 2，表示这是 ARP 响应。<br />在 Linux 环境下，可以使用 tcpdump 截获 ARP 数据包，如果 `tcpdump not found` 的话，可以使用 `yum install -y tcpdump` 安装。<br />使用 `tcpdump -i ens33` 可以打印出在 ens33 地址下的数据包，下面是截取的 ARP 数据包。<br />![2021-05-01-17-17-39-228541.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861678434-a82ae2a4-ed24-4685-8e54-5220ad0ad596.png#clientId=ufc962763-2a81-4&from=ui&id=u7ffb18bb&originHeight=200&originWidth=1080&originalType=binary&size=220613&status=done&style=none&taskId=u23a567ae-2d87-4d8f-9549-5a2f890c216)
<a name="q0u9F"></a>
## ARP 缓存超时
缓存超时通常与 ARP 缓存中的项有关系，arp 命令可以允许管理员设置永不超时。ARP 把保存在高速缓存中的每一映射地址都设置生存时间，一般为 20 分钟。如果是不完整的映射，那么缓存超时时间为 3 分钟，不完整的映射通常会强制发送一条不存在主机的 ARP 请求。
<a name="TgpLk"></a>
## RARP
与 ARP 相对的，RARP(Reverse Address Resolution Protocol) 是将 ARP 反过来，从 MAC 地址定位 IP 地址的一种协议，将打印机服务器等小型嵌入式设备接入网络时会使用到。<br />![2021-05-01-17-17-39-539321.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861695535-8499f4b4-2432-4c88-8e38-9798f0f47d93.png#clientId=ufc962763-2a81-4&from=ui&id=u757ffd0b&originHeight=212&originWidth=1080&originalType=binary&size=32117&status=done&style=shadow&taskId=ue0c2c43e-530a-4acd-8005-de59a9e59f1)<br />平常设置 IP 地址一般会有两种方式，手动设置 和 DHCP 动态获取<br />![2021-05-01-17-17-40-183971.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861712596-5603291f-0a0f-4fe8-8f21-59e406fa297f.png#clientId=ufc962763-2a81-4&from=ui&id=u00900124&originHeight=561&originWidth=1080&originalType=binary&size=267262&status=done&style=none&taskId=u1cb04c12-fc07-4727-9282-4970f6166a5)<br />但是对于嵌入式设备来说，它没有任何输入接口，也无法通过 DHCP 获取动态地址。<br />在这种情况下，就要使用到 RARP 了，需要准备一个 RARP 服务器，在这个服务器上注册设备的 MAC 地址和 IP 地址，然后将设备接入网络，设备会发出一条 IP 和 MAC 地址的查询请求给服务器，服务器会告诉设备其 IP 地址和 MAC 地址。<br />![2021-05-01-17-17-40-661332.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1619861729435-dd50924f-44ac-4b4e-a308-39c8ac606140.png#clientId=ufc962763-2a81-4&from=ui&id=u14ecb433&originHeight=355&originWidth=1080&originalType=binary&size=58206&status=done&style=shadow&taskId=u03cee302-0426-48ce-8127-465f9b6b7f4)
<a name="Tfu0h"></a>
## ARP 攻击
ARP 是一种非常不安全的协议，目前已经有很多涉及 ARP 的攻击，最主要的就是使用代理 ARP 功能假扮主机，对 ARP 请求作出应答，通过伪造 ARP 数据包来窃取合法用户的通信数据，造成影响网络传输速率和盗取用户隐私信息等严重危害。
<a name="s3RFU"></a>
### ARP 攻击分类
ARP 主要攻击方式分为下面这几种

- ARP 泛洪攻击：通过向网关发送大量 ARP 报文，导致网关无法正常响应。首先发送大量的 ARP 请求报文，然后又发送大量虚假的 ARP 响应报文，从而造成网关部分的 CPU 利用率上升难以响应正常服务请求，而且网关还会被错误的 ARP 缓存表充满导致无法更新维护正常 ARP 缓存表，消耗网络带宽资源。
- ARP 欺骗主机攻击：ARP 欺骗主机的攻击也是 ARP 众多攻击类型中很常见的一种。攻击者通过 ARP 欺骗使得局域网内被攻击主机发送给网关的流量信息实际上都发送给攻击者。主机刷新自己的 ARP 使得在自己的ARP 缓存表中对应的 MAC 为攻击者的 MAC，这样一来其他用户要通过网关发送出去的数据流就会发往主机这里，这样就会造成用户的数据外泄。
- 欺骗网关的攻击: 欺骗网关就是把别的主机发送给网关的数据通过欺骗网关的形式使得这些数据通过网关发送给攻击者。这种攻击目标选择的不是个人主机而是局域网的网关，这样就会攻击者源源不断的获取局域网内其他用户韵数据．造成数据的泄露，同时用户电脑中病毒的概率也会提升。
- 中间人攻击: 中间人攻击是同时欺骗局域网内的主机和网关，局域网中用户的数据和网关的数据会发给同一个攻击者，这样，用户与网关的数据就会泄露。
- IP地址冲突攻击: 通过对局域网中的物理主机进行扫描，扫描出局域网中的物理主机的 MAC 地址，然后根据物理主机的 MAC 进行攻击，导致局域网内的主机产生 IP 地址冲突，影响用户的网络正常使用。
<a name="wW6mH"></a>
## 总结
ARP 是 TCP/IP 实现中的一个基本协议，它通常在应用程序或用户没有察觉到的情况下运行。ARP 可以用于映射 IP 地址为 MAC 地址。
