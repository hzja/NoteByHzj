# 原创
：  [网络安全提高篇] 一一九.恶意软件动态分析经典沙箱Cape的安装和基础用法详解

# [网络安全提高篇] 一一九.恶意软件动态分析经典沙箱Cape的安装和基础用法详解

**终于忙完初稿，开心地写一篇博客。** “网络安全提高班”新的100篇文章即将开启，包括Web渗透、内网渗透、靶场搭建、CVE复现、攻击溯源、实战及CTF总结，它将更加聚焦，更加深入，也是作者的慢慢成长史。换专业确实挺难的，Web渗透也是块硬骨头，但我也试试，看看自己未来四年究竟能将它学到什么程度，漫漫长征路，偏向虎山行。享受过程，一起加油~

<mark>**前文详细介绍恶意代码静态分析经典工具Capa的基础用法，以及批量提取静态特征和ATT&amp;CK技战术，主要是从提取的静态特征Json文件中提取关键特征。这篇文章将详细讲解动态分析沙箱Cape，其是一个开源的自动恶意软件分析系统，通过自动运行和分析恶意软件，全面分析和提取恶意软件的关键特征。本文先介绍Cape沙箱的安装和基础用法，后续随着深入再分享。基础性文章，希望对您有帮助，如果存在错误或不足之处，还请海涵。且看且珍惜！**</mark>

#### 文章目录

作者作为网络安全的小白，分享一些自学基础教程给大家，主要是关于安全工具和实践操作的在线笔记，希望您们喜欢。同时，更希望您能与我一起操作和进步，后续将深入学习网络安全和系统安全知识并分享相关实验。总之，希望该系列文章对博友有所帮助，写文不易，大神们不喜勿喷，谢谢！如果文章对您有帮助，将是我创作的最大动力，点赞、评论、私聊均可，一起加油喔~

> 
声明：本人坚决反对利用教学方法进行犯罪的行为，一切犯罪行为必将受到严惩，绿色网络需要我们共同维护，更推荐大家了解它们背后的原理，更好地进行防护。


**提高篇：（自学系列100篇目录放在文章末尾）**

---


## 一.恶意软件分析

恶意软件或恶意代码分析通常包括静态分析和动态分析。特征种类如果按照恶意代码是否在用户环境或仿真环境中运行，可以划分为静态特征和动态特征。

**那么，如何提取恶意软件的静态特征或动态特征呢？** 因此，第一部分将简要介绍静态特征和动态特征。

### 1.静态特征

没有真实运行的特征，通常包括：

静态特征提取方式：

---


### 2.动态特征

相当于静态特征更耗时，它要真正去执行代码。通常包括：<br/> – <mark>API调用关系</mark>：比较明显的特征，调用了哪些API，表述对应的功能<br/> – <mark>控制流图</mark>：软件工程中比较常用，机器学习将其表示成向量，从而进行分类<br/> – <mark>数据流图</mark>：软件工程中比较常用，机器学习将其表示成向量，从而进行分类

动态特征提取方式：

---


## 二.Cuckoo和Cape沙箱简介

### 1.Cuckoo沙箱简介

**Cuckoo Sandbox** 是一个开源的自动恶意软件分析系统，并且是经典的沙箱分析工具。Cuckoo沙箱将在几秒钟内为您提供一些详细的分析结果，概述该文件在隔离环境中执行时的情况。不像在线VirusTotal、VirusShare、微步、AnyRun、Hybrid等在线沙箱，Cuckoo可以实现本地安装和离地分析，其定制化和可控程度更高。

Cuckoo Sandbox始于2010年蜜网计划中的谷歌Summer of Code项目，它最初是由Claudio“nex”Guarnieri设计和开发的。在2010年夏天开启该工作之后，第一个测试版于2011年2月5日发布，这是Cuckoo第一次公开发布。2011年3月，在谷歌Code Summer of 2011期间，Cuckoo再次被选为蜜网项目的支持项目，在此期间Dario Fernandes加入了该项目并扩展了其功能。

> 
Cuckoo Sandbox started as a Google Summer of Code project in 2010 within The Honeynet Project. It was originally designed and developed by Claudio “nex” Guarnieri, who is still the main developer and coordinates all efforts from joined developers and contributors.


---


### 2.Cape沙箱简介

**CAPE Sandbox** 是一款用于自动分析可疑文件或恶意软件的开源系统，它使用自定义组件来监视在隔离环境中运行的恶意进程的行为。CAPE来源于Cuckoo Sandbox，目的是添加自动恶意软件解包和配置提取——因此它的名字是一个缩写“配置和有效载荷提取（`Config And Payload Extraction`）”。自动解包允许基于Yara签名的分类，以补充网络(Suricata)和行为(API)签名。于2016年诞生。

> 
CAPE Sandbox is an Open Source software for automating analysis of suspicious files. To do so it makes use of custom components that monitor the behavior of the malicious processes while running in an isolated environment.


CAPE被用来自动运行和分析文件，并收集全面的分析结果，概述恶意软件在孤立的Windows操作系统中运行时的行为。它可以检测以下类型的结果:

由于CAPE的模块化设计，它既可以作为独立的应用程序使用，也可以集成到更大的框架中。它可以用来分析:

虽然CAPE沙箱的配置和有效载荷提取是最初声明的目标，但CAPE调试器的首要目标是：为了从任意恶意软件家族中提取配置文件或解压缩有效负载，而不依赖进程转储（迟早会被坏人破坏），指令级别的监视和控制是必要的。CAPE中的新调试器遵循最大化使用处理器硬件和最小化使用Windows调试接口的原则，允许通过Yara签名或API调用在引爆期间以编程方式设置硬件断点，从入口点偷偷地检测和操纵恶意软件。这允许捕获指令跟踪，或执行操作，如控制流操作或转储内存区域。

调试器允许CAPE在其原始功能之外继续发展，这些功能现在包括了**动态反规避绕过**。由于现代恶意软件通常试图在沙箱中逃避分析，例如通过使用定时陷阱来进行虚拟化或API钩子检测，CAPE允许开发动态对策，结合调试器在Yara签名中的动作，来检测隐藏的恶意软件，并执行控制流程操作，迫使样品完全引爆或跳过规避动作。CAPE的动态旁路越来越多，其中包括:

CAPE利用了许多恶意软件技术或行为，允许未打包的有效载荷捕获，这些行为将导致捕获注入、提取或解压缩的有效载荷，以便进一步分析。此外，CAPE自动为每个进程创建一个进程转储，或者在DLL的情况下，为内存中的DLL模块映像创建一个进程转储。

**推荐读者学习官方文档：**

---


### 3.Cape原理

CAPE Sandbox由处理样本执行和分析的中央管理软件组成。每个分析都在一个全新的、孤立的虚拟机中启动。CAPE的基础结构由一台主机（管理软件）和一些Guest机器（用于分析的虚拟机）组成。主机Host运行管理整个分析过程的沙盒核心组件，而Guest是安全执行和分析恶意软件样本的隔离环境。

CAPE的主要架构如下图所示：

---


## 三.Cape沙箱安装过程

在介绍Cape沙箱之前，我先介绍如何安装Cape。在网上会有很多Cuckoo或Cape沙箱的安装教程，整个安装真的繁琐，需要多个系统嵌套，包括Ubuntu、Windows、Cuckoo等。这里作者介绍一种相对简单的Cape沙箱安装环境，通过我CFT师弟集成的Cape虚拟机镜像安装，通过他允许后在此分享，并表示感谢。具体步骤如下：

### 1.载入虚拟机镜像

第一步：安装VMware虚拟机并打开。

第二步，利用VMware打开指定文件夹的虚拟机镜像。该集成镜像由我师弟完成，再次表示感谢。整个虚拟机内容如下：

第三步，导入虚拟机并存储指定位置，等待虚拟机的导入。

第四步，导入成功后如下图所示，接着开启虚拟机。

等待打开Ubuntu系统，如下图所示：

第五步，打开Ubuntu系统。

最终结果如下图所示，这是配置好的环境，接下来需要启动沙箱。

---


### 2.启动沙箱

<font color="red">**第一步， 在任意文件夹中运行"sudo virtualbox"，现在已经安装了一个Win7 X64专业版虚拟机。**</font>

```
sudo virtualbox

```

输入密码仍然为“admin123”，后续操作均是它。

此时会启动cuckoo沙箱，如下图所示。

如果cuckoo关闭则启动即可，如下图所示：

它会启动Windows 7系统，后续会调用agent.py代码执行动态分析。

<font color="red">**第二步， 进入/opt/CAPEv2/文件夹，运行"sudo python3 cuckoo.py"。**</font>

```
cd /opt/CAPEv2
sudo python3 cuckoo.py

```

注意输入命令按“Tab”键会自动补齐。

对应的源文件如下图所示，集成的CAPEv2文件夹。

<font color="red">**第三步， 在/opt/CAPEv2/文件夹下运行"sudo python3 utils/process.py -p7 auto"，参数代表优先级划分，输入多个样本时，沙箱会优先运行高优先级样本。**</font>

```
cd /opt/CAPEv2/
sudo python3 utils/process.py -p7 auto

```

类似于动态分析监控过程。

运行的文件对应位置如下：

<font color="red">**第四步，在/opt/CAPEv2/web目录下(由于环境依赖的问题，必须由指向该文件夹的shell运行该命令)，运行"sudo python3 manage.py runserver 127.0.0.1:8088"(该虚拟机的8080端口已被占用，端口可自己指定)。**</font>

```
cd /opt/CAPEv2/web
sudo python3 manage.py runserver 127.0.0.1:8088

```

该操作相当于打开前段服务器，用于加载恶意软件和呈现分析结果。

对应源文件如下：

至此，沙箱成功启动，共开启四个窗口分别运行各种操作。

---


## 四.Cape沙箱基本用法

该部分将介绍Cape沙箱的详细用法。

### 1.提交样本

**在虚拟机的火狐中打开127.0.0.1:8088，在submit页面提交样本即可。**

第一步，在虚拟机的火狐中打开127.0.0.1:8088。

第二步， 选择需要分析的样本上传。注意，作者在环境中已设置两个样本供大家分析。

同时，作者已将虚拟机的Tool开启，可以直接从主机中拖动需要分析的文件至指定目录进行分析。如下图所示，将HGZ和WannaCry样本。

> 
**再次强调**<br/> 在恶意软件分析中，一定要做好本机保护，包括在虚拟机隔离环境中进行分析，甚至需要断网防止沙箱逃逸。同时，本人坚决反对渗透和破坏行为，一切犯罪行为必将受到严惩，绿色网络需要我们共同维护。这里仅是分享恶意软件分析背后的原理，更好地进行防护。


选择动态分析的必要参数，比如时间为60秒。

第三步，提交分析，调用Cape沙箱开展动态分析。

会唤醒Cuckoo沙箱进行分析。

完成分享后如下图所示：

---


### 2.WannaCry动态分析结果查看

点击控制面板的“Recent”查看分析结果。由图可知，本文分析的结果已产生，同时有之前提交的两个样本。

点击MD5值查看分析结果。

#### Quick Overview

首先展示快速分析的基本信息，包括机器和时间等。

下面是恶意软件动态分析的具体内容。

<mark>(1) 文件详细信息</mark>

<mark>(2) 签名信息（signatures）</mark>

可以看到生成的文件，比如WannaCry任务执行生成的“taskche.exe”，感兴趣的读者请详细看看我之前分析的WannaCry样本传播机理。

DLL载入文件如下图所示：

HTTP请求可以看到WannaCry域名开关去连接的三个域名（早已下架）。

加密和签名信息如下：

<mark>(3) 动态运行截屏信息</mark>

<mark>(4) 各种动态行为特征总结</mark><br/> 下面是各种动态特征总结，由图可知，Cape沙箱的功能非常强大。其中比较重要的信息，比如IOCs如下图所示。

动态API如下图所示：

注册表操作如下图所示：

---


#### Static Analysis

静态分析结果如下图所示：

---


#### Behavior Analysis

动态行为特征如下图所示：

该部分能看到动态API序列，极为重要的特征，如下图所示：

---


#### Network Analysis

网络分析如下图所示：

---


#### Process Dumps

进程特征如下：

---


#### Reports

同时可以下载对应的报告，如下图所示：<br/> <img alt="在这里插入图片描述" height="400" src="https://img-blog.csdnimg.cn/f4d7ccf399114a8e85d5a0f27d663dee.png#pic_center" width="650"/>

报告的位置如下图所示，分析结果均存储在“storage”文件夹中。

---


#### Statistics

统计结果如下图所示：

---


### 3.其它功能介绍

整个Cape页面主要包括六个菜单：

Dashboard是分析统计结果。

Recent是最近分析的结果，需从该位置查看详细信息。

Pending是正在分析的样本。

Search是搜索功能。

API是相关函数及信息。

Submit是提交页面。

---


## 五.总结

写到这里这篇文章就结束，希望对您有所帮助。忙碌的三月，真的很忙，项目本子论文毕业，等忙完后好好写几篇安全博客，感谢支持和陪伴，尤其是家人的鼓励和支持， 继续加油！

> 
2023年3月20日，终于完成初稿，凌晨迫不及待来写一篇博客，纪念下，感恩下！娜璋白首。


提问：

> 
三月应该是今年最忙碌的一个月了，好多事情。希望一切顺利，更希望四月后能沉下心来读论文和写论文，继续加油，只争朝夕。 <br/><br/> <img alt="在这里插入图片描述" height="400" src="https://img-blog.csdnimg.cn/b74aa4d6a4f249e195cc87cb9d5655c0.jpeg#pic_center" width="550"/>


**欢迎大家讨论，是否觉得这系列文章帮助到您！任何建议都可以评论告知读者，共勉。**

(By:Eastmount 2023-03-22 夜于武汉 [http://blog.csdn.net/eastmount/](http://blog.csdn.net/eastmount/) )

---


参考文献：

---


**自学篇（链接直接跳转到正文）：**
