随着开源产品的越来越盛行，作为一个Linux运维工程师，能够清晰地鉴别异常机器是否已经被入侵了显得至关重要，个人结合自己的工作经历，整理了几种常见的机器被黑情况供参考：<br />背景信息：以下情况是在CentOS 6.9的系统中查看的，其它Linux发行版类似。
<a name="Gzd0N"></a>
### 1、入侵者可能会删除机器的日志信息
可以查看日志信息是否还存在或者是否被清空，相关命令示例：<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749895846-73f238a8-6d13-4ac7-9081-70e0f6ec3658.png#averageHue=%23f4f4f3&clientId=uc2ad0a7d-6910-4&from=paste&id=u90c4239d&originHeight=428&originWidth=543&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u5f4aaaea-77b4-476a-a1ff-cfcf5d239dc&title=)
<a name="vmzyn"></a>
### 2、入侵者可能创建一个新的存放用户名及密码文件
可以查看/etc/passwd及/etc/shadow文件，相关命令示例：<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749895837-0f06d3b3-7f76-4c75-85f2-cda983c4c5ca.png#averageHue=%23f2f2f1&clientId=uc2ad0a7d-6910-4&from=paste&id=u4ec6b50f&originHeight=237&originWidth=479&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc74e4e2f-f241-4d3c-a735-26348a6cdcf&title=)
<a name="JzpiW"></a>
### 3、入侵者可能修改用户名及密码文件
可以查看/etc/passwd及/etc/shadow文件内容进行鉴别，相关命令示例：<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749895773-1facb7dc-d667-4c44-ac82-6036124c43ca.png#averageHue=%23f3f2f2&clientId=uc2ad0a7d-6910-4&from=paste&id=ubf8fa47a&originHeight=310&originWidth=486&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u87c94ab1-3acb-4096-9614-db1254e03a3&title=)
<a name="MnxVe"></a>
### 4、查看机器最近成功登陆的事件和最后一次不成功的登陆事
对应日志“/var/log/lastlog”，相关命令示例：<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749895840-354f8069-76cf-4e3f-a67d-1aaa86f2f133.png#averageHue=%23f3f2f2&clientId=uc2ad0a7d-6910-4&from=paste&id=ua8590d47&originHeight=164&originWidth=530&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud3ecc24e-6e87-4509-ab3c-f43b9802a0b&title=)
<a name="OvdgN"></a>
### 5、查看机器当前登录的全部用户
对应日志文件“/var/run/utmp”，相关命令示例：<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749895815-e7f1fba3-5807-4ecc-98f8-b78148581a0f.png#averageHue=%23f3f2f1&clientId=uc2ad0a7d-6910-4&from=paste&id=u95d00a1f&originHeight=94&originWidth=440&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub026a1d4-350a-47a9-8383-5163538d500&title=)
<a name="ycvHA"></a>
### 6、查看机****器创建以来登陆过的用户
对应日志文件“/var/log/wtmp”，相关命令示例：<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896116-6f73d638-4b63-4e32-b925-9f2b4783f826.png#averageHue=%23f2f1f1&clientId=uc2ad0a7d-6910-4&from=paste&id=u37d2e8b5&originHeight=167&originWidth=528&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u830bd7ff-43b5-4a44-904c-eeb8e8d1b2c&title=)
<a name="E7KNd"></a>
### 7、查看机器所有用户的连接时间（小时）
对应日志文件“/var/log/wtmp”，相关命令示例：![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896223-a56720a9-0faa-4a40-941f-e5baae260c4e.png#averageHue=%23f4f3f3&clientId=uc2ad0a7d-6910-4&from=paste&id=ue3436199&originHeight=282&originWidth=466&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8a15fd59-ecd0-4cea-942e-5cc37763360&title=)
<a name="il86z"></a>
### 8、如果发现机器产生了异常流量
可以使用命令“tcpdump”抓取网络包查看流量情况或者使用工具”iperf”查看流量情况
<a name="g1pEd"></a>
### 9、可以查看/var/log/secure日志文件
尝试发现入侵者的信息，相关命令示例：![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896242-9d83de6a-e70c-4281-b604-7d1217a48da9.png#averageHue=%23f1f0ef&clientId=uc2ad0a7d-6910-4&from=paste&id=u2502d06e&originHeight=298&originWidth=566&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3b29dac5-1b62-43c6-ad83-923f6a71e5b&title=)
<a name="AIuGO"></a>
### 10、查询异常进程所对应的执行脚本文件

1. top命令查看异常进程对应的PID

![](https://cdn.nlark.com/yuque/0/2023/jpeg/396745/1672749896334-76910214-fcc8-40e7-a3d8-2d569c195dc4.jpeg#averageHue=%233c3b37&clientId=uc2ad0a7d-6910-4&from=paste&id=uc57a3d61&originHeight=143&originWidth=554&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud49bded1-8da5-4304-a33d-d965770fd00&title=)

2. 在虚拟文件系统目录查找该进程的可执行文件

![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896389-5afe2df1-b72a-4722-b8f1-7695ab9fbd11.png#averageHue=%23f2f1f1&clientId=uc2ad0a7d-6910-4&from=paste&id=u0a38774b&originHeight=173&originWidth=498&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ub1dbdd1e-c938-4d23-8ea2-43fcd406f39&title=)
<a name="dWHz9"></a>
### 11、如果确认机器已被入侵，重要文件已被删除，可以尝试找回被删除的文件Note:
1、当进程打开了某个文件时，只要该进程保持打开该文件，即使将其删除，它依然存在于磁盘中。这意味着，进程并不知道文件已经被删除，它仍然可以向打开该文件时提供给它的文件描述符进行读取和写入。除了该进程之外，这个文件是不可见的，因为已经删除了其相应的目录索引节点。<br />2、在/proc 目录下，其中包含了反映内核和进程树的各种文件。/proc目录挂载的是在内存中所映射的一块区域，所以这些文件和目录并不存在于磁盘中，因此当对这些文件进行读取和写入时，实际上是在从内存中获取相关信息。大多数与 lsof 相关的信息都存储于以进程的 PID 命名的目录中，即 /proc/1234 中包含的是 PID 为 1234 的进程的信息。每个进程目录中存在着各种文件，它们可以使得应用程序简单地了解进程的内存空间、文件描述符列表、指向磁盘上的文件的符号链接和其他系统信息。lsof 程序使用该信息和其他关于内核内部状态的信息来产生其输出。所以lsof 可以显示进程的文件描述符和相关的文件名等信息。也就是通过访问进程的文件描述符可以找到该文件的相关信息。<br />3、当系统中的某个文件被意外地删除了，只要这个时候系统中还有进程正在访问该文件，那么就可以通过lsof从/proc目录下恢复该文件的内容。<br />假设入侵者将/var/log/secure文件删除掉了，尝试将/var/log/secure文件恢复的方法可以参考如下：

1. 查看/var/log/secure文件，发现已经没有该文件

![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896490-e8bd1fd6-9310-4f32-971f-3485ca84c953.png#averageHue=%23f1efee&clientId=uc2ad0a7d-6910-4&from=paste&id=uf0a99a9b&originHeight=58&originWidth=481&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u06c3b1b1-01e3-4434-a3f4-235b23bdb0d&title=)

2. 使用lsof命令查看当前是否有进程打开/var/log/secure，

![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896600-1360cb25-db94-4f21-a2c5-78f6f2a45bbc.png#averageHue=%23f2f1f0&clientId=uc2ad0a7d-6910-4&from=paste&id=u83ce1367&originHeight=79&originWidth=527&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u751d4827-40a7-4341-b5df-b0336c580e1&title=)

3. 从上面的信息可以看到 PID 1264（rsyslogd）打开文件的文件描述符为4。同时还可以看到/var/log/ secure已经标记为被删除了。因此可以在/proc/1264/fd/4（fd下的每个以数字命名的文件表示进程对应的文件描述符）中查看相应的信息，如下：

![](https://cdn.nlark.com/yuque/0/2023/jpeg/396745/1672749896618-5e160d37-fbfc-466b-887d-b8c6f2e04d24.jpeg#averageHue=%23e8e8e5&clientId=uc2ad0a7d-6910-4&from=paste&id=u1a38d37d&originHeight=562&originWidth=568&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u6d5fd3ca-3160-44a7-9f05-738d6266cf6&title=)

4. 从上面的信息可以看出，查看/proc/1264/fd/4就可以得到所要恢复的数据。如果可以通过文件描述符查看相应的数据，那么就可以使用I/O重定向将其重定向到文件中，如:

![](https://cdn.nlark.com/yuque/0/2023/png/396745/1672749896818-b97cffeb-958e-4cee-a351-d6042e2207a5.png#averageHue=%23f0edeb&clientId=uc2ad0a7d-6910-4&from=paste&id=u702c62ec&originHeight=25&originWidth=460&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=udcc7da11-62e3-4f56-823c-363e2b4b0f6&title=)

5. 再次查看/var/log/secure，发现该文件已经存在。对于许多应用程序，尤其是日志文件和数据库，这种恢复删除文件的方法非常有用。

![](https://cdn.nlark.com/yuque/0/2023/jpeg/396745/1672749896768-28fa9ac4-609a-4ced-9788-1bc6c4f09ad9.jpeg#averageHue=%23e8e9e6&clientId=uc2ad0a7d-6910-4&from=paste&id=udbee1e58&originHeight=704&originWidth=567&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u65128549-94e5-4393-97ef-8fb501cf1f5&title=)
