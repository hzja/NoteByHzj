WiFi<br />Wi-Fi和4G/5G蜂窝网络，是上网时最常用的两种接入方式。<br />这两种接入方式，平时在上网时似乎没感觉到有什么区别。然而，它们却是完全不同的**设计哲学**。<br />蜂窝网络以基站为小区中心，基站承担了小区的中央控制、用户授权和调度。<br />以5G为例，基站在每个帧中广播同步信号块SSB。SSB包含了小区的PCI（物理小区标识）、基站的同步时间信息、空口信息、接入控制等参数。<br />手机在确认同步信号后，通过随机接入信道PRACH，发送接入前导序列Preamble，以此获取基站授权接入。不同的用户，采用不同的ZC正交序列来区分。<br />在接入后，无线信道分配好上下行时隙（这里特指TDD网络），基站和所有终端都在固定的时间内进行数据发送或接收。这种设计理念以基站作为小区中心，采用中心规划的设计哲学。<br />而Wi-Fi网络则不同。<br />Wi-Fi在设计时，将AP接入点（这里AP的功能等同于5G中的基站）和用户终端放在同等的位置考虑。基于802.11协议的AP和终端，采用了载波侦听多路访问/碰撞避免（CSMA/CA）的方式，来平等竞争占用无线信道。<br />AP和终端、终端与终端之间，在接入网络时先进行无线信道侦听。在确保信道没被占用的情况下，接入网络。设备之间并不分层级，而是采用自协调竞争接入的模式，访问网络。<br />从某种意义上，**Wi-Fi网络是一种去中心化的设计哲学**。<br />这两种设计哲学，各有千秋。<br />蜂窝网络考虑的侧重点，是多设备接入时的容量和效率。而Wi-Fi，由于其使用非授权频谱以及成本上考量，设计时更加侧重于抗干扰、低成本等特性。<br />两种方案都能让信道得到充分的利用。参考Aruba Networks发布的测试结果可以看出，LTE和Wi-Fi 6在MAC层面的频谱使用效率非常接近，单流、256QAM的情况下，都能到5bps/Hz以上的频谱使用效率。<br />![图 1 LTE与Wi-Fi在频谱使用效率上的对比（勘误：图中Mbps应为bps）](https://cdn.nlark.com/yuque/0/2022/png/396745/1657079167044-ce6684a3-a171-4914-9a3b-08d3c367b931.png#clientId=ufa6ea81e-94e8-4&from=paste&id=u5f846235&originHeight=347&originWidth=606&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u17683288-d138-4319-abd9-88592e101fe&title=%E5%9B%BE%201%20LTE%E4%B8%8EWi-Fi%E5%9C%A8%E9%A2%91%E8%B0%B1%E4%BD%BF%E7%94%A8%E6%95%88%E7%8E%87%E4%B8%8A%E7%9A%84%E5%AF%B9%E6%AF%94%EF%BC%88%E5%8B%98%E8%AF%AF%EF%BC%9A%E5%9B%BE%E4%B8%ADMbps%E5%BA%94%E4%B8%BAbps%EF%BC%89 "图 1 LTE与Wi-Fi在频谱使用效率上的对比（勘误：图中Mbps应为bps）")
<a name="tePKK"></a>
## █ 接入过程与漫游
那么，没有中心控制的Wi-Fi，具体是怎么协作接入的呢？<br />首先第一步，是寻找Wi-Fi网络。<br />由于Wi-Fi网络中AP没有广播功能，终端是不可能预先知道是否有可用的网络资源以及AP参数的。<br />这里，终端采用了一种主动探针的方式来进行请求。<br />终端会在Wi-Fi的第一个20MHz频道上，发送一系列探针序列，然后等待AP回应。<br />如果20ms后AP没有回应的话，终端将切换到下一个20MHz频道，重复上述动作，直到收到AP的回应，确认AP的工作频段和接入参数才能接入网络。<br />![图 2 手机进行主动扫探针搜寻信道过程](https://cdn.nlark.com/yuque/0/2022/png/396745/1657079166997-67cb26a9-e21f-49ef-a252-5f6f04fe3657.png#clientId=ufa6ea81e-94e8-4&from=paste&id=u39db86e8&originHeight=427&originWidth=936&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u13ca5921-8416-4d6c-9e3e-aa330ee9652&title=%E5%9B%BE%202%20%E6%89%8B%E6%9C%BA%E8%BF%9B%E8%A1%8C%E4%B8%BB%E5%8A%A8%E6%89%AB%E6%8E%A2%E9%92%88%E6%90%9C%E5%AF%BB%E4%BF%A1%E9%81%93%E8%BF%87%E7%A8%8B "图 2 手机进行主动扫探针搜寻信道过程")<br />写到这里，可能会想到，如果室内有多个Wi-Fi AP，当用户在移动，终端从一个AP切换到另一个AP时，还要重复上述的AP搜寻过程吗？<br />每个频道20ms，搜索一圈信道下来，需要较长时间，连接岂不是会中断？那还怎么确保视频会议或者微信语音的通信质量呢？<br />现在的办公室甚至现在很多家庭无线局域网，都会采用多AP mesh组网的方式，来提高网络覆盖性能。<br />如果每次终端切换AP时，都重新做上述的主动探针搜寻信道过程，将是会非常低效的。好在802.11工作组考虑到了小区切换的问题，在802.11k中开发了**“邻居报告”**的协议。<br />设备在接入AP后，该AP会将其附近AP的BSSID和频道信息发送给用户。这样一来，用户在需要切换到另一个AP时，就不用再扫描一遍频道了。<br />这样做的好处，一来是极大节省了切换时间，保证通信不出现中断。二来是给用户设备省电，设备不再需要发送一个个探针。第三，就是无线信道也得到了更加有效的利用，AP不需要频繁占用无线信道来不断回应终端的请求。<br />![图 3 AP通过802.11k协议回应终端设备其邻近AP的信息](https://cdn.nlark.com/yuque/0/2022/jpeg/396745/1657079167050-a38cfbe9-0665-413e-aaea-111f65a7952d.jpeg#clientId=ufa6ea81e-94e8-4&from=paste&id=u220e63b5&originHeight=402&originWidth=550&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u99ec3c07-6aa9-4b65-9694-22a37475728&title=%E5%9B%BE%203%20AP%E9%80%9A%E8%BF%87802.11k%E5%8D%8F%E8%AE%AE%E5%9B%9E%E5%BA%94%E7%BB%88%E7%AB%AF%E8%AE%BE%E5%A4%87%E5%85%B6%E9%82%BB%E8%BF%91AP%E7%9A%84%E4%BF%A1%E6%81%AF "图 3 AP通过802.11k协议回应终端设备其邻近AP的信息")
<a name="hpvVS"></a>
## █ 自我协调，信道竞争接入，避免冲突
接入网络后，AP和终端们便开始竞争无线信道的使用。<br />在Wi-Fi系统中，终端和AP的空口时间统一被分为空闲（Idle）和机会发送（TXOP）时段。没有数据时，设备属于空闲期，不会发送任何信息。<br />当设备收到数据发送请求时，设备开始进入争夺无线信道的“仲裁”（Arbitration）过程。没有中央调度器，所有设备按照数据优先级采用“公平竞争”模式来赢得信道仲裁。赢得信道的设备，将会得到6ms的机会发送窗，然后进入下一个仲裁期。<br />![图 4 802.11中的空口时间分配](https://cdn.nlark.com/yuque/0/2022/png/396745/1657079166969-5a99ed02-d2f6-4c17-a723-63fe65f31971.png#clientId=ufa6ea81e-94e8-4&from=paste&id=u0e0f21a3&originHeight=177&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u68dc6103-fbc9-417b-8040-f0d8c80833d&title=%E5%9B%BE%204%20802.11%E4%B8%AD%E7%9A%84%E7%A9%BA%E5%8F%A3%E6%97%B6%E9%97%B4%E5%88%86%E9%85%8D "图 4 802.11中的空口时间分配")<br />进入仲裁过程的Wi-Fi设备，首先开启信道侦听模式，RF接收机对无线信道中的802.11信号进行监测（Signal Detection）。如果侦听到的信号强度低于其SD阈值（以下图思科的方案为例，阈值为-82dBm）时，设备判定目前信道没有其他Wi-Fi设备在使用。<br />由于Wi-Fi使用的频段属于免授权频段，需要与非802.11设备共享使用，比如蓝牙，遥控器，微波炉等等。那么，在判断信道占用情况时，不仅仅需要能对自身802.11协议的信号进行监测，还需要对不明通信协议的功率进行检测。<br />这里就引出了第二个检测机制——**能量检测（Energy Detection）**。<br />ED的作用，是判断无线信道没有被其他非Wi-Fi设备占用，防止发送的有用Wi-Fi信号被淹没在噪声中，通常ED的门限比SD高20dB。<br />![图 5 思科无线设备的SD，ED设定](https://cdn.nlark.com/yuque/0/2022/png/396745/1657079167044-c079fdc4-ab73-4cd3-a062-27a44c09f563.png#clientId=ufa6ea81e-94e8-4&from=paste&id=u2543a6bc&originHeight=537&originWidth=1043&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=ud4ff5a0e-efd2-45c9-ac6e-71848094c7b&title=%E5%9B%BE%205%20%E6%80%9D%E7%A7%91%E6%97%A0%E7%BA%BF%E8%AE%BE%E5%A4%87%E7%9A%84SD%EF%BC%8CED%E8%AE%BE%E5%AE%9A "图 5 思科无线设备的SD，ED设定")<br />细心的用户可能会发现，在网络环境不好的情况下，视频通话时经常有能听到声音但图像被卡住的现象。这其实是Wi-Fi的一种发送优化措施，用于保障最基本的服务。<br />**Wi-Fi将数据分为四种不同的优先级，从上到下分别为语音（VO），视频（VI），最大努力（BE）和背景（BK）。**每一个级别，都会附上不同的AIFS值。AIFS值越低，发送优先级越高。<br />在AIFS时间结束之后，设备便进入了竞争窗口（CW），设备开始侦听无线信道，同时开始倒计时准备发送。<br />当CW倒计时结束时，如果设备发现信道正在占用，设备便自动进入下一个仲裁期。如果设备发现信道处于空闲状态，便开始占用信道，发送数据。<br />下图这个例子，在第一个仲裁期中，IPad的CW时间最短，竞争信道成功，获得了发送权。在IPad数据发送后，一轮新的仲裁开始，手机在CW结束后，发现信道没有被占用，获得了发送权。最终，无线AP赢得了第三轮仲裁，获得发送权。<br />![图 6 多设备信道竞争过程](https://cdn.nlark.com/yuque/0/2022/png/396745/1657079167400-2a3e0dc8-38c4-43b9-af82-209fe2485e1c.png#clientId=ufa6ea81e-94e8-4&from=paste&id=u3c86d27f&originHeight=461&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u462a116b-47ce-4a7e-9ea3-8ccc7dfdca3&title=%E5%9B%BE%206%20%E5%A4%9A%E8%AE%BE%E5%A4%87%E4%BF%A1%E9%81%93%E7%AB%9E%E4%BA%89%E8%BF%87%E7%A8%8B "图 6 多设备信道竞争过程")<br />读到这里，可能会发现，这个竞争过程在设备增多的情况下，效率会明显降低，每个设备的等待发送时间将会变长很多。<br />实际体验中，可能也注意到了，在Wi-Fi设备多的公共环境，比如商场、学校中，经常需要等待很长时间，才能发送或接收数据。<br />那么，很有可能是网络还没有升级到最新的Wi-Fi 6。<br />Wi-Fi 6可以说是Wi-Fi行业过去十多年中最大的一次革新。
