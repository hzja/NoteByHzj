网络 QoS
<a name="ixpg9"></a>
## 1、QoS的产生
随着网络技术的飞速发展，IP网络已经从当初的单一数据网络向集成数据、语音、视频、游戏的多业务网络转变。网络中所承载的数据呈几何级倍数增长，而且这些业务对网络带宽、时延有着极高的要求。同时，由于硬件芯片研发的难度大、周期长、成本高等原因，带宽逐渐成为互联网发展的瓶颈，导致网络发生拥塞，产生丢包，业务质量下降，严重时甚至造成业务不可用。<br />要在IP网络上开展这些业务，就必须解决网络拥塞问题，最好的解决办法是增加网络带宽。但从运营、维护的成本考虑，一味增加网络带宽是不现实的。<br />QoS（Quality of Service，服务质量）技术就是在这种背景下发展起来的。QoS技术本身不会增加网络带宽，而是在有限的带宽资源下，如何平衡地为各种业务分配带宽，针对各种业务的不同需求，为其提供端到端的服务质量保证。
<a name="xPpc7"></a>
## 2、QoS的度量标准
既然要提高网络质量，首先需要了解一下哪些因素会影响网络的服务质量。从传统意义上来讲，影响网络质量的因素包括传输链路的带宽、报文传送时延和抖动、以及丢包率等。因此，要提高网络的服务质量，就可以从保证传输链路的带宽，降低报文传送的时延和抖动，降低丢包率等方面着手。而这些影响网络服务质量的因素，也就成为QoS的度量指标。
<a name="g6Hbb"></a>
### 2.1  带宽
带宽也称为吞吐量，是指在一个固定的时间内（1秒），从网络一端传输到另一端的最大数据位数，也可以理解为网络的两个节点之间特定数据流的平均速率。带宽的单位是比特/秒（bit/s）。<br />在网络中，有两个常见的与带宽有关的概念：上行速率和下行速率。上行速率是指用户向网络发送信息时的数据传输速率，下行速率是指网络向用户发送信息时的传输速率。例如，用户用FTP上传文件到网络，影响上传文件速度的就是上行速率；而从网络下载文件，影响下载文件速度的就是下行速率。<br />通常情况下，带宽越大，数据通行能力就越强，网络服务质量就越好。这就好比高速公路，车道越多，车辆通行能力就越强，发生堵车的概率就越低。对于网络用户而言，都希望带宽越大越好，但是与其相应的，网络运营和维护成本也就越高。因此，在互联网日益强大和业务多样化的情况下，带宽成为了严重的瓶颈。
<a name="B1pJe"></a>
### 2.2  时延
时延是指一个报文或分组从网络的发送端到接收端所需要的延迟时间，一般由传输延迟及处理延迟组成。<br />以语音传输为例，时延是指从说话者开始说话到对方听到所说内容的时间。一般人们察觉不到小于100毫秒的延迟。当延迟在100毫秒和300毫秒之间时，说话者可以察觉到对方回复的轻微停顿，这种停顿可能会使通话双方都感觉到不舒服。超过300毫秒，延迟就会很明显，用户开始互相等待对方的回复。当通话的一方不能及时接收到期望的回复时，说话者可能会重复所说的话，这样会与远端延迟的回复碰撞，导致重复。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1636767747369-e4f342ba-58a2-4347-a9c5-9d3727e2f463.webp#clientId=udaf43f4a-7a1d-4&from=paste&id=u3dd3b468&originHeight=269&originWidth=554&originalType=url&ratio=1&status=done&style=shadow&taskId=u62754ea0-8fff-441b-8079-637b0cd803d)<br />图1 时延对网络质量的影响
<a name="qjn5c"></a>
### 2.3  抖动
如果网络发生拥塞，导致通过同一连接传输的分组延迟各不相同。抖动用来描述延迟变化的程度，也就是最大延迟与最小延迟的时间差。<br />如下图所示，员工A向员工B发送一句语音“**我留，他不留**“。假设每个字是一个分组，发送端将语音分割为6个分组，以均匀的时间间隔顺序发出。由于IP网络的复杂性，每个分组时延可能不同，导致在接收端收到分组时各分组之间的时间间隔与发送时的时间间隔不一致。加上说话者的语气等因素，员工B可能会将接收到的语音理解成“**我留他？不留！**”，从而造成语义上的误解。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1636767747321-1a5ef6d0-2dc8-4f95-9c26-6bd8e7e179ae.webp#clientId=udaf43f4a-7a1d-4&from=paste&id=uc48efc37&originHeight=498&originWidth=478&originalType=url&ratio=1&status=done&style=shadow&taskId=ub43ab491-2a6e-47ec-9dcb-caa42b74109)<br />图2 抖动对网络质量的影响<br />所以抖动对于实时性的传输是一个重要参数，特别是语音和视像等实时业务是极不容忍抖动的，抖动会造成语音或视像的断续。<br />抖动也会影响一些网络协议的处理。有些协议是按固定的时间间隔发送交互性报文，抖动过大会导致协议震荡。<br />所有传输系统都有抖动，只要抖动在规定容差之内就不会影响服务质量。利用缓存可以克服过量的抖动，但这将增加时延。
<a name="WOD6A"></a>
### 2.4  丢包率
丢包率是指在网络传输过程中丢失报文的数量占传输报文总数的百分比。少量的丢包对业务的影响并不大，例如，在语音传输中，丢失一个比特或一个分组的信息，通话双方往往注意不到。在视频的传输中，丢失一个比特或一个分组可能造成在屏幕上瞬间的波形干扰，但能很快恢复正常。<br />使用TCP传送数据可以处理少量的丢包，因为TCP允许丢失的信息重发。但大量的丢包会影响传输效率。在QoS中，关注的是丢包的统计数据，也就是丢包率。所以正常传输时，网络丢包率应该控制在一定范围内即可。
<a name="w78ax"></a>
## 3、QoS服务模型
现在已经了解了QoS的度量指标。那么，如何在网络中通过部署来保证这些指标在一定的合理范围内，从而提高网络的服务质量呢？这就涉及到QoS模型。需要说明的是，QoS模型不是一个具体功能，而是端到端QoS设计的一个方案。例如，网络中的两个主机通信时，中间可能会跨越各种各样的设备。只有当网络中所有设备都遵循统一的QoS服务模型时，才能实现端到端的质量保证。IETF、ITU-T等国际组织都为自己所关注的业务设计了QoS模型。下面就来介绍一下主流的三大QoS模型。
<a name="DB56S"></a>
### 3.1  Best-Effort服务模型
Best-Effort是最简单也是最早出现的QoS服务模型。在这种模型中，网络中的设备上除了保证网络之间路由可达之外，不需要部署额外的功能。应用程序可以在任何时候发出任意数量的报文，而且不需要通知网络。网络只是尽最大的可能性来发送报文，但对时延、可靠性等性能不提供任何保证。<br />在理想状态下，如果有足够的带宽，Best-Effort是最简单的服务模式。而实际上，这种“简单“带来一定的限制。因此，Best-Effort适用于对时延、可靠性等性能要求不高的业务，如FTP、E-Mail等。
<a name="yDyUD"></a>
### 3.2   IntServ服务模型
由于网络带宽的限制，Best-Effort服务模型不能为一些实时性要求高的业务提供有力的质量保障，于是IETF在1994年的RFC1633中提出了InterServ模型。<br />IntServ模型是指应用程序在发送报文前，首先通过RSVP（Resource Reservation Protocol）信令向网络描述它的流量参数。网络在流量参数描述的范围内，预留资源（如带宽、优先级）以承诺满足该请求。在收到确认信息，确定网络已经为这个应用程序的报文预留了资源后，应用程序才开始发送报文。应用程序发送的报文应该控制在流量参数描述的范围内。网络节点需要为每条数据流维护一个状态，并基于这个状态执行相应的QoS动作，来满足对应用程序的承诺。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1636767747340-2fbabaf9-054a-47d4-a3f9-dd670f4adff7.webp#clientId=udaf43f4a-7a1d-4&from=paste&id=u4fe1c704&originHeight=225&originWidth=527&originalType=url&ratio=1&status=done&style=shadow&taskId=ubca027dd-6940-40e6-b7c4-5bcfa2433fb)<br />图3 IntServ服务模型<br />简单来说，InterServ模型下，网络需要为某个业务预留一条专用通道。这种资源预留的状态称为“软状态”。为了保证这条通道不被占用，RSVP会定期发送大量协议报文进行探测。通过RSVP，各网元可以判断是否有足够的资源可以预留。只有所有的网元都预留了足够的资源，专用通道方可建立。<br />IntServ模型为业务提供了一套端到端的保障制度，其优点显而易见，但是其局限性一样明显。

- **实现难度大：**IntServ模型要求端到端所有网络节点支持。而网络上存在不同厂商的设备，核心层、汇聚层和接入层的设备功能参差不齐，要所有节点都支持IntServ模型，很难达到这方面要求。
- **资源利用率低：**为每条数据流预留一条路径，意味着一条路径只为一条数据流服务而不能为其他数据流复用。这样导致有限的网络资源不能得到充分的利用。
- **带来额外带宽占用：**为了保证这条通道不被占用，RSVP会发送大量协议报文定期进行刷新探测，这在无形中增大了网络的负担。
<a name="Oq53Q"></a>
### 3.3  DiffServ服务模型
为了克服InterServ的可扩展性差的问题，IETF在1998年提出了DiffServ服务模型。<br />DiffServ服务模型，也叫差分服务模型，意思就是提供有差别的服务。就好比银行有黑金卡用户、金卡用户和普通卡用户，银行为不同用户提供的服务也不相同：黑金卡用户享有专人专区服务；金卡用户不能享有专人专区的服务，但是可以享受优先办理业务的特权；普通卡用户则只能按照正常的排队顺序办理业务。这就银行提供的差分服务。<br />DiffServ模型中，网络中的流量可以根据多种条件被分成多个类，或者标记不同的优先级。这个过程类似于将报文分为黑金卡用户、金卡用户和普通卡用户。当网络出现拥塞时，不同的类会享受不同的优先处理，从而实现差分服务。同一类的业务在网络中会被聚合起来统一发送，保证相同的延迟、抖动、丢包率等QoS指标。<br />DiffServ模型不需要信令，也不需要预先向网络提出资源申请。业务分类和汇聚工作在网络的边缘节点进行，后续设备根据分类识别出不同的业务，并提供相应的服务。<br />当前网络中承载的业务类型越来越多，DiffServ模型显得相当灵活，可以说是为现在的网络量身定做的。因此，DiffServ模型成为QoS设计和应用的主要方案。
<a name="ZJAas"></a>
## 4、基于DiffServ模型的QoS组成及应用
DiffServ模型包含了四大组件，通过这四大组件实现端到端的QoS：

- 报文分类和标记

要实现差分服务，首先需要将报文分为不同的类别。类别确定好了，设备才能针对性地提供服务。

- 流量监管、流量整形和接口限速

**流量监管**是将流量限制在特定的带宽内。当业务流量超过额定带宽时，超过的流量将被丢弃。这样可以防止个别业务或用户无限制地占用带宽。<br />**流量整形**是一种主动调整流的输出速率的流控措施，使流量比较平稳地传送给下游设备，避免不必要的报文丢弃和拥塞。流量整形通常在**接口出方向**使用。<br />**接口限速**是对一个接口上发送或者接收全部报文的总速率进行限制。当不需要对报文类型进行进一步细化分类而要限制通过接口全部流量的速率时，接口限速功能可以简化配置。

- 拥塞管理

**拥塞管理**是在网络发生拥塞时，通过一定的调度算法安排报文的转发次序，保证网络可以尽快恢复正常。拥塞管理通常在**接口出方向**使用。

- 拥塞避免

**拥塞避免**可以监视网络资源（如队列或内存缓冲区）的使用情况。在拥塞有加剧的趋势时，主动丢弃报文，避免网络拥塞继续加剧。拥塞管理通常在**接口出方向**使用。<br />**综上所述，报文分类是基础，是有区别地实施服务的前提，流量监管、流量整形和接口限速主要用于预防拥塞，拥塞管理和拥塞避免是用来解决拥塞。**<br />QoS各个组件在设备上的处理顺序如下图所示。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1636767747340-d25d1583-eaa0-4ab2-afd7-0b2bc313311c.webp#clientId=udaf43f4a-7a1d-4&from=paste&id=ucaac3419&originHeight=188&originWidth=497&originalType=url&ratio=1&status=done&style=shadow&taskId=u9a40ec7d-6949-4835-9451-8f8b636e0c5)<br />图4 QoS技术处理流程
<a name="R5YDD"></a>
## 5、QoS在企业网中的应用
在企业网络中，QoS的一系列技术不要求在同一台设备上应用，而应根据业务需要在不同位置应用。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1636767747695-71e189cd-a539-4e3b-801d-d7a3d6e45099.webp#clientId=udaf43f4a-7a1d-4&from=paste&id=u6cbaf8c5&originHeight=380&originWidth=220&originalType=url&ratio=1&status=done&style=shadow&taskId=uc361c556-a032-4cb3-88db-76f2602fecd)<br />图5 QoS技术在企业网络中的应用<br />理论上来说，各层次设备的功能如下：

- 接入层业务识别

接入交换机LSW1作为边界交换机，在接入侧需要担负数据流的识别、分类以及流标记的工作；在网络侧需要担负不同应用数据流的拥塞管理、拥塞避免、流量整形等工作。

- 汇聚层/核心层提供差分服务

汇聚层和核心层设备端口信任基于接入层标识的QoS参数，通过队列调度、流量整形、拥塞避免等方式实施QoS策略，保证高优先级业务优先获得调度。<br />而实际应用时，具体功能的部署完全取决于业务需求。在图5的组网中，可以在SwitchA应用报文分类和标记，用以区分不同部门的报文，然后在接口GE1/0/2出方向应用流量监管，限制进入广域网的流量。如果不需要区分来自不同部门的报文，可以直接在接口GE1/0/2出方向应用接口限速，限制进入广域网的流量。<br />当然，同一种QoS技术，也可能因为应用的位置不同而作用范围不同。如图5所示，如果在LSW1的接口GE0/0/1和GE0/0/2应用出方向接口限速，则可以分别保证部门1、部门2可以使用的最大带宽。如果在SwitchA的接口GE1/0/1应用入方向接口限速，则保证的是部门1和部门2一共可以使用的最大带宽，并不能保证部门1、部门2分别可以使用的最大带宽。
<a name="aLXjI"></a>
## 6、结束语
QoS的各个组成部分与QoS的度量指标并不是一一对应的。也就是说，并不是一个QoS组成就能保证一项QoS指标。实际上，QoS的各个组成部分是通过相互结合使用来保证服务质量的。例如，报文分类和标记是实现差分服务的前提和基础。流量监管、流量整形、接口限速、拥塞管理和拥塞避免是根据分类或标记结果，从不同方面对网络流量及其分配的资源实施控制，是提供差分服务的具体体现。
