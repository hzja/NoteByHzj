本来以为可以搞自主研发然后摸摸鱼的一天，没想到项目经理来了一句"勒索病毒应急",属实无奈，作为有理想有志气有信仰的安服仔，毅然接受任务远程应急。

<a name="B7bW7"></a>
## 隔离感染主机
第一步处理需要控制内网传染，需要把沦陷的服务器进行隔离，就是拔掉网线、网卡关闭掉。<br />因为沦陷的服务器在客户的某个集群中，所以客户提供远程连接即可通过web访问目标主机进行远程主机排查。
<a name="H6DFg"></a>
## 确定勒索特征
感染目标系统后，勒索病毒会以 .txt 文本格式及可执行 Web 文件（.HTA）格式，扔下两个勒索信息文件。后者将完成加密文件后，自动打开。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651766790664-c8222ab2-cc75-4ffa-a2b2-f2ef618cc560.png#clientId=u71025785-9cc0-4&from=paste&height=458&id=u14697903&originHeight=572&originWidth=933&originalType=binary&ratio=1&rotation=0&showTitle=false&size=346235&status=done&style=none&taskId=u4b21aadb-de0c-429d-81f2-994b7c8f412&title=&width=746.4)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651820298371-08f849de-0c6e-4dc3-9099-9992e1d473df.png#clientId=uefe84aed-a146-4&from=paste&height=133&id=u44183b46&originHeight=166&originWidth=734&originalType=binary&ratio=1&rotation=0&showTitle=false&size=81024&status=done&style=none&taskId=u41559d23-35bc-47a7-b423-432ea916edf&title=&width=587.2)<br />此次勒索软件变种使用了“RSA+AES”加密算法对文件进行加密，加密后的文件名为：<br /><原文件名>+<原文件后缀名>+<勒索信中的个人ID>+<联系邮箱>+<.Elbie><br />根据勒索信息与加密文件后缀名(.Elbie)可初步确定为Phobos家族勒索病毒。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651819793173-177969f1-45fd-486e-b49e-d5a8eaa481e5.png#clientId=uefe84aed-a146-4&from=paste&height=216&id=ue3f7b6fa&originHeight=212&originWidth=538&originalType=binary&ratio=1&rotation=0&showTitle=false&size=87134&status=done&style=none&taskId=ua110d251-08c4-4903-bdcc-f565dc86d6a&title=&width=548.3999938964844)

<a name="P60LN"></a>
## 溯源以及后门排查
登陆到目标服务器中进行排查，发现文件加密时间均为2022年5月05日凌晨2:56分。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651847816267-4669d434-5986-46a1-bfe5-4e2368ce0d31.png#clientId=u0411ccd3-b552-4&from=paste&height=228&id=ue543800b&originHeight=285&originWidth=1015&originalType=binary&ratio=1&rotation=0&showTitle=false&size=212402&status=done&style=none&taskId=u3a77a3e6-6166-48f4-9387-bc0825bdf3f&title=&width=812)

根据客户提供的信息，感染服务器存在互联网地址，发现该服务器对外开放了3389端口，通过查看windows登陆日志，发现攻击者于2022/5/5 凌晨1:31:36爆破成功登陆到服务器。攻击ip为46.xxx.xxx.213。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651821074672-fe217bad-7ed4-44c6-a0f9-f3e6619afe36.png#clientId=uefe84aed-a146-4&from=paste&height=410&id=uf9eab329&originHeight=513&originWidth=717&originalType=binary&ratio=1&rotation=0&showTitle=false&size=216082&status=done&style=none&taskId=ub16729d4-31c1-4248-9bfd-3a1efa39031&title=&width=573.6)

经过一系列的排查，才发现勒索病毒的母体伪装成cmd.exe，该文件落地时间是2022/4/1号的17:38分。msconfig可以看到在windows启动项中也会存在cmd.exe但是在注册表启动项中是不存在的，还是值得怀疑。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651839241732-731bf753-17a6-4552-9912-64cdaaa94460.png#clientId=ubaf3be0a-4069-4&from=paste&height=324&id=u52d7e72a&originHeight=405&originWidth=891&originalType=binary&ratio=1&rotation=0&showTitle=false&size=282718&status=done&style=none&taskId=ub87007df-dfa1-4280-b399-d789b1367e2&title=&width=712.8)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651848059030-c92fb2a2-8691-4fe5-9165-5a9e9e79d004.png#clientId=u0411ccd3-b552-4&from=paste&height=409&id=u5bd5d584&originHeight=511&originWidth=888&originalType=binary&ratio=1&rotation=0&showTitle=false&size=223835&status=done&style=none&taskId=u98283d33-e0b5-4652-8ab3-6da8d7e9390&title=&width=710.4)

因为远程的原因，没办法方便的取出cmd.exe的样本，只能通过对病毒cmd.exe的md5(a81420ba7028c9827e8fcd7f7a866005)进行分析<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651839345757-7e010fa4-f393-4d57-9ac9-9734e99686af.png#clientId=ubaf3be0a-4069-4&from=paste&height=158&id=u42a08244&originHeight=197&originWidth=1026&originalType=binary&ratio=1&rotation=0&showTitle=false&size=215044&status=done&style=none&taskId=ue13e315d-9423-4b9f-8bb4-6682613949a&title=&width=820.8)

通过微步分析出其勒索病毒释放的行为，发现被伪装的cmd.exe文件触发后，会对文件进行加密成Elbie后缀文件，与被感染的服务器情况一致，证实了被伪装的cmd.exe是勒索病毒的母体。<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651839380196-742ffdfd-8a93-40fb-a7fd-cfe9bc0da996.png#clientId=ubaf3be0a-4069-4&from=paste&height=487&id=u22f7ca9c&originHeight=609&originWidth=913&originalType=binary&ratio=1&rotation=0&showTitle=false&size=117614&status=done&style=none&taskId=u45ba72d1-3934-44c8-bbcf-5caf929e789&title=&width=730.4)

因为cmd.exe文件的落地时间是2022/4/1，通过日志查看，2022/4/1号5:18分，的确存在攻击者(139.162.124.90)通过RDP远程登陆过服务器<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651839469209-6aaf0543-4cec-467c-9e1e-4798eb3f4fd0.png#clientId=ubaf3be0a-4069-4&from=paste&height=493&id=u8d998979&originHeight=559&originWidth=475&originalType=binary&ratio=1&rotation=0&showTitle=false&size=225070&status=done&style=none&taskId=u1224e37f-1397-45bf-8029-75a44447118&title=&width=419)<br />至此基本可以确认，是3389端口对外开放，密码可能也不是什么复杂口令，被不怀好意的黑客入侵并投放勒索，为了防止二次感染，必须得清理服务器上存在的后门。后续清理就是按照常规的后门排查项进行。所幸的是，看安全设备后发现该勒索病毒并没有在内网中大规模传染。
<a name="PiOJK"></a>
## 感想
其实刚开始碰见Phobos勒索病毒的时候，也在freebuf看过相关的应急文章，但和他们不一样的是，他们的勒索病毒会在注册表 HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run  以及 C:\Users\user\AppData\Local  目录下会存在勒索病毒的母体，而且exe名字并不常见，一看就能看得出不正常。但是这次碰到的Phobos勒索居然是伪装成cmd.exe文件命名,并且有清理过痕迹的操作，加之是远程应急，没办法安装杀毒软件工具所以耗费了很长时间去寻找样本。<br />这次应急历时了2天，中间踩了不少坑，总结下来其实就是一套流程处理<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1651840933959-6a3eafd4-95cf-4ad3-8847-5a44aa97260a.png#clientId=ubaf3be0a-4069-4&from=paste&height=276&id=u0ab727a9&originHeight=345&originWidth=1159&originalType=binary&ratio=1&rotation=0&showTitle=false&size=60831&status=done&style=none&taskId=ue939b70a-58f7-4b42-bc7a-c8ed1978f26&title=&width=927.2)
