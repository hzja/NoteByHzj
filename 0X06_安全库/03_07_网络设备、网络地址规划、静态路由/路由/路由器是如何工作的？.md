路由器
<a name="i7jjZ"></a>
### 什么叫路由？
路由器的英文是 Router，也就是「找路的工具」。找什么路？寻找各个网络节点之间的路。<br />换句话说，路由器就像是**快递中转站**，包裹会经过一个个的中转站，从遥远的地方寄到你家附近，数据包也是一样。<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704239795-7d480745-557a-426c-9eff-076ebf2f78c9.png#clientId=ubd9af9bb-1228-4&from=paste&id=u06d04086&originHeight=620&originWidth=1034&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u2fac8f53-1eee-4543-822b-efe3be28d20&title=)<br />**路由器是连接两个网络的硬件设备，承担寻路功能，是网络的大门**，因此，路由器又叫做网关设备（Gateway）。
<a name="CK5Nu"></a>
### 路由表
路由器和交换机一样，也有自己的小本本，这个路由表上记载了**到各个网络节点之间的路**，会记录数据来源、相应的路由条目以及下一跳。<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704239804-309f6fda-16a9-4e47-b614-c2bda7a57108.png#clientId=ubd9af9bb-1228-4&from=paste&id=uf5b8f796&originHeight=625&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u01a64ecd-ea0d-4a4c-9f55-295bd68054e&title=)<br />**路由表就相当于路由器的导航**，路由器只需要按照路由表的指示走就可以了。当然前提是，路由表中存在匹配该数据包目的 IP 地址的路由条目。路由表会周期性更新，当网络拓扑发生变化时也会更新，不用担心走错路。<br />![路由器收发数据包的流程](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704239816-e8296308-5748-4070-8523-957abed2b8df.png#clientId=ubd9af9bb-1228-4&from=paste&id=ue66ed853&originHeight=308&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u59205f4f-4fd2-4311-9b3c-a63e78e9905&title=%E8%B7%AF%E7%94%B1%E5%99%A8%E6%94%B6%E5%8F%91%E6%95%B0%E6%8D%AE%E5%8C%85%E7%9A%84%E6%B5%81%E7%A8%8B "路由器收发数据包的流程")<br />路由器在收发数据包的时候会先查看路由表，如果路由表里有匹配项，就会把数据包交给下一跳。如果没有匹配项，就会直接丢弃数据包，然后告诉主机，这个目的地不可达。
<a name="BZk2e"></a>
### 直连、静态路由、动态路由
路由条目的获取来源有很多种，比如说直连、静态路由和动态路由。<br />**直连**，也就是路由器的**直接邻居**。路由器会自己去认识邻居，然后记录下来。<br />当然，也可以通过手动添加的方式告诉路由器目的网段的路径，也就是静态路由，适合网络规模比较小的场景。但是当网络拓扑发生变化，或是规模扩大的时候，配置和维护的成本就会很高。<br />这时候就需要结合**动态路由**，让路由器通过**动态的方式来学习**。在大型网络中，往往采用这种**动、静路由相结合**的方式进行部署。
<a name="OyTsh"></a>
### 三层寻址
二层寻址，大家还记得吗？二层寻址就是交换机根据 MAC 地址，在物理层进行寻址。<br />**三层寻址就是指路由器根据 IP 地址，在网络层进行寻址。**<br />![路由器三层寻址流程](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704239803-94cc9af2-e0c0-45e7-8041-4c3b1029d8a0.png#clientId=ubd9af9bb-1228-4&from=paste&id=u89e7c4e2&originHeight=334&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=u34df68f2-b473-4c22-a7a8-25e26f6b0ac&title=%E8%B7%AF%E7%94%B1%E5%99%A8%E4%B8%89%E5%B1%82%E5%AF%BB%E5%9D%80%E6%B5%81%E7%A8%8B "路由器三层寻址流程")<br />当主机想要发送数据的时候，首先会查看目的地**是否和自己在同一个网段**，如果**在同一个网段**就会让**交换机进行二层转发**。<br />如下图所示，PC1 要给 PC2 发送数据，就会通过交换机来完成。<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704239784-295c0b04-3e56-409e-b7df-74e8030587da.png#clientId=ubd9af9bb-1228-4&from=paste&id=u8ab22f10&originHeight=453&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=uabcee3a3-c3f1-4b0f-bb36-e1a0c706c3a&title=)<br />如果不在同一个网段，主机会把数据包交给自己的路由器，路由器再根据目的 IP 查询自己的路由表，如果有匹配的条目，则交给下一跳，没有就丢弃。<br />如下图所示，PC1 要给 PC3 发送数据，发现 PC3 和自己不在同一个网段，就会把数据包交给路由器 A，再根据路由表的条目转发给路由器 B -> C，最后通过交换机 C 送达 PC3。<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704240090-24286f39-ebb9-415b-b318-6c7ee28fea36.png#clientId=ubd9af9bb-1228-4&from=paste&id=u3792d734&originHeight=461&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u3eae42a0-aad2-46d3-8bfe-ee86d1aa06d&title=)
<a name="WGfzR"></a>
### 寻路原则
既然路由器是负责找路的，那条条大路通罗马，哪条大路最近呢？<br />![来源：Giphy](https://cdn.nlark.com/yuque/0/2022/gif/396745/1653704240227-ad4459b3-a9f4-48ac-9b52-1a97dfe8b4a7.gif#clientId=ubd9af9bb-1228-4&from=paste&id=u8660ea6f&originHeight=376&originWidth=500&originalType=url&ratio=1&rotation=0&showTitle=true&status=done&style=shadow&taskId=uad9ad77d-f382-418f-990a-594d53fe129&title=%E6%9D%A5%E6%BA%90%EF%BC%9AGiphy "来源：Giphy")<br />默认情况下，路由的查询遵循最**长匹配原则**，也就是**掩码越长、越精确，路由器就会优先选择那条路。**<br />然后考虑路径开销，比如说带宽、管理距离、度量值等。也就是如果从这条路走，要花上多少时间和金钱。绝大部分数据通信行为是双向的，考虑流量的时候，还要关注流量的往返，从这条路去，也得从这条路回来，回来的时候没路了，这也不行。<br />![](https://cdn.nlark.com/yuque/0/2022/jpeg/396745/1653704240237-a1c3afcb-a5c2-4856-bf3d-ef810c1ec199.jpeg#clientId=ubd9af9bb-1228-4&from=paste&id=uaf71c0e4&originHeight=870&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u9b54d0f0-783c-4f69-a1e5-27bd07cb787&title=)<br />路由查询的行为是**逐跳**的，到目标网络沿途的每个路由器都必须有关于该目标网段的路由信息。简单来说，数据包每经过一个路由器，**路由器就会告诉它下一跳是谁，该往哪个方向走。**
<a name="RyQVb"></a>
### 如何选择路由器？
路由器选型可以考虑这几个因素：**带宽需求/转发性能、端口数量、带机量。**<br />比如说家里拉了千兆宽带，那么路由器一定得是千兆路由器，还要满足千兆 NAT 转发的性能。顺带一提，运营商配的光猫是自带路由功能的，如果没有特殊需求，普通家庭一般够用了。<br />一般家用场景，路由端口用的不太多，可以通过交换机补充。大部分商用场景，4-12 口也就够了，再多的话，相信大部分企业会选择三层交换机。<br />带机量是一个很重要的指标，一般会考虑**并发用户，还有用户的业务类型。**<br />以 UniFi 的网关设备为例：USG 可以到 100 并发，普通家庭或小微企业，都足够用了；USG-Pro-4 带机量可以到 1000 并发，中小企业需求基本可以满足；如果还有更高需求，可以使用 UDM-Pro。<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1653704240361-61f7d4db-9815-46ba-9bdd-496bf339a6d8.png#clientId=ubd9af9bb-1228-4&from=paste&id=u0c7cad2d&originHeight=241&originWidth=718&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u97852aab-03cd-426c-92e3-91bf36baaa1&title=)
