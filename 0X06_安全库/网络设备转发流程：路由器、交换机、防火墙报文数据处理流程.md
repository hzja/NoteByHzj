网络
<a name="gwwYg"></a>
## 前言
在一个网络中，最常见的网络设备就是交换机、路由器、防火墙（如下图）。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342132-047edc3b-5c35-459e-905a-ef6c3ede7caa.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u93592010&originHeight=708&originWidth=453&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u1155148f-8acf-45b8-aea2-3defb63cbc4&title=)<br />那么这些网络设备是如何工作的，如何处理数据报文的呢？今天我们就以交换机、路由器为例，给大家介绍下。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342089-6da931e8-89c8-4fa3-8f96-2c23b88173c6.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u6e65e386&originHeight=289&originWidth=733&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3511747c-e86f-4c33-9dc4-8e28a0d00d5&title=)
<a name="YlQrV"></a>
## 网络设备介绍
<a name="ExOgO"></a>
### 1、框式网络设备
如下图所示，是华为的一款框式交换机 S12708。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342025-ed42f7ca-6ce3-4088-ad0e-a93ae56dae8f.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u6ef96cd3&originHeight=294&originWidth=315&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9a10e968-dcfd-4efc-9413-4602d764646&title=)<br />这款交换机的硬件满配组成如下：2个主控板、4个交换网板、8个接口板卡、2个集中监控板、6个电源模块、4个风扇模块等。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342034-83c3f94f-8898-419c-be2b-cb994a689e67.webp#clientId=uf08d3679-d5ad-4&from=paste&id=ubb656d15&originHeight=468&originWidth=330&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf90afa2e-1781-4806-8b4c-71ad92dda3d&title=)<br />那么这些硬件组成的作用是什么呢？
<a name="siClo"></a>
#### （1）主控板
主控板其实就是设备的“大脑”，对设备进行整体的管理和控制。<br />主控板提供了整个系统的管理平面和控制平面。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342140-5340fe19-9b85-464b-b37e-13585123e447.webp#clientId=uf08d3679-d5ad-4&from=paste&id=uea4679b4&originHeight=129&originWidth=363&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u6c627977-cd02-4409-9891-7b040585f88&title=)
<a name="pkWOf"></a>
#### （2）接口板卡
接口板卡就是我们常说的业务板卡，提供丰富的端口类型和端口数量，不同的板卡类型提供的端口数量和端口类型（光口、电口）也不一样，端口的速率也不一样（10G/25G/40G/100G等）。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342459-7b6e5fb8-b252-4656-b687-9e7100b2381a.webp#clientId=uf08d3679-d5ad-4&from=paste&id=ue86735c9&originHeight=157&originWidth=358&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u92d26ad5-20fa-465e-94d6-954a885bdb5&title=)
<a name="oEGLB"></a>
#### （3）交换网板
交换网板从字面上理解就是用作数据交换的，可以理解成是整个设备的通信总线，业务板之间通信都需要经过交换网板。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342349-03cacaf8-82f0-4a91-8b81-cc2bc341f978.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u0d9ccd10&originHeight=150&originWidth=372&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8e1c4ba0-5523-4ab1-a379-15114a31adc&title=)<br />例如下图：不同槽位的接口板卡通信都需要通过交换网板。（这个大家记住，后面讲转发流程会涉及）<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342433-a1b20422-e4b9-4301-845d-72c506db5ab8.webp#clientId=uf08d3679-d5ad-4&from=paste&id=ub440cba8&originHeight=242&originWidth=426&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud16677fa-75f9-4047-9013-567dbcd88a0&title=)
<a name="hoYU0"></a>
### 2、盒式网络设备
盒式网络设备相对于框式设备而言，不具备**扩展性**，端口数量固定，将各个模块集成在一起了。但是价格相对框式设备便宜。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342570-be695866-8d0f-4bce-a9be-5bb5ab3f9b50.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u0c2bbf59&originHeight=120&originWidth=160&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u2ed902e9-7a61-47df-bf35-5a9daf7f4f5&title=)
<a name="LWViY"></a>
### 3、网络设备的逻辑平面
网络设备从逻辑上可以分为：控制平面、数据平面、监控平面；

![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342619-3581c73f-e405-4900-b96c-964b5fc9ae64.webp#clientId=uf08d3679-d5ad-4&from=paste&id=uda15d8c8&originHeight=305&originWidth=831&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u77d2c3de-1dce-4cd7-8510-fe9be78beb7&title=)<br />**（1）控制平面**：用于控制和管理所有网络协议的运行。控制平面由设备的主控板和业务板卡中的管理单元组成。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342716-c1262012-b8d0-4ad3-af17-90b9b4e6134b.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u20273173&originHeight=147&originWidth=379&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u03292f4d-2eca-4c86-893e-7c631f03ee7&title=)<br />例如：交换机是基于MAC地址表转发的，那么这个表项就是控制平面干的活；路由器是基于路由表转发的，那么这个表项就是控制平面干的活；<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342814-611547c5-3620-4c01-bd70-5c32b8aab29d.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u7262500d&originHeight=101&originWidth=231&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u9690471e-ff07-4162-af6a-8d4037909ef&title=)<br />**（2）数据平面**：实现各个业务模块之间的业务交换功能。<br />转发平面有接口板和交换网板组成。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342851-f1afcabc-fc39-4cca-afd0-ada143216177.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u84212ee5&originHeight=391&originWidth=801&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua6bd3671-1a48-4770-be87-6c8058f9049&title=)<br />其实网络设备简单来看就是接受数据，处理数据，转发数据。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343087-ebd1e399-cedf-407b-b4ee-a2fafe199ce3.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u268b1182&originHeight=171&originWidth=540&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u386eba0f-d873-4b7e-b4ae-60efb42eefe&title=)<br />**（3)监控平面**：完成系统的运行状态监控、环境监控、日志和告警信息处理、系统加载、系统升级等功能。<br />监控平面由主控板、接口板监控单元组成，框式设备还会有集中监控板。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997342966-e49092b8-2c3d-4175-bc8a-f5f5772e5b2a.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u62f7d679&originHeight=171&originWidth=374&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc2c06cbd-39ff-4a54-add2-d597e1b8ab9&title=)<br />大家都应该通过TELNET、SSH、SNMP等方式来登录管理设备，那么这些其实就是和监控管理平面相关的。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343109-b2a13ee3-20ca-437e-8aff-0069dfc765b6.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u985cfbf1&originHeight=402&originWidth=632&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua0a3800a-0605-415f-928b-8c8b6fa4900&title=)
<a name="fi2fh"></a>
## 网络设备报文处理流程
<a name="H3U1j"></a>
### 1、什么是上行、下行？
**上行：**设备从LPU接口板收到报文转发到交换网板的过程；<br />**下行：**设备从交换网板发给LPU接口板的过程；<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343205-7bd73862-91d0-4f1c-a2c2-8f24fd94185a.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u4fd35598&originHeight=392&originWidth=801&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uca60de1e-6c3e-4c7c-85e0-3d25c52c21e&title=)
<a name="auGSn"></a>
### 2、什么是协议报文、业务报文？
网络设备处理的报文可以分为业务报文和协议报文；<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343228-c123796b-6ca6-4117-a59c-b533c81b69fd.webp#clientId=uf08d3679-d5ad-4&from=paste&id=ufcfe709d&originHeight=156&originWidth=419&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ucd27026a-48dd-4612-b86f-3efbf3f99fb&title=)
<a name="WGZrY"></a>
#### （1）业务报文：服务、应用在交互过程中涉及的报文；
设备收到业务报文只会进行转发，从接口板的一个端口进入之后根据转发表项从另一个接口转发出去；<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343436-d0cfbfb8-6462-461a-b955-429b64fef95d.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u50f4fe30&originHeight=82&originWidth=801&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u36b7266e-2373-4e87-a67d-3378fe7a9c3&title=)
<a name="haA8k"></a>
#### （2）协议报文：
设备收到协议报文（如BGP、OSPF、ARP等协议报文），会上送给控制平面处理；<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343527-e229f87e-49bc-40b5-9235-6333d83c385b.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u7b090a31&originHeight=222&originWidth=801&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf65c12f5-7625-408e-a39f-90007260cda&title=)<br />如ARP报文交由控制层面处理、判断之后决定是否回应，是否学习ARP报文中的源MAC、源IP。
<a name="Yii7n"></a>
### 3、业务报文转发流程
![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343568-a95602b1-5d24-490b-909e-7f0e41c86e86.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u739484c0&originHeight=282&originWidth=991&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u0777ca33-f29a-4b22-9906-cc9231f12bd&title=)

（1）业务报文从接口板进来后，首先通过**PFE（包转发引擎）**对报文进行处理；<br />A、解封装：对报文进行解封装，获取二层或者三层报文头信息；<br />B、查表转发：如果是二层转发，就查找MAC地址表，确认报文的出接口；如果是三层转发，就查找路由表，确认报文的出接口；<br />如果报文送往交换网板之前，需要进行**切片处理**，就把报文按一定粒度进行切片，切成固定长度。<br />（2）入接口板通过数据总线交给交换机网板，交换网板交由下行接口板。<br />（3）下行接口板对分片后的报文进行**重组**，并通过PFE（包转发引擎）对报文进行处理，获取封装信息，对报文进行封装，并通过出接口转发出去。

---

<a name="BsX34"></a>
#### 硬件转发：
1、框式设备的业务报文转发一般不经过主控板CPU，直接由接口板查询表项进行数据转发。这种直接由接口板完成数据转发，没有主控板参与的转发方式就是**硬件转发**。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343542-d369c98e-2ed4-45bc-be3f-7cc315deabb4.webp#clientId=uf08d3679-d5ad-4&from=paste&id=udb66ac1b&originHeight=104&originWidth=734&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3050e067-5b0f-46cd-84d6-6400606dd01&title=)<br />2、接口板上的转发信息（例如：FIB表项）是由**主控板**根据生成的路由表下发到接口板上的。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343647-7633ca70-a365-4f12-963c-e91e9436bb9e.webp#clientId=uf08d3679-d5ad-4&from=paste&id=ud7f52be0&originHeight=219&originWidth=684&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u59881942-363e-4e13-a660-6c8a5f8a524&title=)
<a name="zQVrk"></a>
### 4、协议报文转发流程
（1）设备收到协议报文（ospf、bgp、ARP等）后，需要**上送到主控板**进行处理。<br />![](https://cdn.nlark.com/yuque/0/2022/webp/396745/1642997343869-a5a877ff-574a-499b-8527-32858bb148ea.webp#clientId=uf08d3679-d5ad-4&from=paste&id=u99ca6f99&originHeight=401&originWidth=991&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u2400761c-5d40-420a-913e-8682442b534&title=)<br />（2）主控板CPU收到协议报文之后进行相应的处理，如果需要回应报文，则主控板会构造协议报文进行回应。<br />如收到发往自身的ARP Request、ICMP Echo Request报文，主控板处理之后构造ARP Reply、ICMP Echo Reply进行回应。
