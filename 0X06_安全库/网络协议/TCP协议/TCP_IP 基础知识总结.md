TCP IP
<a name="vnA0Y"></a>
## TCP/IP 的历史背景
最初还没有 TCP/IP 协议的时候，也就是在 20 世纪 60 年代，许多国家和地区认识到通信技术的重要性。美国国防部希望能够研究一种即使通信线路被破坏也能够通过其他路线进行通信的技术。为了实现这种技术，出现了`分组`网络。<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530898826-1e8fa6d3-228a-475b-bc8f-39a2e525409f.webp#align=left&display=inline&height=347&originHeight=347&originWidth=1080&size=0&status=done&style=shadow&width=1080)<br />即使在两个节点通信的过程中，几个节点遭到破坏，却依然能够通过改变线路等方式使两个节点之间进行通信。<br />这种分组网络促进了 `ARPANET(Advanced Research Projects Agency Network)` 的诞生。ARPANET 是第一个具有分布式控制的广域包分组交换网络，也是最早实现 TCP/IP 协议的前身。
> ARPANET 其实是由 美国国防部高级研究计划局 计划建立。

所以，计算机网络的出现在最一开始是因为军事研究目的。<br />20 世纪 90 年代，IOS 开展了 OSI 这一国际标准化的进程，然而却没有取得实质性的进展，但是却使 TCP/IP 协议得到了广泛使用。<br />这种致使 TCP/IP 协议快速发展的原因可能是由于 TCP/IP 的标准化。也就是说 TCP/IP 协议中会涉及到 OSI 所没有的标准，而这种标准将是接下来主要探讨的内容。<br />这里先来认识一下 TCP/IP 协议，TCP/IP 协议说的不仅仅只是 TCP 和 IP 这两种协议，实际上，TCP/IP 指的是协议簇，协议簇是啥呢？简单来说就是一系列协议的综合<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530898886-a0083dfc-914e-4d88-a6d4-dfa13c33f882.webp#align=left&display=inline&height=493&originHeight=493&originWidth=1080&size=0&status=done&style=shadow&width=1080)<br />以上的协议汇总起来，就是 TCP/IP 协议簇。
<a name="WYPDu"></a>
## TCP/IP 标准
TCP/IP 相较于其他协议的标准，更注重两点：`开放性` 和 `实用性`，即标准化能否被实际使用。<br />开放性说的是 TCP/IP 是由 `IETF` 讨论制定的，而 IETF 本身就是一个允许任何人加入进行讨论的组织。<br />实用性说的是就拿框架来说，如果只浮于理论，而没有落地的实践，那么永远成为不了主流。<br />TCP/IP 的标准协议就是所熟知的 `RFC 文档`，当然可以在网络上看到。RFC 不仅规范了协议标准，还包含了协议的实现和使用信息。<br />关于更多 RFC 协议，可以看一下官方文档 [https://www.rfc-editor.org/rfc-index.html](https://www.rfc-editor.org/rfc-index.html)
<a name="8LuY4"></a>
## TCP/IP 协议簇
TCP/IP 协议是程序员接触最多的协议，OSI 模型共有七层，从下到上分别是物理层、数据链路层、网络层、运输层、会话层、表示层和应用层。但是这显然是有些复杂的，所以在 TCP/IP 协议中，它们被简化为了四个层次<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530898892-3a5ba066-416e-41f9-9250-38407009a1e0.webp#align=left&display=inline&height=518&originHeight=518&originWidth=980&size=0&status=done&style=none&width=980)<br />下面从通信链路层开始介绍一下这些层以及与层之间的协议。
<a name="gIbpO"></a>
### 通信链路层
如果非要细分的话，通信链路层也可以分为 `物理层` 和 `数据链路层`。
<a name="8D8zd"></a>
### 物理层
物理层是 TCP/IP 的最底层是负责传输的硬件，这种硬件就相当于是以太网或电话线路等物理层的设备。
<a name="juoBb"></a>
### 数据链路层
另外一层是数据链路层，数据链路层位于物理层和网络层中间，数据链路层定义了在单个链路上如何传输数据。
<a name="gC39k"></a>
### 网络层
网络层主要使用 `IP`协议，IP 协议基于 IP 地址转发分包数据。<br />![](https://cdn.nlark.com/yuque/0/2020/png/396745/1606530898826-465e465e-9d51-4757-bc89-75c223d8dcaf.png#align=left&display=inline&height=331&originHeight=331&originWidth=1080&size=0&status=done&style=shadow&width=1080)<br />IP 协议的主要作用就是将分组数据包发送到目标主机<br />TCP/IP 分层中的互联网层与传输层的功能通常由操作系统提供。<br />IP 还隐含着数据链路层的功能，通过 IP 协议，相互通信的主机之间不论经过怎样的底层数据链路，都能够实现相互通信。<br />虽然 IP 也是一种分组交换协议，但是 IP 却不具备重发机制。即使数据没有到达另一端也不会进行重发，所以 IP 属于非可靠性协议。<br />网络层还有一种协议就是 `ICMP`，因为 IP 在数据包的发送过程中可能会出现异常，当 IP 数据包因为异常而无法到达目标地址时，需要给发送端发送一个异常通知，ICMP 的主要功能就在于此了。鉴于此情况，ICMP 也可以被用来诊断网络情况。
<a name="8pjEA"></a>
### 传输层
刚介绍完 TCP/IP 协议最重要的 IP 协议后，下面来看一下传输层协议，TCP 协议是传输层协议的一种。<br />传输层就好像高速公路一样，连接两个城市的道路。下面是互联网的逻辑通道，可以把它想象成为高速公路。<br />![](https://cdn.nlark.com/yuque/0/2020/png/396745/1606530898961-63f0a22e-cf80-412c-b2e6-dafc899e8385.png#align=left&display=inline&height=465&originHeight=465&originWidth=1080&size=0&status=done&style=shadow&width=1080)<br />传输层最主要的功能就是让应用层的应用程序之间完成通信和数据交换。在计算机内部运行着很多应用程序，每个应用程序都对应一个端口号，一般使用端口号来区分这些应用程序。<br />传输层的协议主要分为面向有连接的协议 TCP 和面向无连接的协议 UDP<br />**TCP**<br />TCP 是一种可靠的协议，它能够保证数据包的可靠性交付，TCP 能够正确处理传输过程中的丢包、传输顺序错乱等异常情况。此外，TCP 还提供拥塞控制用于缓解网络拥堵。<br />**UDP**<br />UDP 是一种不可靠的协议，它无法保证数据的可靠交付，相比 TCP ，UDP 不会检查数据包是否到达、网络是否阻塞等情况，但是 UDP 的效率比较高。<br />UDP 常用于分组数据较少或者广播、多播等视频通信和多媒体领域。
<a name="vNzd3"></a>
### 应用层
在 TCP/IP 协议簇中，将 OSI 标准模型中的会话层、表示层都归为了应用层。应用层的架构大多属于客户端/服务端模型，提供服务的程序叫做服务端、接受服务的程序叫做客户端。在这种架构中，服务端通常会提前部署到服务器上，等待客户端的连接，从而提供服务。<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530898874-6a8c8757-0837-4c1f-9b8b-e44b5e6cb9f1.webp#align=left&display=inline&height=467&originHeight=467&originWidth=1080&size=0&status=done&style=shadow&width=1080)
<a name="fwj94"></a>
## 数据包的发送历程
下面来看一下一个数据包是如何经过应用层、运输层、网络层和通信链路层把一个数据包发送给另外一个数据包的。
<a name="5CmuY"></a>
### 数据包结构
首先先来认识一下数据包的结构<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530898948-cbeee604-4d1b-494f-9d3b-9a0d9c4a250b.webp#align=left&display=inline&height=671&originHeight=671&originWidth=1080&size=0&status=done&style=shadow&width=1080)<br />在上面的每个分层中，都会对所发送的数据增加一个 `首部`，这个首部中包含了该层必要的信息。每一层都会对数据进行处理并在数据包中附上这一层的必要信息。下面就来看一下数据包的发送过程。
<a name="LY9ZQ"></a>
### 数据包发送历程
假设主机 A 和主机 B 进行通信，主机 A 想要向主机 B 发送一个数据包，都会经历哪些奇特的操作？
<a name="34BJh"></a>
#### 应用层的处理
主机 A 也就是用户点击了某个应用或者打开了一个聊天窗口输入了`fcant`，然后点击了发送，那么这个 `fcant`就作为一个数据包遨游在了网络中，等下还没完呢，应用层还需要对这个数据包进行处理，包括字符编码、格式化等等，这一层其实是 OSI 中表现层做的工作，只不过在 TCP/IP 协议中都归为了应用层。<br />数据包在发送的那一刻建立 TCP 连接，这个连接相当于通道，在这之后其他数据包也会使用通道传输数据。
<a name="07vTt"></a>
#### 传输层的处理
为了描述信息能准确的到达另一方，使用 TCP 协议来进行描述。TCP 会根据应用的指示，负责建立连接、发送数据和断开连接。<br />TCP 会在应用数据层的前端附加一个 TCP 首部字段，TCP 首部包含了`源端口号` 和 `目的端口号`，这两个端口号用于表明数据包是从哪里发出的，需要发送到哪个应用程序上；TCP 首部还包含`序号`，用以表示该包中数据是发送端整个数据中第几个字节的序列号；TCP 首部还包含 `校验和`，用于判断数据是否损坏，随后将 TCP 头部附加在数据包的首部发送给 IP。
<a name="Mfyor"></a>
#### 网络层的处理
网络层主要负责处理数据包的是 IP 协议，IP 协议将 TCP 传过来的 TCP 首部和数据结合当作自己的数据，并在 TCP 首部的前端加上自己的 IP 首部。因此，IP 数据包后面会紧跟着 TCP 数据包，后面才是数据本身。IP 首部包含目的和源地址，紧随在 IP 首部的还有用来判断后面是 TCP 还是 UDP 的信息。<br />IP 包生成后，会由路由控制表判断应该发送至哪个主机，IP 修饰后的数据包继续向下发送给路由器或者网络接口的驱动程序，从而实现真正的数据传输。
> 如果不知道目标主机的 IP 地址，可以利用 `ARP(Address Resolution Protocol)` 地址解析协议进行查找。

<a name="CZoRO"></a>
#### 通信链路层的处理
经由 IP 传过来的数据包，以太网会给数据附上以太网首部并进行发送处理。以太网首部包含接收端的 MAC 地址、发送端的 MAC 地址以及标志以太网类型的以太网数据协议等。<br />下面是完整的处理过程和解析过程。<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530899005-c73b6849-6ee4-45ea-8818-ddd04702ab37.webp#align=left&display=inline&height=821&originHeight=821&originWidth=1080&size=0&status=done&style=shadow&width=1080)<br />如上图所示，左侧是数据的发送处理过程，应用层的数据经过层层处理后会变为可以发送的数据包，经过物理介质发送至指定主机中。<br />数据包的接收流程是发送流程的逆序过程，数据包的解析同样也会经过下面这几步。
<a name="9pF46"></a>
#### 通信链路的解析
目标主机收到数据包后，首先会从以太网的首部找到 MAC 地址判断是否是发给自己的数据包，如果不是发给自己的数据包则会丢弃该数据包。<br />如果收到的数据包是发送给自己的，就会查找以太网类型判断是哪种协议，如果是 IP 协议就会扔给 IP 协议进行处理，如果是 `ARP` 协议就会扔给 ARP 协议进行处理。如果协议类型是一种无法识别的协议，就会将该数据包直接丢弃。
<a name="35evb"></a>
#### 网络层的解析
经过以太网处理后的数据包扔给网络层进行处理，假设协议类型是 IP 协议，那么，在 IP 收到数据包后就会解析 IP 首部，判断 IP 首部中的 IP 地址是否和自己的 IP 地址匹配，如果匹配则接收数据并判断上一层协议是 TCP 还是 UDP；如果不匹配则直接丢弃。
> 注意：在路由转发的过程中，有的时候 IP 地址并不是自己的，这个时候需要借助路由表协助处理。

<a name="6ublr"></a>
#### 传输层的处理
在传输层中，默认使用 TCP 协议，在 TCP 处理过程中，首先会计算一下 `校验和`，判断数据是否被损坏。然后检查是否按照序号接收数据，最后检查端口号，确定具体是哪个应用程序。<br />数据被完整的识别后，会传递给由端口号识别的应用程序进行处理。
<a name="01ae39e9"></a>
#### 应用程序的处理
接收端指定的应用程序会处理发送方传递过来的数据，通过解码等操作识别出数据的内容，然后把对应的数据存储在磁盘上，返回一个保存成功的消息给发送方，如果保存失败，则返回错误消息。<br />上面是一个完整的数据包收发过程，在上面的数据收发过程中，涉及到不同层之间的地址、端口号、协议类型等，那么现在就来剖析一下。<br />数据包经过每层后，该层协议都会在数据包附上包首部，一个完整的包首部图如下所示<br />![](https://cdn.nlark.com/yuque/0/2020/webp/396745/1606530898994-04ff6071-27b1-4c30-9651-26bc150fc85b.webp#align=left&display=inline&height=600&originHeight=600&originWidth=1080&size=0&status=done&style=none&width=1080)<br />在数据包的发送过程中，各层依次对数据包添加了首部信息，每个首部都包含发送端和接收端地址以及上一层的协议类型。以太网会使用 MAC 地址、IP 会使用 IP 地址、TCP/UDP 则会用端口号作为识别两端主机的地址。<br />此外，每个分层中的包首部还包含一个识别位，它是用来标识上一层协议的种类信息。
