# 短信接口

[https://app.yunxin.163.com](https://app.yunxin.163.com/)

访问网易云信-->进入控制台-->创建应用-->开通短信服务

![1582729675082-75082f37-967e-42d4-ac82-ca6b37d9a11e](D:\Note\python\Django\图片\1582729675082-75082f37-967e-42d4-ac82-ca6b37d9a11e.png)

![1582729524644-4680a730-d1c0-4369-8871-4802428f1734](D:\Note\python\Django\图片\1582729524644-4680a730-d1c0-4369-8871-4802428f1734.png)

获取前端提供的手机号码，然后调用util_sendmsg发送短信模块，根据返回信息判断是否发送成功，然后再从前端获取用户提交的验证码并判断



## 手机验证码登录试视图

~~~ python 
# 手机验证码登录视图
def code_login(request):
    if request.method == 'GET':
        return render(request, 'user/codelogin.html')
    # 获取用户提交的数据
    else:
        # 获取用户提交的手机和验证码
        mobile = request.POST.get('mobile')
        code = request.POST.get('code')

        # 根据mobile取session值
        check_code = request.session.get(mobile)
        # 判断用户提交的验证码是否正确
        if code == check_code:
            # 从库中取出账户信息，准备登陆
            user = UserProfile.objects.filter(mobile=mobile).first()
            if user:
                login(request, user)
                return redirect(reverse('index'))
            else:
                return HttpResponse('验证失败!')
        else:
            return render(request, 'user/codelogin.html', context={'msg':'验证码有误!'})
~~~



## 发送手机验证码模块

~~~ python 
from .utils import util_sendmsg

# 发送手机验证码模块  接受ajax发过来的请求，调用第三方模块给传过来的手机号码发短信
def send_code(request):
    mobile = request.GET.get('mobile')
    data = {}

    # 取出mobile所对应的所有账户信息
    if UserProfile.objects.filter(mobile=mobile).exists():
        # 调用utils中的发送手机验证码模块
        json_result = util_sendmsg(mobile)
        # 从返回的json数据中取值,状态码
        status = json_result.get('code')

        # 发送成功
        if status == 200:
            # obj字段表示此次发送的验证码
            check_code = json_result.get('obj')

            # 将验证码保存到session
            request.session[mobile]= check_code

            data['status'] = 200
            data['msg'] = '验证码发送成功'

        # 发送失败
        else:
            data['status'] = 500
            data['msg'] = '验证码发送失败'
    # 手机号不存在
    else:
        data['status'] = 501
        data['msg'] = '手机号码不存在'

    # 将成功或失败的结果的字典返回
    return JsonResponse(data)
~~~



## 自定义发短信模块

~~~ python 
import hashlib
from time import time
import json
import requests

# 作用就是向网易云信发送请求，帮助后台发送短信息给客户
def util_sendmsg(mobile):
    # 访问网易云信的url地址
    url = 'https://api.netease.im/sms/sendcode.action'
    # 传过来的的手机号码
    data = {'mobile': mobile}
    # 4部分组成 headers： AppKey  Nonce  CurTime  CheckSum
    AppKey = '*******'
    Nonce = '******'
    CurTime = str(time())
	
    # 这个可以自己定义
    AppSecret = '17e9dbcf5938'
    content = AppSecret + Nonce + CurTime
    CheckSum = hashlib.sha1(content.encode('utf-8')).hexdigest()

    # 打包headers中的信息
    headers = {'AppKey': AppKey, 'Nonce': Nonce, 'CurTime': CurTime, 'CheckSum':CheckSum}

    # 发送requset请求，获得响应体
    response = requests.post(url, data, headers=headers)

    print(response)

    # 获得响应体中的数据，字符串格式
    str_result = response.text

    # 转换成json格式
    json_result = json.loads(str_result)

    return json_result
~~~

