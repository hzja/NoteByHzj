# 上传文件

## 环境准备

安装 Pillow

~~~ shell
pip install Pillow==3.4.1
~~~

在Django中上传图片包括两种方式：

- 在管理页面admin中上传图片
- 自定义form表单中上传图片

上传图片后，将图片存储在服务器上，然后将图片的路径存储在表中。



settings.py

~~~ python
# 添加后可以在模板中使用{{ MEDIA_URL }}
...
'django.template.context_processors.media', 
...

# 文件上传的文件
MEDIA_URL = '/media/'
MEDIA_ROOT = os.path.join(BASE_DIR, 'media')
~~~



views.py

~~~ python 
# 用户个人中心视图，图片保存到本地和云存储
def user_center1(request):
    user = request.user
    if request.method == 'GET':
        return render(request, 'user/center.html', context={'user': user})
    # 如果用户要更新数据
    else:
        username = request.POST.get('username')
        email = request.POST.get('email')
        mobile = request.POST.get('mobile')
        # 内存存储对象，此处表现为图片名
        icon = request.FILES.get('icon')

        # 将基本信息保存到本地数据库
        user.username = username
        user.email = email
        user.mobile = mobile
        
        # 保存到本地，使用此方法更新图片需要在models中定义icon = models.ImageField(upload_to='')的方法
        user.icon = icon

        # 将图片上传到云存储
        save_path = upload_image(icon)
        user.yunicon = save_path
        user.save()
        

        # 重新加载页面
        return render(request, 'user/center.html', context={'user': user})
~~~



utlis.py

~~~ python
# 上传图片到云存储
def upload_image(storeobj):
    # 需要填写你的 Access Key 和 Secret Key
    access_key = 'gAfs4XKMy8-Tf3_JotL6hCqaQkKX2FVM21usVbWR'
    secret_key = 'KUhYH1TSnLQiB44tjGE1v09fzGqtdS4nS8f4Uhr7'

    # 构建鉴权对象
    q = Auth(access_key, secret_key)

    # 要上传的空间
    bucket_name = 'zygboke'

    # 上传后保存的文件名
    key = storeobj.name

    # 生成上传 Token，可以指定过期时间等
    token = q.upload_token(bucket_name, key, 3600)

    # 将图片推送到云存储
    ret, info = put_data(token, key, storeobj.read())

    # 获取保存后的文件名
    filename = ret.get('key')
    # 拼接图片访问路径给前端使用
    save_path = 'http://q5p4gw7j9.bkt.clouddn.com/'+filename
    return save_path
~~~



在主路由中 添加

~~~ python 
re_path(r'^media/(?P<path>.*)$', serve, {'document_root': MEDIA_ROOT})
~~~



前端调用

~~~html
<img src="{{ MEDIA_URL }}{{ user.icon }}" alt="" id="icon">
~~~



# 云存储

https://www.qiniu.com/

这里我使用的七牛云的云存储，有10G的免费空间，超额部分也很实惠

![1582730394211-53d0133a-1ead-415c-8b95-2166acf38cdf](D:\Note\python\Django\图片\1582730394211-53d0133a-1ead-415c-8b95-2166acf38cdf.png)



## 安装七牛云模块

~~~ shell
pip install qiniu
~~~



## 用户个人中心视图

~~~ python
# 用户个人中心视图，图片保存到云存储
# 自动验证用户是否登陆，前提必须继承AbstractUser
@login_required
def user_center1(request):
    user = request.user
    if request.method == 'GET':
        return render(request, 'user/center.html', context={'user': user})
    # 如果用户要更新数据
    else:
        username = request.POST.get('username')
        email = request.POST.get('email')
        mobile = request.POST.get('mobile')
        # 内存存储对象，此处表现为图片名
        icon = request.FILES.get('icon')

        # 将基本信息保存到本地数据库
        user.username = username
        user.email = email
        user.mobile = mobile

        # 将图片上传到云存储
        save_path = upload_image(icon)
        user.yunicon = save_path
        user.save()

        # 重新加载页面
        return render(request, 'user/center.html', context={'user': user})
~~~



## 上传图片到云存储

~~~ python 
from qiniu import Auth, put_data


# 上传图片到云存储
def upload_image(storeobj):
    # 需要填写你的 Access Key 和 Secret Key
    access_key = '****'
    secret_key = '*****'

    # 构建鉴权对象
    q = Auth(access_key, secret_key)

    # 要上传的空间
    bucket_name = 'zygboke'

    # 上传后保存的文件名
    key = storeobj.name

    # 生成上传 Token，可以指定过期时间等
    token = q.upload_token(bucket_name, key, 3600)

    # 将图片推送到云存储
    ret, info = put_data(token, key, storeobj.read())

    # 获取保存后的文件名
    filename = ret.get('key')
    # 拼接图片访问路径给前端使用
    save_path = 'http://q5p4gw7j9.bkt.clouddn.com/'+filename
    return save_path
~~~