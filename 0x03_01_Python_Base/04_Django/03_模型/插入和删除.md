# 插入和删除

- save()：将模型对象保存到数据表中，ORM框架会转换成对应的insert或update语句
- delete()：将模型对象从数据表中删除，ORM框架会转换成对应的delete语句



## 增

### 方法一，调用模块函数对象

~~~ python
b = models.UserProfile()
b.username = 'xiaoming'
b.mobile = '15830900798'
b.save()
~~~



### **方法二，直接加**

~~~ python
models.UserProfile.objects.create(username='xiaohong',mobile=15830900797)
~~~



###  批量增加

~~~ python
object_list = [
    models.UserInfo(name='Alex',age=18),
    models.UserInfo(name='sss',age=20),
    ...
]
models.UserInfo.objects.bulk_create(object_list,10) # 每次10个批量添加
~~~



## 删

~~~ python
models.Tb1.objects.filter(name='seven').delete() # 删除指定条件的数据
~~~



## 查

~~~ python
models.Tb1.objects.get(id=123)         # 获取单条数据，不存在则报错（不建议）
models.Tb1.objects.all()               # 获取全部
models.Tb1.objects.filter(name='seven') # 获取指定条件的数据
~~~



## 改

### 方法一，直接加

~~~ python
models.Tb1.objects.filter(name='seven').update(gender='0')  # 将指定条件的数据更新，均支持 **kwargs
~~~

### 方法二，调用模块函数对象

~~~ python
obj = models.Tb1.objects.filter(id=1).first()
obj.c1 = '111'
obj.save()  # 修改单条数据
~~~



## update_or_create()方法的机制

如果数据库内没有该数据则新增，如果有则更新，就大大减少了代码量而不用写两个方法。该方法的参数必须为一些用于查询的指定字段（这里是username）以及需要新增或者更新的defaults字典。而其返回值则是一个查询对象和是否新建对象布尔值的二元元组。

~~~ python
def add_to_new_assets_zone(self):
    defaults = {
        'data': json.dumps(self.data),
        'username': self.data.get('username'),
        'password': self.data.get('password'),
    }
models.UserProfile.objects.update_or_create(username='xiaohong', defaults=defaults)
~~~



## 调用save()时会发生什么?

1. **发出** `pre_save` **信号**。允许监听该信号的函数执行一些操作。

2. **预处理数据**。调用每个字段的 `pre_save()` 方法来执行自动数据的修改。例如，日期/时间字段覆盖 `pre_save()` 以实现 `auto_now_add` 和 `auto_now`。

3. **准备数据库的数据**。要求每个字段的 `get_db_prep_save()` 方法在可写入数据库的数据类型中提供其当前值。

   大多数字段不需要数据准备。简单的数据类型，如整数和字符串，可以作为 Python 对象“准备好写入”。但是，更复杂的数据类型通常需要进行一些修改。

   例如， `DateField` 字段使用 Python `datetime` 对象来存储数据。数据库不存储 `datetime` 对象，所以必须将字段值转换为符合 ISO 的日期字符串以便插入到数据库中。

4. **将数据插入数据库**。预处理的准备好的数据组成一个 SQL 语句，用于插入数据库。

5. **发出** `post_save` **信号**。允许监听该信号的函数执行一些操作。



## Django 如何知道 UPDATE 与 INSERT

 Django 数据库对象使用相同的 `save()` 方法来创建和更改对象；

Django 抽象了使用 `INSERT` 或 `UPDATE` SQL 语句的必要性；

具体来说，当调用 `save()` 时，Django 遵循这个算法：

- 如果对象的主键(primary key)属性设置了一个值为 `True`的值（即，除 `None` 或『空字符串』以外的值），Django 将执行 `UPDATE`。
- 如果该对象的主键(primary key)属性未设置，或者 `UPDATE` 未更新任何内容，则 Django 将执行 INSERT。

这里的一个问题是，如果不能保证主键值未被使用，那么在保存新对象时，应该小心不要明确指定主键值。