# 高阶名词

## 什么是VLAN?

VLAN中文是“虚拟局域网”。LAN可以是由少数几台计算机构成的网络，也可以是数以百计的计算机构成的企业网络。VLAN所指的LAN特指使用路由器分割的网络——也就是广播域。

简单来说，同一个VLAN中的用户间通信就和在一个局域网内一样，同一个VLAN中的广播只有VLAN中的 成员才能听到，而不会传输到其他的VLAN中去，从而控制不必要的广播风暴的产生。同时， 若没有路由，不同VLAN之间不能相互通信，从而提高了不同工作组之间的信息安全性。网络 管理员可以通过配置VLAN之间的路由来全面管理网络内部不同工作组之间的信息互访。



### 网络风暴

假设这时，计算机A需要与计算机B通信。在基于以太网的通信中，必须在数据帧中指定目标MAC地址才能正常通信，因此计算机A必须先广播“ARP请求（ARP Request）信息”，来尝试获取计算机B的MAC地址。

交换机1收到广播帧（ARP请求）后，会将它转发给除接收端口外的其他所有端口，也就是泛滥了。接着，交换机2收到广播帧后也会泛滥。交换机3、4、5也还会泛滥。最终ARP请求会被转发到同一网络中的所有客户机上，**这也就是网络风暴**



## 基于端口的静态VLAN和基于IP的动态VLAN

### 静态VLAN

+ 直接指示哪些端口是一个VLAN组，比如一个交换机上有8个端口，我们指示1，3，5，7为VLAN1分组，2,4,6,8为VLAN2分组，不同的交换机之间也可以进行VLAN组别划分。在这里，交换机端口被分配给某些特定的VLAN。终端用户设备根据它们所连人的物理交换机端口而成为一个VLAN中的成员。对于这些终端设备，不需要握手联络或独特的VLAN成员关系协议；当它们连入一个端口时，会自动进行VLAN互连。
+ + 特点：简单，有效。缺点，当用户更改连线端口时（把一个相连的计算机端口线拔出来插入另一个端口时），需要重新对组别进行划分



### 动态VLAN

+ 基于IP地址的VLAN，则是通过相连计算机的IP地址进行划分的，当用户改变端口时，只要IP地址不变，组别不用重新划分，但是IP地址是OSI参照第三层信息，
+ +   动态VLAN的实现方法有多种，目前最普遍的实现方法是基于MAC地址的动态VLAN。基于MAC地址的动态VLAN需要一台VMPS（VLAN Membership Policy Server）VLAN 管理策略服务器,VMPS可以是一台具有该功能的交换机（如Catalyst 5000 交换机）或是一台外部服务器，VMPS中维护着MAC地址与VLAN的对应关系表。另外，需要把交换机的端口设置为支持动态VLAN属性的端口。当交换机的支持动态VLAN的端口收到数据帧时，通过使用该数据帧的源MAC地址查询VMPS，从而建立起端口与VLAN的对应关系。一个动态使用该数据帧的源MAC地址查询VMPS，从而建立起端口与VLAN的对应关系。一个动态的端口在某一时刻只能属于一个VLAN，属于同一VLAN的多个主机可以连接在交换机的同一个端口上；

+ + 一般路由器和三层交换机都是基于IP地址方法划分VLAN；



## 什么是STP?

STP是一种运行在二层的，用来解决交换机网络中环路问题的数据链路层协议



### 为什么会有环路？

在二层网络中，某个交换机上面有多条路径可以到达根桥（暂且理解为需要转发的目的地址），这时候就会发生我们不希望看到的现象。



### 环路的优点和缺点？

环路的存在，会导致三个问题，地址翻摆，广播风暴，多帧复制，这些问题对交换机或者网络资源来说都是致命的。但是，环路却能提高网络的连接可靠性。因为有环路的存在，即使两台交换机之间的链路因为故障断掉了，整个网络会依然保持连通性，这是无环网络无法做到的。



#### 地址翻摆

我们都知道二层交换机里面的MAC地址表记录的是，进入某个端口的源MAC地址和端口的映射，按需来进行，泛洪、转发、丢弃的二层操作。

那么，当某个交换机有环路时，假如发送的是广播帧，那么源MAC至少有两条或者以上路径转发，(假设分别是port1和porT2)假设这台电脑是PC1，MAC是MAC1,

那么有一条路径的里面的MAC表里的记录是MAC1-port1，紧接着另一条从port2进入，那么MAC地址表又会被刷新为：MAC1-port2

多条路径，顺时针和逆时针不停的转发，MAC地址表不断翻摆震荡，地址翻摆会大量消耗交换机处理资源，导致交换机瘫痪。



#### 广播风暴

PC1的帧由于顺时针逆时针高速旋转，局域网的每台交换机不停的收到PC1帧的拷贝，不停的泛洪，就产生了广播风暴。计算机收到广播帧后，都会送给网络层处理，大量广播帧袭来，导致计算机瘫痪。



#### 多帧复制

由于多转发路径的存在，且数据帧按MAC地址表，可能会出现多点转发，即源地址发出的数据帧可能会被多个交换机转发导致目的计算机收到了多个PC1帧，这样被称为多帧复制。



### 生成树协议

是指在交换机之间有两条及两条以上的物理线路时，会自动阻塞某些端口进行备用，使其不能行程环路。当有故障链路时，另一条链路可以快速进入转发状态，增强网络稳定性。



### 局域网可以不需要生成树吗？

不是，任意简单的一个小交换机环路会导致你整个局域网震荡，这是企业中绝对不允许出现的，也许别人无心插环，但是会给网络管理者带来大量不便。所以，我们从合规和安全来说，很有必要进行生成树的配置。



### 生成树的工作过程

1. 选举根桥
2. 选举根端口
3. 选举指定端口
4. 阻塞剩余端口

注：选举时，其实都是不同交换机的不同端口或者同一交换机的不同端口的竞选，会通过一些人为干预，或者自然选举，从而完美的产生空闲端口，即进选剩下的端口，生成树协议则会吧这些剩下的端口系统的阻塞，从而形成无环的网络



## MAC地址表刷新时间

1. MAC地址表与ARP表是两个表格，ARP表是存放在主机操作系统缓存中的，而且也有相应的超时值；
2. 交换机的MAC地址表在建立完毕后当用户有流量通信时相应MAC表项的老化时间是会刷新的；
3. 主机的ARP表中没有表项当然要发ARP请求，但是这个和MAC地址表项没有必然关系。

ARP表项的老化超时时间缺省为1200秒

MAC地址表项的老化时间为300秒



## GSLB

**SLB(Server load balancing)**是对集群内物理主机的负载均衡，而**GSLB**是对物理集群的负载均衡。

这里的负载均衡可能不只是简单的流量均匀分配,而是会根据策略的不同实现不同场景的应用交付。



### 全局负载均衡分类

基于DNS实现、基于重定向实现、基于路由协议实现。

特点：能通过判断服务器的负载，包括CPU占用、带宽占用等数据，决定服务器的可用性，同时能判断用户(访问者)与服务器间的链路状况，选择链路状况最好的服务器。因此GSLB是对服务器和链路进行综合判断来决定由哪个地点的服务器来提供服务，实现异地服务器群服务质量的保证。



### 调度算法

+ 健康检查—— 优先选用通过健康检查的服务IP。
+ Weighted-IP —— 根据Service-IP上手工配置的权重来分配请求。
+ Weighted-Site —— 根据站点上手工配置的权重来分配请求。
+ Capacity —— 优先选用可用最大会话容量值较多的站点。
+ Active-Servers —— 优先选用当前活跃服务器数量较多的站点。
+ Geographic —— 优先选用在地理位置上最接近的客户端的站点。
+ Connection-Load —— 优先选用新建连接数量未超过设定阀值的站点。
+ Num-Session —— 当站点会话数量没有超出配置的会话容量阀值时，优先选择有效会话数量较多的站点。
+ Admin-Preference —— 优先选择手工设定优先级最高的站点。
+ Least-Response —— 优先选择命中次数最少的站点。
+ Admin-IP TOP Only —— 基于手工设定的权重来选择站点。
+ 轮询 —— 按照请求的顺序依次选择站点。
+ 管理员别名—— 优先选择手工设定优先级最高的DNS CNAME记录类型。这个度量方法与Admin-Preference类似，但仅应用于DNS CNAME记录类型。
+ 加权别名 —— 按照CNAME记录类型上设置的权重值来选择CNAME解析结果。这个度量方法与Weight-IP类似，但仅应用于DNS CNAME记录类型。



## OSPF

OSPF开放最短路径优先，是一个基于链路状态的自治系统内部网关协议。目前针对IPv4协议使用的是OSPF Version 2。ospf直接工作在ip层之上，ip协议号89，ospf以组播方式发送协议包！由于OSPF通过最短路径优先算法计算得到路由表的，所以ospf的收敛速度较快。

就好比去一个陌生的城市去旅游，在某个起点（路由器A），你想要去往某个景点X，这时候有2个人，一个导游（路由器B），一个路人（路由器C），各自都告诉了你去往景点X不同的路径（传递路由表），导游告诉你他的路径只要5分钟（路径的度量值），路人告诉你他的路径要15分钟（路径的度量值），这时候通常你都会采用导游的路径（路由的选择并加入自己的路由表）



### OSPF的五种包

1. Hellow：发现邻居建立邻接关系，**作用**就是建立邻居和邻居保活
2. DBD：检查路由器的数据库之间是否同步
3. LSR：向另外一台设备请求特定的链路状态
4. LSU：发送链路状态信息
5. LSACK：确认多段的发送信息



### OSPF的三张表 

1. 邻居列表：记录所有建立了邻居关系的路由器，包括相关描述和邻居状态。会定期的相互发送hello报文来维护，若在一定的周期内没有收到领居回应的hello报文，则认为邻居路由器失效，将它从邻居表中删除
2. 链路状态数据库：此表里包含了网络拓扑中链路状态的通告。。**每台路由器在同一个区域内LSDB表一样**
3. 路由表：在获得完整LSDB表后，进行SPF算法，形成最优路由加入路由表



### 工作过程

1. 每台路由器学习激活的直接相连的网络。
2. 每台路由器和直接相连的路由器互交，发送Hello报文，发现并建立邻居关系。
3. 每台路由器构建包含直接相连的链路状态的LSA（Link-State Advertisement，链路状态通告）。链路状态通告(LSA)中记录了所有相关的路由器，包括邻路由器的标识、链路类型、带宽等。
4. 每台路由器泛洪链路状态通告（LSA）给所有的邻路由器，并且自己也在本地储存邻路由发过来的LSA，然后再将收到的LSA泛洪给自己的所有邻居，直到在同一区域中的所有路由器收到了所有的LSA。每台路由器在本地数据库中保存所有收到的LSA副本，这个数据库被称作"链路状态数据库（LSDB，Link-State Database）"
5. 每台路由器基于本地的"链路状态数据库(LSDB)"执行"最短路径优先（SPF）"算法，并以本路由器为根，生成一个SPF树，基于这个SPF树计算去往每个网络的最短路径，也就得到了最终的路由表。



### 使用场景

+ BGP协议支持的路由条目比较多，试用大型跨域的网络，实现AS间互联；
+ OSPF一般应用在企业网的内网，支持的路由条目毕BGP少很多；



## ECMP

等价多径路由，是一种基于流的负载均衡策略。ECMP存在多条不同链路到达同一目的地址的网络环境中，如果使用传统的路由技术，发往该目的地址的数据包只能利用其中的一条链路，其它链路处于备份状态或无效状态，并且在动态路由环境下相互的切换需要一定时间，而等值多路径路由协议可以在该网络环境下同时使用多条链路，不仅增加了传输带宽，并且可以无时延无丢包地备份失效链路的数据传输。



### ECMP的路径选择策略

1. 哈希，例如根据源IP地址的哈希为流选择路径；
2. 轮询，各个流在多条路径之间轮询传输；
3. 基于路径权重，根据路径的权重分配流，权重大的路径分配的流数量更多；



### 负载方式

1. 基于流负载分担

路由器根据IP报文的五元组信息（是指源IP地址，源端口，目的IP地址，目的端口，和传输层协议这五个量组成的一个集合。 例如：192.168.1.1 10000 TCP 121.14.88.76 80 就构成了一个五元组）将数据分成不同的流。具有相同五元组信息的IP报文属于同一个流。转发数据时，路由器把不同的数据流根据算法从多个路径上依次发送出去。

2. 基于包负载分担

转发数据时，路由器把数据包从多个路径上依次发送出去。

基于包转发能够做到更精确的负载分担。但是由于路由器要对每一个包进行路由查表与转发操作，所以无法使用快速转发缓存来转发数据，转发效率降低了。另外，Internet应用都是基于流的，如果路由器采用基于包的负载分担，一条流中的数据包会经过不同路径到达目的地，可能会造成接收方的乱序接收，从而影响应用程序的正常运行。

3. 基于带宽的非平衡负载分担

报文按接口物理带宽进行负载分担(即基于报文的负载分担)。当用户为接口配置了指定的负载带宽后，设备将按用户指定的接口带宽进行负载分担，即根据各接口物理带宽比例关系进行分配。



## BGP

边界网关协议（BGP）是运行于 TCP 上的一种自治系统的路由协议。BGP 构建在 EGP 的经验之上。 BGP用于在不同的自治系统（AS）之间交换路由信息。当两个AS需要交换路由信息时，每个AS都必须指定一个运行BGP的节点，来代表AS与其他的AS交换路由信息。这个节点可以是一个主机。但通常是路由器来执行BGP。两个AS中利用BGP交换信息的路由器也被称为边界网关（Border Gateway）或边界路由器（Border Router）



### 目的

为方便管理规模不断扩大的网络，网络被分成了不同的自治系统。BGP是为取代最初的EGP而设计的另一种外部网关协议。BGP能够进行路由优选、避免路由环路、更高效率的传递路由和维护大量的路由信息。



虽然BGP用于在AS之间传递路由信息，但并不是所有AS之间传递路由信息都需要运行BGP。比如在数据中心上行的连入Internet的出口上，为了避免Internet海量路由对数据中心内部网络的影响，设备采用静态路由代替BGP与外部网络通信。



- weight(权重值)
- local-preference(本地优先级)只在本地IBGP邻居间有效，不会通告给其他AS；用于判断流量离开AS最佳路由，local-preference值越大，即优先级越高（默认100）
- next-hop(优选本地下一跳)通过EBGP获得的路由再发布给IBGP邻居时，IBGP邻居收到的路由下一跳不改变，此时可以修改下一跳地址指向自己
- as-path（记录路由经过的AS）可以防止环路，如果收到BGP路由包含自己的AS号，则丢弃，as-path越短，路径越优先
- origin（起源属性）标识路径信息的来源，可以是三种值，

- - iGP 表示网络层可达信息源自AS内部
  - EGP 表示网络层可达信息源自AS外部学习
  - INCOMPLETE 败事网络层可达信息来源无法确定



### BGP的优点

BGP从多方面保证了网络的安全性、灵活性、稳定性、可靠性和高效性。



- BGP采用认证和GTSM的方式，保证了网络的安全性。
- BGP提供了丰富的路由策略，能够灵活的进行路由选路，并且能指导邻居按策略发布路由。
- BGP提供了路由聚合和路由衰减功能由于防止路由震荡，有效提高了网络的稳定性。
- BGP使用TCP作为其传输层协议（目的端口号179），并支持与BGP与BFD联动、BGP Tracking和BGP GR和NSR，提高了网络的可靠性。
- 在邻居数目多、路由量大且大部分邻居具有相同出口的策略的场景下，BGP使用按组打包技术极大的提高了BGP打包发包性能。
- BGP原理描述

### 

### BGP基本概念

#### 自治系统ASAutonomous System

AS是指在一个实体管辖下的拥有相同选路策略的IP网络。BGP网络中的每个AS都被分配一个唯一的AS号，用于区分不同的AS。AS号分为2字节AS号和4字节AS号，其中2字节AS号的范围为1至65535，4字节AS号的范围为1至4294967295。支持4字节AS号的设备能够与支持2字节AS号的设备兼容。



#### BGP分类

- EBGP：运行于不同AS之间的BGP称为EBGP。为了防止AS间产生环路，当BGP设备接收EBGP对等体发送的路由时，会将带有本地AS号的路由丢弃。
- IBGP：运行于同一AS内部的BGP称为IBGP。为了防止AS内产生环路，BGP设备不将从IBGP对等体学到的路由通告给其他IBGP对等体，并与所有IBGP对等体建立全连接。为了解决IBGP对等体的连接数量太多的问题，BGP设计了路由反射器和BGP联盟。



#### BGP报文交互中的角色

- Speaker：发送BGP报文的设备称为BGP发言者（Speaker），它接收或产生新的报文信息，并发布（Advertise）给其它BGP Speaker。
- Peer：相互交换报文的Speaker之间互称对等体（Peer）。若干相关的对等体可以构成对等体组（Peer Group）。



## 一个指针的大小是多少

指针大小跟编译器有关，用32位的编译器就是4，用64位编译器就是8