标签体系是各大公司业务系统最重要的基石，无论是user标签还是item标签。可以这样说，评价一个公司技术能力强弱，其构建起的标签体系是最关键的评价指标。这里基于个人经验，借鉴GNetMine以及PageRank算法，阐述自己设计的基于社交图谱的标签传播算法。

标签体系最基础也是最难的两个目标，就是准和全。准即准确率，要求算法打的标签要准确，毕竟标签体系很大一部分是作为其他后续算法的输入，如果后续算法的数据源都不准确，何谈产出好效果；全即覆盖率，要求覆盖一定量数据集，如果数据集很少那人工打标即可，还特别准，然而现实业务场景应用中，数据集非常大，人工只能打标其中一部分，这就要求算法要具有一般性。**这里我利用知识图谱的信息传递性，尤其社交网络中的关系传递，只用约万分之一的已标注样本量给大量待标注数据进行标签标注(约十万已标注账号给数十亿账号打标)，且效果准确，可用于商业推广。**

# 算法概述

基于约十万已标注账号信息，一段时间内账号间社交互动(关注、转发、评论等)信息，输出预测未标注账号属于各类别概率，设计了基于社交网络的多轮迭代标签传播算法。分为损失函数、标签传播、结果汇集三部分解释。总流程如下：
```c
初始化: f(0)=y, Loss(0)=Inf

while Loss变小:
    标签传播: 由第t-1轮结果f(t-1)和社交互动关系R，得到第t轮结果f(t)
    结果汇集: 基于第t轮结果f(t)汇集成p(t)
    损失计算: 基于p(t)计算Loss(t)

输出Loss最小一轮结果p
```

算法基于知识图谱的信息传递性（[相关知识](https://www.yuque.com/angsweet/machine-learning/wang-luo-tu-mo-xing_wang-luo-tu-mo-xing_da-gui-mo-tu-chu-li_heterogeneous-network)之前阐述过，这里我就不展开赘述了），可以想象农田水渠灌溉，标签传播就像水流随着水渠流动，只不过算法中是类别信息按照社交互动行为进行流动，且是多源头的，比如下图，大的几个图标是源头，他们的标签信息会随着和他们进行互动的路径传播出去。这里的多源既是多类别源头(比如下面红绿蓝3个最大的图标各代表1类的源头，共3类)，也指的单类别多源头(假设下面是黑色的，都是一个类别，这个类别有3个信息源)。

![](./img/1599441029086-4a40237f-662c-459d-9cab-eb750e020df2.jpeg)
<a name="duo-tiao-chuan-bo"></a>

## **多跳传播**
灰色为未知类别，用户b对用户c进行过互动(比如6次转发等)，用户c的类别就会传递给b(左图)。经过上一轮的传递后，用户b从c那里获得了类别信息，用户a对b也进行过互动(比如4次评论等)，c的类别信息就由经b也流向了a，即完成了2 hop传播(右图)。现实网络里肯定存在环，所以会有无穷尽hop传播，我们基于Loss在合适的时刻进行切断。<br />![](./img/1599441029135-130bd93a-fb5f-4124-88f0-0ab1fa9101a3.png)![](./img/1599441029088-387af55e-78ef-4e6e-941f-bc986eded104.png)
<a name="kua-lei-yu-zi-chuan-bo"></a>
## **跨类与自传播**
就如我们前面说多源部分说的，可能一个用户(如左图用户a)和多个类别的(用户b、c)进行过互动，那b和c的标签信息都流给a，a也会将他们两个信息也再往后传(左图)。还有自传播(用户b转发10次自己的文章)，已标注另一类别的传播给本类别节点(用户c传播给用户b)等(右图)。<br />![](./img/1599441029184-e56df60a-156e-4f6a-a912-1338e049be66.png)![](./img/1599441029172-dd550063-6a3a-4b03-9178-6f24c9009aa3.png)
<a name="suan-fa-she-ji"></a>
# 算法设计
<a name="sun-shi-han-shu"></a>
## 损失函数
损失如下公式，由精度损失和泛化损失两部分组成，其中![](./img/7b7f9dbfea05c83784f8b85149852f08.svg)和![](./img/b0603860fcffe94e5b8eec59ed813421.svg)调节更关注准确还是泛化：

![](./img/0859b3ace5aec57761e9da3173558223.svg)<br />1、精度损失：![](./img/e86cb5d9243ebcdb20569d17c15436c6.svg)

- 集合![](./img/dd7536794b63bf90eccfd37f9b147d7f.svg)为Ground Truth，即人工标注样本的集合；
- 参数![](./img/65445646e7a531a2185d03b58b4d60e1.svg)表示第![](./img/865c0c0b4ab0e063e5caa3387c1a8741.svg)个已标注样本账号的重要程度，比如在微博场景下是此账号的粉丝数等，我们更倾向于将粉丝量大的账号类别预测准；
- 余弦距离![](./img/6070a644048caa9148b29abe4ba839e9.svg)即第![](./img/e358efa489f58062f10dd7316b65649e.svg)轮账号![](./img/865c0c0b4ab0e063e5caa3387c1a8741.svg)的预测向量和其Ground Truth向量的余弦距离，向量每一列对应一个类别，比如分成语数外三类，![](./img/7aedd96bc1aaae16a106d6c81ef7a573.svg) ，账号![](./img/73417220282d3e9d58544d3eaeddc604.svg)实际属于数学类别。

2、泛化损失：![](./img/7b838a4acd905b905edb022ac28aa821.svg) 

- 集合![](./img/5dbc98dcc983a70728bd082d1a47546e.svg)为相似账号的集合；
- 参数![](./img/c99dfa4e490ed0018dfb299022419234.svg)表示账号![](./img/0cc175b9c0f1b6a831c399e269772661.svg)和![](./img/92eb5ffee6ae2fec3ad71c777531578f.svg)的相似程度，可以使用SimRank，Random Walk，PathSim等等，这里我采用了粉丝重合度![](./img/8262a09a64ae881d2dd372d29530786e.svg)，两账号粉丝交集数/两账号粉丝并集数，我们更倾向于关注粉丝重合度高的账号对，物理意义即若两账号粉丝相同，则两账号类别大概率相似；
- 余弦距离![](./img/6ddd9f21138d757b9b451a8cffb0bac4.svg)第![](./img/e358efa489f58062f10dd7316b65649e.svg)轮账号![](./img/0cc175b9c0f1b6a831c399e269772661.svg)的预测向量和账号![](./img/92eb5ffee6ae2fec3ad71c777531578f.svg)的预测向量的余弦距离。
<a name="biao-qian-chuan-bo"></a>
## 标签传播
具体标签传播过程可以由下面公式表达，第![](./img/43c98a64bcde4857b095743482e04281.svg)轮结果由第![](./img/e358efa489f58062f10dd7316b65649e.svg)轮结果进行传播加Ground Truth：

![](./img/d53bc19e83a9cf352851c8e34976ff09.svg)

1、标签传播：![](./img/4464535fc2ff33cdff6fdb773e29ccaa.svg)

- 集合![](./img/e1e1d3d40573127e9ee0480caf1283d6.svg)为社交互动类型集合，比如![](./img/a84c28e4c62eed7fee0fb91610cf7198.svg)，![](./img/4b43b0aee35624cd95b910189b3dc231.svg)即其中一种互动类型；
- ![](./img/cf25b8d557544eb88ee0dafbcdae7de2.svg)即互动类型![](./img/4b43b0aee35624cd95b910189b3dc231.svg)的影响因子，比如微博场景下关注、转发、评论的社交成本是不一样的，转发的少，而评论和关注次之，而大家经常随意点赞，这个因子是调节不同社交互动的融合权重；
- ![](./img/e72b070649097be3b9b9e77c750b4ed1.svg)为账号影响力矩阵，一百万个粉丝的账号和一万个粉丝的账号影响力不同，使用这个矩阵进行调节影响力权重，比如账号的对应影响力权重为其粉丝量；
- ![](./img/7a18f340ce446702084e5b59612b64e1.svg)矩阵就是标签传播的路径。以关注关系简单举例，假设社交网络中有![](./img/69691c7bdcc3ce6d5d8a1361f22d04ac.svg)个账号节点，行表示关注人，列表示被关注人，矩阵![](./img/7a18f340ce446702084e5b59612b64e1.svg)为![](./img/627dfe3da8c871a94e9f209e28cc7121.svg)维，假设账号![](./img/6f8f57715090da2632453988d9a1501b.svg)共关注了![](./img/0cc175b9c0f1b6a831c399e269772661.svg)、![](./img/92eb5ffee6ae2fec3ad71c777531578f.svg)和![](./img/4a8a08f09d37b73795649038408b5f33.svg)三个账号，则![](./img/7a18f340ce446702084e5b59612b64e1.svg)矩阵中对应![](./img/6f8f57715090da2632453988d9a1501b.svg)账号行，对应![](./img/0cc175b9c0f1b6a831c399e269772661.svg)、![](./img/92eb5ffee6ae2fec3ad71c777531578f.svg)和![](./img/4a8a08f09d37b73795649038408b5f33.svg)账号列的值各为![](./img/7964c6a339acf2ddea25a5ef0552b97e.svg)；
- ![](./img/d6e3af948a34fd5f432cb9d377a98ef0.svg)即第![](./img/e358efa489f58062f10dd7316b65649e.svg)轮结果，若![](./img/69691c7bdcc3ce6d5d8a1361f22d04ac.svg)个账号分为![](./img/8d9c307cb7f3c4a32822a51922d1ceaa.svg)类，则![](./img/d6e3af948a34fd5f432cb9d377a98ef0.svg)是一个![](./img/77a72b608a1beff4bf12b46d0ee0f3bb.svg)的矩阵，第![](./img/6f8f57715090da2632453988d9a1501b.svg)行第![](./img/7b8b965ad4bca0e41ab51de7b31363a1.svg)列即代表账号![](./img/6f8f57715090da2632453988d9a1501b.svg)属于第![](./img/7b8b965ad4bca0e41ab51de7b31363a1.svg)类的权值，其中第![](./img/cfcd208495d565ef66e7dff9f98764da.svg)轮初始化![](./img/2710549829fad1a2ad40f93025593935.svg)，即假设有![](./img/a5f3c6a11b03839d46af9fb43c97c188.svg)个已标注账号，![](./img/01ba77110113019916a9054319ae7c05.svg)的这![](./img/a5f3c6a11b03839d46af9fb43c97c188.svg)行对应的所属类别列值为![](./img/c4ca4238a0b923820dcc509a6f75849b.svg)，其他为![](./img/cfcd208495d565ef66e7dff9f98764da.svg)，剩下的![](./img/09c7ab37639caebf5797e81dbc4d26fa.svg)行(待分类账号属于各类权值)全为![](./img/cfcd208495d565ef66e7dff9f98764da.svg)。

2、加入Ground Truth：![](./img/fd60b3e53a5ecc171e9480faecb685cf.svg)

- 每轮结果再加入Ground Truth，![](./img/a1c5ef84a61f97159520c00e49a728a0.svg)为行业及账号权重调节，比如微博场景下，文娱和金融和教育几个类别量级是不一样的，这里做标准化；
- ![](./img/415290769594460e2e485922904f345d.svg)即Ground Truth的矩阵。
<a name="jie-guo-hui-ji"></a>
## 结果汇集
获得第![](./img/e358efa489f58062f10dd7316b65649e.svg)轮的结果![](./img/d6e3af948a34fd5f432cb9d377a98ef0.svg)后，根据关系对聚合成对应账号的结果向量：

![](./img/4c4e233835999ca322d9d934083d1852.svg)

账号![](./img/9dd4e461268c8034f5c8564e155c67a6.svg)结果通过其粉丝集合![](./img/7fc56270e7a70fa81a5935b72eacbe29.svg)求和，然后经过输出函数得到。输出函数![](./img/a2ab7d71a0f07f388ff823293c147d21.svg)任选，比如softmax，数据量太大可以直接计算对应值除以总和得到占比。
<a name="suan-fa-jie-shi"></a>
# 算法解释
**具体实现：**可以看到，算法基于矩阵运算，可以使用GPU加速。当然，直接用Hive也可以实现，矩阵加法用union+sum group by，乘法用inner join，稀疏矩阵里的![](./img/cfcd208495d565ef66e7dff9f98764da.svg)在数据表里不存在此记录，所以数据量、计算速度也都可以接受。

**标签传播：**算法下一轮结果![](./img/9e8103325ff5ec4fc438a9672482e43f.svg)都由当前轮结果![](./img/d6e3af948a34fd5f432cb9d377a98ef0.svg)进行标签传播再加Ground Truth ![](./img/415290769594460e2e485922904f345d.svg)，可以想象为农田水渠灌溉，每轮加Ground Truth就像水源头，标签传播就像水流随着水渠流动，只不过算法中是类别权重按照社交互动行为进行流动。

**多跳传播：**第![](./img/e358efa489f58062f10dd7316b65649e.svg)轮，会进行![](./img/69d662b562733cfcbccf8de90531f842.svg)跳传播，例如![](./img/3f3d5118e374c670258e6e2b2cfb1b0c.svg)时，只有![](./img/c4ca4238a0b923820dcc509a6f75849b.svg)跳传播，已标注账号的信息传播至与其进行过社交互动的账号；当![](./img/a048559662d4b59eb8308cf4f404c163.svg)时，已标注账号的信息依旧传播至与其社交互动的账号(![](./img/c4ca4238a0b923820dcc509a6f75849b.svg)跳)，此时上一轮通过![](./img/c4ca4238a0b923820dcc509a6f75849b.svg)跳得到信息的账号，在这一轮将信息传给了与他互动的账号，即已标注账号信息通过![](./img/c4ca4238a0b923820dcc509a6f75849b.svg)跳媒介又将信息传播了出去(![](./img/c81e728d9d4c2f636f067f89cc14862c.svg)跳)...

**Loss表现：**1、对于精度损失(已标注账号和其预估结果)，每个账号的![](./img/7b8b965ad4bca0e41ab51de7b31363a1.svg)维向量![](./img/be26619828025bdf0f9f8fb9041b6d49.svg)是由其粉丝向量聚合得到，已标注账号![](./img/9dd4e461268c8034f5c8564e155c67a6.svg)的标签传给其粉丝，粉丝又将标签汇集给已标注账号![](./img/9dd4e461268c8034f5c8564e155c67a6.svg)；对于泛化损失(粉丝相同两账号分类应相似)，粉丝重合越高，两账号![](./img/0cc175b9c0f1b6a831c399e269772661.svg)和![](./img/92eb5ffee6ae2fec3ad71c777531578f.svg)越相似，获得的![](./img/7b8b965ad4bca0e41ab51de7b31363a1.svg)维向量![](./img/c21f32bec8fa72d2d23160d8090b53f3.svg)和![](./img/14fd4b957cce85bd6ece642052471ca5.svg)由粉丝向量聚合得到，所以也会约接近。随着轮数越来越多，标签传播hop增多，噪声干扰会越来越多，会导致Loss上升。所以模型经多轮计算，Loss逐渐下降，待到开始上升时停止迭代，输出Loss最小轮时所生成的结果。

**应用方式：**算法最后得出的是一个![](./img/77a72b608a1beff4bf12b46d0ee0f3bb.svg)维的矩阵，其中![](./img/69691c7bdcc3ce6d5d8a1361f22d04ac.svg)是账号数，每个账号对应一行，![](./img/8d9c307cb7f3c4a32822a51922d1ceaa.svg)是类别数，第![](./img/7b8b965ad4bca0e41ab51de7b31363a1.svg)列的值为属于这个类别的权值。所以，一个账号对应一个可解释的![](./img/8d9c307cb7f3c4a32822a51922d1ceaa.svg)维向量：

- 账号分类，比如进行广告行业分类，一个娱乐搞笑账号投什么行业广告比较好也就知道了 
- 通过计算向量间余弦距离，获得相似账号，进行账号聚类，Lookalike扩充等
- 当然，向量可以作为后续算法的输入，为匹配，点击等等模型提供源数据
- 结果发现会有向量值全![](./img/cfcd208495d565ef66e7dff9f98764da.svg)的异常账号，查验这些是刷的僵尸号，也可用于甄别异常号
<a name="6toTR"></a>
# 结果展示
![示意图.png](./img/1599462772805-baea6ca4-2ca7-416c-ae03-c342121b35e0.png)<br />![最相似.png](./img/1599463828314-fb2ab469-12c9-4afd-bb46-2361d093ee5c.png)
