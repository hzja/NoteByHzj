# 区块链全套教程

学习视频地址:https://www.bilibili.com/video/BV1NJ411D7rf?p=1&vd_source=1e325091774aa31c4dcd65d8667c69de

参考仓库地址:https://github.com/KrisJiaqiXie/my_simple_voting_dapp

## 以太坊(Ethereum)

### 为什么要学习以太坊

+ 庞大开发者社区,是目前最大的区块链开发平台
+ 相对较成熟,有代表性,资料众多
+ 以应用入手,学习曲线不那么陡峭
+ 与JavaScript结合紧密,方便开发人员入手
  
### 学习目标

+ 掌握以太坊的基本概念和工作原理
+ 理解以太坊和比特币的联系和区别
+ 掌握以太坊客户端的使用
+ 深入理解智能合约
+ 掌握Solidity语法并能写出复杂合约
+ 掌握web3.js的调用并能实现具体DApp
+ 综合运用各种工具完成较复杂项目
  
### 主要参考资料

+ 《精通以太坊》(Mastering Ethereum):https://github.com/ethereumbook/ethereumbook/
+ 《以太坊白皮书》(A Next-Generation Smart Contract and Decentralized Application Platform):https://github.com/ethereum/wiki/wiki/White-Paper
+ 《以太坊黄皮书》(《以太坊：一种安全去中心化的通用交易账本 拜占庭版本》)
+ 《以太坊官方文档》(Ethereum Homestead Documentation):http://www.ethdocs.org/en/latest/index.html
+ 《Solidity官方文档》:https://solidity.readthedocs.io/en/latest/

### 涉及工具

+ MetaMask：浏览器插件钱包
+ Remix:基于浏览器的Solidity在线编辑器
+ Geth:以太坊客户端（go语言)
+ web3.js:以太坊javascript API库
+ Ganach:以太坊客户端(测试环境私链)
+ Truffle:以太坊开发框架
  
### 环境准备

+ Chrome浏览器(最新版本)
+ Linux系统或虚拟机(ubuntu 16.04.3)
    需要装:go git node npm
+ 文本编辑器(VisualCode)
+ 科学上网工具 
  
## 以太坊简介

### 区块链发展简史

+ 2008年,区块链1.0(比特币),只是简单的记账
+ 2014年,区块链2.0(以太坊),智能合约
+ 2017年,区块链3.0(EOS、ArcBlock、IOTA等),高性能、大吞吐量、开发者友好、用户友好

### 发展阶段

+ "前沿"(Frointier) - Block #0
  
    以太坊初始阶段,持续时间为2015年7月30日至2016年3月
    
+ "家园"(Homestead) - Block #1,150,000

​	   以太坊第二阶段,于2016年3月推出

+ "大都会"(Metropolis)Block #4370000

​	  以太坊第三阶段,于2017年10月推出"拜占庭"(Byzantium)是Metropolis的两个硬分叉中第一个,也是我们现在所处阶段

​	  ”君士坦丁堡“(Constantinople)

​	  Metropolis阶段第二部分,计划于2018年推出.预计将包括切换到混合POW/POS共识算法以及其他变更.

+ "宁静"(Serenity)

  以太坊第四个也是最后一个

### 重大分叉

+ Block #200000

  "Ice Age"-引入指数难度增加的硬分叉促使项Proof-of-State过渡

+ Block #1192000

  "The DAO"-扭转了被攻击的DAO合约并导致以太坊和以太坊经典分裂为两个竞争系统的硬分叉,保留所有历史记录的链称"以太坊经典(ETC)"而分叉出来的就是"以太坊(ETA)"

+ Block #2463000

  "Tangerine Whistle"-改变某些IO运算的gas运算并从拒绝服务攻击中清除累积状态,该攻击利用了这些操作的低gas成本.

+ Block #2675000

  "Spurious Dragon"-一个解决更多拒绝服务攻击媒介的硬分叉以及另一状态清除.此外还有重放攻击保护机制

### 发展现状

+ 根据State of DApps统计,目前运行在以太坊的合约多达47228个;

+ 而以太坊地址数也达到4000w以上,如图:

  

  ![FireShot Capture 014 - 002_尚硅谷_以太坊简介（一）_哔哩哔哩_bilibil_ - https___www.bilibili.com_video_BV1NJ411D7rf_](D:\Note\区块链\图片\FireShot Capture 014 - 002_尚硅谷_以太坊简介（一）_哔哩哔哩_bilibil_ - https___www.bilibili.com_video_BV1NJ411D7rf_.png)

  ---

  ---

  ---
  
  ### 以太坊特点
  
  + 以太坊是“世界计算机”,代表其是一个开源、全球分布的计算基础设施;
  + 可执行称为智能合约(smart contract)程序
  + 使用区块链同步和存储系统状态以及名为以太币(ether)的加密货币以计量和约束执行资源成本(以太坊无法买到而以太币可买到)
  + 本质是一个基于交易的状态机(transaction-based state machine)
  + 以太坊平台使开发人员能构建具有内置经济功能的强大去中心化应用程序(DApp),在持续自我正常运行时还减少或消除了审查即第三方界面和交易对手风险(内置经济功能指具有以太的经济特性)

  ---

  ps：矿工挖矿时，将所有的区块打包在一起然后出一个区块广播出去让其他矿工确认，若大家都认同则大家都认同的账本即增长则	在账本后增加一个区块，所有的区块连接起来就构成了区块链。

  ---

  ---

  ---

  ### 以太坊组成部分	

  + #### P2P网络

    以太坊在以太坊主网络上运行,该网络可在TCP端口30303上寻址并运行一个名为DEVp2p的协议

  + #### 交易(Transaction)

    以太坊交易是网络消息，其中包括发送者(sender),接收者(recevier),值(value)和数据有效载荷(payload)
  
  + #### 以太坊虚拟机(EVM)
  
    以太坊虚拟机(EVM)是以太坊被称为世界级计算机的原因;
  
    以太坊状态转换由以太坊虚拟机(EVM)处理,这是一个执行字节码(机器语言指令)的基于堆栈的虚拟机;
  
  + #### 数据库(Blockchain)
  
    以太坊区块链作为数据库(通常是Google的LevelDB)本地存储在每个节点上,包含序列化后的交易结果和系统状态;
  
  + #### 客户端
  
    以太坊由几种可互操作的客户端软件实现而其中最突出的是Go-Ethereum(Geth)和Parity;
  
  ### 以太坊中的重要概念
  
  + #### 账户(Account)
  
    包含地址,余额和随机数以及可选的存储和代码的对象
  
    - 普通账户(EOA),存储和代码均为空;
    - 合约账户(Contract),包含存储和代码;
  
  + #### 地址(Address)
  
    一般来说这代表一个EOA或合约可在区块链上接收或发送交易,更具体地说其是ECDSA(椭圆曲线算法)公钥的keccak散列最右边的160位
  
  + #### 交易(Transaction)
  
    + 可发送以太币和信息;
    + 向合约发送的交易可调用合约代码并以信息数据为函数参数;
    + 向空用户发送信息可自动生成以信息为代码块的合约账户;
  
  + #### gas (可简单理解为以太坊的手续费但实际不准确)
  
    以太坊用于执行智能合约的虚拟燃料，以太坊虚拟机使用核算机制衡量gas的消耗量并限制计算资源的消耗

---

---

---

### 以太币的货币

​		以太坊的货币单位成为以太(ether),也可表示为ETH或符号E

#### 	以太币的发行规则:

+ 挖矿前(Pre-mine,Genesis)

​		2014年7月/8月间,为众筹大约发行了7200万以太币用于兑换比特币,这些币有时候被称为"矿前".众筹阶段之后以太币每年产量基本稳	定,被限制不超过7200万的25％(即1800万).

+ 挖矿产出(Mining),凭空产生

  ----区块奖励(block reward),

  ----叔块奖励(uncle reward)

  ----叔块引用奖励(uncle referencing reward)

+ 以太币产量未来的变化

​		以太坊出块机制从工作量证明(PoW)转换为股权证明(PoS)后以太币的发行会有什么变化尚未有定论.股权证明机制将使用一个称为	    	Casper的协议,而在Casper(精灵)协议下以太币发行率将大大低于目前幽灵(GHOST)协议下的发行率.(股权证明即拥有的以太币越多则	挖矿成功率越高)

---

---

---

### 以太坊的挖矿产出

+ #### 区块奖励(Block rewards)

​	每产生一个新区快就会有一笔固定奖励给矿工,初始是五个以太币而现在是三个

​	以太坊出块速度比比特币快很多,比特币出块速度大约为1块/10分钟,而以太坊出块速度大约为1块/10多秒

+ #### 叔块奖励

​	有些区块被挖得稍晚一些则不能作为主区块链的组成部分,比特币称这类区块为"孤块"并且完全舍弃,但以太币称其为叔块(uncles)并在之后区块中可引用它们.如果叔块在之后区块链中作为叔块被引用则每个叔块会为挖矿者产出区块奖励的7/8(大约2.625个以太币),这被称为叔块奖励.

​	区块链中,子块的父亲称为父块,而子块的叔叔则称为叔块

+ #### 数块引用奖励(Uncle referencing rewards)

​	矿工每引用一个叔块可得到区块奖励的1/32作为奖励(最多引用两个叔块),这种机制鼓励引用

+ #### 这样一套基于POW的奖励机制被称为以太坊的”幽灵协议“

---

---

---

### 以太币供应

![FireShot Capture 015 - 004_尚硅谷_以太坊简介（三）_哔哩哔哩_bilibil_ - https___www.bilibili.com_video_BV1NJ411D7rf_](D:\Note\区块链\图片\FireShot Capture 015 - 004_尚硅谷_以太坊简介（三）_哔哩哔哩_bilibil_ - https___www.bilibili.com_video_BV1NJ411D7rf_.png)

每年以太币供应量基本一样,故以太币供应量以一条直线往上涨;

但在2018年8、9月份时“拜占庭”出现后斜率发生了变化，这是因为以太币的奖励措施发生了变化，由每次奖5个变为每次奖3个;

![FireShot Capture 016 - 004_尚硅谷_以太坊简介（三）_哔哩哔哩_bilibil_ - https___www.bilibili.com_video_BV1NJ411D7rf_](D:\Note\区块链\图片\FireShot Capture 016 - 004_尚硅谷_以太坊简介（三）_哔哩哔哩_bilibil_ - https___www.bilibili.com_video_BV1NJ411D7rf_.png)这些是截止2018年11月的数据;

---

---

---

### 以太坊区块收入

+ #### 普通区块收入

  + 固定奖励(挖矿奖励)，每个普通区块都有;
  + 区块内包含的所有程序gas花费总和;
  + 若普通区块引用了叔块则每引用一个叔块可得到固定奖励的1/32;

+ #### 叔块收入

  叔块收入只有一项即叔块奖励,具体计算公式为：叔块奖励=(叔块高度+8-引用叔块的区块高度)*普通区块奖励/8;

​		引用叔块的区块与叔块的亲缘关系越远,可获得的叔块奖励就越少;

---

---

---

### 区块链浏览器：etherscan.io

简介：应用最广泛、使用最多的区块链浏览器，上面所有区块、所有交易、所有区块链相关信息都可以看到

![FireShot Capture 017 - Ethereum (ETH) Blockchain Explorer - https___etherscan.io_](D:\Note\区块链\图片\FireShot Capture 017 - Ethereum (ETH) Blockchain Explorer - https___etherscan.io_.png)

​																								首页介绍

![](D:\Note\区块链\图片\FireShot Capture 019 - Ethereum Blocks #16543197 I Etherscan - https___etherscan.io_block_16543197.png)

​																						具体区块链信息

---

---

---

### “幽灵”协议

+ 以太坊出块时间：设计为12秒(略大于广播时间)，实际为14-15秒左右(比特币出块时间是10分钟而广播时间大约12.6秒基本覆盖全网的95％)(出块时间越短挖块难度越低)

+ 快速确认会带来区块的高作废率,由此链的安全性也会降低(由于出块时间短，有优势的选手会越来越有优势，最终造成中心化)

+ “幽灵”协议:Greedy Heaviest Observed SubTree,"GHOST"(为了提高链的安全性去中心化，提出”幽灵协议")

  --将所有加起来最重(权重最重)的子链作为主链，而不是像比特币选择最长的链作为主链；

  --计算工作量证明时不仅包括当前区块的祖区块，父区块，还要包括祖区块作废的后代区块("叔区块"),将他们综合考虑;

  --目前协议要求下探到第七层(最早简版设计是五层)，即废区块只能以叔区块身份被其父母第二代至第七代后辈区块引用而不能是更远关系的后辈区块；

  --以太坊付给以”叔区块"身份为新块确认作出贡献的废区块7/8奖励，把它们纳入计算的"侄子区块"将获得区块奖励的1/32，不过交易费用不会奖励给叔区块;

---

---

---

### 以太坊和图灵完备

+ 1936年英国数学家艾伦图灵(Alan Turing)创建了一个计算机的数学模型，其由一个控制器、一个读写头和一根无限长工作带组成。

  纸带起存储作用，被分成一个个小方格(可看成磁带)；读写头可读取纸带上信息以及将运算结果写进纸带；控制器负责根据程序对搜集到信息进行处理。每个时刻机器头都要从当前纸带读入一个方格信息然后结合自己内部状态查找程序表而后根据程序输出信息到纸带方格并转换自己内部状态后进行移动纸带；

+ 若一个系统可模拟任何图灵机即被定义为"图灵完备"(Turing Complete),这种系统被称为通用图灵机(UTM);

+ 以太坊能在称为以太坊虚拟机的状态机中执行存储程序，同时向内存读取和写入数据使其成为图灵完备系统，因此成为通用图灵机；

  考虑到有限存储器限制，以太坊可计算任何可由任何图灵机计算的算法；

+ 简单说以太坊中支持循环语句，理论上可运行"无限循环"程序；

---

---

---

### 去中心化应用

+ 基于以太坊可以构建智能合约(Smart Contract)构建<b>去中心化应用(Decentralized Application,简称DApp)</b>；

+ 以太坊构想是成为DApps编程开发平台；

+ DApp至少由以下组成：

  ----区块链上智能合约；(当成Web后端)

  ----Web前端用户界面；

----

----

---

### 以太坊应用

+ 基于以太坊创建新的加密货币(CryptoCurrency，该能力是2017年各种ICO泛滥的技术动因)；

+ 基于以太坊创建域名注册系统、博彩系统；

+ 基于以太坊开发去中心化的游戏，如2017年底红极一时的以太猫(CryptoKitties,最高单只猫售价高达80W美元)

---

---

---

### 代币(Token)

+ 代币(token)也称作通证,本意为"令牌",代表具有所有权资产、货币、权限等在区块链的抽象；

+ 可替代性通证(fungible token)：指基于区块链技术发行,互相可替代,可接近无限拆分token;(基于DApp，代表EOS)

+ 非同质通证(non-fungible token):指基于区块链技术发行的、唯一的、不可替代的，大多数情况下不可拆分的token，如加密猫(CryptoKitties,就是NFT)

  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili1](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili1.png)

  ---

  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili2](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili2.png)

  ---

  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 3](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 3.png)
  
  ---
  
  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 4](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 4.png)
  
  ---
  
  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 5](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 5.png)
  
  ---
  
  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 6](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 6.png)
  
  ---
  
  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 7](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili 7.png)
  
  ---
  
  ![007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili8](D:\Note\区块链\图片\007_尚硅谷_以太坊简介（六）_哔哩哔哩_bilibili8.png)
  
  ---
  
  #### 名词解释
  
  + <b>EIP:</b> Ethereum Improvement Proposals,以太坊改进建议
  + <b>ERC:</b> Ethereum Request for Comments的缩写，以太坊征求意见。一些EIP被标记为ERC,表示试图定义以太坊使用的特定标准的提议
  + <b>EOA:</b> External Owned Account,外部账户。由以太坊网络的人类用户创建的账户
  + <b>Ethash:</b> 以太坊1.0的工作量证明算法
  + <b>HD钱包:</b> 使用分层确定性（HD protocol)密钥创建和转账协议(BIP32)的钱包
  + <b>Keccak256:</b> 以太坊中使用的密码哈希函数，Keccak256被标准化为SHA-3
  + <b>Nonce:</b> 密码学中术语nonce用于指代只能使用一次的值，以太坊使用两种类型随机数分别是账户随机数和POW随机数
  
  ---
  
  ---
  
  ---
  
  ## 初识以太坊
  
  ---
  
  ### 账户和钱包
  
  ---
  
  #### 以太币单位
  
  + 以太坊的货币单位称为以太，也称为ETH或符号E
  + ether被细分为更小单位知道可能的最小单位，称为wei;1 ether = 10^18 wei
  + 以太的值总是在以太坊内部表示为以wei表示的无符号整数值；
  + 以太的各种单位都有一个使用国际单位制(SI)科学名称和一个口语名称；
  
  
  
  #### 以太坊各单位名称
  
  ---
  
  | 值(wei)                           | 指数  | 通用名称 | SI名称                |
  | --------------------------------- | ----- | -------- | --------------------- |
  | 1                                 | 1     | wei      | wei                   |
  | 1,000                             | 10^3  | babbage  | kilowei or femtoether |
  | 1,000,000                         | 10^6  | lovelace | megawei or picoether  |
  | 1,000,000,000                     | 10^9  | shannon  | gigawei or nanoether  |
  | 1,000,000,000,000                 | 10^12 | szabo    | microether or micro   |
  | 1,000,000,000,000,000             | 10^15 | finney   | milliether or milli   |
  | 1,000,000,000,000,000,000         | 10^18 | ether    | ether                 |
  | 1,000,000,000,000,000,000,000     | 10^21 | grand    | kiloether             |
  | 1,000,000,000,000,000,000,000,000 | 10^24 |          | megaether             |
  
  
  
  #### 以太坊钱包
  
  ---
  
  以太坊钱包是进入以太坊系统的门户，其包含了私钥，可代表创建和广播交易
  
  + MetaMask:一个浏览器扩展钱包，可在浏览器运行(也可当成插件);
  + Jaxx:一款多平台、多币种钱包，可在各种操作系统运行，包括Android、iOS、Windows、Mac和Linux;
  + MyEtherWallet(MEW):一个基于web钱包,可在任何浏览器运行;
  + Emerald Wallet:旨在与ETC配合使用,但与其他基于以太坊区块链兼容;
  
  
  
  #### 私钥、公钥和地址
  
  ---
  
  + 私钥(Private Key)
  
    以太坊私钥事实上只是一个256位随机数，用于发送以太的交易中创建签名证明自己对资金的所有权
  
  + 公钥(Public Key)
  
    公钥是由私钥通过椭圆曲线加密secp256k1算法单向生成的512(64字节)数
  
  + 地址(Address)
  
    地址是由公钥的Keccak-256单向哈希，取最后20个字节(160位)派生出来的标识符
  
  
  
  #### 安全须知
  
  ---
  
  + keystore文件就是加密存储的私钥,故当系统提示选择密码时：将其设置为强密码,备份不要共享。若没有密码管理器,将其写下来并将其存放在带锁的抽屉或保险箱中。要访问账户，必须同时有keystore文件和密码。
  + 帮助记词可导出私钥,故可认为助记词就是私钥,可使用纸和笔物理备份,不要将这个任务留给"以后",否则会忘记;
  + 私钥可以用椭圆加密曲线算法单向导出公钥，公钥可以用哈希然后取后160位单向导出地址；
  + <b>有私钥啥都有，没私钥啥都没；</b>
  + 切勿以简单形式存储私钥,尤其以电子方式存储,物理存储最安全;
  + 不要将私钥资料存储在电子文档、数码照片、屏幕截图、在线驱动器、加密PDF等中，使用密码管理器或笔和纸;
  + 在转移任何大额金额前,首先做一个小的测试交易(如，小于1美元),收到测试交易后再尝试从该钱包发送;
  
  现在看到[[009_尚硅谷_初识以太坊（二）主网络和测试网络_哔哩哔哩_bilibili](https://www.bilibili.com/video/BV1NJ411D7rf?p=9&vd_source=1e325091774aa31c4dcd65d8667c69de)]

