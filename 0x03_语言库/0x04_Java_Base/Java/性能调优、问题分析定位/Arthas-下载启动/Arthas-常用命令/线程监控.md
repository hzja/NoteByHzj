Java Arthas
<a name="NUxiM"></a>
### thread-查看当前 JVM 的线程堆栈信息
<a name="wXwYF"></a>
#### thread -h ：thread命令的帮助
```bash
[arthas@9244]$ thread -h
 USAGE:
   thread [-h] [-b] [--lockedMonitors] [--lockedSynchronizers] [-i <value>] [--state <value>] [-n <value>] [id]

 SUMMARY:
   Display thread info, thread stack

 EXAMPLES:
   thread
   thread 51
   thread -n -1
   thread -n 5
   thread -b
   thread -i 2000
   thread --state BLOCKED

 WIKI:
   https://alibaba.github.io/arthas/thread

 OPTIONS:
 -h, --help                              this help
 -b, --include-blocking-thread           Find the thread who is holding a lock that blocks the most number of threads.
     --lockedMonitors                    Find the thread info with lockedMonitors flag, default value is false.
     --lockedSynchronizers               Find the thread info with lockedSynchronizers flag, default value is false.
 -i, --sample-interval <value>           Specify the sampling interval (in ms) when calculating cpu usage.
     --state <value>                     Display the thead filter by the state. NEW, RUNNABLE, TIMED_WAITING, WAITING,
                                          BLOCKED, TERMINATED is optional.
 -n, --top-n-threads <value>             The number of thread(s) to show, ordered by cpu utilization, -1 to show all.
 <id>                                    Show thread stack
[arthas@9244]$
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1594879338366-c3e79b07-a7aa-4504-918a-cefc36e722be.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2111032&status=done&style=none&width=1107.6666666666667)
<a name="u3mpJ"></a>
#### thread：查看所有线程的情况
打印出线程总数和线程状态，便于问题的排查分析
```bash
[arthas@9244]$ thread
Threads Total: 56, NEW: 0, RUNNABLE: 29, BLOCKED: 0, WAITING: 16, TIMED_WAITING: 11, TERMINATED: 0
ID        NAME                          GROUP               PRIORITY STATE     %CPU      TIME      INTERRUPT DAEMON
48        Abandoned connection cleanup  main                5        TIMED_WAI 0         0:0       false     true
5         Attach Listener               system              5        RUNNABLE  0         0:0       false     true
35        ContainerBackgroundProcessor[ main                5        TIMED_WAI 0         0:0       false     true
113       DestroyJavaVM                 main                5        RUNNABLE  0         0:23      false     false
49        Druid-ConnectionPool-Create-1 main                5        WAITING   0         0:0       false     true
50        Druid-ConnectionPool-Destroy- main                5        TIMED_WAI 0         0:0       false     true
3         Finalizer                     system              8        WAITING   0         0:0       false     true
86        IdleConnectionMonitorThread   main                5        TIMED_WAI 0         0:0       false     true
428       Keep-Alive-Timer              system              8        TIMED_WAI 0         0:0       false     true
97        NioBlockingSelector.BlockPoll main                5        RUNNABLE  0         0:0       false     true
16        RMI Scheduler(0)              system              5        WAITING   0         0:0       false     true
14        RMI TCP Accept-0              system              5        RUNNABLE  0         0:0       false     true
2         Reference Handler             system              10       WAITING   0         0:0       false     true
4         Signal Dispatcher             system              9        RUNNABLE  0         0:0       false     true
354       arthas-shell-server           system              5        TIMED_WAI 0         0:0       false     true
355       arthas-shell-server           system              5        TIMED_WAI 0         0:0       false     true
351       arthas-timer                  system              5        WAITING   0         0:0       false     true
369       as-command-execute-daemon     system              10       RUNNABLE  0         0:0       false     true
36        container-0                   main                5        TIMED_WAI 0         0:0       false     false
110       http-nio-8085-Acceptor-0      main                5        RUNNABLE  0         0:0       false     true
111       http-nio-8085-AsyncTimeout    main                5        TIMED_WAI 0         0:0       false     true
108       http-nio-8085-ClientPoller-0  main                5        RUNNABLE  0         0:0       false     true
109       http-nio-8085-ClientPoller-1  main                5        RUNNABLE  0         0:0       false     true
98        http-nio-8085-exec-1          main                5        WAITING   0         0:1       false     true
107       http-nio-8085-exec-10         main                5        WAITING   0         0:1       false     true
99        http-nio-8085-exec-2          main                5        WAITING   0         0:1       false     true
100       http-nio-8085-exec-3          main                5        WAITING   0         0:1       false     true
101       http-nio-8085-exec-4          main                5        WAITING   0         0:1       false     true
102       http-nio-8085-exec-5          main                5        WAITING   0         0:1       false     true
103       http-nio-8085-exec-6          main                5        WAITING   0         0:1       false     true
104       http-nio-8085-exec-7          main                5        WAITING   0         0:1       false     true
105       http-nio-8085-exec-8          main                5        WAITING   0         0:1       false     true
106       http-nio-8085-exec-9          main                5        WAITING   0         0:1       false     true
76        net.sf.ehcache.CacheManager@5 main                5        TIMED_WAI 0         0:0       false     true
379       nioEventLoopGroup-2-1         system              10       RUNNABLE  0         0:0       false     false
386       nioEventLoopGroup-2-2         system              10       RUNNABLE  0         0:0       false     false
387       nioEventLoopGroup-2-3         system              10       RUNNABLE  0         0:0       false     false
389       nioEventLoopGroup-2-4         system              10       RUNNABLE  0         0:0       false     false
388       nioEventLoopGroup-2-5         system              10       RUNNABLE  0         0:0       false     false
390       nioEventLoopGroup-2-6         system              10       RUNNABLE  0         0:0       false     false
391       nioEventLoopGroup-2-7         system              10       RUNNABLE  0         0:0       false     false
392       nioEventLoopGroup-2-8         system              10       RUNNABLE  0         0:0       false     false
352       nioEventLoopGroup-3-1         system              10       RUNNABLE  0         0:0       false     false
358       nioEventLoopGroup-3-2         system              10       RUNNABLE  0         0:0       false     false
368       nioEventLoopGroup-3-3         system              10       RUNNABLE  0         0:0       false     false
370       nioEventLoopGroup-3-4         system              10       RUNNABLE  0         0:0       false     false
353       nioEventLoopGroup-4-1         system              10       RUNNABLE  0         0:0       false     false
378       nioEventLoopGroup-4-2         system              10       RUNNABLE  0         0:0       false     false
380       nioEventLoopGroup-4-3         system              10       RUNNABLE  0         0:0       false     false
381       nioEventLoopGroup-4-4         system              10       RUNNABLE  0         0:0       false     false
382       nioEventLoopGroup-4-5         system              10       RUNNABLE  0         0:0       false     false
383       nioEventLoopGroup-4-6         system              10       RUNNABLE  0         0:0       false     false
384       nioEventLoopGroup-4-7         system              10       RUNNABLE  0         0:0       false     false
385       nioEventLoopGroup-4-8         system              10       RUNNABLE  0         0:0       false     false
96        pool-3-thread-1               main                5        TIMED_WAI 0         0:43      false     false
356       pool-4-thread-1               system              5        WAITING   0         0:0       false     false
Affect(row-cnt:0) cost in 103 ms.
[arthas@9244]$
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1594878625626-d97b4a98-1daa-4ba2-bc11-c9bbfd98de37.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2179954&status=done&style=none&width=1107.6666666666667)
<a name="qm76v"></a>
#### thread [线程ID-来自通过thread命令输出的ID值]：查看对应线程的详情
```bash
[arthas@9244]$ thread 48
"Abandoned connection cleanup thread" Id=48 TIMED_WAITING on java.lang.ref.ReferenceQueue$Lock@3f93990c
    at java.lang.Object.wait(Native Method)
    -  waiting on java.lang.ref.ReferenceQueue$Lock@3f93990c
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
    at com.mysql.jdbc.AbandonedConnectionCleanupThread.run(AbandonedConnectionCleanupThread.java:64)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1149)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)

Affect(row-cnt:0) cost in 3 ms.
[arthas@9244]$
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1594879078620-662700b7-e20f-4c6e-b6b2-c5d2e64941b2.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2239925&status=done&style=none&width=1107.6666666666667)
<a name="hpMZW"></a>
#### thread -n [显示线程的个数]：查看占用CPU高的线程
如果只是为了寻找 CPU 使用较高的线程，可以直接使用命令 **thread -n [显示的线程个数]** ，就可以排列出 CPU 使用率 **Top N** 的线程。
```bash
[arthas@4084]$ thread -n 5
"Reference Handler" Id=2 cpuUsage=0% WAITING on java.lang.ref.Reference$Lock@602514d1
    at java.lang.Object.wait(Native Method)
    -  waiting on java.lang.ref.Reference$Lock@602514d1
    at java.lang.Object.wait(Object.java:502)
    at java.lang.ref.Reference.tryHandlePending(Reference.java:191)
    at java.lang.ref.Reference$ReferenceHandler.run(Reference.java:153)


"Finalizer" Id=3 cpuUsage=0% WAITING on java.lang.ref.ReferenceQueue$Lock@1b98a0d5
    at java.lang.Object.wait(Native Method)
    -  waiting on java.lang.ref.ReferenceQueue$Lock@1b98a0d5
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:144)
    at java.lang.ref.ReferenceQueue.remove(ReferenceQueue.java:165)
    at java.lang.ref.Finalizer$FinalizerThread.run(Finalizer.java:216)


"Signal Dispatcher" Id=4 cpuUsage=0% RUNNABLE


"Attach Listener" Id=5 cpuUsage=0% RUNNABLE


"RMI TCP Accept-0" Id=14 cpuUsage=0% RUNNABLE (in native)
    at java.net.DualStackPlainSocketImpl.accept0(Native Method)
    at java.net.DualStackPlainSocketImpl.socketAccept(DualStackPlainSocketImpl.java:131)
    at java.net.AbstractPlainSocketImpl.accept(AbstractPlainSocketImpl.java:409)
    at java.net.PlainSocketImpl.accept(PlainSocketImpl.java:199)
    at java.net.ServerSocket.implAccept(ServerSocket.java:545)
    at java.net.ServerSocket.accept(ServerSocket.java:513)
    at sun.management.jmxremote.LocalRMIServerSocketFactory$1.accept(LocalRMIServerSocketFactory.java:52)
    at sun.rmi.transport.tcp.TCPTransport$AcceptLoop.executeAcceptLoop(TCPTransport.java:405)
    at sun.rmi.transport.tcp.TCPTransport$AcceptLoop.run(TCPTransport.java:377)
    at java.lang.Thread.run(Thread.java:748)


Affect(row-cnt:0) cost in 125 ms.
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1595031821878-4cdab719-6a69-44ff-84e7-628823e21ddb.png#align=left&display=inline&height=583&originHeight=1750&originWidth=3323&size=2123764&status=done&style=none&width=1107.6666666666667)
<a name="XEfUP"></a>
#### thread -b：查看处于死锁的线程
```bash
[arthas@9244]$ thread -b
No most blocking thread found!
Affect(row-cnt:0) cost in 144 ms.
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1594879455976-3ada3682-2189-42b7-84fe-d4510bfd5608.png#align=left&display=inline&height=90&originHeight=270&originWidth=1900&size=142739&status=done&style=none&width=633.3333333333334)
<a name="oQLol"></a>
#### thread | grep pool 命令查看线程池里线程信息
```bash
[arthas@4084]$ thread | grep pool
84        pool-3-thread-1               main                5        RUNNABLE  0         0:8       false     false
167       pool-4-thread-1               system              5        WAITING   0         0:0       false     false
[arthas@4084]$ thread 167
"pool-4-thread-1" Id=167 WAITING on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@5cfa3e44
    at sun.misc.Unsafe.park(Native Method)
    -  waiting on java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject@5cfa3e44
    at java.util.concurrent.locks.LockSupport.park(LockSupport.java:175)
    at java.util.concurrent.locks.AbstractQueuedSynchronizer$ConditionObject.await(AbstractQueuedSynchronizer.java:2039)
    at java.util.concurrent.LinkedBlockingQueue.take(LinkedBlockingQueue.java:442)
    at java.util.concurrent.ThreadPoolExecutor.getTask(ThreadPoolExecutor.java:1074)
    at java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1134)
    at java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:624)
    at java.lang.Thread.run(Thread.java:748)

Affect(row-cnt:0) cost in 0 ms.
```
![image.png](https://cdn.nlark.com/yuque/0/2020/png/396745/1595032138256-457e02ef-0626-4b91-9092-bb7e337d0971.png#align=left&display=inline&height=257&originHeight=771&originWidth=3323&size=1008669&status=done&style=none&width=1107.6666666666667)
