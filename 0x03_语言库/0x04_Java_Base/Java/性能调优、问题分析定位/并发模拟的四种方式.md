<a name="n3hPm"></a>
## 一、Postman
PostMan下载地址：[https://www.postman.com/downloads/](https://www.postman.com/downloads/)<br />Postman 是一个款 HTTP 请求模拟工具。<br />首先演示一下 Postman 最基本的使用，创建一个 Spring Boot 项目，测试的代码如下：
```java
import org.springframework.web.bind.annotation.GetMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;

@RestController
@RequestMapping("test")
public class TestConrtoller {

    @GetMapping("demo")
    public String testDemo() {
        return "result~";
    }
}
```
为了便于操作，一般会将<br />http://127.0.0.1:8080 是经常使用的地址+端口号，可以设置为环境，点击右上角的设置图标，选择 global，输入信息，以后再进行测试就能这样搞简写了。<br />知道基本使用之后，来看一下如何模拟并发测试。首先需要创建一个请求集合：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657508823728-47dc2459-50b9-4536-87d0-92587596b1b7.png#clientId=uc7b88dfd-5296-4&from=paste&height=772&id=u4fe341f7&originHeight=1930&originWidth=3203&originalType=binary&ratio=1&rotation=0&showTitle=false&size=258228&status=done&style=shadow&taskId=u5bd1f346-b4aa-4b5f-9837-ef69c201009&title=&width=1281.2)<br />填写基本信息后。<br />这个时候会创建出并发测试的文件夹，可以把刚才测试的demo的例子放进这个文件夹下：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657508888252-7fc321f2-0ad1-43ef-9187-51196778fdb4.png#clientId=uc7b88dfd-5296-4&from=paste&height=772&id=ue06b03f5&originHeight=1930&originWidth=3203&originalType=binary&ratio=1&rotation=0&showTitle=false&size=256481&status=done&style=shadow&taskId=ud07a621b-e179-4b65-8eb8-13fae1041a2&title=&width=1281.2)<br />这个时候就可以在并发测试下看到这个接口测试了<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657508930814-bb0e79d1-20c3-4e56-96ef-507edc53a41f.png#clientId=uc7b88dfd-5296-4&from=paste&height=772&id=ua16dc6c4&originHeight=1930&originWidth=3203&originalType=binary&ratio=1&rotation=0&showTitle=false&size=279567&status=done&style=shadow&taskId=udcf90913-290f-452c-8fca-ff42b9c053d&title=&width=1281.2)<br />选择并发测试：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657508967136-8b66ea4f-7ab9-44c3-939b-acbe9c50f8fc.png#clientId=uc7b88dfd-5296-4&from=paste&height=772&id=u29b62028&originHeight=1930&originWidth=3203&originalType=binary&ratio=1&rotation=0&showTitle=false&size=361668&status=done&style=shadow&taskId=ub606030c-6558-49c0-9c99-c25ccd862cc&title=&width=1281.2)<br />这个时候弹出需要的框了<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657509003046-d80a45fb-b1f4-43e0-9a02-040bddb98da0.png#clientId=uc7b88dfd-5296-4&from=paste&height=772&id=ubda9caa9&originHeight=1930&originWidth=3203&originalType=binary&ratio=1&rotation=0&showTitle=false&size=291322&status=done&style=shadow&taskId=uf4633496-541e-45a7-9e74-da1608fd6f1&title=&width=1281.2)<br />点击 Run 并发测试<br />可以立马感觉到 CPU 在“燃烧”，因为要记录并打印日志，显示的话是一条一条来的，其实测试的速度，要比看到的打印的日志的速度快，绿色表示正常<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657509022786-27517fb7-45fe-478c-bdd6-4f6eaa848166.png#clientId=uc7b88dfd-5296-4&from=paste&height=772&id=u594b8b66&originHeight=1930&originWidth=3203&originalType=binary&ratio=1&rotation=0&showTitle=false&size=424401&status=done&style=shadow&taskId=ude80806f-c683-4c7a-a202-30b3bf02dc3&title=&width=1281.2)
<a name="LZEqw"></a>
## 二、Apache Bench（AB）
ApacheBench 是 Apache 服务器自带的一个web压力测试工具，简称ab。<br />ab又是一个命令行工具，对发起负载的本机要求很低，根据ab命令可以创建很多的并发访问线程，模拟多个访问者同时对某一URL地址进行访问，因此可以用来测试目标服务器的负载压力。总的来说ab工具小巧简单，上手学习较快，可以提供需要的基本性能指标，但是没有图形化结果，不能监控。<br />使用的话，首先需要安装 Apache 服务器<br />网站：传送门 [http://httpd.apache.org/download.cgi](http://httpd.apache.org/download.cgi)<br />因为操作系统是 windows10， 这里选择 File for Microsoft Windows<br />Linux下的安装是非常简单的，这里不再演示<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657502712333-9e59e572-3f8c-435d-ba75-00a3d4a912ea.png#clientId=uc7b88dfd-5296-4&from=paste&height=713&id=uab25dca3&originHeight=1783&originWidth=3840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=608038&status=done&style=shadow&taskId=u314b2696-2e18-4c67-aab8-7be9491abe3&title=&width=1536)<br />选择 ApacheHaus<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657502749551-5a29d5f7-0c7c-4a1b-8f79-b90b84cab48c.png#clientId=uc7b88dfd-5296-4&from=paste&height=713&id=u4b164b01&originHeight=1783&originWidth=3840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=539975&status=done&style=shadow&taskId=u8fdcf9db-11ac-43ad-b0e7-70f56c398d2&title=&width=1536)<br />进入下载页面 选择适合自己电脑的版本<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657502797784-b5a805eb-317f-4955-afdc-e1e9abd126e2.png#clientId=uc7b88dfd-5296-4&from=paste&height=713&id=u22ce14dd&originHeight=1783&originWidth=3840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=434211&status=done&style=shadow&taskId=u76641c6e-b86d-41dd-91ef-b99e93f5133&title=&width=1536)<br />文件解压到本地文件夹下，如果不是解压在c盘，需要设置参数，注意文件路径最好都是英文，关于需要设置参数，conf->httpd.conf 使用文本编辑器打开，需要修改的有三个地方：<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1657502416642-b9f6a7f5-698b-4094-8591-429cf0001648.png#clientId=uc7b88dfd-5296-4&from=paste&id=uf0830153&originHeight=115&originWidth=617&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u92de9c18-9e93-47eb-9f9a-dad9ad092c2&title=)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657502995803-90e0780c-d407-4198-b9ab-78a3ab36a3f0.png#clientId=uc7b88dfd-5296-4&from=paste&height=594&id=u44273158&originHeight=1484&originWidth=2255&originalType=binary&ratio=1&rotation=0&showTitle=false&size=318474&status=done&style=shadow&taskId=ueec1a5d3-8f63-4f7e-8759-49d36f19d06&title=&width=902)<br />运行根目录，修改成自己解压到本地的路径<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657503356960-c911330c-765d-45dd-ae09-49dfdc1df0ff.png#clientId=uc7b88dfd-5296-4&from=paste&height=306&id=ue5eb1042&originHeight=765&originWidth=2667&originalType=binary&ratio=1&rotation=0&showTitle=false&size=97284&status=done&style=shadow&taskId=ud1968f94-b906-4266-87f9-7c03347dc6a&title=&width=1066.8)<br />监听端口，默认监听端口是80，如果已被使用会报错需要修改，如果80端口未被使用，可不修改；如果修改了监听端口，则需要把ServerName localhost也相应改成同样的端 口号<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657503193809-289996b5-f008-4e92-8904-34f0d9f4098b.png#clientId=uc7b88dfd-5296-4&from=paste&height=241&id=u69091f1c&originHeight=602&originWidth=2379&originalType=binary&ratio=1&rotation=0&showTitle=false&size=72426&status=done&style=shadow&taskId=u131c9e63-847b-44d0-b42a-26263071b55&title=&width=951.6)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657503502055-4f251657-a7c5-49c2-ab9d-527abe9e3add.png#clientId=uc7b88dfd-5296-4&from=paste&height=196&id=u6c50d278&originHeight=491&originWidth=2587&originalType=binary&ratio=1&rotation=0&showTitle=false&size=63192&status=done&style=shadow&taskId=ud1bbdae1-0cd7-4ea8-b985-752c606cd75&title=&width=1034.8)<br />DocumentRoot 测试文件存放地，且该目录必须存在<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657503623341-ce8e2a7a-fbb0-4158-ac8c-7db34e0970b6.png#clientId=uc7b88dfd-5296-4&from=paste&height=145&id=uee7fc520&originHeight=362&originWidth=2629&originalType=binary&ratio=1&rotation=0&showTitle=false&size=49297&status=done&style=shadow&taskId=u33936098-725b-46f0-85da-94e33be1c27&title=&width=1051.6)<br />配置完成后，命令行cmd进入 D:\SoftUtil\Apache24\bin 目录下
```bash
httpd.exe -k install
```
![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504043272-60b5370e-3f19-44d3-836b-2d615408f0b3.png#clientId=uc7b88dfd-5296-4&from=paste&height=200&id=ue727d1eb&originHeight=500&originWidth=3323&originalType=binary&ratio=1&rotation=0&showTitle=false&size=389176&status=done&style=shadow&taskId=ub0b849e5-2c35-4da4-ac72-6551c305316&title=&width=1329.2)<br />启动：
```bash
httpd.exe -k start
```
测试:<br />`-n`：请求数<br />`-c`：并发数<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504483263-4702d0f3-a5ac-48d5-8a8d-166f81ba3ede.png#clientId=uc7b88dfd-5296-4&from=paste&height=704&id=u57077bac&originHeight=1760&originWidth=2819&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1156454&status=done&style=shadow&taskId=ue729a92f-a160-4f34-b067-fc84dd53b86&title=&width=1127.6)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504399007-b711c298-937c-4a13-8bba-eb11a5c4e6de.png#clientId=uc7b88dfd-5296-4&from=paste&height=704&id=u9402547d&originHeight=1760&originWidth=2525&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1071086&status=done&style=shadow&taskId=u0f844b5a-5dc4-47d7-8e6a-7e307f3380e&title=&width=1010)<br />使用结束可以停止httpd<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505438713-8baf8f78-5968-4aed-83a7-46f2f5a63242.png#clientId=uc7b88dfd-5296-4&from=paste&height=135&id=u54d06996&originHeight=338&originWidth=1753&originalType=binary&ratio=1&rotation=0&showTitle=false&size=137592&status=done&style=shadow&taskId=u8ec66f9b-aa29-4870-8b4b-477082c8366&title=&width=701.2)
<a name="VbIBN"></a>
## 三、并发模拟工具JMeter
JMeter也是一款性能测试工具，是图形化的。下载地址：传送门 [http://jmeter.apache.org/](http://jmeter.apache.org/)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504631580-35797e42-c323-4cac-be78-26298ce1b4f3.png#clientId=uc7b88dfd-5296-4&from=paste&height=713&id=u23d9f289&originHeight=1783&originWidth=3840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=662159&status=done&style=shadow&taskId=u2b09ccc4-8e15-4730-81cd-999aba61a12&title=&width=1536)<br />需要 Java8+ 的环境<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504660551-dcb63521-cd07-4ab9-906c-c72772afb21a.png#clientId=uc7b88dfd-5296-4&from=paste&height=713&id=u977f3e61&originHeight=1783&originWidth=3840&originalType=binary&ratio=1&rotation=0&showTitle=false&size=632504&status=done&style=shadow&taskId=u0d2d5b69-1adc-49af-932e-5862077768b&title=&width=1536)<br />解压到合适的目录下（注意最好是英文路径），进入它的 bin 目录下 启动 jmeter.bat 即可。<br />使用很简单，首先在测试计划部分新建一个线程组<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504741676-10fca37e-2231-4599-8e3e-359606ed5d37.png#clientId=uc7b88dfd-5296-4&from=paste&height=682&id=u7df4f722&originHeight=1706&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=250087&status=done&style=shadow&taskId=u82ef25ac-c526-4a46-bba1-fa17f752cd3&title=&width=1216)<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504924697-7c2ced02-5c82-428b-b8e4-40ac921d6219.png#clientId=uc7b88dfd-5296-4&from=paste&height=681&id=u9de49e0a&originHeight=1703&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=371965&status=done&style=shadow&taskId=udfcec9a7-4f72-4bfe-8abc-82a5b3bdfb9&title=&width=1216)<br />设置好基础信息后添加HTTP请求（基本信息设置好，直接添加HTTP请求）<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657504978058-30f797fa-739d-464a-9396-57d3738893f6.png#clientId=uc7b88dfd-5296-4&from=paste&height=682&id=uac342d03&originHeight=1706&originWidth=3029&originalType=binary&ratio=1&rotation=0&showTitle=false&size=286356&status=done&style=shadow&taskId=ub5f234b9-832c-4178-ad7a-8a528749490&title=&width=1211.6)<br />填写HTTP请求相关的内容<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505058354-81004abe-2498-4f96-beaa-e453bc7dc8a4.png#clientId=uc7b88dfd-5296-4&from=paste&height=685&id=u8cee0d93&originHeight=1712&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=201221&status=done&style=shadow&taskId=uf0024179-f9bb-4716-8476-45e9792cbf5&title=&width=1216)<br />之后还要添加监听器，这里选择是图形结果<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505134776-260024f4-3e6a-48dc-bf73-fe2fe84fda30.png#clientId=uc7b88dfd-5296-4&from=paste&height=681&id=ua113b963&originHeight=1703&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=296699&status=done&style=shadow&taskId=u6b309169-46c6-4b22-8bb2-62a2a9fc0e3&title=&width=1216)<br />再添加一个查看结果树吧<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505170505-eef027b9-1ca6-472f-a0e2-98df011e0777.png#clientId=uc7b88dfd-5296-4&from=paste&height=683&id=u965639b7&originHeight=1708&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=299419&status=done&style=shadow&taskId=u8b26cadd-eb46-4bd6-9286-2d5bb9b7d82&title=&width=1216)<br />在运行之前打开log Viewer<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505198206-ad6b6018-16b9-4703-89f2-aedcb2d775f6.png#clientId=uc7b88dfd-5296-4&from=paste&height=683&id=u2c6d33e0&originHeight=1707&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=189201&status=done&style=shadow&taskId=u9fb80d86-7ef0-4712-8c44-692f64409c1&title=&width=1216)<br />下面开始运行：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505268355-5cb09346-a382-4045-bc8a-8f62f0ef12b3.png#clientId=uc7b88dfd-5296-4&from=paste&height=460&id=u2b7665a7&originHeight=1150&originWidth=1906&originalType=binary&ratio=1&rotation=0&showTitle=false&size=149973&status=done&style=shadow&taskId=uf279eaf8-5853-40e2-bf05-075f16f2b75&title=&width=762.4)<br />执行成功，来感受一下结果：<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505302837-2c611981-3bf0-4740-a44d-06fee68e6647.png#clientId=uc7b88dfd-5296-4&from=paste&height=682&id=ua6ad5702&originHeight=1705&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=312223&status=done&style=shadow&taskId=ud95804f6-e6ea-4d8a-a709-4bda41d94f6&title=&width=1216)<br />点进去<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505320654-dbf17322-10f9-41d5-8852-893b7461b01c.png#clientId=uc7b88dfd-5296-4&from=paste&height=683&id=u5f93ce27&originHeight=1708&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=380875&status=done&style=shadow&taskId=u41c4a364-3f80-4167-8743-cbf3844c117&title=&width=1216)<br />查看结果树<br />![image.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505366802-dde0beef-ed74-479d-8089-34753d4f43a4.png#clientId=uc7b88dfd-5296-4&from=paste&height=683&id=u64fa44f8&originHeight=1707&originWidth=3040&originalType=binary&ratio=1&rotation=0&showTitle=false&size=182623&status=done&style=shadow&taskId=u4bd6ae1e-0b4f-4727-be13-eab53b80c2a&title=&width=1216)
<a name="hMu08"></a>
## 四、代码模拟
这里需要用到一个类，就是 CountDownLatch。CountDownLatch 是一个计数器闭锁，通过它可以完成类似于阻塞当前线程的功能，即：一个线程或多个线程一直等待，直到其他线程执行的操作完成。<br />CountDownLatch 用一个给定的计数器来初始化，该计数器的操作是原子操作，即同时只能有一个线程去操作该计数器。调用该类await方法的线程会一直处于阻塞状态，直到其他线程调用 countDown 方法使当前计数器的值变为零，每次调用 countDown 计数器的值减1。<br />当计数器值减至零时，所有因调用`await()`方法而处于等待状态的线程就会继续往下执行。这种现象只会出现一次，因为计数器不能被重置。下图和它的方法可以体现出来：<br />![2022-07-11-10-11-43-976246.png](https://cdn.nlark.com/yuque/0/2022/png/396745/1657505600041-982bca0d-2b39-4e63-9e98-7028508bfb9f.png#clientId=uc7b88dfd-5296-4&from=ui&id=u7cb14dfb&originHeight=702&originWidth=741&originalType=binary&ratio=1&rotation=0&showTitle=false&size=1563847&status=done&style=shadow&taskId=u5bad7e3e-58b9-4df3-bed1-f68ea76d3a9&title=)<br />`CountDownLatch`类只提供了一个构造器：
```java
public CountDownLatch(int count) { };
```
然后下面这 3 个方法是 `CountDownLatch` 类中最重要的方法(上图能够反映出来）
```java
public void await() throws InterruptedException { };
public boolean await(long timeout, TimeUnit unit) throws InterruptedException { };
public void countDown() { };
```
下面还需要看一个类 `Semaphore`<br />`Semaphore` 与 `CountDownLatch` 相似，不同的地方在于 `Semaphore` 的值被获取到后是可以释放的，并不像 `CountDownLatch` 那样一直减到底。<br />它也被更多地用来限制流量，类似阀门的 功能。如果限定某些资源最多有N个线程可以访问，那么超过N个主不允许再有线程来访问，同时当现有线程结束后，就会释放，然后允许新的线程进来。有点类似于锁的`lock`与`unlock`过程。相对来说他也有两个主要的方法：<br />用于获取权限的`acquire()`，其底层实现与`CountDownLatch.countdown()`类似；用于释放权限的`release()`，其底层实现与`acquire()`是一个互逆的过程。<br />通过这两个类可以进行并发的模拟：<br />测试一下：
```java
import lombok.extern.slf4j.Slf4j;
import java.util.concurrent.*;

@Slf4j
public class CuncurrencyTest {

    public static int clientTotal = 5000;
    public static int threadTotal = 200;
    public static int count = 0;
    public static void main(String[] args) throws InterruptedException {
        
        ExecutorService executorService = Executors.newCachedThreadPool();
        
        final Semaphore semaphore = new Semaphore(threadTotal);
        final CountDownLatch countDownLatch = new CountDownLatch(clientTotal);

        for (int i = 0; i < clientTotal; i++) {
            executorService.execute(() -> {
                try {
                    semaphore.acquire();
                    add();
                    semaphore.release();
                } catch (InterruptedException e) {
                    e.printStackTrace();
                    log.error("exception",e);
                }
                countDownLatch.countDown();
            });
        }
        countDownLatch.await();
        executorService.shutdown();
        log.info("count:{}",count);

    }

    private static void  add() {
        count++;
    }
}
```
因为 count 不是线程安全的，且没有作防护措施，结果是错的<br />![](https://cdn.nlark.com/yuque/0/2022/png/396745/1657502418915-fcb1da4c-0e9e-41ba-98fd-1489c067cb15.png#clientId=uc7b88dfd-5296-4&from=paste&id=u68f95c28&originHeight=150&originWidth=944&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u66f5bea3-4818-410d-9e42-ebc6c638052&title=)<br />上面是对代码的并发模拟的简单形式，值得注意的是，这里提到的两个类不是专门做并发模拟，它们的用途很广泛。
