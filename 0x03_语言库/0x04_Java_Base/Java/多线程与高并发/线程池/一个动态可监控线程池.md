Java
<a name="d12iV"></a>
## èƒŒæ™¯
ä½œä¸ºä¸€ä¸ªJavaå¼€å‘è€…ï¼Œåº”ç”¨é‡Œå°‘ä¸äº†ä½¿ç”¨ThreadPoolExecutor åˆ›å»ºçº¿ç¨‹æ± ï¼Œåœ¨ä½¿ç”¨çš„è¿‡ç¨‹ä¸­æ˜¯å¦æœ‰ä»¥ä¸‹ç—›ç‚¹ï¼š<br />**1ã€ä»£ç ä¸­åˆ›å»ºäº†ä¸€ä¸ª ThreadPoolExecutorï¼Œä½†æ˜¯ä¸çŸ¥é“é‚£å‡ ä¸ªæ ¸å¿ƒå‚æ•°è®¾ç½®å¤šå°‘æ¯”è¾ƒåˆé€‚**<br />**2ã€å‡­ç»éªŒè®¾ç½®å‚æ•°å€¼ï¼Œä¸Šçº¿åå‘ç°éœ€è¦è°ƒæ•´ï¼Œæ”¹ä»£ç é‡æ–°å‘å¸ƒæœåŠ¡ï¼Œéå¸¸éº»çƒ¦**<br />**3ã€çº¿ç¨‹æ± ç›¸å¯¹å¼€å‘äººå‘˜æ¥è¯´æ˜¯ä¸ªé»‘ç›’ï¼Œè¿è¡Œæƒ…å†µä¸èƒ½åŠæ—¶æ„ŸçŸ¥åˆ°ï¼Œç›´åˆ°å‡ºç°é—®é¢˜**<br />é¢å¯¹è¿™äº›ç—›ç‚¹æ˜¯å¦ç»å¸¸æŠ“è€³æŒ è…®ï¼Œæ‰€ä»¥ï¼Œå¸¦ç€è¿™ä¸ªé—®é¢˜ï¼Œä»‹ç»è¿™ä¸ªå¼€æºçš„é¡¹ç›®ï¼š<br />**dynamic-tp**   ğŸ”¥ğŸ”¥ğŸ”¥ åŸºäºé…ç½®ä¸­å¿ƒçš„è½»é‡çº§åŠ¨æ€å¯ç›‘æ§çº¿ç¨‹æ± <br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1693888310283-8375e125-3e35-4a68-b69d-d8101536794a.png#averageHue=%2310151e&clientId=u04ca03e8-8ca0-4&from=paste&id=u26c6c24f&originHeight=296&originWidth=1080&originalType=url&ratio=2.5&rotation=0&showTitle=false&status=done&style=none&taskId=uf02c7b49-6c9a-4d0a-8a84-abb41d2f189&title=)
<a name="b5K4v"></a>
## ä»‹ç»
**dynamic-tp**  ï¼Œæ˜¯ä¸€ä¸ªè®©çº¿ç¨‹æ± å˜çš„æ›´ç®€å•çš„å·¥å…·ï¼Œå¹¶ä¸”æ‹¥æœ‰ä¼—å¤šä¼˜åŠ¿ï¼š

- **åŠ¨æ€è°ƒå‚ï¼šåœ¨è¿è¡Œæ—¶åŠ¨æ€è°ƒæ•´çº¿ç¨‹æ± å‚æ•°ï¼ŒåŒ…æ‹¬æ ¸å¿ƒçº¿ç¨‹æ•°ã€æœ€å¤§çº¿ç¨‹æ•°ã€ç©ºé—²çº¿ç¨‹è¶…æ—¶æ—¶é—´ã€ä»»åŠ¡é˜Ÿåˆ—å¤§å°ç­‰**
- **é€šçŸ¥æŠ¥è­¦ï¼šç›®å‰æ”¯æŒè°ƒå‚é€šçŸ¥ã€æ´»æ€§ã€é˜Ÿåˆ—å®¹é‡ã€æ‹’ç»ç­–ç•¥ã€è¶…æ—¶å…±å…­ç±»é€šçŸ¥æŠ¥è­¦ç»´åº¦ï¼Œåœ¨è¿è¡Œæ—¶å®æ—¶+å®šæ—¶æ£€æµ‹ï¼Œè§¦å‘é˜ˆå€¼è¿›è¡Œæ¨é€**
- **è¿è¡Œç›‘æ§ï¼šå®šæ—¶é‡‡é›†çº¿ç¨‹æ± è¿è¡ŒæŒ‡æ ‡æ•°æ®ï¼Œæä¾›jsonlogã€micrometerã€endpointä¸‰ç§æŒ‡æ ‡æ•°æ®é‡‡é›†æ–¹å¼ï¼Œå¯çµæ´»é€‰æ‹©**
- **ä¸‰æ–¹åŒ…é›†æˆï¼šé›†æˆä¸‰æ–¹ä¸­é—´ä»¶çº¿ç¨‹æ± ç®¡ç†ï¼Œå·²æ¥å…¥dubboã€rocketmqã€hystrixã€grpcã€tomcatã€undertowã€jettyã€grpcã€okhttpç­‰ç»„ä»¶çº¿ç¨‹æ± ç®¡ç†**
<a name="QGklI"></a>
## å¿«é€Ÿä½¿ç”¨
dynamic-tpçš„ä½¿ç”¨ä¹Ÿéå¸¸ç®€å•ï¼Œæ”¯æŒå¤šç§é…ç½®ä¸­å¿ƒé›†æˆï¼Œä¸‹é¢æ— é…ç½®ä¸­å¿ƒåº”ç”¨æ¥å…¥ä¸ºä¾‹ï¼Œå…·ä½“æ–‡æ¡£å¯ä»¥å‚è€ƒå¦‚ä¸‹åœ°å€ã€‚<br />å®˜ç½‘åœ°å€ï¼š[https://dynamictp.cn/guide/use/quick-start.html](https://dynamictp.cn/guide/use/quick-start.html)
<a name="p96aD"></a>
### 1ã€å¼•å…¥ç›¸åº”é…ç½®ä¸­å¿ƒçš„ä¾èµ–
```xml
<dependency>
  <groupId>org.dromara.dynamictp</groupId>
  <artifactId>dynamic-tp-core</artifactId>
  <version>1.1.3</version>
</dependency>
```
<a name="IfIrP"></a>
### 2ã€é…ç½®çº¿ç¨‹æ± å®ä¾‹
é…ç½®çº¿ç¨‹æ± æœ‰ä¸¤ç§æ–¹å¼ï¼Œä¸€æ˜¯é…ç½®ä¸­å¿ƒé…ç½®ï¼ˆæ¨èï¼‰ï¼ŒäºŒæ˜¯ä»£ç é…ç½®<br />**aã€é…ç½®ä¸­å¿ƒé…ç½®ï¼Œä»…ä¾›å‚è€ƒï¼Œè¯·æ ¹æ®è‡ªå·±å®é™…éœ€è¦è¿›è¡Œåˆ æ”¹**
```yaml
spring:
  dynamic:
    tp:
      enabled: true
      enabledCollect: true                    # æ˜¯å¦å¼€å¯ç›‘æ§æŒ‡æ ‡é‡‡é›†ï¼Œé»˜è®¤false
      collectorTypes: micrometer,logging      # ç›‘æ§æ•°æ®é‡‡é›†å™¨ç±»å‹ï¼ˆlogging | micrometer | internal_loggingï¼‰ï¼Œé»˜è®¤micrometer
      logPath: /home/logs                     # ç›‘æ§æ—¥å¿—æ•°æ®è·¯å¾„ï¼Œé»˜è®¤ ${user.home}/logsï¼Œé‡‡é›†ç±»å‹éloggingä¸ç”¨é…ç½®
      monitorInterval: 5                      # ç›‘æ§æ—¶é—´é—´éš”ï¼ˆæŠ¥è­¦æ£€æµ‹ã€æŒ‡æ ‡é‡‡é›†ï¼‰ï¼Œé»˜è®¤5s
      apollo:                                 # apolloé…ç½®ï¼Œä¸é…ç½®é»˜è®¤æ‹¿apolloé…ç½®ç¬¬ä¸€ä¸ªnamespace
        namespace: user-center-dtp-dev.yml
      configType: yml                         # é…ç½®æ–‡ä»¶ç±»å‹
      platforms:                              # é€šçŸ¥æŠ¥è­¦å¹³å°é…ç½®
        - platform: wechat
          platformId: 1                            # å¹³å°id
          urlKey: 3a700-127-4bd-a798-c53d8b69c     # æ›¿æ¢
          receivers: test1,test2                   # æ¥å—äººä¼å¾®åç§°
        - platform: ding
          platformId: 2                            # å¹³å°id
          urlKey: f80dad441fcd655438f4a08dcd6a     # æ›¿æ¢
          secret: SECb5441fa6f375d5b9d21           # æ›¿æ¢ï¼Œésignæ¨¡å¼å¯ä»¥æ²¡æœ‰æ­¤å€¼
          receivers: 18888888888                   # é’‰é’‰è´¦å·æ‰‹æœºå·
        - platform: lark
          platformId: 3
          urlKey: 0d944ae7-b24a-40                 # æ›¿æ¢
          receivers: test1,test2                   # æ¥å—äººé£ä¹¦åç§°/openid
        - platform: email
          platformId: 4
          receivers: 123456@qq.com,789789@qq.com   # æ”¶ä»¶äºº
      executors:                                   # åŠ¨æ€çº¿ç¨‹æ± é…ç½®ï¼Œéƒ½æœ‰é»˜è®¤å€¼ï¼Œé‡‡ç”¨é»˜è®¤å€¼çš„å¯ä»¥ä¸é…ç½®è¯¥é¡¹ï¼Œå‡å°‘é…ç½®é‡
        - threadPoolName: dtpExecutor1
          threadPoolAliasName: æµ‹è¯•çº¿ç¨‹æ±              # çº¿ç¨‹æ± åˆ«å
          executorType: common                     # çº¿ç¨‹æ± ç±»å‹commonã€eagerï¼šé€‚ç”¨äºioå¯†é›†å‹
          corePoolSize: 6
          maximumPoolSize: 8
          queueCapacity: 200
          queueType: VariableLinkedBlockingQueue   # ä»»åŠ¡é˜Ÿåˆ—ï¼ŒæŸ¥çœ‹æºç QueueTypeEnumæšä¸¾ç±»
          rejectedHandlerType: CallerRunsPolicy    # æ‹’ç»ç­–ç•¥ï¼ŒæŸ¥çœ‹RejectedTypeEnumæšä¸¾ç±»
          keepAliveTime: 50
          allowCoreThreadTimeOut: false                  # æ˜¯å¦å…è®¸æ ¸å¿ƒçº¿ç¨‹æ± è¶…æ—¶
          threadNamePrefix: test                         # çº¿ç¨‹åå‰ç¼€
          waitForTasksToCompleteOnShutdown: false        # å‚è€ƒspringçº¿ç¨‹æ± è®¾è®¡ï¼Œä¼˜é›…å…³é—­çº¿ç¨‹æ± 
          awaitTerminationSeconds: 5                     # å•ä½ï¼ˆsï¼‰
          preStartAllCoreThreads: false                  # æ˜¯å¦é¢„çƒ­æ‰€æœ‰æ ¸å¿ƒçº¿ç¨‹ï¼Œé»˜è®¤false
          runTimeout: 200                                # ä»»åŠ¡æ‰§è¡Œè¶…æ—¶é˜ˆå€¼ï¼Œç›®å‰åªåšå‘Šè­¦ç”¨ï¼Œå•ä½ï¼ˆmsï¼‰
          queueTimeout: 100                              # ä»»åŠ¡åœ¨é˜Ÿåˆ—ç­‰å¾…è¶…æ—¶é˜ˆå€¼ï¼Œç›®å‰åªåšå‘Šè­¦ç”¨ï¼Œå•ä½ï¼ˆmsï¼‰
          taskWrapperNames: ["ttl", "mdc"]               # ä»»åŠ¡åŒ…è£…å™¨åç§°ï¼Œç»§æ‰¿TaskWrapperæ¥å£
          notifyEnabled: true                            # æ˜¯å¦å¼€å¯æŠ¥è­¦ï¼Œé»˜è®¤true
          notifyItems:                     # æŠ¥è­¦é¡¹ï¼Œä¸é…ç½®è‡ªåŠ¨ä¼šæŒ‰é»˜è®¤å€¼é…ç½®ï¼ˆå˜æ›´é€šçŸ¥ã€å®¹é‡æŠ¥è­¦ã€æ´»æ€§æŠ¥è­¦ã€æ‹’ç»æŠ¥è­¦ã€ä»»åŠ¡è¶…æ—¶æŠ¥è­¦ï¼‰
            - type: capacity               # æŠ¥è­¦é¡¹ç±»å‹ï¼ŒæŸ¥çœ‹æºç  NotifyTypeEnumæšä¸¾ç±»
              enabled: true
              threshold: 80                # æŠ¥è­¦é˜ˆå€¼
              platforms: [ding,wechat]     # å¯é€‰é…ç½®ï¼Œä¸é…ç½®é»˜è®¤æ‹¿ä¸Šå±‚platformsé…ç½®çš„æ‰€ä»¥å¹³å°
              interval: 120                # æŠ¥è­¦é—´éš”ï¼ˆå•ä½ï¼šsï¼‰
            - type: change
              enabled: true
            - type: liveness
              enabled: true
              threshold: 80
            - type: reject
              enabled: true
              threshold: 1
            - type: run_timeout
              enabled: true
              threshold: 1
            - type: queue_timeout
              enabled: true
              threshold: 1
```
**bã€ä»£ç é…ç½®ï¼Œå¦‚æœæƒ³åæœŸå†æ·»åŠ åˆ°é…ç½®ä¸­å¿ƒï¼Œå¯ä»¥å…ˆç”¨ **`**@Bean**`** ç¼–ç å¼å£°æ˜ï¼ˆæ–¹ä¾¿ Spring ä¾èµ–æ³¨å…¥ï¼‰**
```java
@Configuration
public class DtpConfig {

    /**
     * é€šè¿‡ {@link @DynamicTp} æ³¨è§£å®šä¹‰æ™®é€š juc çº¿ç¨‹æ± ï¼Œä¼šäº«å—åˆ°è¯¥æ¡†æ¶ç›‘æ§åŠŸèƒ½ï¼Œæ³¨è§£åç§°ä¼˜å…ˆçº§é«˜äºæ–¹æ³•å
     *
     * @return çº¿ç¨‹æ± å®ä¾‹
     */
    @DynamicTp("commonExecutor")
    @Bean
    public ThreadPoolExecutor commonExecutor() {
        return (ThreadPoolExecutor) Executors.newFixedThreadPool(1);
    }

    /**
     * é€šè¿‡ {@link ThreadPoolCreator} å¿«é€Ÿåˆ›å»ºä¸€äº›ç®€å•é…ç½®çš„åŠ¨æ€çº¿ç¨‹æ± 
     * tips: å»ºè®®ç›´æ¥åœ¨é…ç½®ä¸­å¿ƒé…ç½®å°±è¡Œï¼Œä¸ç”¨ @Bean å£°æ˜
     *
     * @return çº¿ç¨‹æ± å®ä¾‹
     */
    @Bean
    public DtpExecutor dtpExecutor1() {
        return ThreadPoolCreator.createDynamicFast("dtpExecutor1");
    }

    /**
     * é€šè¿‡ {@link ThreadPoolBuilder} è®¾ç½®è¯¦ç»†å‚æ•°åˆ›å»ºåŠ¨æ€çº¿ç¨‹æ± ï¼ˆæ¨èæ–¹å¼ï¼‰ï¼Œ
     * ioIntensiveï¼Œå‚è€ƒ tomcat çº¿ç¨‹æ± è®¾è®¡ï¼Œå®ç°äº†å¤„ç† io å¯†é›†å‹ä»»åŠ¡çš„çº¿ç¨‹æ± ï¼Œå…·ä½“å‚æ•°å¯ä»¥çœ‹ä»£ç æ³¨é‡Š
     * <p>
     * tips: å»ºè®®ç›´æ¥åœ¨é…ç½®ä¸­å¿ƒé…ç½®å°±è¡Œï¼Œä¸ç”¨@Beanå£°æ˜
     *
     * @return çº¿ç¨‹æ± å®ä¾‹
     */
    @Bean
    public DtpExecutor ioIntensiveExecutor() {
        return ThreadPoolBuilder.newBuilder()
                .threadPoolName("ioIntensiveExecutor")
                .corePoolSize(20)
                .maximumPoolSize(50)
                .queueCapacity(2048)
                .ioIntensive(true)
                .buildDynamic();
    }

    /**
     * tips: å»ºè®®ç›´æ¥åœ¨é…ç½®ä¸­å¿ƒé…ç½®å°±è¡Œï¼Œä¸ç”¨ @Bean å£°æ˜
     *
     * @return çº¿ç¨‹æ± å®ä¾‹
     */
    @Bean
    public ThreadPoolExecutor dtpExecutor2() {
        return ThreadPoolBuilder.newBuilder()
                .threadPoolName("dtpExecutor2")
                .corePoolSize(10)
                .maximumPoolSize(15)
                .keepAliveTime(50)
                .timeUnit(TimeUnit.MILLISECONDS)
                .workQueue(QueueTypeEnum.SYNCHRONOUS_QUEUE.getName(), null, false)
                .waitForTasksToCompleteOnShutdown(true)
                .awaitTerminationSeconds(5)
                .buildDynamic();
    }
}
```
<a name="u3CCM"></a>
### 3ã€å¯åŠ¨ç±»åŠ  `@EnableDynamicTp` æ³¨è§£
<a name="JCgtZ"></a>
### 4ã€ä½¿ç”¨ `@Resource` æˆ– `@Autowired` è¿›è¡Œä¾èµ–æ³¨å…¥
```java
@Resource
private ThreadPoolExecutor dtpExecutor1;

public void exec() {
    dtpExecutor1.execute(() -> System.out.println("test"));
}
```
<a name="QSN0Z"></a>
## æ€»ç»“
æ€»çš„æ¥è¯´dynamic-tpæ˜¯ä¸€ä¸ªéå¸¸è½»é‡çš„çº¿ç¨‹æ± ï¼Œå¹¶ä¸”åŠŸèƒ½ä¸°å¯Œï¼Œå¯¹ä»£ç é›¶ä¾µå…¥ï¼Œè€Œä¸”é›†ç›‘æ§æŠ¥è­¦äºä¸€ä½“ï¼Œä½¿ç”¨ä¸ŠåŸºæœ¬æ— éœ€æ‹…å¿ƒ<br />æœ€ååœ¨è´´ä¸Šåœ°å€ï¼š<br />ä½¿ç”¨æ–‡æ¡£ï¼š[https://dynamictp.cn/](https://dynamictp.cn/)<br />githubä»£ç ï¼š[https://github.com/dromara/dynamic-tp](https://github.com/dromara/dynamic-tp)<br />giteeä»£ç ï¼š[https://gitee.com/dromara/dynamic-tp](https://gitee.com/dromara/dynamic-tp)
