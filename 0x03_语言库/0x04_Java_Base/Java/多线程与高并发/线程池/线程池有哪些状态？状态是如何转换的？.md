Java 线程池<br />在 Java 中，线程池的状态和线程的状态是完全不同的，线程有 6 种状态：NEW：初始化状态、RUNNABLE：可运行/运行状态、BLOCKED：阻塞状态、WAITING：无时限等待状态、TIMED_WAITING：有时限等待状态和 TERMINATED：终止状态。而线程池的状态有以下 5 种：

1. RUNNING：运行状态，线程池创建好之后就会进入此状态，如果不手动调用关闭方法，那么线程池在整个程序运行期间都是此状态。
2. SHUTDOWN：关闭状态，不再接受新任务提交，但是会将已保存在任务队列中的任务处理完。
3. STOP：停止状态，不再接受新任务提交，并且会中断当前正在执行的任务、放弃任务队列中已有的任务。
4. TIDYING：整理状态，所有的任务都执行完毕后（也包括任务队列中的任务执行完），当前线程池中的活动线程数降为 0 时的状态。到此状态之后，会调用线程池的 `terminated()` 方法。
5. TERMINATED：销毁状态，当执行完线程池的 `terminated()` 方法之后就会变为此状态。

这 5 种状态可以在 ThreadPoolExecutor 源码中找到，如下图所示：![](https://cdn.nlark.com/yuque/0/2022/png/396745/1650009507895-23d75b74-97a9-4173-96cb-6a3f6dc3742e.png#clientId=uc2769e3f-6c1f-4&from=paste&id=uca5d67ec&originHeight=255&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u1703e026-cdd8-48da-a234-cc48f845ab1&title=)
<a name="SD392"></a>
## 线程池状态转移
线程池的状态转移有两条路径：

1. 当调用 `shutdown()` 方法时，线程池的状态会从 RUNNING 到 SHUTDOWN，再到 TIDYING，最后到 TERMENATED 销毁状态。
2. 当调用 `shutdownNow()` 方法时，线程池的状态会从 RUNNING 到 STOP，再到 TIDYING，最后到 TERMENATED 销毁状态。

线程状态转换的流程如下图所示：![](https://cdn.nlark.com/yuque/0/2022/png/396745/1650009507907-2c82ff93-5c2b-4ca4-9e83-117a0169decd.png#clientId=uc2769e3f-6c1f-4&from=paste&id=ub5536258&originHeight=426&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=ud065f30f-62c7-4991-9c14-d1afd85d1b3&title=)
<a name="isSuC"></a>
## `terminated`方法
线程池中的 `terminated()` 方法，也就是线程池从 TIDYING 转换到 TERMINATED 状态时调用的方法，默认是空的，它的源码如下：![](https://cdn.nlark.com/yuque/0/2022/png/396745/1650009507896-46c59af9-1a87-4458-94ef-6fd09367e91a.png#clientId=uc2769e3f-6c1f-4&from=paste&id=ua58570bc&originHeight=300&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u0fe98754-9be9-4abe-870b-d2ded1bd92b&title=)可以在创建线程池的时候重写 `terminated()` 方法，具体实现代码如下：
```java
import java.util.concurrent.LinkedBlockingQueue;
import java.util.concurrent.ThreadPoolExecutor;
import java.util.concurrent.TimeUnit;

public class ThreadPoolStateTransition {
	public static void main(String[] args) throws InterruptedException {
		// 创建线程池
		ThreadPoolExecutor threadPool = new ThreadPoolExecutor(10, 10, 0L,
															   TimeUnit.SECONDS, new LinkedBlockingQueue<>(100)) {
			@Override
			protected void terminated() {
				super.terminated();
				System.out.println("执行 terminated() 方法");
			}
		};
		// 关闭线程池
		threadPool.shutdown();
		// 等待线程池执行完再退出
		while (!threadPool.awaitTermination(1, TimeUnit.SECONDS)) {
			System.out.println("线程池正在运行中");
		}
	}
}
```
<a name="uCSwo"></a>
## 总结
线程池的状态总共有 5 种：RUNNING：运行状态、SHUTDOWN：关闭状态、STOP：停止状态、TIDYING：整理状态和 TERMINATED：销毁状态。默认情况下，如果不调用关闭方法，线程池会一直处于 RUNNING 状态，而线程池状态的转移有两个路径：当调用 `shutdown()` 方法时，线程池的状态会从 RUNNING 到 SHUTDOWN，再到 TIDYING，最后到 TERMENATED 销毁状态；当调用 `shutdownNow()` 方法时，线程池的状态会从 RUNNING 到 STOP，再到 TIDYING，最后到 TERMENATED 销毁状态。
