Java String<br />Java中String是有长度限制的，听到这里很多人不禁要问，String还有长度限制？是的有，而且在JVM编译中还有规范。
<a name="JkgAo"></a>
## String
首先要知道String的长度限制就需要知道String是怎么存储字符串的，String其实是使用的一个`char`类型的数组来存储字符串中的字符的。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970211987-190bb98d-4008-4c3b-b24a-492770edea85.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u63e15931&originHeight=144&originWidth=872&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uff09b334-47dc-41c1-b414-22aac0424bc&title=)<br />存储String的容器原来是它<br />那么String既然是数组存储那数组会有长度的限制吗？是的有限制，但是是在有先提条件下的，看看String中返回length的方法。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970211827-54fc8ebc-0db4-4394-a41c-6a60d4ceefaa.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u96f16f93&originHeight=318&originWidth=971&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u08df2b67-5641-42da-ac5a-026835b8d2f&title=)<br />String类中的length方法<br />由此看到返回值类型是int类型，Java中定义数组是可以给数组指定长度的，当然不指定的话默认会根据数组元素来指定：
```java
int[] arr1 = new int[10]; // 定义一个长度为10的数组
int[] arr2 = {1,2,3,4,5}; // 那么此时数组的长度为5
```
整数在java中是有限制的，通过源码来看看int类型对应的包装类Integer可以看到，其长度最大限制为2^31 -1，那么说明了数组的长度是0~2^31-1，那么计算一下就是（2^31-1 = 2147483647 = 4GB）<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970211850-e83be2d0-dea2-438d-a364-23e3b1f78f1f.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u0c576cb1&originHeight=449&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uc11bcf3d-2ec7-4624-ab6e-b7ace20aa20&title=)<br />Integer的取值范围<br />看到这尝试通过编码来验证一下上述观点。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970211850-8c64cb2f-211b-404d-9510-24257224aed1.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u7767f34c&originHeight=454&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ud7560c30-1cf7-423d-96e2-94cc7b74746&title=)<br />以字面量形式定义字符串<br />以上是通过定义字面量的形式构造的10万个字符的字符串，编译之后虚拟机提示报错，提示字符串长度过长，不是说好了可以存21亿个吗？为什么才10万个就报错了呢？<br />其实这里涉及到了JVM编译规范的限制了，其实JVM在编译时，如果将字符串定义成了字面量的形式，编译时JVM是会将其存放在常量池中，这时候JVM对这个常量池存储String类型做出了限制，接下来先看下手册是如何说的。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212006-c797c06b-0a64-4501-a87c-cae65791b07b.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=ubf0e97db&originHeight=540&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u041503fb-2624-4c57-8e0c-c76641d9477&title=)<br />java虚拟机规范截图<br />常量池中，每个 cp_info 项的格式必须相同，它们都以一个表示 cp_info 类型的单字节 “tag”项开头。后面 `info[]`项的内容 由tag 的类型所决定。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212224-c76f4be6-c64f-4c0b-bab0-c7ef70bca76b.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=ud3ed29ee&originHeight=701&originWidth=640&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u59b306ba-d08c-468f-bf14-6be104e1fa9&title=)<br />java虚拟机规范手册常量类型表<br />可以看到 String类型的表示是 CONSTANT_String ，来看下CONSTANT_String具体是如何定义的。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212430-1860fa7c-e6e1-4564-8880-b420c676f056.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u10db6410&originHeight=741&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=ua52ee866-52f5-4f67-8300-2c28aff50c9&title=)<br />这里定义的 `u2 string_index` 表示的是常量池的有效索引，其类型是`CONSTANT_Utf8_info` 结构体表示的，这里需要注意的是其中定义的length看下面这张图。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212430-2d335a7a-b1f4-4fad-a92d-2141a87f5a82.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u480160b3&originHeight=225&originWidth=890&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=u96f64d32-2de6-4102-87f9-aab086cef86&title=)<br />在class文件中u2表示的是无符号数占2个字节单位，1个字节占8位，2个字节就是16位 ，那么2个字节能表示的范围就是2^16- 1 = 65535 。范中class文件格式对u1、u2的定义的解释做了一下摘要：
> 这里对java虚拟机规摘要部分<br />1、class文件中文件内容类型解释定义一组私有数据类型来表示 Class 文件的内容，它们包括 u1，u2 和 u4，分别代表了 1、2 和 4 个字节的无符号数。每个 Class 文件都是由 8 字节为单位的字节流组成，所有的 16 位、32 位和 64 位长度的数据将被构造成 2 个、4 个和 8 个 8 字节单位来表示。
> 2、程序异常处理的有效范围解释start_pc 和 end_pc 两项的值表明了异常处理器在 code[]数组中的有效范围。start_pc 必须是对当前 code[]数组中某一指令的操作码的有效索引，end_pc 要么是对当前 code[]数组中某一指令的操作码的有效索引，要么等于 code_length的值，即当前 code[]数组的长度。start_pc 的值必须比 end_pc 小。当程序计数器在范围[start_pc, end_pc)内时，异常处理器就将生效。即设 x 为异常句柄的有效范围内的值，x 满足：start_pc ≤ x < end_pc。实际上，end_pc 值本身不属于异常处理器的有效范围这点属于 Java 虚拟机历史上的一个设计缺陷：如果 Java 虚拟机中的一个方法的 code 属性的长度刚好是 65535个字节，并且以一个 1 个字节长度的指令结束，那么这条指令将不能被异常处理器所处理。不过编译器可以通过限制任何方法、实例初始化方法或类初始化方法的code[]数组最大长度为 65534，这样可以间接弥补这个 BUG。
> 注意：这里对个人认为比较重要的点做了标记，首先第一个加粗说白了就是说数组有效范围就是【0-65535】但是第二个加粗的地方又解释了，因为虚拟机还需要1个字节的指令作为结束，所以其实真正的有效范围是【0-65534】，这里要注意这里的范围仅限编译时期，如果是运行时拼接的字符串是可以超出这个范围的。

接下来通过一个小实验来测试一下构建一个长度为65534的字符串，看看是否就能编译通过。<br />首先通过一个for循环构建65534长度的字符串，在控制台打印后，通过一个在线字符统计工具计算了一下确实是65534个字符，如下：<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212433-1a36c3b2-1c39-4cf1-b354-4de07eb76735.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u936188d1&originHeight=1080&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u97d69b8e-f40c-4fa0-b697-97f08a376ff&title=)<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212625-015e1ff7-b08b-46fa-91ea-3cda973d0a15.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u7dc1b234&originHeight=724&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=shadow&taskId=ued7fd34f-713c-4d07-b997-7e1db09ada0&title=)<br />然后将字符复制后以定义字面量的形式赋值给字符串，可以看到选择这些字符右下角显示的确实是65534，运行一下，果然成功了。<br />![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212647-dfd9bb1c-3bdc-4c36-a66d-a17462e63a81.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u5915a502&originHeight=555&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uff344060-ed64-4dcb-8253-f40750591e4&title=)

![](https://cdn.nlark.com/yuque/0/2021/webp/396745/1638970212912-06d4f15e-5920-45c9-bc91-3afcb5081a02.webp#clientId=ub0a9ce52-e9c8-4&from=paste&id=u73ce3196&originHeight=183&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ued1d2aeb-225c-4e73-ab15-149d7e45fa3&title=)<br />看到这里来总结一下：<br />问：字符串有长度限制吗？是多少？<br />答：首先字符串的内容是由一个字符数组 `char[]` 来存储的，由于数组的长度及索引是整数，且String类中返回字符串长度的方法`length()` 的返回值也是int ，所以通过查看java源码中的类Integer可以看到Integer的最大范围是2^31 -1,由于数组是从0开始的，所以数组的最大长度可以使【0~2^31-1】通过计算是大概4GB。<br />但是通过翻阅java虚拟机手册对class文件格式的定义以及常量池中对String类型的结构体定义可以知道对于索引定义了u2，就是无符号占2个字节，2个字节可以表示的最大范围是2^16 -1 = 65535。<br />其实是65535，但是由于JVM需要1个字节表示结束指令，所以这个范围就为65534了。超出这个范围在编译时期是会报错的，但是运行时拼接或者赋值的话范围是在整形的最大范围。
