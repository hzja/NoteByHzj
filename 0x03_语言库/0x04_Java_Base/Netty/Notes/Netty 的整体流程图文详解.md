JavaNetty
<a name="RjqKh"></a>
## Netty 的整体流程
Netty 的整体流程相对来说还是比较复杂的，初学者往往会被绕晕。<br />所以这里总结了一下整体的流程，从而对 Netty 的整体服务流程有一个大致的了解。从功能上，流程可以分为服务启动、建立连接、读取数据、业务处理、发送数据、关闭连接以及关闭服务。<br />整体流程如下所示(图中没有包含关闭的部分)：<br />![2023-04-27-14-05-19.402249800.png](https://cdn.nlark.com/yuque/0/2023/png/396745/1682575776905-0dd8047c-d146-4b1b-852c-8735f8e522ba.png#averageHue=%23fdfdfc&clientId=u0007c3b7-5c6d-4&from=ui&id=u8ef3f44e&originHeight=725&originWidth=1080&originalType=binary&ratio=2.5&rotation=0&showTitle=false&size=2353596&status=done&style=none&taskId=u8fd6c40a-1aee-4595-91dd-b5b8fa8a427&title=)
<a name="SrvgW"></a>
## 服务启动
服务启动时，以 example 代码中的 EchoServer 为例，启动的过程以及相应的源码类如下：

1. `EchoServer#new NioEventLoopGroup(1)`->`NioEventLoop#provider.openSelector()`：创建 selector
2. `EchoServer#b.bind(PORT).sync`->`AbstractBootStrap#doBind()`->`initAndRegister()`-> `channelFactory.newChannel()` / `init(channel)`：创建 `serverSocketChannel` 以及初始化
3. `EchoServer#b.bind(PORT).sync`->`AbstractBootStrap#doBind()`->`initAndRegister()`-> `config().group().register(channel)`：从 boss group 中选择一个 `NioEventLoop` 开始注册 `serverSocketChannel`
4. `EchoServer#b.bind(PORT).sync`->`AbstractBootStrap#doBind()`->`initAndRegister()`->`config().group().register(channel)`->`AbstractChannel#register0(promise)`->`AbstractNioChannel#javaChannel().register(eventLoop().unwrappedSelector(), 0, this)`：将 server socket channel 注册到选择的 NioEventLoop 的 selector
5. `EchoServer#b.bind(PORT).sync()`->`AbstractBootStrap#doBind()`->`doBind0()`->`AbstractChannel#doBind(localAddress)`->`NioServerSocketChannel#javaChannel().bind(localAddress, config.getBacklog())`：绑定地址端口开始启动
6. `EchoServer#b.bind(PORT).sync()`->`AbstractBootStrap#doBind()`->`doBind0()`->`AbstractChannel#pipeline.fireChannelActive()`->`AbstractNioChannel#selectionKey.interestOps(interestOps|readInterestOp)`：注册 OP_READ 事件

上述启动流程中，1、2、3 是由自己的线程执行的，即 mainThread，4、5、6 是由 Boss Thread 执行。相应时序图如下：
![](https://cdn.nlark.com/yuque/__puml/f309f53d7f14f51305880ae8650dd7cc.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYXV0b251bWJlclxuXG5wYXJ0aWNpcGFudCBcIkVjaG9TZXJ2ZXJcIiBhcyBFY2hvU2VydmVyXG5wYXJ0aWNpcGFudCBcIk5pb0V2ZW50TG9vcEdyb3VwXCIgYXMgTmlvRXZlbnRMb29wR3JvdXAgI29yYW5nZVxucGFydGljaXBhbnQgXCJBYnN0cmFjdEJvb3RTdHJhcFwiIGFzIEFic3RyYWN0Qm9vdFN0cmFwICNza3libHVlXG5wYXJ0aWNpcGFudCBcIkFic3RyYWN0Q2hhbm5lbFwiIGFzIEFic3RyYWN0Q2hhbm5lbFxucGFydGljaXBhbnQgXCJBYnN0cmFjdE5pb0NoYW5uZWxcIiBhcyBBYnN0cmFjdE5pb0NoYW5uZWxcbnBhcnRpY2lwYW50IFwiTmlvU2VydmVyU29ja2V0Q2hhbm5lbFwiIGFzIE5pb1NlcnZlclNvY2tldENoYW5uZWxcblxuRWNob1NlcnZlciAtPiBOaW9FdmVudExvb3BHcm91cDogb3BlblNlbGVjdG9yXG5hY3RpdmF0ZSBOaW9FdmVudExvb3BHcm91cFxuZGVhY3RpdmF0ZSBOaW9FdmVudExvb3BHcm91cFxuRWNob1NlcnZlciAtPiBBYnN0cmFjdEJvb3RTdHJhcDogYmluZFxuYWN0aXZhdGUgQWJzdHJhY3RCb290U3RyYXBcbkFic3RyYWN0Qm9vdFN0cmFwIC0-IEFic3RyYWN0Qm9vdFN0cmFwOiBuZXdDaGFubmVsLCBpbml0Q2hhbm5lbFxuQWJzdHJhY3RCb290U3RyYXAgLT4gQWJzdHJhY3RCb290U3RyYXA6IHJlZ2lzdGVyQ2hhbm5lbFxuQWJzdHJhY3RCb290U3RyYXAgLT4gQWJzdHJhY3RDaGFubmVsOiBib29zR3JvdXAgcmVnaXN0ZXIgY2hhbm5lbFxuZGVhY3RpdmF0ZSBBYnN0cmFjdEJvb3RTdHJhcFxuYWN0aXZhdGUgQWJzdHJhY3RDaGFubmVsXG5BYnN0cmFjdENoYW5uZWwgLT4gQWJzdHJhY3ROaW9DaGFubmVsOiByZWdpc3RlciBjaGFubmVsIHRvIHNlbGVjdG9yIGluIGV2ZW50bG9vcFxuYWN0aXZhdGUgQWJzdHJhY3ROaW9DaGFubmVsXG5kZWFjdGl2YXRlIEFic3RyYWN0Q2hhbm5lbFxuZGVhY3RpdmF0ZSBBYnN0cmFjdE5pb0NoYW5uZWxcbkFic3RyYWN0Qm9vdFN0cmFwIC0-IEFic3RyYWN0Qm9vdFN0cmFwOiBkb0JpbmQwXG5hY3RpdmF0ZSBBYnN0cmFjdEJvb3RTdHJhcFxuQWJzdHJhY3RCb290U3RyYXAgLT4gQWJzdHJhY3RDaGFubmVsOiBkb0JpbmRcbmFjdGl2YXRlIEFic3RyYWN0Q2hhbm5lbFxuQWJzdHJhY3RDaGFubmVsIC0-IE5pb1NlcnZlclNvY2tldENoYW5uZWw6IEphdmEgQ2hhbm5lbCBiaW5kIGFkZHJlc3NcbmFjdGl2YXRlIE5pb1NlcnZlclNvY2tldENoYW5uZWxcbmRlYWN0aXZhdGUgQWJzdHJhY3RDaGFubmVsXG5kZWFjdGl2YXRlIE5pb1NlcnZlclNvY2tldENoYW5uZWxcbkFic3RyYWN0Qm9vdFN0cmFwIC0-IEFic3RyYWN0Q2hhbm5lbDogZmlyZUNoYW5uZWxBY3RpdmVcbmRlYWN0aXZhdGUgQWJzdHJhY3RCb290U3RyYXBcbmFjdGl2YXRlIEFic3RyYWN0Q2hhbm5lbFxuQWJzdHJhY3RDaGFubmVsIC0-IEFic3RyYWN0TmlvQ2hhbm5lbDogc2VsZWN0aW9uS2V5LmludGVyZXN0T3BzIE9QX0FDQ0VQVFxuYWN0aXZhdGUgQWJzdHJhY3ROaW9DaGFubmVsXG5kZWFjdGl2YXRlIEFic3RyYWN0Q2hhbm5lbFxuQGVuZHVtbCIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX3B1bWwvZjMwOWY1M2Q3ZjE0ZjUxMzA1ODgwYWU4NjUwZGQ3Y2Muc3ZnIiwiaWQiOiJ4TnVHdSIsIm1hcmdpbiI6eyJ0b3AiOnRydWUsImJvdHRvbSI6dHJ1ZX0sImNhcmQiOiJkaWFncmFtIn0=)<a name="MLFuw"></a>
## 建立连接
服务启动后便是建立连接的过程了，相应过程及源码类如下：

1. `NioEventLoop#run()`->`processSelectedKey()` NioEventLoop 中的 selector 轮询创建连接事件（OP_ACCEPT）
2. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioMessageChannel#read`->`NioServerSocketChannel#doReadMessages()`->`SocketUtil#accept(serverSocketChannel)` 创建 socket channel
3. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioMessageChannel#fireChannelRead`->`ServerBootstrap#ServerBootstrapAcceptor#channelRead`-> `childGroup.register(child)` 从worker group 中选择一个 `NioEventLoop` 开始注册 socket channel
4. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioMessageChannel#fireChannelRead`->`ServerBootstrap#ServerBootstrapAcceptor#channelRead`-> `childGroup.register(child)`->`AbstractChannel#register0(promise)`-> `AbstractNioChannel#javaChannel().register(eventLoop().unwrappedSelector(), 0, this)` 将 socket channel 注册到选择的 NioEventLoop 的 selector
5. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioMessageChannel#fireChannelRead`->`ServerBootstrap#ServerBootstrapAcceptor#channelRead`-> `childGroup.register(child)`->`AbstractChannel#pipeline.fireChannelActive()`-> `AbstractNioChannel#selectionKey.interestOps(interestOps | readInterestOp)` 注册 OP_ACCEPT 事件

同样，上述流程中 1、2、3 的执行仍由 Boss Thread 执行，直到 4、5 由具体的 Work Thread 执行。
![](https://cdn.nlark.com/yuque/__puml/16bb5dc1057931e24e14d6e68b9bba6b.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYXV0b251bWJlclxuXG5wYXJ0aWNpcGFudCBcIk5pb0V2ZW50TG9vcFwiIGFzIE5pb0V2ZW50TG9vcFxucGFydGljaXBhbnQgXCJBYnN0cmFjdE5pb01lc3NhZ2VDaGFubmVsXCIgYXMgQWJzdHJhY3ROaW9NZXNzYWdlQ2hhbm5lbCAjb3JhbmdlXG5wYXJ0aWNpcGFudCBcIk5pb1NlcnZlclNvY2tldENoYW5uZWxcIiBhcyBOaW9TZXJ2ZXJTb2NrZXRDaGFubmVsICNza3libHVlXG5wYXJ0aWNpcGFudCBcIlNlcnZlckJvb3RzdHJhcHxTZXJ2ZXJCb290c3RyYXBBY2NlcHRvclwiIGFzIFNlcnZlckJvb3RzdHJhcFxucGFydGljaXBhbnQgXCJBYnN0cmFjdENoYW5uZWxcIiBhcyBBYnN0cmFjdENoYW5uZWxcbnBhcnRpY2lwYW50IFwiQWJzdHJhY3ROaW9DaGFubmVsXCIgYXMgQWJzdHJhY3ROaW9DaGFubmVsXG5cbk5pb0V2ZW50TG9vcCAtPiBOaW9FdmVudExvb3A6IHJ1biBwcm9jZXNzU2VsZWN0ZWRLZXkgZm9yIE9QX0FDQ0VQVFxuYWN0aXZhdGUgTmlvRXZlbnRMb29wIFxuTmlvRXZlbnRMb29wIC0-IEFic3RyYWN0TmlvTWVzc2FnZUNoYW5uZWw6IHJlYWRcbmFjdGl2YXRlIEFic3RyYWN0TmlvTWVzc2FnZUNoYW5uZWxcbkFic3RyYWN0TmlvTWVzc2FnZUNoYW5uZWwgLT4gTmlvU2VydmVyU29ja2V0Q2hhbm5lbDogZG9SZWFkTWVzc2FnZVxuYWN0aXZhdGUgTmlvU2VydmVyU29ja2V0Q2hhbm5lbFxuTmlvU2VydmVyU29ja2V0Q2hhbm5lbCAtPiBOaW9TZXJ2ZXJTb2NrZXRDaGFubmVsOiBhY2NlcHQgfCBjcmVhdGUgc29ja2V0Q2hhbm5lbFxuZGVhY3RpdmF0ZSBOaW9TZXJ2ZXJTb2NrZXRDaGFubmVsXG5BYnN0cmFjdE5pb01lc3NhZ2VDaGFubmVsIC0-IFNlcnZlckJvb3RzdHJhcDogZmlyZUNoYW5uZWxSZWFkIHwgcmVnaXN0ZXIgY2hhbm5lbFxuYWN0aXZhdGUgU2VydmVyQm9vdHN0cmFwXG5TZXJ2ZXJCb290c3RyYXAgLT4gQWJzdHJhY3RDaGFubmVsOiB3b3JrR3JvdXAgcmVnaXN0ZXIgc29ja2V0Q2hhbm5lbFxuYWN0aXZhdGUgQWJzdHJhY3RDaGFubmVsXG5kZWFjdGl2YXRlIFNlcnZlckJvb3RzdHJhcFxuZGVhY3RpdmF0ZSBBYnN0cmFjdE5pb01lc3NhZ2VDaGFubmVsXG5kZWFjdGl2YXRlIE5pb0V2ZW50TG9vcFxuQWJzdHJhY3RDaGFubmVsIC0-IEFic3RyYWN0TmlvQ2hhbm5lbDogcmVnaXN0ZXIgY2hhbm5lbCB0byBzZWxlY3RvciBpbiBldmVudGxvb3BcbmFjdGl2YXRlIEFic3RyYWN0TmlvQ2hhbm5lbFxuZGVhY3RpdmF0ZSBBYnN0cmFjdE5pb0NoYW5uZWxcbkFic3RyYWN0Q2hhbm5lbCAtPiBBYnN0cmFjdENoYW5uZWw6IGZpcmVDaGFubmVsQWN0aXZlXG5BYnN0cmFjdENoYW5uZWwgLT4gQWJzdHJhY3ROaW9DaGFubmVsOiBzZWxlY3Rpb25LZXkuaW50ZXJlc3RPcHMgT1BfUkVBRFxuYWN0aXZhdGUgQWJzdHJhY3ROaW9DaGFubmVsXG5kZWFjdGl2YXRlIEFic3RyYWN0Q2hhbm5lbFxuZGVhY3RpdmF0ZSBBYnN0cmFjdE5pb0NoYW5uZWxcblxuQGVuZHVtbCIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX3B1bWwvMTZiYjVkYzEwNTc5MzFlMjRlMTRkNmU2OGI5YmJhNmIuc3ZnIiwiaWQiOiJ1RGl0YSIsIm1hcmdpbiI6eyJ0b3AiOnRydWUsImJvdHRvbSI6dHJ1ZX0sImNhcmQiOiJkaWFncmFtIn0=)<a name="uEXM1"></a>
## 读写与业务处理
连接建立完毕后是具体的读写，以及业务处理逻辑。以 `EchoServerHandler` 为例，读取数据后会将数据传播出去供业务逻辑处理，此时的 `EchoServerHandler` 代表业务逻辑，而它的实现也非常简单，就是直接将数据写回去。<br />将这块看成一个整条，流程如下：

1. `NioEventLoop#run()`->`processSelectedKey()` `NioEventLoop` 中的 selector 轮询创建读取事件（OP_READ）
2. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioByteChannel#read()` `nioSocketChannel` 开始读取数据
3. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioByteChannel#read()`->`pipeline.fireChannelRead(byteBuf)`把读取到的数据传播出去供业务处理
4. `AbstractNioByteChannel#pipeline.fireChannelRead`->`EchoServerHandler#channelRead`在这个例子中即 `EchoServerHandler` 的执行
5. `EchoServerHandler#write`->`ChannelOutboundBuffer#addMessage` 调用 write 方法
6. `EchoServerHandler#flush`->`ChannelOutboundBuffer#addFlush` 调用 flush 准备数据
7. `EchoServerHandler#flush`->`NioSocketChannel#doWrite` 调用 flush 发送数据

在这个过程中读写数据都是由 Work Thread 执行的，但是业务处理可以由自定义的线程池来处理，并且一般也是这么做的，默认没有指定线程的情况下仍然由 Work Thread 代为处理。
![](https://cdn.nlark.com/yuque/__puml/796d67e903c5272ba6c6a3cad8f7910e.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYXV0b251bWJlclxuXG5wYXJ0aWNpcGFudCBcIk5pb0V2ZW50TG9vcFwiIGFzIE5pb0V2ZW50TG9vcFxucGFydGljaXBhbnQgXCJBYnN0cmFjdE5pb0J5dGVDaGFubmVsXCIgYXMgQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbCAjb3JhbmdlXG5wYXJ0aWNpcGFudCBcIkVjaG9TZXJ2ZXJIYW5kbGVyXCIgYXMgRWNob1NlcnZlckhhbmRsZXIgI3NreWJsdWVcbnBhcnRpY2lwYW50IFwiQ2hhbm5lbE91dGJvdW5kQnVmZmVyXCIgYXMgQ2hhbm5lbE91dGJvdW5kQnVmZmVyXG5wYXJ0aWNpcGFudCBcIk5pb1NvY2tldENoYW5uZWxcIiBhcyBOaW9Tb2NrZXRDaGFubmVsXG5cbk5pb0V2ZW50TG9vcCAtPiBOaW9FdmVudExvb3A6IHJ1biBwcm9jZXNzU2VsZWN0ZWRLZXkgZm9yIE9QX1JFQURcbmFjdGl2YXRlIE5pb0V2ZW50TG9vcFxuTmlvRXZlbnRMb29wIC0-IEFic3RyYWN0TmlvQnl0ZUNoYW5uZWw6IHJlYWRcbmFjdGl2YXRlIEFic3RyYWN0TmlvQnl0ZUNoYW5uZWxcbmRlYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5BYnN0cmFjdE5pb0J5dGVDaGFubmVsIC0-IEVjaG9TZXJ2ZXJIYW5kbGVyOiBwaXBlbGluZS5maXJlQ2hhbm5lbFJlYWRcbmFjdGl2YXRlIEVjaG9TZXJ2ZXJIYW5kbGVyXG5FY2hvU2VydmVySGFuZGxlciAtPiBDaGFubmVsT3V0Ym91bmRCdWZmZXI6IGFkZE1lc3NhZ2VcbmFjdGl2YXRlIENoYW5uZWxPdXRib3VuZEJ1ZmZlclxuZGVhY3RpdmF0ZSBFY2hvU2VydmVySGFuZGxlclxuZGVhY3RpdmF0ZSBDaGFubmVsT3V0Ym91bmRCdWZmZXJcbkFic3RyYWN0TmlvQnl0ZUNoYW5uZWwgLT4gRWNob1NlcnZlckhhbmRsZXI6IHBpcGVsaW5lLmZpcmVDaGFubmVsUmVhZENvbXBsZXRlXG5hY3RpdmF0ZSBFY2hvU2VydmVySGFuZGxlclxuRWNob1NlcnZlckhhbmRsZXIgLT4gQ2hhbm5lbE91dGJvdW5kQnVmZmVyOiBhZGRGbHVzaFxuYWN0aXZhdGUgQ2hhbm5lbE91dGJvdW5kQnVmZmVyXG5kZWFjdGl2YXRlIEFic3RyYWN0TmlvQnl0ZUNoYW5uZWxcbmRlYWN0aXZhdGUgQ2hhbm5lbE91dGJvdW5kQnVmZmVyXG5FY2hvU2VydmVySGFuZGxlciAtPiBOaW9Tb2NrZXRDaGFubmVsOiBkb1dyaXRlXG5hY3RpdmF0ZSBOaW9Tb2NrZXRDaGFubmVsXG5kZWFjdGl2YXRlIEVjaG9TZXJ2ZXJIYW5kbGVyXG5kZWFjdGl2YXRlIE5pb1NvY2tldENoYW5uZWxcblxuQGVuZHVtbCIsInVybCI6Imh0dHBzOi8vY2RuLm5sYXJrLmNvbS95dXF1ZS9fX3B1bWwvNzk2ZDY3ZTkwM2M1MjcyYmE2YzZhM2NhZDhmNzkxMGUuc3ZnIiwiaWQiOiJZcEI5NSIsIm1hcmdpbiI6eyJ0b3AiOnRydWUsImJvdHRvbSI6dHJ1ZX0sImNhcmQiOiJkaWFncmFtIn0=)<a name="SIT6C"></a>
## 关闭连接
服务处理完毕后，单个连接的关闭是什么样的呢？

1. `NioEventLoop#run()`->`processSelectedKey()` `NioEventLoop` 中的 selector 轮询创建读取事件（OP_READ)，这里关闭连接仍然是读取事件
2. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioByteChannel#read()`->`closeOnRead(pipeline)`当字节<0 时开始执行关闭 nioSocketChannel
3. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioByteChannel#read()`->`closeOnRead(pipeline)`->`AbstractChannel#close`->`AbstractNioChannel#doClose()` 关闭 `socketChannel`
4. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioByteChannel#read()`->`closeOnRead(pipeline)`->`AbstractChannel#close`->`outboundBuffer.failFlushed/close` 清理消息：不接受新信息，fail 掉所有 queue 中消息
5. `NioEventLoop#run()`->`processSelectedKey()`->`AbstractNioByteChannel#read()`->`closeOnRead(pipeline)`->`AbstractChannel#close`->`fireChannelInactiveAndDeregister`->`AbstractNioChannel#doDeregister eventLoop().cancel(selectionKey())` 关闭多路复用器的 key

时序图如下：
![](https://cdn.nlark.com/yuque/__puml/61c58ce4ef57e6d6b8e96460424788d2.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYXV0b251bWJlclxuXG5wYXJ0aWNpcGFudCBcIk5pb0V2ZW50TG9vcFwiIGFzIE5pb0V2ZW50TG9vcFxucGFydGljaXBhbnQgXCJBYnN0cmFjdE5pb0J5dGVDaGFubmVsXCIgYXMgQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbCAjb3JhbmdlXG5wYXJ0aWNpcGFudCBcIkFic3RyYWN0Q2hhbm5lbFwiIGFzIEFic3RyYWN0Q2hhbm5lbCAjc2t5Ymx1ZVxucGFydGljaXBhbnQgXCJBYnN0cmFjdE5pb0NoYW5uZWxcIiBhcyBBYnN0cmFjdE5pb0NoYW5uZWxcblxuTmlvRXZlbnRMb29wIC0-IE5pb0V2ZW50TG9vcDogcnVuIHByb2Nlc3NTZWxlY3RlZEtleSBmb3IgT1BfUkVBRFxuYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5OaW9FdmVudExvb3AgLT4gQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbDogcmVhZFxuYWN0aXZhdGUgQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbFxuZGVhY3RpdmF0ZSBOaW9FdmVudExvb3BcbkFic3RyYWN0TmlvQnl0ZUNoYW5uZWwgLT4gQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbDogY2xvc2Ugb24gcmVhZFxuQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbCAtPiBBYnN0cmFjdENoYW5uZWw6IGNsb3NlXG5hY3RpdmF0ZSBBYnN0cmFjdENoYW5uZWxcbmRlYWN0aXZhdGUgQWJzdHJhY3ROaW9CeXRlQ2hhbm5lbFxuQWJzdHJhY3RDaGFubmVsIC0-IEFic3RyYWN0TmlvQ2hhbm5lbDogZG9DbG9zZVxuYWN0aXZhdGUgQWJzdHJhY3ROaW9DaGFubmVsXG5kZWFjdGl2YXRlIE5pb0V2ZW50TG9vcFxuQWJzdHJhY3ROaW9DaGFubmVsIC0-IEFic3RyYWN0TmlvQ2hhbm5lbDogSmF2YSBDaGFubmVsIGNsb3NlXG5kZWFjdGl2YXRlIEFic3RyYWN0TmlvQ2hhbm5lbFxuQWJzdHJhY3RDaGFubmVsIC0-IEFic3RyYWN0Q2hhbm5lbDogb3V0Ym91bmRCdWZmZXIuZmFpbEZsdXNoZWQgfCBjbG9zZVxuQWJzdHJhY3RDaGFubmVsIC0-IEFic3RyYWN0TmlvQ2hhbm5lbDogZG9EZXJlZ2lzdGVyXG5hY3RpdmF0ZSBBYnN0cmFjdE5pb0NoYW5uZWxcbmRlYWN0aXZhdGUgQWJzdHJhY3RDaGFubmVsXG5BYnN0cmFjdE5pb0NoYW5uZWwgLT4gQWJzdHJhY3ROaW9DaGFubmVsOiBldmVudGxvb3AgY2FuY2VsIHNlbGVjdGlvbktleVxuXG5AZW5kdW1sIiwidXJsIjoiaHR0cHM6Ly9jZG4ubmxhcmsuY29tL3l1cXVlL19fcHVtbC82MWM1OGNlNGVmNTdlNmQ2YjhlOTY0NjA0MjQ3ODhkMi5zdmciLCJpZCI6IlI5U0RQIiwibWFyZ2luIjp7InRvcCI6dHJ1ZSwiYm90dG9tIjp0cnVlfSwiY2FyZCI6ImRpYWdyYW0ifQ==)<a name="xAALW"></a>
## 关闭服务
最后是关闭整个 Netty 服务：

1. `NioEventLoop#run`->`closeAll()`->`selectionKey.cancel/channel.close` 关闭 channel，取消 selectionKey
2. `NioEventLoop#run`->`confirmShutdown`->`cancelScheduledTasks` 取消定时任务
3. `NioEventLoop#cleanup`->`selector.close()` 关闭 selector

时序图如下，为了好画将 `NioEventLoop` 拆成了 2 块：
![](https://cdn.nlark.com/yuque/__puml/11f80dc7959adc24863b1367dce6dcba.svg#lake_card_v2=eyJ0eXBlIjoicHVtbCIsImNvZGUiOiJAc3RhcnR1bWxcblxuYXV0b251bWJlclxuXG5wYXJ0aWNpcGFudCBcIk5pb0V2ZW50TG9vcFwiIGFzIE5pb0V2ZW50TG9vcDFcbnBhcnRpY2lwYW50IFwiTmlvRXZlbnRMb29wXCIgYXMgTmlvRXZlbnRMb29wICNvcmFuZ2VcblxuTmlvRXZlbnRMb29wMSAtPiBOaW9FdmVudExvb3AxOiBydW5cbmFjdGl2YXRlIE5pb0V2ZW50TG9vcDFcbk5pb0V2ZW50TG9vcDEgLT4gTmlvRXZlbnRMb29wOiBjbG9zZUFsbFxuYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5OaW9FdmVudExvb3AgLT4gTmlvRXZlbnRMb29wOiBzZWxlY3Rpb25LZXkuY2FuY2VsL2NoYW5uZWwuY2xvc2VcbmRlYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5OaW9FdmVudExvb3AxIC0-IE5pb0V2ZW50TG9vcDogY29uZmlybVNodXRkb3duXG5hY3RpdmF0ZSBOaW9FdmVudExvb3BcbmRlYWN0aXZhdGUgTmlvRXZlbnRMb29wMVxuTmlvRXZlbnRMb29wIC0-IE5pb0V2ZW50TG9vcDogY2FuY2VsU2NoZWR1bGVkVGFza3NcbmRlYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5OaW9FdmVudExvb3AxIC0-IE5pb0V2ZW50TG9vcDE6IGNsZWFudXBcbmFjdGl2YXRlIE5pb0V2ZW50TG9vcDFcbk5pb0V2ZW50TG9vcDEgLT4gTmlvRXZlbnRMb29wOiBzZWxlY3Rvci5jbG9zZVxuYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5kZWFjdGl2YXRlIE5pb0V2ZW50TG9vcDFcbmRlYWN0aXZhdGUgTmlvRXZlbnRMb29wXG5cbkBlbmR1bWwiLCJ1cmwiOiJodHRwczovL2Nkbi5ubGFyay5jb20veXVxdWUvX19wdW1sLzExZjgwZGM3OTU5YWRjMjQ4NjNiMTM2N2RjZTZkY2JhLnN2ZyIsImlkIjoiQnY5Z0ciLCJtYXJnaW4iOnsidG9wIjp0cnVlLCJib3R0b20iOnRydWV9LCJjYXJkIjoiZGlhZ3JhbSJ9)至此，整个 Netty 的服务流程就结束了。
