微服务 云原生
<a name="OtpsD"></a>
## 生产就绪（Production Ready）
架构的可运维性主要和配置，监控，部署这些环节相关。其中监控包括日志监控，调用链监控。
<a name="eSJLa"></a>
### 经典软件工程阶段
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631539147592-94e7e694-f4c6-4532-a3ae-eba243c5f573.jpeg)
<a name="giS7R"></a>
### 互联网软件交付阶段
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631539620665-114ff5b5-c9c8-4884-b39f-a4404d876aa3.jpeg)
<a name="UnWF1"></a>
### 什么是生产就绪
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631542031828-40bc62e8-3902-4536-9aeb-143722c48035.jpeg)
<a name="QfmRf"></a>
## SpringBoot如何实现分环境配置
<a name="InbAo"></a>
### Staffjoy环境
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631543418880-c63360db-7ad4-44c8-bcc9-1e364453cab5.jpeg)
<a name="ehFL9"></a>
## 配置中心选项比较
<a name="aUEaD"></a>
### 动态配置更新
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631543774826-d13de251-c210-47e5-87ad-0c101a96822d.jpeg)
<a name="aB0sO"></a>
### Apollo vs SpringCloud Config vs K8s ConfigMap
| <br /> | **Apollo** | **SpringCloud** | **K8s ConfigMap** |
| --- | --- | --- | --- |
| **配置界面** | **统一界面管理，不同环境和集群配置** | **无，通过Git操作** | **Cli或Dashboard** |
| **配置存储** | **DB** | **Git** | **Etcd** |
| **配置生效时间** | **实时推送+应用配合** | **近实时+应用配合** | **近实时+应用配置** |
| **动态配置** | **支持，实时推送** | **复杂+MQ** | **支持发布更新** |
| **版本管理** | **UI支持发布历史和回滚** | **无，通过Git操作** | **无，需自己管理** |
| **灰度发布** | **支持** | **不支持** | **支持灰度发布** |
| **授权/审计/审核** | **UI操作，修改和发布权限分离** | **需要通过Git仓库设置** | **K8s平台部分支持** |
| **实例配置监控** | **可见哪些客户端配置生效** | **不支持** | **可查询容器环境变量** |
| **客户端支持** | **原生Java/.Net，提供API，支持Spring标注** | **Spring应用+标注支持** | **语言无关** |

<a name="lukWX"></a>
### 参考样例
<a name="PYIVu"></a>
#### Apollo动态配置
[https://github.com/ctripcorp/apollo-use-cases](https://github.com/ctripcorp/apollo-use-cases)
<a name="uVigP"></a>
#### SpringCloud集中配置
[https://github.com/sqshq/piggymetrics](https://github.com/sqshq/piggymetrics)
<a name="CSNTP"></a>
## 服务监控工具对比
<a name="yemb5"></a>
### 监控平台的演进历史
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631547484365-83cf7425-7184-4769-bf89-b0a4f6ad8679.jpeg)
<a name="JdZ6E"></a>
### CAT vs Zipkin vs Skywalking
| <br /> | **CAT** | **Zipkin** | **Apache Skywalking** |
| --- | --- | --- | --- |
| **调用链可视化** | **有** | **有** | **有** |
| **聚合报表** | **非常丰富** | **少** | **较丰富** |
| **服务依赖图** | **简单** | **简单** | **好** |
| **埋点方式** | **侵入** | **侵入** | **非侵入，运行期字节码增强** |
| **VM指标监控** | **好** | **无** | **有** |
| **告警支持** | **有** | **无** | **有** |
| **多语言支持** | **Java/.Net** | **丰富** | **Java/.Net/NodeJS/PHP自动，Go手动** |
| **存储机制** | **MySQL（报表），本地文件/HDFS（调用链）** | **可选in memory，MySQL，ES（生产），Cassandra（生产）** | **H2，ES（生产）** |
| **社区支持** | **主要在国内，点评/美团** | **文档丰富，国外主流** | **Apache支持，国内社区好** |
| **国内案例** | **点评，携程，陆金所，拍拍贷** | **京东，阿里定制不开源** | **华为，小米，当当，微众银行** |
| **APM** | **Yes** | **No** | **Yes** |
| **祖先源头** | **eBay CAL** | **Google Dapper** | **Google Dapper** |
| **同类产品** | **暂无** | **Uber Jaeger，SpringCloud Sleuth** | **Naver Pinpoint** |
| **亮点** | **企业级生产，报表丰富** | **社区生态好** | **非侵入，Apache背书** |
| **不足** | **用户体验一般，社区一般** | **APM报表能力弱** | **时间不长，文档一般，仅限中文社区** |

<a name="LFVaZ"></a>
### Skywalking
[https://skywalking.apache.org/](https://skywalking.apache.org/)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1631549065525-a43154f0-e428-4b61-9121-01c9cb2f8f66.png#clientId=u1489721f-42ad-4&from=paste&height=601&id=u12e34201&originHeight=1803&originWidth=3798&originalType=binary&ratio=1&size=4567391&status=done&style=none&taskId=uaf5badda-6e24-4f0b-93ca-977da1f5f20&width=1266)
<a name="XvItm"></a>
#### Skywalking Java Agent支持库
[https://skywalking.apache.org/docs/#JavaAgent](https://skywalking.apache.org/docs/#JavaAgent)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1631548892092-d09ab66b-35fc-4b26-846d-975d7a02290a.png#clientId=u1489721f-42ad-4&from=paste&height=601&id=u5e5ff2c9&originHeight=1803&originWidth=3840&originalType=binary&ratio=1&size=429261&status=done&style=stroke&taskId=u1366c11c-bce5-4472-b422-7fd561bcc8e&width=1280)
<a name="r4ATf"></a>
### Zipkin
[https://zipkin.io/](https://zipkin.io/)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1631549119470-685ae7af-151b-4ff2-9d2f-6430fbff2245.png#clientId=u1489721f-42ad-4&from=paste&height=601&id=u502bd5a6&originHeight=1803&originWidth=3798&originalType=binary&ratio=1&size=719757&status=done&style=stroke&taskId=u8b9364a0-50ec-4944-ac40-01d232ebee0&width=1266)
<a name="q5VT1"></a>
### Jaeger
[https://www.jaegertracing.io/](https://www.jaegertracing.io/)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1631549187658-167581ac-ea94-4515-91ec-bc3cc43d6842.png#clientId=u1489721f-42ad-4&from=paste&height=599&id=u97ad0c11&originHeight=1797&originWidth=3798&originalType=binary&ratio=1&size=2353461&status=done&style=stroke&taskId=u1352096d-c89c-4cfa-9132-a252da12bf7&width=1266)
<a name="ZTNbX"></a>
## Staffjoy依赖监控图
![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1631548930670-9b943e7b-f2fc-43b0-a927-8cd377a15a1a.png#clientId=u1489721f-42ad-4&from=paste&height=399&id=ua53fc351&originHeight=532&originWidth=1031&originalType=binary&ratio=1&size=288275&status=done&style=none&taskId=u9767e225-4eb5-445b-a495-f4d6c4d5b77&width=773)
<a name="g4VHo"></a>
## 日志监控
<a name="rWPvH"></a>
### 结构化日志和审计日志
[https://github.com/jacek99/structlog4j](https://github.com/jacek99/structlog4j)<br />[![](https://github.com/jacek99/structlog4j/raw/master/img/logo.png#from=url&id=bpZY7&originHeight=148&originWidth=764&originalType=binary&ratio=1&status=done&style=stroke)](https://github.com/jacek99/structlog4j/blob/master/README.md)
```java
import com.github.structlog4j.IToLog;
import lombok.Builder;
import lombok.Data;

@Data
@Builder
public class LogEntry implements IToLog {

    private String currentUserId;
    private String companyId;
    private String teamId;
    private String authorization;
    private String targetType;
    private String targetId;
    private String originalContents;
    private String updatedContents;

    @Override
    public Object[] toLog() {
        return new Object[] {
                "auditlog", "true",
                "currentUserId", currentUserId,
                "companyId", companyId,
                "teamId", teamId,
                "authorization", authorization,
                "targetType", targetType,
                "targetId", targetId,
                "originalContents", originalContents,
                "updatedContents", updatedContents
        };
    }
}
```
```java
import com.github.structlog4j.ILogger;
import com.github.structlog4j.SLoggerFactory;

static ILogger logger = SLoggerFactory.getLogger(AccountService.class);

LogEntry auditLog = LogEntry.builder()
    .authorization(AuthContext.getAuthz())
    .currentUserId(AuthContext.getUserId())
    .targetType("account")
    .targetId(account.getId())
    .updatedContents(account.toString())
    .build();
logger.info("created account", auditLog);
```
<a name="LX2JM"></a>
## 集中异常监控和Sentry
官网：[https://sentry.io](https://sentry.io)<br />开源仓库：[https://github.com/getsentry/sentry](https://github.com/getsentry/sentry)
<a name="O4blG"></a>
### Sentry云服务的使用
<a name="Qk9j3"></a>
#### 客户端配置
```java
@Bean
public SentryClient sentryClient() {

    SentryClient sentryClient = Sentry.init(staffjoyProps.getSentryDsn());
    sentryClient.setEnvironment(activeProfile);
    sentryClient.setRelease(staffjoyProps.getDeployEnv());
    sentryClient.addTag("service", appName);

    return sentryClient;
}
```
<a name="gP6PC"></a>
#### 发送异常监控日志
```java
public void handleError(ILogger log, String errMsg) {
    log.error(errMsg);
    if (!envConfig.isDebug()) {
        sentryClient.sendMessage(errMsg);
    }
}
```
<a name="OTF3u"></a>
## EFK & Prometheus & Skywalking + Kubernetes集成架构
<a name="qKoke"></a>
### EFK + K8s
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631593636617-ba72e628-6d3d-4cc8-9037-71ba1a933c53.jpeg)
<a name="fcsX0"></a>
### Prometheus + K8s
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631593639390-658f8fc4-a610-43fd-a9dc-90bf5e0983a6.jpeg)
<a name="gJuqJ"></a>
### Skywalking + K8s
![](https://cdn.nlark.com/yuque/0/2021/jpeg/396745/1631630609933-00e953ed-667f-43fc-b81c-4f5fba284d03.jpeg)
