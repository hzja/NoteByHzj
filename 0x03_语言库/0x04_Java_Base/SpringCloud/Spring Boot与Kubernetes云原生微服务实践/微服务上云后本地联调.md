Java微服务<br />当微服务上云以后在开发过程中会遇到这样的场景：<br />生产者服务部署到了云上，消费者服务还处于开发阶段，现在开发人员想在本地启动消费者服务调用云上生产者服务进行接口调试，很显然由于生产者和消费者处于不同的网络区间无法互相访问，在应用层的表现就是：会出现服务调用超时的异常，如下所示<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793166-69001ad3-e51f-4820-b46f-0db5bfd91dde.png#averageHue=%2367473f&clientId=ua8f6fd07-fd6b-4&from=paste&id=u679e5663&originHeight=187&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=uf48c8684-2c31-4ae6-b740-f7e69b09dd6&title=)<br />此时为了联调不得不将本地服务也部署到云上，显然这对于开发同学来说及其不方便！那有没有一种简单高效的办法可以让本地服务跟Kubernetes集群中的服务互通呢？这就是今天要解决的问题！<br />解决方案嘛其实也很简单，网上已经有现成工具，那就是Kt Connect！
<a name="HlOzO"></a>
## Kt Connect
Kt Connect是阿里巴巴开源的一款云原生协同开发测试解决方案，目前包含以下几个核心功能，参加官方文档。[https://alibaba.github.io/kt-connect](https://alibaba.github.io/kt-connect)
<a name="Hv71n"></a>
### 核心功能

- 本地直接访问Kubernetes集群内网

通过KtConnect可以直接连接Kubernetes集群内部网络，在不修改代码的情况下完成本地联调测试

- 本地解析Kubernetes服务内网域名

直接使用服务名解析服务Cluster IP，本地开发也能获得真正的云原生体验

- 重定向集群服务流量到本地

将集群中的流量转移到本地，使得集群中的服务无需额外配置即可访问本地服务

- 测试环境多人协作互不干扰

通过自动或手工设定流量规则，在不影响测试环境正常使用的情况下，仅将指定请求重定向到本地

- 支持Windows/MacOS/Linux开发环境

不同的操作系统，相同的使用方式，让所有开发者轻松共享Kubernetes网络互通的便利
<a name="LOXe0"></a>
## Kt Connect 安装使用
下面以windows为例，介绍一下Kt Connect的安装使用。
<a name="qzT6d"></a>
### 1、安装
1、下载kubectl并解压放入D盘<br />在此链接中下载kubectl的可执行文件 ，注意下载对应线上kubernetes版本的kubectl ，如果想要下载对应其它版本，可以修改上面链接将版本号改为对应的即可 。<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793168-ef900537-af75-4b30-be50-a17bfea35172.png#averageHue=%23fcfbfb&clientId=ua8f6fd07-fd6b-4&from=paste&id=uc9592075&originHeight=290&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u174224b9-26b6-4b47-9ddd-b0cba967b84&title=)<br />2、配置环境变量<br />将Kt Connect的解压目录D:\kube\添加到PATH环境变量中<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793164-1c24fbfd-9daf-4c20-95e5-f24fc1538b72.png#averageHue=%23f5f4f2&clientId=ua8f6fd07-fd6b-4&from=paste&id=u6073d1c7&originHeight=426&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua4243b2d-2732-4d8a-9736-e069b86f40e&title=)<br />3、执行`kubectl version`命令查看已安装的 kubectl 版本号<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793078-5f2d091b-e77d-4021-827b-195531935798.png#averageHue=%23110e0b&clientId=ua8f6fd07-fd6b-4&from=paste&id=u3d851aac&originHeight=228&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u080aee5d-1b80-4bb0-8ab6-1b4eccc5e7a&title=)
<a name="VGN5k"></a>
### 2、连接配置
1、 从Kubernets master节点下载集群配置文件kubeconfig<br />此文件位于master节点中的$HOME/.kube/config<br />2、将C盘当前用户根目录下创建.kube文件夹，并将集群配置文件kubeconfig拷贝到此处<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793140-f971515d-6863-495b-956e-941dfcf2ebca.png#averageHue=%23fefdfd&clientId=ua8f6fd07-fd6b-4&from=paste&id=u0197df66&originHeight=231&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua48859c3-4ee0-4e81-92ce-b8a9411be19&title=)
<a name="UbPvS"></a>
### 3、连接集群
现在想连接kubernetes集群中namespace为workbench的项目，可以按照如下操作进行<br />1、运行命令连接指定集群
```bash
#xx为指定项目命名空间
ktctl --namespace=workbench connect
```
![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793610-d3f1f280-bd37-48f4-942c-9b206dbd0836.png#averageHue=%230c0a08&clientId=ua8f6fd07-fd6b-4&from=paste&id=ua76ba5ef&originHeight=937&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u8355701a-56b1-4050-9aa6-ea31acc3ecb&title=)<br />当连接上指定namespace后，可以在kubesphere平台看到本地创建的容器<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793675-89e7693e-accc-4f83-842d-441b0f33e145.png#averageHue=%23edede6&clientId=ua8f6fd07-fd6b-4&from=paste&id=u0bffad62&originHeight=431&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u5a92409e-a6d1-435f-9c0b-f058387fd8c&title=)<br />2、 当连接上以后就可以直接在本地访问云上的接口了<br />直接通过dns访问服务接口<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793690-e5b383b7-85ce-4fcd-a68c-a3927fce7f12.png#averageHue=%230a0907&clientId=ua8f6fd07-fd6b-4&from=paste&id=u77800534&originHeight=83&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u54d293fb-1743-4bfa-aa18-596fb8a780a&title=)<br />使用postman调本地接口通过feign调用集群服务，有正常响应<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793845-6d84505d-f754-4512-8d0f-f8e66aaf45b3.png#averageHue=%23333230&clientId=ua8f6fd07-fd6b-4&from=paste&id=u1acba63a&originHeight=209&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u3dd66555-347d-440b-b64a-8074d1a7fa4&title=)
<a name="ocr93"></a>
### 4、可能出现的问题
运行 `ktctl --namespace=workbench connect` 可能会出现hosts权限拒绝<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765793905-f49ca121-b89e-4b30-8c33-0a1a0fa822c8.png#averageHue=%23151312&clientId=ua8f6fd07-fd6b-4&from=paste&id=u5cbdf0d4&originHeight=377&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=u6001dfd3-2899-424e-a39e-9c760b8d301&title=)<br />**解决方案**<br />方法1：修改C盘 C:\Windows\System32\drivers\etc\ 此路径下hosts文件权限<br />在 hosts文件上点击鼠标右键，在弹出的选项中，点击打开“属性” , 选中用户后，点击编辑，勾选上下方的“修改”和“写入”权限，完成后，点击右下角的“应用”，再重新运行命令。<br />![](https://cdn.nlark.com/yuque/0/2023/png/396745/1673765794023-9a6ebae4-866b-4dcb-bf5d-41e3de10e351.png#averageHue=%23f6f5f4&clientId=ua8f6fd07-fd6b-4&from=paste&id=ued12259e&originHeight=747&originWidth=1080&originalType=url&ratio=1&rotation=0&showTitle=false&status=done&style=none&taskId=ua14579c8-8786-4307-aaa0-517b53a5c85&title=)<br />方法2：如果方法1不行，在本地新建一个记事本文件，将 hosts文件打开全选再复制进新建的记事本中，将记事本名修改成hosts替换进C:\Windows\System32\drivers\etc\路径下hosts文件，重新运行命令。
