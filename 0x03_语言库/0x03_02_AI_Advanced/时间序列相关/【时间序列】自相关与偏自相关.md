时间序列 自相关 偏自相关
<a name="jveYB"></a>
## 1、简介
自相关和偏自相关的图在时序分析中有广泛的应用。<br />这些图以图形化的方式总结了时间序列中的一个观测值与之前的时间步长的关系强度。<br />两者的区别对于初学者来说是困难的以及难以理解的。<br />数据准备：<br />[时序.zip](https://www.yuque.com/attachments/yuque/0/2021/zip/396745/1627950684982-c8cf64a7-9f53-4838-8940-a3ed563178fd.zip?_lake_card=%7B%22src%22%3A%22https%3A%2F%2Fwww.yuque.com%2Fattachments%2Fyuque%2F0%2F2021%2Fzip%2F396745%2F1627950684982-c8cf64a7-9f53-4838-8940-a3ed563178fd.zip%22%2C%22name%22%3A%22%E6%97%B6%E5%BA%8F.zip%22%2C%22size%22%3A4402303%2C%22type%22%3A%22application%2Fx-zip-compressed%22%2C%22ext%22%3A%22zip%22%2C%22status%22%3A%22done%22%2C%22taskId%22%3A%22u1881e4bd-f957-4be6-82c0-6536de2cc8a%22%2C%22taskType%22%3A%22upload%22%2C%22id%22%3A%22ue09a91a6%22%2C%22card%22%3A%22file%22%7D)<br />该数据集描述了澳大利亚墨尔本市10年(1981-1990年)的最低日温度。单位是摄氏度，有3650个观测值。数据的来源被认为是澳大利亚气象局。<br />下载数据集并将其放在当前工作目录中，文件名为“daily-minimum-temperatures.csv”。
```python
from pandas import read_csv
from matplotlib import pyplot
series = read_csv('daily-minimum-temperatures.csv', header=0, index_col=0)
series.plot()
pyplot.show()
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627950981300-76003bdd-d114-41cc-b8e5-ee12a0725f51.png#clientId=u279670b3-c97b-4&from=paste&height=400&id=u6578e884&originHeight=1201&originWidth=1599&originalType=binary&ratio=1&size=300325&status=done&style=shadow&taskId=u37297cba-f571-478c-917a-09e2cb3755d&width=533)<br />若每个变量都符合高斯分布（bell curve），则可以用 Pearson's 相关性系数计算变量间的相关性。<br />计算时间序列观测值与 前一个时间步长（称为滞后（lag）） 的相关关系。<br />由于时间序列观测值的相关性是用同一序列的前几次值来计算的，所以这称为序列相关性或自相关性。
<a name="GlxkV"></a>
### 1.1 自相关
由滞后引起的时间序列的自相关图称为自相关函数，或简称为 ACF（ Auto Correlation Function）。这种图有时被称为相关图（correlogram）或自相关图（autocorrelation plot）。<br />下面是使用 statsmodels 库中的 `plot_acf()` 函数计算和绘制每日最低温度的自相关图的一个示例。
```python
from matplotlib import pyplot
from statsmodels.graphics.tsaplots import plot_acf
series = read_csv('daily-minimum-temperatures.csv', header=0, index_col=0)
plot_acf(series)
pyplot.show()
```
运行该示例将创建一个2D图，x 轴上显示滞后值、y轴显示相关性 -1 和 1。<br />![2021-08-03-08-43-38-655586.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627951629393-0a1e3ec0-7433-46ed-b456-cb4dbc2266a7.png#clientId=u279670b3-c97b-4&from=ui&id=uacec4b08&originHeight=415&originWidth=537&originalType=binary&ratio=1&size=670136&status=done&style=shadow&taskId=u4f4c927e-2cb0-4c13-aeb7-175509639c9)<br />置信区间被画成一个圆锥体。默认情况下，这个值被设置为95%的置信区间。<br />默认情况下，所有的滞后值都会被打印出来，这使得绘图变得很混乱。<br />可以限制x轴上的滞后次数为50，以使图更容易阅读。<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627951037435-85f927f9-33f6-4799-b8ba-de96340c2173.png#clientId=u279670b3-c97b-4&from=paste&height=342&id=u25f4aff1&originHeight=1025&originWidth=1362&originalType=binary&ratio=1&size=155664&status=done&style=shadow&taskId=ue1823035-99ff-4cb7-b89f-cc78137fe3a&width=454)
<a name="mChs2"></a>
### 1.2 偏自相关
偏自相关是时间序列中的一个观测值与先前的观测值之间的关系的总结，其间的观测值之间的关系被删除了。<br />The partial autocorrelation at lag k is the correlation that results after removing the effect of any correlations due to the terms at shorter lags.<br />观测值与前一个时间节点的观测值的自相关由直接相关和间接相关两部分组成。间接相关是观测值的线性函数，包含时间间隔内的观测值。<br />![2021-08-03-08-43-38-882584.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627951617597-f127ff5b-acfc-4876-a74d-e02a7253dac8.png#clientId=u279670b3-c97b-4&from=ui&id=u123bceaf&originHeight=231&originWidth=459&originalType=binary&ratio=1&size=318908&status=done&style=shadow&taskId=u472ea38b-3371-4a6f-a935-8c5dd80ee9b)<br />如上图所示，想要得到 t 节点的预测值，有两条路径：

- 直接相关：直接由 t-2 节点得到 t
- 间接相关：由 t-2 节点得到 t-1 节点，再由 t-1 节点得到 t 节点，偏相关用的就是间接相关

间接相关是用线性表示，如：<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627951342160-ad704807-f744-4907-a9a0-62276fbd71d0.png#clientId=u279670b3-c97b-4&from=paste&height=29&id=uc86ba88e&originHeight=88&originWidth=790&originalType=binary&ratio=1&size=9212&status=done&style=none&taskId=ubabea6d4-95d4-411a-90aa-21d11dd91d1&width=263.3333333333333)<br />![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627951359395-11382875-ed84-4260-8d55-30b2a773123c.png#clientId=u279670b3-c97b-4&from=paste&height=23&id=ua764b042&originHeight=69&originWidth=66&originalType=binary&ratio=1&size=1556&status=done&style=none&taskId=u39e69c7e-19bb-48b4-89d2-ebebcb95227&width=22)表示今天的相关系数，为 1。<br />下面的示例使用 statsmodels 库中的 `plot_pacf()` 来计算和绘制最小日温度数据集中前50个滞后的偏自相关函数。
```python
from pandas import read_csv
from matplotlib import pyplot
from statsmodels.graphics.tsaplots import plot_pacf
series = read_csv('daily-minimum-temperatures.csv', header=0, index_col=0)
plot_pacf(series, lags=50)
pyplot.show()
```
![image.png](https://cdn.nlark.com/yuque/0/2021/png/396745/1627951174010-3d9ade9f-e9f2-4fca-9dac-69b47a0eaaa9.png#clientId=u279670b3-c97b-4&from=paste&height=340&id=u24269cb0&originHeight=1019&originWidth=1372&originalType=binary&ratio=1&size=161151&status=done&style=shadow&taskId=u6c4bfcc9-b94d-4cd5-8400-d13daf7c04e&width=457.3333333333333)
<a name="yjKcP"></a>
## 2、Python3 实现
```python
import numpy as np

temps = np.array([68.2, 65.7, 80, 90])
# ---------------------------------------------
# 计算自相关,表达的是今天的数据与昨天的数据的关系强弱
autocorrleation = []
for shift in range(3):
    if shift == 0:
        corr = np.corrcoef(temps, temps)[0, 1]
    else:
        corr = np.corrcoef(temps[:-shift], temps[shift:])[0, 1]
    autocorrleation.append(corr)
# ---------------------------------------------
# 计算偏自相关（partial autocorrleation)
# 将数据看做残差
pac = []
residuals = temps  # the residuals haven't been fit yet

for shift in range(3):
    if shift == 0:
        corr = np.corrcoef(temps, temps)[0, 1]
        pac.append(corr)
    else:
        corr = np.corrcoef(temps[:-shift], residuals[shift:])[0, 1]
        pac.append(corr)
        # fit the new day's data and find the residuals
        slope, intercept = np.polyfit(temps[:-shift], residuals[shift:], 1)
        estimate = intercept + slope * temps[:-shift]
        # update residuals
        residuals[shift:] = residuals[shift:] - estimate
```
<a name="GyrtR"></a>
## 3、解释
<a name="R1GDr"></a>
### 3.1 自回归
自回归是与自身进行比较，提供相似性或者自身的重复。<br />对于滞后为 k 的自回归（autoregression，AR），ACF 描述了一个观测值和另一个观测值在前一个时间步上的自相关关系，包括直接相关和间接相关信息。<br />这意味着希望 AR(k)  时间序列的 ACF 在 k 的滞后上是强的，并且这种关系的惯性将持续到随后的滞后值，并在某一时刻随着影响的减弱而减弱。<br />PACF 只描述了观测值与其滞后之间的直接关系。这意味着 k 以外的滞后值没有相关性。
<a name="zgK7u"></a>
### 3.2 移动平均
对于滞后为 k 的移动平均（moving average，MA），其过程是一个基于前面预测值的时间序列残差自回归模型。<br />另一种考虑移动平均模型的方法是，它根据最近预测的误差修正未来预测。<br />希望 MA(k) 过程的 ACF 与最近的值有很强的相关性，直到 k 的滞后，然后急剧下降到低相关性或无相关性。<br />希望 PACF 图中显示出与滞后的强烈关系以及从滞后开始的相关性的减弱。
