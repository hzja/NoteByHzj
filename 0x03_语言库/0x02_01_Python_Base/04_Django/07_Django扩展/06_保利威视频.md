# 保利威视频

![1585460390507-a594b53e-a889-4a1a-92d9-0b6e6a877344](D:\Note\python\Django\图片\1585460390507-a594b53e-a889-4a1a-92d9-0b6e6a877344.png)



urls.py

~~~ python
from django.conf.urls import url
from django.contrib import admin
from app01 import views
urlpatterns = [
    url(r'^admin/', admin.site.urls),
    url(r'^video/list/', views.video_list),
    url(r'^play/(\d+)/', views.play),
    url(r'^video/verify/', views.verify),
    url(r'^crossdomain.xml&', views.crossdomain),
]
~~~



models.py

~~~ python
from django.db import models

class Video(models.Model):
    title = models.CharField(verbose_name='名称',max_length=32)
    vid = models.CharField(verbose_name='保利威视频ID',max_length=64)
~~~



views.py

~~~ python
import json
from django.shortcuts import render,HttpResponse
from django.http import JsonResponse
from app01 import models


def video_list(request):
    video_queryset = models.Video.objects.all()

    return render(request,'video_list.html',{'video_queryset':video_queryset})

def play(request,nid):
    video_object = models.Video.objects.filter(id=nid).first()
    return render(request,'play.html',{'video_object':video_object})


def _gen_md5(arg):
    import hashlib
    obj = hashlib.md5()
    obj.update(arg.encode('utf-8'))
    return obj.hexdigest()

def verify(request):
    """授权播放"""
    t = request.GET.get('t')
    vid = request.GET.get('vid')
    code = request.GET.get('code')
    callback = request.GET.get('callback')

    """
    {
        "status":2,
        "username":"elvis",
        "sign":"2c2bfb00314da7d768d50a7d1e93bd9f",
        "msg":"非常抱歉，您无法播放视频，滚。",
    }
    """
    # 根据code和vid来判断用户是否可以播放此视频
    allow_play = False

    if allow_play:
        sign_info = "vid={}&secretkey={}&username={}&code={}&status={}&t={}".format(vid,"gqhrQA8XWZ",'alex',code,1,t)
        sign = _gen_md5(sign_info)
        data_dict = {
            'status':1,
            'username':'alex',
            'sign':sign
        }
        if callback:
            data = "%s(%s)" %(callback,json.dumps(data_dict))
            return HttpResponse(data)
        return JsonResponse(data_dict)
    else:
        sign_info = "vid={}&secretkey={}&username={}&code={}&status={}&t={}".format(vid, "gqhrQA8XWZ", 'alex', code, 2,
                                                                                    t)
        sign = _gen_md5(sign_info)
        data_dict = {
            'status': 2,
            'username': 'alex',
            'sign': sign,
            'msg':"非常抱歉，您无法播放视频，滚。"
        }
        if callback:
            data = "%s(%s)" % (callback, json.dumps(data_dict))
            return HttpResponse(data)
        return JsonResponse(data_dict)

def crossdomain(request):
    return render(request,'crossdomain.xml')
~~~



video_list.html

~~~ html
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>视频</title>
</head>
<body>
  <ul>
    {% for row in video_queryset %}
      <li><a href="/play/{{ row.id }}/">{{ row.title }}</a></li>
    {% endfor %}
  </ul>
</body>
</html>
~~~



play.py

~~~ python
<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8">
  <title>视频</title>
</head>
<body>
  <h1>播放视频</h1>
  <script src='//player.polyv.net/script/polyvplayer.min.js'></script>
  <div id='player'></div>
  <script>
  var player = polyvObject('#player').videoPlayer({
      'width':'300',
      'height':'169',
      'vid' : '{{ video_object.vid }}' ,
      'forceH5':true,
      'code':'用户ID'
  });
  </script>
</body>
</html>
~~~



crossdomain.xml

~~~ xml
<cross-domain-policy>
<allow-access-from domain="*.polyv.net"/>
</cross-domain-policy>
~~~

