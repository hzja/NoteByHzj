# 日志管理

django自带强大的日志管理工具，只需要在django/settings中设置日志的路径，然后在一些格式等配置，便可在视图函数等使用



## 组成

logging主要包含以下四个模块

- Loggers： 记录器
- Handlers：处理器
- Filters： 过滤器
- Formatters： 格式化器



## 日志级别

**ALL** 最低等级的，用于打开所有日志记录。

**TRACE** designates finer-grained informational events than the DEBUG.Since:1.2.12，很低的日志级别，一般不会使用。

**DEBUG** 指出细粒度信息事件对调试应用程序是非常有帮助的，主要用于开发过程中打印一些运行信息。

**INFO** 消息在粗粒度级别上突出强调应用程序的运行过程。打印一些你感兴趣的或者重要的信息，这个可以用于生产环境中输出程序运行的一些重要信息，但是不能滥用，避免打印过多的日志。

**WARN** 表明会出现潜在错误的情形，有些信息不是错误信息，但是也要给程序员的一些提示。

**ERROR** 指出虽然发生错误事件，但仍然不影响系统的继续运行。打印错误和异常信息，如果不想输出太多的日志，可以使用这个级别。

**FATAL** 指出每个严重的错误事件将会导致应用程序的退出。这个级别比较高了。重大错误，这种级别你可以直接停止程序了。

**OFF** 最高等级的，用于关闭所有日志记录。



如果将log level设置在某一个级别上，那么比此级别优先级高的log都能打印出来。例如，如果设置优先级为WARN，那么OFF、FATAL、ERROR、WARN 4个级别的log能正常输出，而INFO、DEBUG、TRACE、 ALL级别的log则会被忽略。Log4j建议只使用四个级别，优先级从高到低分别是ERROR、WARN、INFO、DEBUG。



## 示例

### 修改settings.py

~~~ python
import time

cur_path = os.path.dirname(os.path.realpath(__file__))  # log_path是存放日志的路径
log_path = os.path.join(os.path.dirname(cur_path), 'logs')
if not os.path.exists(log_path):
    os.mkdir(log_path)  # 如果不存在这个logs文件夹，就自动创建一个

LOGGING = {
    'version': 1,
    'disable_existing_loggers': True, # 是否禁用已经存在的日志器
    'formatters': {
        # 日志格式
        'standard': {
            'format': '[%(asctime)s] [%(filename)s:%(lineno)d] [%(module)s:%(funcName)s] '
                      '[%(levelname)s]- %(message)s'},
        'simple': {  # 简单格式
            'format': '%(levelname)s %(message)s'
        },
    },
    # 过滤
    'filters': {
    },
    # 定义具体处理日志的方式
    'handlers': {
        # 默认记录所有日志
        'default': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(log_path, 'all-{}.log'.format(time.strftime('%Y-%m-%d'))),
            'maxBytes': 1024 * 1024 * 5,  # 文件大小
            'backupCount': 5,  # 备份数
            'formatter': 'standard',  # 输出格式
            'encoding': 'utf-8',  # 设置默认编码，否则打印出来汉字乱码
        },
        # 输出错误日志
        'error': {
            'level': 'ERROR',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(log_path, 'error-{}.log'.format(time.strftime('%Y-%m-%d'))),
            'maxBytes': 1024 * 1024 * 5,  # 文件大小
            'backupCount': 5,  # 备份数
            'formatter': 'standard',  # 输出格式
            'encoding': 'utf-8',  # 设置默认编码
        },
        # 控制台输出
        'console': {
            'level': 'DEBUG',
            'class': 'logging.StreamHandler',
            'formatter': 'standard'
        },
        # 输出info日志
        'info': {
            'level': 'INFO',
            'class': 'logging.handlers.RotatingFileHandler',
            'filename': os.path.join(log_path, 'info-{}.log'.format(time.strftime('%Y-%m-%d'))),
            'maxBytes': 1024 * 1024 * 5,
            'backupCount': 5,
            'formatter': 'standard',
            'encoding': 'utf-8',  # 设置默认编码
        },
    },
    # 配置用哪几种 handlers 来处理日志
    'loggers': {
        # 类型 为 django 处理所有类型的日志， 默认调用
        'django': {
            'handlers': ['default', 'console'],
            'level': 'INFO', # 日志器接收的最低日志级别
            'propagate': False
        },
        # log 调用时需要当作参数传入
        'log': {
            'handlers': ['error', 'info', 'default'],
            'level': 'INFO', # 日志器接收的最低日志级别
            'propagate': True
        },
    }
}
~~~



### 脚本中调用

~~~ python
import logging

logger = logging.getLogger('log')

logger.info('请求成功！ request_user:{}；request_url:{}；response_code:{}；response_body:{}'.format(username, request.path_info,status.HTTP_200_OK, info))
logger.error('请求失败！ request_user:{}；request_url:{}；response_code:{}；response_body:{}'.format(username,request.path_info,status.HTTP_400_BAD_REQUEST,'请输入change_id'))
~~~



### 生成日志

all.log

![image](D:\Note\python\Django\图片\image3.png)



info.log

![image4](D:\Note\python\Django\图片\image4.png)



error.log

![image6](D:\Note\python\Django\图片\image6.png)



### 使用单例模式

~~~ python 
import logging
import settings

class Logger(object):
    def __init__(self,file_path,level):
        file_handler = logging.FileHandler(file_path, 'a', encoding='utf-8')
        fmt = logging.Formatter(fmt="%(asctime)s - %(name)s - %(levelname)s -%(module)s:  %(message)s")
        file_handler.setFormatter(fmt)

        self.logger = logging.Logger('cmdb', level=level)
        self.logger.addHandler(file_handler)

    def error(self,msg):
        self.logger.error(msg)

logger = Logger(settings.LOGGING_PATH,logging.DEBUG)
~~~

~~~ python
LOGGING_PATH = os.path.join(BASE_DIR,'log/cmdb.log')
~~~

