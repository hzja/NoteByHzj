# 面试题

## 为什么是单线程

1. 纯内存操作
2. 单线程也避免了CPU频繁的上下文切换，所以CPU不是瓶颈
3. 使用基于非阻塞的IO多路复用机制，一个线程可以跟踪多个客户端Socket状态，哪个就绪，就处理哪个
4. 使用基于跳跃表数据增删改效率非常高



## 那为什么Redis6.0之后又改用多线程呢?

redis并不是完全放弃单线程了，只是使用多线程来做数据的持久化和协议解析等非业务核心功能



## redis的访问数量级是多少？

Redis单节点的访问数量级8W+/s，多节点倍增。



## 提高缓存命中率的方法

需要在业务需求，缓存粒度，缓存策略，技术选型等各个方面去通盘考虑并做权衡。尽可能的聚焦在高频访问且时效性要求不高的热点业务上（如字典数据、session、token），通过缓存预加载（预热）、合理调整缓存有效期的时间 （避免同时失效）、增加存储容量、调整缓存粒度、更新缓存等手段来提高命中率。对于时效性很高（或缓存空间有限），内容跨度很大（或访问很随机），并且访问量不高的应用来说缓存命中率可能长期很低，可能预热后的缓存还没来得被访问就已经过期了。



## 大Key解决办法

1. **可以将数据拆分：**拆分后存到多个redis实例中，降低对单个redis的IO影响，查询的时候可以应用程序层面汇总

2. 使用hash、set、zset、list存储大key（以万为单位） 



## 热key问题怎么解决？

所谓热key问题就是，突然有几十万的请求去访问redis上的某个特定key，那么这样会造成流量过于集中，达到物理网卡上限，从而导致这台redis的服务器宕机引发雪崩。

针对热key的解决方案：

1. 提前把热key打散到不同的服务器，降低压力
2. 人为预测，预测这个商品会成为热点，加入二级缓存，提前加载热key数据到内存中，如果redis宕机，走内存查询
3. 分布式锁，只允许一个请求线程去访问DB，其他请求阻塞，这样就避免了很多请求打到DB上
4. 前端做缓存，在获取到redis缓存后，在web服务本地把热点的数据进行缓存，因为热点的商品不会很多，所以保存在本地缓存中，是没有问题的。这样请求数据时，如果web本地有缓存数据，就直接返回了



## Redis事务机制？

redis通过MULTI、EXEC、WATCH等命令来实现事务机制，事务执行过程将一系列多个命令按照顺序一次性执行，并且在执行期间，事务不会被中断，也不会去执行客户端的其他请求，直到所有命令执行完毕。事务的执行过程如下：

1. 服务端收到客户端请求，事务以MULTI开始
2. 如果客户端正处于事务状态，则会把事务放入队列同时返回给客户端QUEUED，反之则直接执行这个命令
3. 当收到客户端EXEC命令时，WATCH命令监视整个事务中的key是否有被修改，如果有则返回空回复到客户端表示失败，否则redis会遍历整个事务队列，执行队列中保存的所有命令，最后返回结果给客户端

WATCH的机制本身是一个CAS的机制，被监视的key会被保存到一个链表中，如果某个key被修改，那么REDIS_DIRTY_CAS标志将会被打开，这时服务器会拒绝执行事务。



## 一般Redis的key是如何设计的？

思考：原先在mysql里面数据是如何存储的？

答：使用it_user表（行和列组合）

| id   | username | email          |
| ---- | -------- | -------------- |
| 1    | asion    | gogery@163.com |
| 45   | mark     | mark@sina.com  |

1. 把mysql里面的表名当成redis里面key的前缀（it_user前缀）
2. 把mysql表里面的主键名称放在上面的前缀后面，一般用冒号分割（it_user:id）
3. 对应记录的主键值作为key的第三步（it_user:id:1）
4. 把mysql里面的其他字段作为key的第四部分（it_user:id:1:username）

把上面的记录保存在redis中：

![1144736-20171008173516903-686229769](D:\Note\python\数据库交互\图片\1144736-20171008173516903-686229769.png)

获取用户的信息，eg:要获取id为1的用户的信息

![1144736-20171008173918824-663068042](D:\Note\python\数据库交互\图片\1144736-20171008173918824-663068042.png)